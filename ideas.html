<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Ideas â€” Musical Idea Vault</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        /* Backgrounds - Dark neutral */
        --bg: #0a0a0a; /* Main background (near black) */
        --bg-card: #111111; /* Cards/panels */
        --bg-hover: #1a1a1a; /* Hover states */
        --bg-input: #161616; /* Input fields */
        --bg-elevated: #1a1a1a; /* Modals, dropdowns */
        --bg-selected: rgba(59, 130, 246, 0.15); /* Selected row/item */

        /* Borders */
        --border: rgba(255, 255, 255, 0.08); /* Original */
        --border-focus: rgba(59, 130, 246, 0.5); /* Focus rings */

        /* Text */
        --text: #f1f5f9; /* Primary text (slate-100) */
        --text-soft: #94a3b8; /* Secondary text (slate-400) */
        --text-muted: #64748b; /* Tertiary/disabled (slate-500) */

        /* Primary - Blue */
        --primary: #3b82f6; /* Primary actions (blue-500) */
        --primary-hover: #2563eb; /* Primary hover (blue-600) */
        --primary-soft: #60a5fa; /* Highlights, progress (blue-400) */
        --primary-muted: rgba(59, 130, 246, 0.2); /* Subtle backgrounds */

        /* Secondary - For Ignite, special actions */
        --secondary: #8b5cf6; /* Purple (violet-500) */
        --secondary-hover: #7c3aed; /* Purple hover */

        /* Accent - Keep for legacy/gradual migration */
        --accent: #3b82f6;
        --accent-hover: #2563eb;

        /* Status */
        --success: #14b8a6; /* Teal (muted, harmonizes with blue) */
        --warning: #f59e0b; /* Amber/gold (stars, priority) */
        --danger: #f43f5e; /* Rose (muted red) */

        /* Tags - Desaturated versions */
        --tag-blue: #3b82f6;
        --tag-purple: #8b5cf6;
        --tag-teal: #14b8a6;
        --tag-amber: #f59e0b;
        --tag-rose: #f43f5e;
        --tag-slate: #64748b;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        overflow: hidden;
      }

      /* Navigation Header */
      .nav-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: rgba(10, 10, 10, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        overflow: visible;
      }

      .nav-settings-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .nav-settings-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
        border-color: rgba(255, 255, 255, 0.15);
      }

      .nav-settings-btn svg {
        width: 18px;
        height: 18px;
      }

      /* Inbox Button */
      .nav-inbox-btn {
        position: relative;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .nav-inbox-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
        border-color: rgba(255, 255, 255, 0.15);
      }

      .nav-inbox-btn svg {
        width: 18px;
        height: 18px;
      }

      .inbox-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 18px;
        height: 18px;
        padding: 0 5px;
        background: #ef4444;
        color: white;
        font-size: 10px;
        font-weight: 600;
        border-radius: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* Inbox Modal */
      .inbox-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 1000;
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding: 40px 20px;
        overflow-y: auto;
      }

      .inbox-modal-overlay.open {
        display: flex;
      }

      .inbox-modal {
        width: 100%;
        max-width: 1200px;
        background: var(--bg-card);
        border-radius: 16px;
        border: 1px solid var(--border);
        overflow: hidden;
      }

      .inbox-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
      }

      .inbox-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .inbox-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
      }

      .inbox-icon svg {
        width: 22px;
        height: 22px;
      }

      .inbox-title {
        font-size: 20px;
        font-weight: 600;
      }

      .inbox-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      .inbox-close {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }

      .inbox-close:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .inbox-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        gap: 16px;
        flex-wrap: wrap;
      }

      .inbox-search {
        flex: 1;
        min-width: 200px;
        max-width: 400px;
        padding: 10px 14px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 13px;
      }

      .inbox-search:focus {
        outline: none;
        border-color: var(--primary);
      }

      .inbox-filters {
        display: flex;
        gap: 8px;
      }

      .inbox-filter-btn {
        padding: 8px 14px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-soft);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .inbox-filter-btn:hover {
        background: var(--bg-hover);
      }

      .inbox-filter-btn.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
      }

      .inbox-list {
        max-height: 60vh;
        overflow-y: auto;
      }

      .inbox-table {
        width: 100%;
        border-collapse: collapse;
      }

      .inbox-table th {
        padding: 12px 16px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: var(--bg-hover);
        position: sticky;
        top: 0;
      }

      .inbox-table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }

      .inbox-table tr {
        cursor: pointer;
        transition: background 0.15s;
      }

      .inbox-table tr:hover {
        background: var(--bg-hover);
      }

      .inbox-table tr.playing {
        background: rgba(139, 92, 246, 0.15);
      }

      .inbox-table tr.playing:hover {
        background: rgba(139, 92, 246, 0.2);
      }

      .inbox-table tr.playing td:first-child {
        position: relative;
      }

      .inbox-table tr.playing td:first-child::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--primary);
        border-radius: 0 2px 2px 0;
      }

      .inbox-memo-cell {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .inbox-memo-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .inbox-memo-artwork {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
      }

      .inbox-memo-artwork svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .inbox-memo-info {
        min-width: 0;
      }

      .inbox-memo-title {
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .inbox-memo-title .new-dot {
        width: 8px;
        height: 8px;
        background: #3b82f6;
        border-radius: 50%;
      }

      .inbox-memo-notes {
        font-size: 12px;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 300px;
      }

      .inbox-project-badge {
        padding: 4px 10px;
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .inbox-project-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .inbox-track-badge {
        padding: 4px 10px;
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
        display: inline-block;
      }

      .inbox-unassigned {
        color: var(--text-muted);
        font-size: 12px;
      }

      .inbox-excitement {
        display: flex;
        gap: 2px;
      }

      .inbox-excitement-star {
        color: var(--border);
        font-size: 14px;
        line-height: 1;
        cursor: pointer;
        transition: all 0.15s;
      }

      .inbox-excitement-star:hover {
        transform: scale(1.2);
        color: #f59e0b;
      }

      .inbox-excitement-star.filled {
        color: #f59e0b;
      }

      .inbox-duration {
        font-size: 13px;
        color: var(--text-soft);
        font-family: monospace;
      }

      .inbox-date {
        font-size: 12px;
        color: var(--text-muted);
      }

      .inbox-actions {
        display: flex;
        gap: 4px;
      }

      .inbox-action-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }

      .inbox-action-btn:hover {
        background: var(--bg-hover);
        color: var(--text);
        border-color: var(--text-muted);
      }

      .inbox-action-btn.promote:hover {
        color: #22c55e;
        border-color: #22c55e;
        background: rgba(34, 197, 94, 0.1);
      }

      .inbox-action-btn svg {
        width: 14px;
        height: 14px;
      }

      .inbox-empty {
        padding: 60px 20px;
        text-align: center;
        color: var(--text-muted);
      }

      .inbox-empty svg {
        width: 48px;
        height: 48px;
        opacity: 0.3;
        margin-bottom: 16px;
      }

      /* File Inbox in player panel */
      .file-inbox-section {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
      }

      .file-inbox-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .file-inbox-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .file-inbox-item {
        background: var(--bg-hover);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
      }

      .file-inbox-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .file-inbox-item-title {
        font-size: 13px;
        font-weight: 500;
        color: var(--text);
      }

      .file-inbox-player {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .file-inbox-play-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--bg-input);
        border: none;
        color: var(--text);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .file-inbox-play-btn:hover {
        background: var(--primary);
      }

      .file-inbox-play-btn svg {
        width: 12px;
        height: 12px;
      }

      .file-inbox-progress {
        flex: 1;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        overflow: hidden;
      }

      .file-inbox-progress-fill {
        height: 100%;
        background: var(--primary);
        width: 0%;
      }

      .file-inbox-time {
        font-size: 11px;
        color: var(--text-muted);
        font-family: monospace;
      }

      .file-inbox-download {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .file-inbox-download:hover {
        color: var(--primary);
        border-color: var(--primary);
      }

      .file-inbox-download svg {
        width: 12px;
        height: 12px;
      }

      .file-inbox-notes {
        font-size: 11px;
        color: var(--text-muted);
        font-style: italic;
        margin-top: 8px;
      }

      /* Inbox Player Bar */
      .inbox-player-bar {
        display: none;
        align-items: center;
        gap: 16px;
        padding: 16px 24px;
        background: var(--bg-hover);
        border-top: 1px solid var(--border);
      }

      .inbox-player-bar.active {
        display: flex;
      }

      .inbox-player-info {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 180px;
      }

      .inbox-player-artwork {
        width: 44px;
        height: 44px;
        border-radius: 6px;
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
      }

      .inbox-player-artwork svg {
        width: 100%;
        height: 100%;
      }

      .inbox-player-title {
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px;
      }

      .inbox-player-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .inbox-player-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: transparent;
        border: none;
        color: var(--text);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }

      .inbox-player-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .inbox-player-btn.main {
        width: 44px;
        height: 44px;
        background: white;
        color: black;
      }

      .inbox-player-btn.main:hover {
        transform: scale(1.05);
      }

      .inbox-player-btn svg {
        width: 18px;
        height: 18px;
      }

      .inbox-player-btn.main svg {
        width: 20px;
        height: 20px;
      }

      .inbox-player-progress {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .inbox-progress-bar {
        flex: 1;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .inbox-progress-bar:hover {
        height: 8px;
      }

      .inbox-progress-fill {
        height: 100%;
        background: var(--primary);
        border-radius: 3px;
        width: 0%;
        transition: width 0.1s linear;
      }

      .inbox-player-time {
        font-size: 12px;
        color: var(--text-muted);
        font-family: monospace;
        min-width: 45px;
      }

      .inbox-player-time.current {
        text-align: right;
      }

      .inbox-player-volume {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .inbox-volume-slider {
        width: 80px;
        height: 4px;
        -webkit-appearance: none;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        cursor: pointer;
      }

      .inbox-volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 12px;
        background: white;
        border-radius: 50%;
        cursor: pointer;
      }

      /* Audio Effects Controls */
      .inbox-player-effects {
        display: flex;
        align-items: center;
        gap: 12px;
        padding-left: 16px;
        border-left: 1px solid var(--border);
      }

      .inbox-effect-control {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      .inbox-effect-label {
        font-size: 9px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .inbox-effect-slider {
        width: 60px;
        height: 4px;
        -webkit-appearance: none;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        cursor: pointer;
      }

      .inbox-effect-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 12px;
        background: var(--primary);
        border-radius: 50%;
        cursor: pointer;
      }

      .inbox-effect-slider.reverb::-webkit-slider-thumb {
        background: #06b6d4;
      }

      .inbox-effect-slider.pitch::-webkit-slider-thumb {
        background: #f59e0b;
      }

      .inbox-effect-value {
        font-size: 9px;
        color: var(--text-muted);
        font-family: monospace;
        min-width: 32px;
        text-align: center;
      }

      .inbox-effect-reset {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-muted);
        font-size: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }

      .inbox-effect-reset:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
      }

      /* Inbox More Menu */
      .inbox-more-btn {
        position: relative;
      }

      .inbox-more-menu {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 4px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 4px;
        min-width: 150px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        z-index: 100;
        display: none;
      }

      .inbox-more-menu.open {
        display: block;
      }

      .inbox-more-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text);
        transition: background 0.15s;
      }

      .inbox-more-item:hover {
        background: var(--bg-hover);
      }

      .inbox-more-item.promote {
        color: #22c55e;
      }

      .inbox-more-item.archive {
        color: #ef4444;
      }

      .inbox-more-item svg {
        width: 16px;
        height: 16px;
      }

      /* Inbox Clickable Cells */
      .inbox-cell-clickable {
        cursor: pointer;
        padding: 4px 8px;
        margin: -4px -8px;
        border-radius: 6px;
        transition: background 0.15s;
      }

      .inbox-cell-clickable:hover {
        background: rgba(255, 255, 255, 0.08);
      }

      /* Inbox Dropdown */
      .inbox-dropdown {
        position: fixed;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px;
        min-width: 200px;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        z-index: 1100;
      }

      .inbox-dropdown-search {
        width: 100%;
        padding: 8px 10px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-size: 12px;
        margin-bottom: 8px;
      }

      .inbox-dropdown-search:focus {
        outline: none;
        border-color: var(--primary);
      }

      .inbox-dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text);
        transition: background 0.15s;
      }

      .inbox-dropdown-item:hover {
        background: var(--bg-hover);
      }

      .inbox-dropdown-item.selected {
        background: rgba(59, 130, 246, 0.2);
      }

      .inbox-dropdown-item-color {
        width: 12px;
        height: 12px;
        border-radius: 4px;
        flex-shrink: 0;
      }

      /* Audio Effects Controls */
      .inbox-player-effects {
        display: flex;
        align-items: center;
        gap: 16px;
        padding-left: 16px;
        border-left: 1px solid var(--border);
        margin-left: 8px;
      }

      .inbox-effect-control {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      .inbox-effect-label {
        font-size: 9px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .inbox-effect-knob {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--bg-input);
        border: 2px solid var(--border);
        position: relative;
        cursor: pointer;
        transition: border-color 0.15s;
      }

      .inbox-effect-knob:hover {
        border-color: var(--primary);
      }

      .inbox-effect-knob::after {
        content: "";
        position: absolute;
        top: 4px;
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        height: 8px;
        background: var(--primary);
        border-radius: 1px;
      }

      .inbox-effect-value {
        font-size: 10px;
        color: var(--text-soft);
        font-family: monospace;
      }

      .nav-tabs {
        display: flex;
        gap: 4px;
        padding: 4px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .nav-tab {
        padding: 8px 20px;
        border: none;
        background: transparent;
        color: #606060;
        font-size: 13px;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: inherit;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .nav-tab:hover {
        color: #a0a0a0;
        background: rgba(255, 255, 255, 0.03);
      }

      .nav-tab.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 2px 8px var(--primary-muted);
      }

      .nav-tab svg {
        width: 16px;
        height: 16px;
      }

      /* Main Layout - Three Panels */
      .main-layout {
        display: grid;
        grid-template-columns: auto 1fr auto;
        height: 100vh;
        padding-top: 56px;
      }

      /* Left Panel - Projects Sidebar */
      .sidebar {
        width: 220px;
        background: var(--bg-card);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        min-width: 60px;
        transition: width 0.2s ease;
      }

      .sidebar.collapsed {
        width: 60px !important;
      }

      .sidebar-resize-handle {
        position: absolute;
        top: 0;
        right: 0;
        width: 4px;
        height: 100%;
        cursor: ew-resize;
        background: transparent;
        transition: background 0.15s ease;
        z-index: 10;
      }

      .sidebar-resize-handle:hover,
      .sidebar-resize-handle.dragging {
        background: var(--primary);
      }

      .sidebar-header {
        padding: 0 12px;
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 0;
      }

      .sidebar-header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 57px;
      }

      .sidebar-header .search-input {
        margin-bottom: 12px;
      }

      .sidebar-header-actions {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .sidebar-settings-btn {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .sidebar-settings-btn:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .sidebar-settings-btn svg {
        width: 14px;
        height: 14px;
      }

      .sidebar.collapsed .sidebar-settings-btn {
        display: none;
      }

      .sidebar-title {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
      }

      .sidebar.collapsed .sidebar-title,
      .sidebar.collapsed .search-input,
      .sidebar.collapsed .project-name,
      .sidebar.collapsed .project-count,
      .sidebar.collapsed .upload-zone-text,
      .sidebar.collapsed .upload-progress {
        display: none;
      }

      .sidebar-collapse-btn {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
        flex-shrink: 0;
      }

      .sidebar-collapse-btn:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .sidebar-collapse-btn svg {
        width: 14px;
        height: 14px;
        transition: transform 0.2s ease;
      }

      .sidebar.collapsed .sidebar-collapse-btn svg {
        transform: rotate(180deg);
      }

      .sidebar.collapsed .sidebar-header {
        padding: 12px 8px;
        align-items: center;
      }

      .search-input {
        width: 100%;
        padding: 6px 10px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-size: 12px;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .search-input:focus {
        border-color: var(--border-focus);
        box-shadow: 0 0 0 3px var(--primary-muted);
      }

      .search-input::placeholder {
        color: var(--text-muted);
      }

      .project-list {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 6px;
      }

      .project-item {
        padding: 6px 8px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        color: var(--text-soft);
        transition: all 0.15s ease;
        margin-bottom: 2px;
      }

      .project-item:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .project-item.active {
        background: var(--bg-selected);
        color: var(--primary);
      }

      .project-icon {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
      }

      .project-icon svg {
        width: 7px;
        height: 7px;
      }

      .project-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
      }

      .project-count {
        font-size: 10px;
        color: var(--text-muted);
        background: var(--bg-hover);
        padding: 2px 6px;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .project-shortcut {
        font-size: 9px;
        color: var(--text-muted);
        background: transparent;
        border: 1px solid var(--border);
        padding: 1px 5px;
        border-radius: 3px;
        flex-shrink: 0;
        opacity: 0;
        transition: opacity 0.15s ease;
        margin-left: auto;
        font-weight: 500;
      }

      .sidebar:hover .project-shortcut {
        opacity: 0.6;
      }

      .project-item:hover .project-shortcut {
        opacity: 1;
      }

      .sidebar.collapsed .project-shortcut {
        display: none;
      }

      .project-spacer {
        width: 20px;
        flex-shrink: 0;
      }

      .sidebar.collapsed .project-item {
        justify-content: center;
        padding: 6px;
      }

      .sidebar.collapsed .project-spacer {
        display: none;
      }

      .sidebar.collapsed .project-icon {
        width: 18px;
        height: 18px;
      }

      .project-divider {
        height: 1px;
        background: var(--border);
        margin: 8px 6px;
      }

      /* Drag and Drop */
      .project-item.drag-over {
        background: var(--primary-muted);
        border: 1px dashed var(--primary);
        border-radius: 6px;
      }

      .ideas-table tbody tr.dragging {
        opacity: 0.5;
      }

      .grid-card.dragging {
        opacity: 0.5;
      }

      .ideas-table tbody tr,
      .grid-card {
        cursor: grab;
      }

      .ideas-table tbody tr:active,
      .grid-card:active {
        cursor: grabbing;
      }

      /* Nested Projects */
      .project-item-wrapper {
        position: relative;
      }

      .project-children {
        margin-left: 12px;
        max-height: 500px;
        overflow: hidden;
        transition: max-height 0.2s ease;
      }

      .project-children.collapsed {
        max-height: 0;
      }

      .project-expand-btn {
        width: 16px;
        height: 16px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin-right: 4px;
        transition: transform 0.2s ease;
        flex-shrink: 0;
      }

      .project-expand-btn:hover {
        color: var(--text);
      }

      .project-expand-btn.expanded {
        transform: rotate(90deg);
      }

      .project-expand-btn svg {
        width: 10px;
        height: 10px;
      }

      .sidebar.collapsed .project-expand-btn {
        display: none;
      }

      .sidebar.collapsed .project-children {
        display: none;
      }

      /* Add child project button */
      .project-add-child {
        opacity: 0;
        width: 16px;
        height: 16px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: opacity 0.15s ease;
        flex-shrink: 0;
      }

      .project-item:hover .project-add-child {
        opacity: 1;
      }

      .project-add-child:hover {
        color: var(--primary);
      }

      .project-add-child svg {
        width: 12px;
        height: 12px;
      }

      .sidebar.collapsed .project-add-child {
        display: none;
      }

      /* Project settings button */
      .project-settings-btn {
        opacity: 0;
        width: 18px;
        height: 18px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin-left: auto;
        transition: opacity 0.15s ease, color 0.15s ease;
        flex-shrink: 0;
      }

      .project-item:hover .project-settings-btn {
        opacity: 1;
      }

      .project-settings-btn:hover {
        color: var(--primary);
      }

      .project-settings-btn svg {
        width: 14px;
        height: 14px;
      }

      .sidebar.collapsed .project-settings-btn {
        display: none;
      }

      /* Project Settings Modal */
      .project-settings-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
      }

      .project-settings-modal.open {
        opacity: 1;
        visibility: visible;
      }

      .project-settings-content {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        width: 480px;
        max-width: 90vw;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .project-settings-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .project-settings-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
      }

      .project-settings-close {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .project-settings-close:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .project-settings-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px 20px;
      }

      .project-settings-hint {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 16px;
        line-height: 1.5;
      }

      .settings-project-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .settings-project-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: grab;
        transition: all 0.15s ease;
      }

      .settings-project-item:hover {
        border-color: var(--primary);
      }

      .settings-project-item.dragging {
        opacity: 0.5;
        cursor: grabbing;
      }

      .settings-project-item.drag-over {
        border-color: var(--primary);
        background: var(--primary-muted);
      }

      .settings-project-item.child {
        margin-left: 24px;
      }

      .settings-project-drag {
        color: var(--text-muted);
        cursor: grab;
      }

      .settings-project-drag svg {
        width: 14px;
        height: 14px;
      }

      .settings-project-icon {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        flex-shrink: 0;
      }

      .settings-project-name {
        flex: 1;
        font-size: 13px;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .settings-project-parent {
        font-size: 11px;
        color: var(--text-muted);
        background: var(--bg-hover);
        padding: 2px 6px;
        border-radius: 4px;
      }

      .settings-project-visibility {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: var(--text-soft);
        cursor: pointer;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .settings-project-visibility:hover {
        background: var(--bg-hover);
      }

      .settings-project-visibility.hidden {
        color: var(--text-muted);
        opacity: 0.5;
      }

      .settings-project-visibility svg {
        width: 16px;
        height: 16px;
      }

      .settings-drop-zone {
        padding: 12px;
        border: 2px dashed var(--border);
        border-radius: 8px;
        text-align: center;
        color: var(--text-muted);
        font-size: 12px;
        margin-top: 8px;
        transition: all 0.15s ease;
      }

      .settings-drop-zone.drag-over {
        border-color: var(--primary);
        background: var(--primary-muted);
        color: var(--primary);
      }

      /* Add New Project Section */
      .add-project-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
      }

      .add-project-header {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .add-project-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .add-project-input {
        flex: 1;
        padding: 10px 12px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 13px;
        outline: none;
      }

      .add-project-input:focus {
        border-color: var(--accent);
      }

      .add-project-input::placeholder {
        color: var(--text-muted);
      }

      .add-project-color-picker {
        display: flex;
        gap: 4px;
      }

      .color-option {
        width: 22px;
        height: 22px;
        border-radius: 6px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.15s ease;
      }

      .color-option:hover {
        transform: scale(1.1);
      }

      .color-option.selected {
        border-color: white;
        box-shadow: 0 0 0 2px var(--primary);
      }

      .add-project-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 10px 14px;
        background: var(--primary);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .add-project-btn:hover {
        opacity: 0.9;
      }

      .add-project-btn svg {
        width: 14px;
        height: 14px;
      }

      /* Rename input in settings */
      .settings-project-name {
        cursor: pointer;
        padding: 2px 4px;
        margin: -2px -4px;
        border-radius: 4px;
        transition: background 0.15s ease;
      }

      .settings-project-name:hover {
        background: var(--bg-hover);
      }

      .settings-project-name-input {
        padding: 4px 8px;
        background: var(--bg-input);
        border: 1px solid var(--accent);
        border-radius: 4px;
        color: var(--text);
        font-size: 13px;
        outline: none;
        width: 120px;
      }

      /* Column Settings Modal */
      .column-settings-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
      }

      .column-settings-modal.open {
        opacity: 1;
        visibility: visible;
      }

      .column-settings-content {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        width: 400px;
        max-width: 90vw;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .column-settings-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .column-settings-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
      }

      .column-settings-close {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .column-settings-close:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .column-settings-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px 20px;
      }

      .column-settings-hint {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 16px;
        line-height: 1.5;
      }

      .settings-column-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .settings-column-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: grab;
        transition: all 0.15s ease;
      }

      .settings-column-item:hover {
        border-color: var(--primary);
      }

      .settings-column-item.dragging {
        opacity: 0.5;
        cursor: grabbing;
      }

      .settings-column-item.drag-over {
        border-color: var(--primary);
        border-top-width: 3px;
      }

      .settings-column-drag {
        color: var(--text-muted);
        cursor: grab;
      }

      .settings-column-drag svg {
        width: 14px;
        height: 14px;
      }

      .settings-column-name {
        flex: 1;
        font-size: 13px;
        color: var(--text);
      }

      .settings-column-visibility {
        width: 28px;
        height: 28px;
        border: none;
        background: transparent;
        color: var(--text-soft);
        cursor: pointer;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .settings-column-visibility:hover {
        background: var(--bg-hover);
      }

      .settings-column-visibility.hidden {
        color: var(--text-muted);
        opacity: 0.5;
      }

      .settings-column-visibility svg {
        width: 16px;
        height: 16px;
      }

      .settings-parent-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
      }

      .settings-parent-label {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      /* Center Panel - Ideas Table */
      .ideas-panel {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .ideas-header {
        padding: 0 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        min-height: 57px;
      }

      .ideas-title {
        font-size: 18px;
        font-weight: 600;
      }

      .ideas-count {
        font-size: 13px;
        color: var(--text-muted);
        margin-left: 12px;
      }

      .ideas-actions {
        display: flex;
        gap: 8px;
      }

      .btn {
        padding: 8px 14px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
        font-family: inherit;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-hover);
      }

      .btn-secondary {
        background: transparent;
        color: var(--text-soft);
        border: 1px solid var(--border);
      }

      .btn-secondary:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .btn-ghost {
        background: transparent;
        color: var(--text-muted);
        border: 1px solid var(--border);
      }

      .btn-ghost:hover {
        background: transparent;
        color: var(--text);
        border-color: var(--text-muted);
      }

      .btn svg {
        width: 14px;
        height: 14px;
      }

      /* Ideas Table */
      .ideas-table-container {
        flex: 1;
        overflow-y: auto;
      }

      .ideas-table {
        width: 100%;
        border-collapse: collapse;
      }

      .ideas-table th {
        position: sticky;
        top: 0;
        background: var(--bg-card);
        padding: 12px 16px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.02em;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border);
        z-index: 10;
        user-select: none;
      }

      .ideas-table th.sortable {
        cursor: pointer;
      }

      .ideas-table th.sortable:hover {
        color: var(--text);
        background: var(--bg-hover);
      }

      .ideas-table th.sorted {
        color: var(--primary);
      }

      .ideas-table th:not(.sortable) {
        cursor: context-menu;
      }

      .ideas-table th:not(.sortable):hover {
        color: var(--text-soft);
      }

      .ideas-table td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
      }

      .ideas-table tr {
        cursor: pointer;
        transition: background 0.15s ease;
        background: var(--bg-card);
      }

      .ideas-table tbody tr:hover {
        background: var(--bg-hover);
      }

      .ideas-table tbody tr.playing {
        background: var(--bg-selected);
      }

      .ideas-table tbody tr.playing td:first-child {
        position: relative;
      }

      .ideas-table tbody tr.playing td:first-child::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: var(--primary);
      }

      .idea-title {
        font-weight: 500;
        color: var(--text);
      }

      .idea-project {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 0;
        background: transparent;
        color: var(--text);
        font-weight: 500;
        font-size: 12px;
      }

      .idea-project-thumb {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
      }

      .idea-project-thumb svg {
        width: 100%;
        height: 100%;
      }

      .idea-project.unassigned {
        color: var(--text-soft);
        font-weight: 400;
        opacity: 0.5;
      }

      /* Stage System */
      .stage-cell {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .stage-indicator {
        position: relative;
        width: 36px;
        height: 36px;
        cursor: pointer;
      }

      .stage-ring {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .stage-ring-bg {
        fill: none;
        stroke: rgba(255, 255, 255, 0.1);
        stroke-width: 3;
      }

      .stage-ring-progress {
        fill: none;
        stroke-width: 3;
        stroke-linecap: round;
        transform: rotate(-90deg);
        transform-origin: center;
        transition: stroke-dashoffset 0.3s ease;
      }

      .stage-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 14px;
        line-height: 1;
      }

      .stage-indicator:hover {
        transform: scale(1.1);
        transition: transform 0.15s ease;
      }

      /* Disable all hover effects when dropdown is open */
      body.dropdown-open .ideas-table tr:hover {
        background: transparent !important;
      }

      body.dropdown-open .stage-indicator:hover {
        transform: none !important;
      }

      body.dropdown-open .ideas-table {
        pointer-events: none;
      }

      /* Stage Colors */
      .stage-seed .stage-ring-progress {
        stroke: #94a3b8;
      }
      .stage-sprout .stage-ring-progress {
        stroke: #a3e635;
      }
      .stage-sapling .stage-ring-progress {
        stroke: #22c55e;
      }
      .stage-plant .stage-ring-progress {
        stroke: #f59e0b;
      }
      .stage-tree .stage-ring-progress {
        stroke: #f97316;
      }
      .stage-finished .stage-ring-progress {
        stroke: #06b6d4;
      }

      /* Stage Dropdown */
      .stage-dropdown {
        position: fixed;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px;
        min-width: 200px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        z-index: 9999;
        pointer-events: auto;
      }

      .stage-dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.15s ease;
        background: var(--bg-card);
      }

      .stage-dropdown-item:hover {
        background: var(--bg-hover);
      }

      .stage-dropdown-item.active {
        background: var(--bg-selected);
        border: 1px solid var(--border-focus);
      }

      .stage-dropdown-icon {
        font-size: 20px;
      }

      .stage-dropdown-info {
        flex: 1;
      }

      .stage-dropdown-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text);
      }

      .stage-dropdown-desc {
        font-size: 11px;
        color: var(--text-muted);
      }

      .stage-dropdown-check {
        color: var(--primary);
      }

      /* Project Dropdown - Slimmer version of stage dropdown */
      .project-dropdown {
        position: fixed;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px;
        min-width: 180px;
        max-width: 240px;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        z-index: 9999;
        pointer-events: auto;
      }

      .project-dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.15s ease;
      }

      .project-dropdown-item:hover {
        background: var(--bg-hover);
      }

      .project-dropdown-item.selected {
        background: var(--bg-selected);
      }

      .project-dropdown-checkbox {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.15s ease;
      }

      .project-dropdown-item.selected .project-dropdown-checkbox {
        background: var(--primary);
        border-color: var(--primary);
      }

      .project-dropdown-checkbox svg {
        width: 10px;
        height: 10px;
        color: white;
        opacity: 0;
      }

      .project-dropdown-item.selected .project-dropdown-checkbox svg {
        opacity: 1;
      }

      .project-dropdown-thumb {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .project-dropdown-name {
        font-size: 12px;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Tags Dropdown */
      .tags-dropdown {
        position: fixed;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px;
        min-width: 200px;
        max-width: 260px;
        max-height: 320px;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        z-index: 9999;
        pointer-events: auto;
      }

      .tags-dropdown-search {
        padding: 8px 10px;
        margin-bottom: 4px;
      }

      .tags-dropdown-search input {
        width: 100%;
        padding: 6px 10px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-size: 12px;
        outline: none;
      }

      .tags-dropdown-search input:focus {
        border-color: var(--accent);
      }

      .tags-dropdown-search input::placeholder {
        color: var(--text-muted);
      }

      .tags-dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.15s ease;
      }

      .tags-dropdown-item:hover {
        background: var(--bg-hover);
      }

      .tags-dropdown-item.selected {
        background: var(--bg-selected);
      }

      .tags-dropdown-checkbox {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.15s ease;
      }

      .tags-dropdown-item.selected .tags-dropdown-checkbox {
        background: var(--primary);
        border-color: var(--primary);
      }

      .tags-dropdown-checkbox svg {
        width: 10px;
        height: 10px;
        color: white;
        opacity: 0;
      }

      .tags-dropdown-item.selected .tags-dropdown-checkbox svg {
        opacity: 1;
      }

      .tags-dropdown-name {
        font-size: 12px;
        color: var(--text);
      }

      .tags-dropdown-create {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.15s ease;
        color: var(--primary);
        font-size: 12px;
        border-top: 1px solid var(--border);
        margin-top: 4px;
      }

      .tags-dropdown-create:hover {
        background: var(--bg-hover);
      }

      /* Due Date Badge */
      .due-date-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
      }

      .due-date-badge.empty {
        color: var(--text-soft);
        background: transparent;
        border: none;
        opacity: 0.5;
      }

      .due-date-badge.empty:hover {
        opacity: 0.8;
      }

      .due-date-badge.green {
        background: rgba(34, 197, 94, 0.15);
        color: #22c55e;
      }

      .due-date-badge.orange {
        background: rgba(249, 115, 22, 0.15);
        color: #f97316;
      }

      .due-date-badge.red {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
      }

      .due-date-badge:hover {
        opacity: 0.8;
      }

      /* Due Date Modal */
      .due-date-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
      }

      .due-date-modal.open {
        opacity: 1;
        visibility: visible;
      }

      .due-date-content {
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 16px;
        width: 340px;
        max-width: 95vw;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        overflow: hidden;
      }

      .due-date-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .due-date-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
      }

      .due-date-header .subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .due-date-close {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 4px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .due-date-close:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .due-date-close svg {
        width: 20px;
        height: 20px;
      }

      .due-date-body {
        padding: 16px 20px;
      }

      .due-date-quick-btns {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 16px;
      }

      .due-date-quick-btn {
        padding: 8px 14px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        color: var(--text);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .due-date-quick-btn:hover {
        background: var(--bg-hover);
        border-color: var(--accent);
      }

      .due-date-quick-btn.selected {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
      }

      /* Calendar */
      .calendar-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .calendar-nav-btn {
        width: 32px;
        height: 32px;
        background: transparent;
        border: none;
        border-radius: 8px;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .calendar-nav-btn:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .calendar-nav-btn svg {
        width: 18px;
        height: 18px;
      }

      .calendar-month-year {
        font-size: 15px;
        font-weight: 600;
        color: var(--text);
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
      }

      .calendar-day-header {
        text-align: center;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        padding: 8px 0;
      }

      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        color: var(--text-muted);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .calendar-day:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .calendar-day.other-month {
        color: var(--text-muted);
        opacity: 0.4;
      }

      .calendar-day.today {
        border: 1px solid var(--accent);
        color: var(--text);
      }

      .calendar-day.selected {
        background: #22c55e;
        color: white;
      }

      .calendar-day.past {
        color: var(--text-muted);
      }

      .due-date-footer {
        display: flex;
        gap: 12px;
        padding: 16px 20px;
        border-top: 1px solid var(--border);
      }

      .due-date-btn {
        flex: 1;
        padding: 12px 16px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .due-date-btn.clear {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid #ef4444;
        color: #ef4444;
      }

      .due-date-btn.clear:hover {
        background: rgba(239, 68, 68, 0.25);
      }

      .due-date-btn.update {
        background: var(--primary);
        border: none;
        color: white;
      }

      .due-date-btn.update:hover {
        opacity: 0.9;
      }

      /* Album art due date overlay */
      .album-art-due-date {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 600;
        backdrop-filter: blur(10px);
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .album-art-due-date.green {
        background: rgba(34, 197, 94, 0.8);
        color: white;
      }

      .album-art-due-date.orange {
        background: rgba(249, 115, 22, 0.8);
        color: white;
      }

      .album-art-due-date.red {
        background: rgba(239, 68, 68, 0.8);
        color: white;
      }

      .album-art-due-date.empty {
        background: rgba(0, 0, 0, 0.4);
        color: rgba(255, 255, 255, 0.7);
      }

      .album-art-due-date:hover {
        transform: scale(1.05);
      }

      /* Clickable project and tags cells */
      .idea-project-clickable,
      .idea-tags-clickable {
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 4px;
        transition: all 0.15s ease;
        border: 1px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        width: fit-content;
        max-width: 100%;
      }

      .idea-project-clickable:hover,
      .idea-tags-clickable:hover {
        background: transparent;
        border-color: var(--border);
      }

      .idea-tags {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
      }

      .tag {
        padding: 2px 8px;
        background: var(--bg-hover);
        border-radius: 4px;
        font-size: 10px;
        color: var(--text-soft);
      }

      .tag.tag-empty {
        background: transparent;
        color: var(--text-soft);
        opacity: 0.5;
      }

      .idea-tags-clickable:hover .tag.tag-empty {
        opacity: 0.8;
      }

      .priority-badge {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        cursor: pointer;
      }

      .priority-badge.priority-empty {
        padding: 2px 8px;
        background: transparent;
        border: none;
        border-radius: 4px;
        color: var(--text-soft);
        font-size: 10px;
        font-weight: 400;
        text-transform: none;
        opacity: 0.5;
        transition: all 0.15s ease;
      }

      .idea-priority-clickable:hover .priority-badge.priority-empty {
        opacity: 0.8;
      }

      .priority-high {
        background: rgba(244, 63, 94, 0.15);
        color: var(--danger);
      }

      .priority-medium {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
      }

      .priority-low {
        background: rgba(107, 114, 128, 0.15);
        color: var(--text-muted);
      }

      .idea-priority-clickable {
        cursor: pointer;
        display: inline-block;
      }

      .idea-priority-clickable:hover .priority-badge {
        opacity: 0.8;
      }

      /* Priority Dropdown */
      .priority-dropdown {
        position: fixed;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px;
        min-width: 140px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        z-index: 9999;
      }

      .priority-dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.15s;
        font-size: 13px;
      }

      .priority-dropdown-item:hover {
        background: var(--bg-hover);
      }

      .priority-dropdown-item.selected {
        background: rgba(139, 92, 246, 0.1);
      }

      .priority-dropdown-checkbox {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }

      .priority-dropdown-item.selected .priority-dropdown-checkbox {
        background: var(--primary);
        border-color: var(--primary);
      }

      .priority-dropdown-checkbox svg {
        width: 10px;
        height: 10px;
        opacity: 0;
        color: white;
      }

      .priority-dropdown-item.selected .priority-dropdown-checkbox svg {
        opacity: 1;
      }

      .priority-dropdown-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .priority-dropdown-name {
        flex: 1;
        color: var(--text);
      }

      .priority-dropdown-divider {
        height: 1px;
        background: var(--border);
        margin: 6px 0;
      }

      .favorite-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-muted);
        padding: 4px;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .favorite-btn svg {
        width: 18px;
        height: 18px;
      }

      .favorite-btn:hover {
        color: #ef4444;
      }

      .favorite-btn.active {
        color: #ef4444;
      }

      /* Right Panel - Now Playing */
      .player-panel {
        width: 360px;
        min-width: 80px;
        max-width: 500px;
        background: var(--bg-card);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        transition: width 0.3s ease, min-width 0.3s ease;
        justify-self: end; /* Keep anchored to right edge */
      }

      .player-resize-handle {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        cursor: ew-resize;
        background: transparent;
        z-index: 10;
      }

      .player-resize-handle:hover {
        background: var(--accent);
      }

      .player-collapse-btn {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
        flex-shrink: 0;
      }

      .player-collapse-btn:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .player-collapse-btn svg {
        width: 14px;
        height: 14px;
        transition: transform 0.3s ease;
      }

      .player-panel.collapsed .player-collapse-btn svg {
        transform: rotate(180deg);
      }

      /* Collapsed Player Panel */
      .player-panel.collapsed {
        width: 80px !important;
        min-width: 80px !important;
        margin-left: auto; /* Keep anchored to right */
      }

      .player-panel.collapsed .player-header {
        padding: 8px;
        flex-direction: column;
        gap: 8px;
        align-items: center;
      }

      .player-panel.collapsed .player-header-title,
      .player-panel.collapsed .player-header-actions {
        display: none;
      }

      .player-panel.collapsed .player-content {
        padding: 8px;
        align-items: center;
      }

      /* Mini Album Art */
      .player-panel.collapsed .album-art-container,
      .mini-album-art {
        width: 64px;
        height: 64px;
        min-width: 64px;
        min-height: 64px;
        aspect-ratio: 1;
        margin-bottom: 8px;
        border-radius: 8px;
        position: relative;
      }

      .mini-album-art .album-art {
        border-radius: 8px;
        overflow: hidden;
      }

      .player-panel.collapsed .player-overlay,
      .player-panel.collapsed .album-art-toggle,
      .player-panel.collapsed .album-art-settings,
      .player-panel.collapsed .album-art-info,
      .player-panel.collapsed .album-art-left-overlay,
      .player-panel.collapsed .album-art-due-date {
        display: none;
      }

      /* Circular Progress for Collapsed */
      .mini-circular-progress {
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        pointer-events: none;
      }

      .mini-circular-progress svg {
        width: 100%;
        height: 100%;
      }

      .mini-circular-progress .progress-bg {
        fill: none;
        stroke: rgba(255, 255, 255, 0.1);
        stroke-width: 3;
      }

      .mini-circular-progress .progress-fill {
        fill: none;
        stroke: var(--accent);
        stroke-width: 3;
        stroke-linecap: round;
        transform: rotate(-90deg);
        transform-origin: center;
        transition: stroke-dashoffset 0.1s linear;
        filter: drop-shadow(0 0 4px var(--accent));
      }

      /* Mini Play Button Overlay */
      .mini-play-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s ease;
        border-radius: 8px;
        cursor: pointer;
      }

      .mini-play-overlay:hover {
        opacity: 1;
      }

      .mini-play-overlay svg {
        width: 28px;
        height: 28px;
        color: white;
      }

      /* Mini Track Info */
      .mini-track-info {
        width: 100%;
        text-align: center;
        margin-bottom: 8px;
      }

      .mini-track-title {
        font-size: 10px;
        font-weight: 600;
        color: var(--text);
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-break: break-word;
        margin-bottom: 4px;
      }

      .mini-version {
        font-size: 9px;
        color: var(--text-muted);
        background: var(--bg-input);
        padding: 2px 5px;
        border-radius: 3px;
        display: inline-block;
      }

      /* Mini Stars */
      .mini-stars {
        display: flex;
        justify-content: center;
        gap: 1px;
        margin-bottom: 6px;
      }

      .mini-stars .star {
        font-size: 10px;
        color: var(--text-muted);
        cursor: pointer;
      }

      .mini-stars .star.active {
        color: var(--warning);
      }

      /* Mini Tags */
      .mini-tags {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 2px;
        max-width: 100%;
      }

      .mini-tag {
        font-size: 7px;
        padding: 1px 4px;
        border-radius: 2px;
        background: var(--bg-hover);
        color: var(--text-soft);
        white-space: nowrap;
      }

      .mini-task-tag {
        font-size: 7px;
        padding: 2px 4px;
        border-radius: 3px;
        color: white;
        white-space: nowrap;
      }

      /* Mini Collaborators (collapsed view) */
      .mini-collaborators {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        margin-top: 8px;
        margin-bottom: 8px;
      }

      .mini-collab-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid var(--border);
        background: var(--bg-hover);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: 600;
        color: var(--text);
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.15s ease;
      }

      .mini-collab-avatar:hover {
        transform: scale(1.1);
        border-color: var(--accent);
      }

      .mini-collab-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .mini-collab-more {
        background: rgba(255, 255, 255, 0.1);
        font-size: 8px;
        color: var(--text-muted);
      }

      /* Mini Priority (collapsed view) */
      .mini-priority {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 6px;
        margin-bottom: 6px;
      }

      .mini-priority-badge {
        font-size: 8px;
        padding: 3px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .mini-priority-badge.high {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
      }

      .mini-priority-badge.medium {
        background: rgba(249, 115, 22, 0.2);
        color: #f97316;
      }

      .mini-priority-badge.low {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
      }

      /* Mini Due Date (collapsed view) */
      .mini-due-date {
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 5px;
        font-size: 8px;
        font-weight: 600;
        text-align: center;
        cursor: pointer;
        transition: transform 0.15s ease;
      }

      .mini-due-date:hover {
        transform: scale(1.05);
      }

      .mini-due-date.green {
        background: rgba(34, 197, 94, 0.8);
        color: white;
      }

      .mini-due-date.orange {
        background: rgba(249, 115, 22, 0.8);
        color: white;
      }

      .mini-due-date.red {
        background: rgba(239, 68, 68, 0.8);
        color: white;
      }

      .mini-due-date.empty {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-muted);
      }

      /* Hide full content when collapsed */
      .player-panel.collapsed .track-info-section,
      .player-panel.collapsed .task-tags,
      .player-panel.collapsed .player-tabs,
      .player-panel.collapsed .tab-content {
        display: none;
      }

      /* Show mini content only when collapsed */
      .mini-player-content {
        display: none;
      }

      .player-panel.collapsed .mini-player-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      .player-panel.collapsed .full-player-content {
        display: none;
      }

      .player-header {
        padding: 0 16px;
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 57px;
      }

      .player-header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .player-header-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 3px;
        background: transparent;
        border: none;
        cursor: pointer;
        color: var(--text-soft);
        opacity: 0.5;
        transition: all 0.15s ease;
        padding: 4px 6px;
        border-radius: 6px;
      }

      .player-header-btn:hover {
        opacity: 0.8;
        background: rgba(255, 255, 255, 0.05);
      }

      .player-header-btn.active {
        color: #ef4444;
        opacity: 1;
      }

      .player-header-btn.danger:hover {
        color: var(--danger);
      }

      .player-header-btn.danger.active {
        color: var(--danger);
        opacity: 1;
      }

      .player-header-btn svg {
        width: 16px;
        height: 16px;
      }

      .player-header-btn-label {
        display: none;
      }

      .player-content {
        flex: 1;
        padding: 16px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .player-empty {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 13px;
        text-align: center;
        padding: 20px;
      }

      /* Album Art with Overlay Controls */
      .album-art-container {
        position: relative;
        width: 100%;
        aspect-ratio: 1;
        border-radius: 12px;
        margin-bottom: 16px;
        overflow: visible;
        background: var(--bg-input);
        box-shadow: 0 0 40px rgba(255, 255, 255, 0.06),
          0 0 80px rgba(255, 255, 255, 0.03);
      }

      .album-art-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 12px;
        overflow: hidden;
      }

      /* Frosted Glass Track Info Overlay - Tidal Style */
      .album-art-frosted {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 55%;
        padding: 0 14px 10px 14px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        background: linear-gradient(
          to top,
          rgba(0, 0, 0, 0.95) 0%,
          rgba(0, 0, 0, 0.85) 35%,
          rgba(0, 0, 0, 0.5) 60%,
          rgba(0, 0, 0, 0.2) 80%,
          rgba(0, 0, 0, 0) 100%
        );
        z-index: 3;
        pointer-events: none;
        border-radius: 0 0 12px 12px;
      }

      .album-art-frosted::before {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 100%;
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        mask-image: linear-gradient(
          to top,
          black 0%,
          black 50%,
          rgba(0, 0, 0, 0.4) 75%,
          transparent 100%
        );
        -webkit-mask-image: linear-gradient(
          to top,
          black 0%,
          black 50%,
          rgba(0, 0, 0, 0.4) 75%,
          transparent 100%
        );
        border-radius: 0 0 12px 12px;
        z-index: -1;
      }

      /* Subtle blur on entire album art for frosty feel */
      .album-art-wrapper::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        backdrop-filter: blur(0.5px);
        -webkit-backdrop-filter: blur(0.5px);
        border-radius: 12px;
        pointer-events: none;
        z-index: 1;
      }

      .album-art-frosted * {
        pointer-events: auto;
      }

      .frosted-info {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
      }

      .frosted-category {
        display: none;
      }

      .frosted-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2px;
      }

      .frosted-artist {
        font-size: 10px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.6);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .frosted-version {
        font-size: 8px;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.5);
        padding: 2px 6px;
        background: rgba(255, 255, 255, 0.12);
        border-radius: 8px;
      }

      .frosted-title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 6px;
      }

      .frosted-title {
        font-size: 17px;
        font-weight: 700;
        color: #fff;
        line-height: 1.2;
        text-shadow: 0 2px 16px rgba(0, 0, 0, 0.4);
        letter-spacing: -0.01em;
        flex: 1;
        min-width: 0;
      }

      .frosted-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }

      .frosted-project {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        font-size: 9px;
        font-weight: 400;
        color: rgba(255, 255, 255, 0.75);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .frosted-project:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .frosted-project-thumb {
        display: none;
      }

      .frosted-project-thumb svg {
        width: 100%;
        height: 100%;
      }

      .frosted-more {
        font-size: 8px;
        color: rgba(255, 255, 255, 0.6);
        padding: 3px 6px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .frosted-more:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      .frosted-rating {
        display: flex;
        gap: 2px;
        flex-shrink: 0;
      }

      .frosted-star {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.25);
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        transition: all 0.15s;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }

      .frosted-star:hover {
        transform: scale(1.2);
        color: rgba(255, 255, 255, 0.5);
      }

      .frosted-star.filled {
        color: #fbbf24;
        text-shadow: 0 0 10px rgba(251, 191, 36, 0.6);
      }

      /* Frosted Player Controls */
      .frosted-player {
        margin-top: auto;
        padding-top: 4px;
      }

      .frosted-progress {
        width: 100%;
        margin-bottom: 4px;
      }

      .frosted-progress-bar {
        height: 3px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 2px;
        cursor: pointer;
        position: relative;
      }

      .frosted-progress-fill {
        height: 100%;
        background: white;
        border-radius: 2px;
        width: 0%;
        transition: width 0.1s linear;
      }

      .frosted-time {
        display: flex;
        justify-content: space-between;
        font-size: 9px;
        color: rgba(255, 255, 255, 0.4);
        margin-top: 3px;
      }

      .frosted-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
      }

      .frosted-play-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.2s ease;
      }

      .frosted-play-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: scale(1.05);
      }

      .frosted-play-btn svg {
        width: 16px;
        height: 16px;
      }

      .frosted-skip-btn {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: transparent;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.5);
        transition: all 0.2s ease;
      }

      .frosted-skip-btn:hover {
        color: rgba(255, 255, 255, 0.9);
        transform: scale(1.1);
      }

      .frosted-skip-btn svg {
        width: 12px;
        height: 12px;
      }

      /* Progress Ring around Album Art */
      .album-progress-ring {
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        pointer-events: none;
        z-index: 5;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .player-panel.collapsed .album-progress-ring {
        opacity: 1;
      }

      .album-progress-ring svg {
        width: 100%;
        height: 100%;
      }

      .album-progress-ring .progress-bg {
        fill: none;
        stroke: rgba(255, 255, 255, 0.1);
        stroke-width: 6;
      }

      .album-progress-ring .progress-fill {
        fill: none;
        stroke: var(--primary);
        stroke-width: 6;
        stroke-linecap: round;
        transform: rotate(-90deg);
        transform-origin: center;
        transition: stroke-dashoffset 0.1s linear;
        filter: drop-shadow(0 0 8px var(--primary));
      }

      .album-art {
        width: 100%;
        height: 100%;
        position: relative;
      }

      .album-art svg {
        width: 100%;
        height: 100%;
      }

      .album-art img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Overlay Controls - Hidden, now using frosted player */
      .player-overlay {
        display: none;
      }

      .overlay-progress {
        width: 100%;
      }

      .overlay-progress-bar {
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        cursor: pointer;
        position: relative;
      }

      .overlay-progress-fill {
        height: 100%;
        background: white;
        border-radius: 2px;
        width: 0%;
        transition: width 0.1s linear;
      }

      .overlay-time {
        display: flex;
        justify-content: space-between;
        font-size: 10px;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 4px;
      }

      .overlay-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
      }

      .overlay-play-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.2s ease;
      }

      .overlay-play-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      .overlay-play-btn svg {
        width: 22px;
        height: 22px;
      }

      .overlay-skip-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.8);
        transition: all 0.2s ease;
      }

      .overlay-skip-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }

      .overlay-skip-btn svg {
        width: 16px;
        height: 16px;
      }

      .album-art-toggle {
        display: none;
      }

      .album-art-wrapper:hover .album-art-toggle {
        opacity: 0;
      }

      .album-art-toggle:hover {
        background: rgba(0, 0, 0, 0.7);
        color: white;
      }

      .album-art-settings {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        padding: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 6px;
        color: rgba(255, 255, 255, 0.6);
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transform: translateY(-4px);
      }

      .album-art-settings svg {
        width: 14px;
        height: 14px;
      }

      .album-art-wrapper:hover .album-art-settings {
        opacity: 1;
        transform: translateY(0);
      }

      .album-art-settings:hover {
        background: rgba(0, 0, 0, 0.7);
        color: white;
      }

      .album-art-info {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        padding: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 6px;
        color: rgba(255, 255, 255, 0.6);
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transform: translateY(-4px);
        z-index: 10;
      }

      .album-art-info svg {
        width: 14px;
        height: 14px;
      }

      .album-art-wrapper:hover .album-art-info {
        opacity: 1;
        transform: translateY(0);
      }

      .album-art-info:hover {
        background: rgba(0, 0, 0, 0.7);
        color: white;
      }

      .album-art-left-overlay {
        position: absolute;
        top: 8px;
        left: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 10;
        max-width: 60%;
      }

      .album-collaborator-avatars {
        display: flex;
        align-items: center;
        flex-shrink: 0;
      }

      .album-collaborator-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid rgba(0, 0, 0, 0.4);
        background: var(--bg-card);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: 600;
        color: var(--text);
        margin-left: -8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        transition: transform 0.15s ease;
      }

      .album-collaborator-avatar:first-child {
        margin-left: 0;
      }

      .album-collaborator-avatar:hover {
        transform: scale(1.15);
        z-index: 5;
      }

      .album-collaborator-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .album-collaborator-more {
        background: rgba(0, 0, 0, 0.6);
        color: rgba(255, 255, 255, 0.9);
        font-size: 8px;
      }

      /* Track Info Section - Hidden (now on frosted glass) */
      .track-info-section {
        display: none;
      }

      .track-header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 4px;
      }

      .now-playing-artist {
        font-size: 11px;
        font-weight: 500;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .version-badge {
        font-size: 10px;
        color: var(--text-muted);
        background: var(--bg-hover);
        padding: 2px 6px;
        border-radius: 4px;
      }

      .now-playing-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 12px;
        line-height: 1.3;
      }

      .track-meta-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .track-project-compact {
        display: flex;
        align-items: center;
        gap: 6px;
        flex: 1;
        min-width: 0;
      }

      .project-primary {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px 4px 4px;
        background: var(--bg-hover);
        border-radius: 6px;
        font-size: 11px;
        color: var(--text-soft);
        cursor: pointer;
        transition: background 0.15s;
      }

      .project-primary:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .project-primary-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
      }

      .project-primary-thumb svg {
        width: 100%;
        height: 100%;
      }

      .project-more {
        font-size: 10px;
        color: var(--text-muted);
        padding: 3px 6px;
        background: var(--bg-hover);
        border-radius: 4px;
        cursor: pointer;
      }

      .project-more:hover {
        color: var(--text-soft);
      }

      .track-rating {
        display: flex;
        gap: 2px;
        flex-shrink: 0;
      }

      .track-rating-star {
        background: none;
        border: none;
        padding: 0;
        font-size: 14px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.1s ease;
        line-height: 1;
      }

      .track-rating-star:hover {
        transform: scale(1.2);
      }

      .track-rating-star.filled {
        color: #fbbf24;
      }

      /* Workflow Tags - Compact */
      .workflow-tags-section {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 12px 0;
        margin-bottom: 4px;
        position: relative;
      }

      .workflow-edit-wrapper {
        position: relative;
        display: inline-block;
      }

      .workflow-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.02em;
      }

      .workflow-chip-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
      }

      .workflow-edit-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: transparent;
        border: 1px dashed var(--border);
        border-radius: 4px;
        font-size: 10px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.15s;
      }

      .workflow-edit-btn:hover {
        border-color: var(--text-soft);
        color: var(--text-soft);
      }

      /* Legacy support */
      .now-playing-project {
        font-size: 13px;
        color: var(--text-soft);
        margin-bottom: 8px;
      }

      .now-playing-project-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-bottom: 8px;
      }

      .project-tag {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px 4px 4px;
        background: var(--bg-hover);
        border-radius: 6px;
        font-size: 11px;
        color: var(--text-soft);
      }

      .project-tag-thumb {
        width: 11px;
        height: 11px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
      }

      .project-tag-thumb svg {
        width: 100%;
        height: 100%;
      }

      .inline-excitement {
        display: flex;
        gap: 2px;
      }

      .inline-excitement-star {
        background: none;
        border: none;
        padding: 0;
        font-size: 14px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.1s ease;
        line-height: 1;
      }

      .inline-excitement-star:hover,
      .inline-excitement-star.hovered {
        color: var(--warning);
        transform: scale(1.1);
      }

      .inline-excitement-star.active {
        color: var(--warning);
      }

      .album-art-toggle {
        display: none;
      }

      .album-art:hover .album-art-toggle {
        opacity: 0;
      }

      /* Thumbnail in list */
      .idea-thumbnail {
        width: 36px;
        height: 36px;
        border-radius: 6px;
        overflow: hidden;
        flex-shrink: 0;
      }

      .idea-thumbnail svg {
        width: 100%;
        height: 100%;
      }

      .idea-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .idea-title-cell {
        display: flex;
        align-items: center;
        gap: 12px;
        position: relative;
        padding-left: 24px;
      }

      /* Row Selection Checkbox */
      .idea-select-checkbox {
        position: absolute;
        left: -3px;
        width: 18px;
        height: 18px;
        border: 2px solid var(--border);
        border-radius: 4px;
        background: transparent;
        opacity: 0;
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .idea-select-checkbox svg {
        width: 12px;
        height: 12px;
        stroke: white;
        stroke-width: 3;
        display: none;
      }

      .ideas-table tr:hover .idea-select-checkbox {
        opacity: 0.5;
      }

      .ideas-table tr.selected .idea-select-checkbox,
      .idea-select-checkbox:hover {
        opacity: 1;
        border-color: var(--primary);
      }

      .ideas-table tr.selected .idea-select-checkbox {
        background: var(--primary);
      }

      .ideas-table tr.selected .idea-select-checkbox svg {
        display: block;
      }

      .ideas-table tr.selected {
        background: rgba(59, 130, 246, 0.1);
      }

      .ideas-table tr.selected:hover {
        background: rgba(59, 130, 246, 0.15);
      }

      /* Multi-Select Panel */
      .multi-select-panel {
        padding: 20px;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .multi-select-header {
        margin-bottom: 16px;
      }

      .multi-select-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 4px;
      }

      .multi-select-count {
        font-size: 13px;
        color: var(--text-muted);
      }

      .multi-select-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 12px;
        flex: 1;
        overflow-y: auto;
        padding-bottom: 16px;
      }

      .multi-select-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: background 0.15s ease;
      }

      .multi-select-item:hover {
        background: var(--bg-hover);
      }

      .multi-select-thumb {
        width: 64px;
        height: 64px;
        border-radius: 8px;
        overflow: hidden;
        background: var(--bg-input);
        position: relative;
      }

      .multi-select-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .multi-select-thumb svg {
        width: 100%;
        height: 100%;
      }

      .multi-select-remove {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 18px;
        height: 18px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.15s;
        cursor: pointer;
      }

      .multi-select-item:hover .multi-select-remove {
        opacity: 1;
      }

      .multi-select-name {
        font-size: 11px;
        color: var(--text-soft);
        text-align: center;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .multi-select-actions {
        padding-top: 16px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 8px;
      }

      .multi-select-actions .btn {
        flex: 1;
      }

      .now-playing-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
      }

      .now-playing-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
      }

      .version-selector-wrapper {
        position: relative;
      }

      .version-selector-btn {
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 500;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-soft);
        cursor: pointer;
        outline: none;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: all 0.15s ease;
      }

      .version-selector-btn svg {
        width: 12px;
        height: 12px;
      }

      .version-selector-btn:hover {
        border-color: var(--accent);
        color: var(--text);
      }

      .version-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 4px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 4px;
        min-width: 120px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .version-dropdown-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        color: var(--text);
        transition: background 0.15s ease;
      }

      .version-dropdown-item:hover {
        background: var(--bg-hover);
      }

      .version-dropdown-item.active {
        background: var(--bg-selected);
      }

      .version-dropdown-item .version-check {
        color: var(--primary);
        font-size: 14px;
      }

      .version-dropdown-empty {
        padding: 12px;
        text-align: center;
        color: var(--text-muted);
        font-size: 11px;
      }

      .version-badge {
        padding: 2px 6px;
        font-size: 11px;
        font-weight: 500;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 4px;
        color: var(--text-muted);
      }

      /* Task Tags */
      .task-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 16px;
      }

      .task-tag {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 9px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.02em;
        background: transparent;
      }

      .task-tag.needs-lyrics {
        color: #a78bfa;
        border: 1px solid #a78bfa;
      }

      .task-tag.needs-mix {
        color: #f472b6;
        border: 1px solid #f472b6;
      }

      .task-tag.needs-master {
        color: #5eead4;
        border: 1px solid #5eead4;
      }

      .task-tag.needs-vocals {
        color: #fbbf24;
        border: 1px solid #fbbf24;
      }

      .task-tag.needs-arrangement {
        color: #60a5fa;
        border: 1px solid #60a5fa;
      }

      .task-tag.needs-rework {
        color: #fb7185;
        border: 1px solid #fb7185;
      }

      .add-tag-btn {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 3px 8px;
        border-radius: 16px;
        font-size: 9px;
        font-weight: 500;
        background: transparent;
        border: 1px dashed rgba(255, 255, 255, 0.2);
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .add-tag-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.3);
        color: var(--text-soft);
      }

      .tag-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 4px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px;
        min-width: 180px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        z-index: 100;
      }

      .tag-dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.15s;
      }

      .tag-dropdown-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .tag-dropdown-item.active {
        background: rgba(139, 92, 246, 0.1);
      }

      .tag-dropdown-item .tag-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .tag-dropdown-item .tag-label {
        flex: 1;
      }

      .tag-dropdown-item .tag-check {
        width: 16px;
        text-align: center;
        color: var(--primary);
        font-size: 14px;
        flex-shrink: 0;
      }

      /* Tab System - Redesigned */
      .player-tabs {
        display: flex;
        gap: 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 0;
        margin-top: 8px;
      }

      .player-tab {
        flex: 1;
        padding: 8px 2px;
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -1px;
        font-size: 8px;
        font-weight: 500;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.15s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
      }

      .player-tab svg {
        opacity: 0.5;
        width: 14px;
        height: 14px;
      }

      .player-tab:hover {
        color: var(--text-soft);
      }

      .player-tab:hover svg {
        opacity: 0.7;
      }

      .player-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }

      .player-tab.active svg {
        opacity: 1;
      }

      .tab-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding-top: 12px;
        padding-bottom: 12px;
        overflow: hidden;
      }

      /* Info Tab Styles */
      .info-tab-content {
        display: flex;
        flex-direction: column;
        gap: 0;
        overflow-y: auto;
        padding-bottom: 10px;
      }

      .info-section {
        background: var(--bg-hover);
        padding: 10px 12px;
      }

      .info-section:first-child {
        border-radius: 8px 8px 0 0;
      }

      .info-section:last-child {
        border-radius: 0 0 8px 8px;
        padding-bottom: 20px;
      }

      .info-section:only-child {
        border-radius: 8px;
      }

      .info-section + .info-section {
        border-top: 1px solid rgba(255, 255, 255, 0.05);
      }

      .info-section-title {
        font-size: 9px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .info-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .info-label {
        font-size: 8px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      .info-value {
        font-size: 11px;
        color: var(--text);
      }

      .info-value.red {
        color: #ef4444;
      }

      .info-value.orange {
        color: #f97316;
      }

      .info-value.green {
        color: #22c55e;
      }

      .info-value.priority-high,
      .info-value.priority-medium,
      .info-value.priority-low {
        color: var(--text) !important;
        background: transparent !important;
      }

      .info-collaborators {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .info-collab-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
      }

      .info-collab-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: 600;
        color: white;
        overflow: hidden;
      }

      .info-collab-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .info-collab-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .info-collab-name {
        font-size: 12px;
        font-weight: 500;
        color: var(--text);
      }

      .info-collab-role {
        font-size: 10px;
        color: var(--text-muted);
      }

      .info-collab-split {
        font-size: 12px;
        font-weight: 600;
        color: var(--primary);
      }

      .info-empty {
        font-size: 11px;
        color: var(--text-muted);
        font-style: italic;
      }

      .info-add-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px;
        background: transparent;
        border: 1px dashed var(--border);
        border-radius: 6px;
        font-size: 11px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.15s;
      }

      .info-add-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
      }

      .info-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        min-height: 30px;
      }

      .info-tag {
        padding: 4px 10px;
        background: var(--bg-input);
        border-radius: 12px;
        font-size: 11px;
        color: var(--text-soft);
      }

      /* Files Tab Styles */
      .files-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .file-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: var(--bg-hover);
        border-radius: 8px;
        transition: background 0.15s;
      }

      .file-item:hover {
        background: rgba(255, 255, 255, 0.08);
      }

      .file-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .file-icon.audio {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
      }

      .file-icon.folder {
        background: linear-gradient(135deg, #f59e0b, #ef4444);
      }

      .file-icon.project {
        background: linear-gradient(135deg, #10b981, #059669);
      }

      .file-icon svg {
        width: 18px;
        height: 18px;
        color: white;
      }

      .file-path-display {
        word-break: break-all;
        line-height: 1.3;
      }

      .project-file-input-row {
        display: flex;
        gap: 8px;
        padding: 10px;
        background: var(--bg-hover);
        border-radius: 8px;
        align-items: center;
      }

      .project-file-input-row input {
        flex: 1;
        min-width: 0;
      }

      .btn-sm {
        padding: 4px 10px;
        font-size: 11px;
        border-radius: 4px;
      }

      .file-details {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .file-name {
        font-size: 12px;
        font-weight: 500;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .file-meta {
        font-size: 10px;
        color: var(--text-muted);
      }

      .file-action {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        background: transparent;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        transition: all 0.15s;
      }

      .file-action:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
      }

      .file-action svg {
        width: 14px;
        height: 14px;
      }

      .files-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 32px;
        color: var(--text-muted);
        font-size: 12px;
        text-align: center;
      }

      .tab-panel {
        display: none;
        flex: 1;
        flex-direction: column;
        min-height: 0;
        overflow-y: auto;
      }

      .tab-panel.active {
        display: flex;
      }

      /* Tab Panel Header with Save Button */
      .tab-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
        min-height: 28px;
      }

      .tab-panel-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
      }

      .tab-save-btn {
        padding: 4px 12px;
        background: var(--accent);
        border: none;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
        color: white;
        cursor: pointer;
        opacity: 0;
        transform: translateX(10px);
        transition: all 0.2s ease;
        pointer-events: none;
      }

      .tab-save-btn.visible {
        opacity: 1;
        transform: translateX(0);
        pointer-events: auto;
      }

      .tab-save-btn:hover {
        background: var(--accent-hover);
      }

      .tab-save-btn.saved {
        background: var(--success);
      }

      /* Notes/Comments Tab */
      .notes-textarea {
        flex: 1;
        min-height: 120px;
        padding: 12px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 13px;
        font-family: inherit;
        resize: none;
        outline: none;
        transition: border-color 0.2s;
      }

      .notes-textarea:focus {
        border-color: var(--accent);
      }

      .notes-textarea::placeholder {
        color: var(--text-muted);
      }

      /* Bookmark System */
      .bookmark-add-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: var(--bg-hover);
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 10px;
        color: var(--text-soft);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .bookmark-add-btn:hover {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
      }

      .bookmark-tabs {
        display: flex;
        gap: 6px;
        padding: 8px 0;
        overflow-x: auto;
        flex-wrap: nowrap;
        scrollbar-width: thin;
      }

      .bookmark-tabs:empty {
        display: none;
        padding: 0;
      }

      .bookmark-tab {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 20px;
        font-size: 12px;
        color: var(--text-soft);
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .bookmark-tab:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .bookmark-tab.active {
        background: var(--bg-hover);
        border-color: var(--text-soft);
        color: var(--text);
      }

      .bookmark-tab .bookmark-time {
        font-size: 10px;
        opacity: 0.6;
      }

      .bookmark-tab .bookmark-delete {
        margin-left: 2px;
        opacity: 0.5;
        font-size: 14px;
        line-height: 1;
        cursor: pointer;
        transition: opacity 0.15s;
      }

      .bookmark-tab:hover .bookmark-delete {
        opacity: 0.7;
      }

      .bookmark-tab .bookmark-delete:hover {
        opacity: 1;
      }

      .bookmark-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
      }

      /* Bookmark Modal */
      .bookmark-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 480px;
        max-width: 95vw;
        max-height: 85vh;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        z-index: 10001;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .bookmark-modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .bookmark-modal-title {
        font-size: 16px;
        font-weight: 600;
      }

      .bookmark-modal-close {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: 6px;
        font-size: 18px;
      }

      .bookmark-modal-close:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .bookmark-modal-body {
        padding: 20px;
        flex: 1;
        overflow-y: auto;
      }

      .bookmark-name-input {
        width: 100%;
        padding: 10px 12px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        color: var(--text);
        margin-bottom: 16px;
      }

      .bookmark-name-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      /* Timeline Scrubber */
      .bookmark-timeline-container {
        margin-bottom: 16px;
      }

      .bookmark-timeline-label {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .bookmark-timeline {
        position: relative;
        height: 48px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
      }

      .bookmark-waveform {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: space-around;
        padding: 0 4px;
      }

      .bookmark-waveform-bar {
        width: 2px;
        background: var(--text-muted);
        border-radius: 1px;
        opacity: 0.3;
      }

      .bookmark-selection {
        position: absolute;
        top: 0;
        bottom: 0;
        background: rgba(59, 130, 246, 0.3);
        border-left: 2px solid var(--primary);
        border-right: 2px solid var(--primary);
      }

      .bookmark-handle {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 12px;
        height: 24px;
        background: var(--primary);
        border-radius: 4px;
        cursor: ew-resize;
        z-index: 5;
      }

      .bookmark-handle-start {
        left: -6px;
      }

      .bookmark-handle-end {
        right: -6px;
      }

      .bookmark-playhead {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--accent);
        z-index: 3;
        pointer-events: none;
      }

      .bookmark-time-display {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 6px;
      }

      .bookmark-time-selected {
        color: var(--primary);
        font-weight: 600;
      }

      /* Bookmark Playback Controls */
      .bookmark-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .bookmark-play-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--primary);
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
      }

      .bookmark-play-btn:hover {
        transform: scale(1.05);
        background: var(--primary-hover);
      }

      .bookmark-play-btn svg {
        width: 20px;
        height: 20px;
      }

      .bookmark-note-input {
        width: 100%;
        min-height: 80px;
        padding: 10px 12px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 13px;
        color: var(--text);
        resize: none;
        font-family: inherit;
      }

      .bookmark-note-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .bookmark-modal-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }

      .bookmark-modal-footer .btn {
        padding: 8px 16px;
      }

      /* Metadata Tab */
      .metadata-grid {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 8px 12px;
        font-size: 12px;
      }

      .metadata-label {
        color: var(--text-muted);
        font-weight: 500;
      }

      .metadata-value {
        color: var(--text);
      }

      .metadata-input {
        padding: 6px 10px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-size: 12px;
        font-family: inherit;
        outline: none;
        width: 100%;
      }

      .metadata-input:focus {
        border-color: var(--accent);
      }

      /* Tab Toggle Labels */
      .tab-toggle-label {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--bg-hover);
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .tab-toggle-label:hover {
        border-color: var(--text-muted);
      }

      .tab-toggle-label input[type="checkbox"] {
        accent-color: var(--accent);
        width: 14px;
        height: 14px;
      }

      .tab-toggle-text {
        font-size: 12px;
        color: var(--text);
      }

      /* Info Section Styles */
      .info-section {
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .info-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .info-section-title {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 12px;
      }

      .info-section textarea.metadata-input {
        resize: vertical;
        min-height: 60px;
      }

      /* Collaborators Tab */
      .collaborators-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .collaborator-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.15s ease;
      }

      .collaborator-item:hover {
        background: rgba(255, 255, 255, 0.06);
      }

      .collaborator-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--primary-soft)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
      }

      .collaborator-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .collaborator-info {
        flex: 1;
        min-width: 0;
      }

      .collaborator-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text);
      }

      .collaborator-role {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      .collaborator-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
      }

      .collaborator-badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 2px 6px;
        background: var(--bg-hover);
        border-radius: 4px;
        font-size: 9px;
        color: var(--text-soft);
        font-weight: 500;
      }

      .collaborator-badge.split {
        background: rgba(139, 92, 246, 0.15);
        color: var(--primary);
      }

      .collaborator-badge.pro {
        background: rgba(20, 184, 166, 0.15);
        color: var(--success);
      }

      .collaborator-actions {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.15s ease;
      }

      .collaborator-item:hover .collaborator-actions {
        opacity: 1;
      }

      .add-collaborator-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px;
        background: transparent;
        border: 1px dashed rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: var(--text-muted);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.15s ease;
        width: 100%;
      }

      .add-collaborator-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      .add-collaborator-picker {
        position: relative;
      }

      .collaborator-picker-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
        margin-bottom: 8px;
        max-height: 280px;
        overflow-y: auto;
        z-index: 100;
      }

      .picker-header {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .picker-close {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 2px;
      }

      .picker-close:hover {
        color: var(--text);
      }

      .picker-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        cursor: pointer;
        transition: background 0.15s;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
      }

      .picker-item:hover {
        background: var(--bg-hover);
      }

      .picker-item.disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .picker-item-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
      }

      .picker-item-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .picker-item-info {
        flex: 1;
        min-width: 0;
      }

      .picker-item-name {
        font-size: 13px;
        color: var(--text);
        font-weight: 500;
      }

      .picker-item-meta {
        font-size: 10px;
        color: var(--text-muted);
      }

      .picker-item-check {
        color: var(--primary);
      }

      .picker-empty {
        padding: 20px;
        text-align: center;
        color: var(--text-muted);
        font-size: 12px;
      }

      .picker-empty a {
        color: var(--primary);
        cursor: pointer;
      }

      /* Comments Tab */
      .comments-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
      }

      .comments-list {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-bottom: 8px;
      }

      .comment-item {
        display: flex;
        gap: 8px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
      }

      .comment-avatar {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), var(--primary));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
      }

      .comment-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .comment-content {
        flex: 1;
        min-width: 0;
      }

      .comment-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 2px;
      }

      .comment-author {
        font-size: 10px;
        font-weight: 600;
        color: var(--text);
      }

      .comment-time {
        font-size: 9px;
        color: var(--text-muted);
      }

      .comment-timestamp {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        padding: 1px 5px;
        background: var(--bg-hover);
        border-radius: 4px;
        font-size: 9px;
        color: var(--accent);
        font-weight: 500;
        cursor: pointer;
        transition: background 0.15s ease;
      }

      .comment-timestamp:hover {
        background: rgba(139, 92, 246, 0.2);
      }

      .comment-timestamp svg {
        width: 8px;
        height: 8px;
      }

      .comment-text {
        font-size: 11px;
        color: var(--text-soft);
        line-height: 1.4;
        word-wrap: break-word;
      }

      .comment-input-wrapper {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding-top: 8px;
        border-top: 1px solid var(--border);
        margin-top: auto;
      }

      .comment-input-row {
        display: flex;
        gap: 6px;
        align-items: flex-end;
      }

      .comment-input {
        flex: 1;
        padding: 8px 10px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-size: 11px;
        font-family: inherit;
        resize: none;
        outline: none;
        min-height: 32px;
        max-height: 80px;
        transition: border-color 0.2s ease;
      }

      .comment-input:focus {
        border-color: var(--accent);
      }

      .comment-send-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: var(--accent);
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s ease;
        flex-shrink: 0;
      }

      .comment-send-btn:hover {
        background: var(--accent-hover);
      }

      .comment-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .comment-send-btn svg {
        width: 14px;
        height: 14px;
      }

      .comment-send-btn svg {
        width: 16px;
        height: 16px;
      }

      .comment-options {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .timestamp-toggle {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 9px;
        color: var(--text-muted);
        cursor: pointer;
        user-select: none;
      }

      .timestamp-toggle input {
        display: none;
      }

      .timestamp-toggle-switch {
        width: 26px;
        height: 14px;
        background: var(--bg-hover);
        border-radius: 7px;
        position: relative;
        transition: background 0.2s ease;
      }

      .timestamp-toggle-switch::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 10px;
        height: 10px;
        background: var(--text-muted);
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .timestamp-toggle input:checked + .timestamp-toggle-switch {
        background: var(--accent);
      }

      .timestamp-toggle input:checked + .timestamp-toggle-switch::after {
        left: 14px;
        background: white;
      }

      .timestamp-preview {
        font-size: 9px;
        color: var(--accent);
        font-weight: 500;
      }

      .comments-empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 11px;
        padding: 16px;
        text-align: center;
      }

      .comments-empty svg {
        width: 32px;
        height: 32px;
        margin-bottom: 8px;
        opacity: 0.3;
      }

      /* Todo Tab */
      .todo-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .todo-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
      }

      .todo-checkbox {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        border: 1.5px solid var(--border);
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
        flex-shrink: 0;
      }

      .todo-checkbox:hover {
        border-color: var(--accent);
      }

      .todo-checkbox.checked {
        background: var(--accent);
        border-color: var(--accent);
      }

      .todo-checkbox.checked svg {
        color: white;
      }

      .todo-text {
        flex: 1;
        font-size: 12px;
        color: var(--text);
      }

      .todo-item.completed .todo-text {
        color: var(--text-muted);
        text-decoration: line-through;
      }

      .todo-delete {
        background: none;
        border: none;
        padding: 4px;
        cursor: pointer;
        color: var(--text-muted);
        opacity: 0;
        transition: all 0.15s ease;
        border-radius: 4px;
      }

      .todo-item:hover .todo-delete {
        opacity: 1;
      }

      .todo-delete:hover {
        color: var(--danger);
        background: rgba(239, 68, 68, 0.1);
      }

      .add-todo-input {
        padding: 10px 12px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-size: 12px;
        font-family: inherit;
        outline: none;
        margin-top: 8px;
      }

      .add-todo-input:focus {
        border-color: var(--accent);
      }

      .add-todo-input::placeholder {
        color: var(--text-muted);
      }

      /* Notes Section */
      .notes-section {
        margin-top: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .notes-label {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      .notes-textarea {
        flex: 1;
        min-height: 120px;
        padding: 12px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 13px;
        font-family: inherit;
        resize: none;
        outline: none;
        transition: border-color 0.2s;
      }

      .notes-textarea:focus {
        border-color: var(--accent);
      }

      .notes-textarea::placeholder {
        color: var(--text-muted);
      }

      .notes-actions {
        margin-top: 8px;
        display: flex;
        justify-content: flex-end;
      }

      /* Favorite Toggle in Player */
      .player-favorite {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
      }

      .player-favorite-btn {
        background: none;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 8px 12px;
        cursor: pointer;
        color: var(--text-soft);
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.15s ease;
      }

      .player-favorite-btn:hover {
        background: var(--bg-hover);
        color: #ef4444;
      }

      .player-favorite-btn.active {
        background: rgba(239, 68, 68, 0.15);
        border-color: #ef4444;
        color: #ef4444;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* Loading State */
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: var(--text-muted);
      }

      /* Empty State */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        color: var(--text-muted);
        text-align: center;
      }

      .empty-state svg {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      /* Filter buttons */
      .filter-row {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
      }

      .filter-btn {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 11px;
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-soft);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .filter-btn:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .filter-btn.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
      }

      /* Saved Views Row */
      .saved-views-tabs {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        align-items: center;
        margin-left: 12px;
        padding-left: 12px;
        border-left: 1px solid var(--border);
      }

      .saved-views-tabs:empty {
        display: none;
        margin-left: 0;
        padding-left: 0;
        border-left: none;
      }

      .saved-view-tab {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 11px;
        color: var(--text-soft);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .saved-view-tab:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .saved-view-tab.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
      }

      .saved-view-tab .view-delete {
        width: 12px;
        height: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        opacity: 0.6;
        transition: opacity 0.15s;
        font-size: 10px;
        line-height: 1;
      }

      .saved-view-tab:hover .view-delete {
        opacity: 1;
      }

      .saved-view-tab .view-delete:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* Filter Panel Modal */
      .filter-panel-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 80px;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
      }

      .filter-panel-overlay.open {
        opacity: 1;
        visibility: visible;
      }

      .filter-panel {
        background: var(--bg-card);
        border-radius: 12px;
        width: 90%;
        max-width: 480px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        transform: translateY(-20px);
        transition: transform 0.2s;
      }

      .filter-panel-overlay.open .filter-panel {
        transform: translateY(0);
      }

      .filter-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
      }

      .filter-panel-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
      }

      .filter-panel-close {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .filter-panel-close:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .filter-panel-body {
        padding: 20px;
      }

      .filter-section {
        margin-bottom: 20px;
      }

      .filter-section:last-child {
        margin-bottom: 0;
      }

      .filter-section-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 10px;
      }

      .filter-options {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .filter-option {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 12px;
        color: var(--text-soft);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .filter-option:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .filter-option.selected {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
      }

      .filter-option .option-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .filter-panel-footer {
        display: flex;
        gap: 10px;
        padding: 16px 20px;
        border-top: 1px solid var(--border);
      }

      .filter-panel-footer button {
        flex: 1;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .filter-clear-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-soft);
      }

      .filter-clear-btn:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .filter-apply-btn {
        background: var(--primary);
        border: none;
        color: white;
      }

      .filter-apply-btn:hover {
        background: var(--primary-hover);
      }

      /* Active filter indicator */
      .filter-active-indicator {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        font-size: 10px;
        font-weight: 600;
        margin-left: 4px;
      }

      /* Generic Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
      }

      .modal-overlay.open {
        opacity: 1;
        visibility: visible;
      }

      .modal-content {
        background: var(--bg-card);
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        transform: scale(0.95);
        transition: transform 0.2s;
      }

      .modal-overlay.open .modal-content {
        transform: scale(1);
      }

      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
      }

      .modal-header h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
      }

      .modal-close {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-close:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .modal-body {
        padding: 20px;
      }

      .modal-input {
        width: 100%;
        padding: 12px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 14px;
        outline: none;
      }

      .modal-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
      }

      .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        padding: 16px 20px;
        border-top: 1px solid var(--border);
      }

      /* Settings Modal - Large */
      .settings-modal {
        width: 90%;
        max-width: 800px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
      }

      .settings-modal .modal-body {
        display: flex;
        flex: 1;
        padding: 0;
        overflow: hidden;
      }

      .settings-sidebar {
        width: 200px;
        background: rgba(0, 0, 0, 0.2);
        border-right: 1px solid var(--border);
        padding: 12px;
        flex-shrink: 0;
      }

      .settings-nav-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 8px;
        color: var(--text-soft);
        cursor: pointer;
        transition: all 0.15s;
        font-size: 13px;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
      }

      .settings-nav-item:hover {
        background: var(--bg-hover);
        color: var(--text);
      }

      .settings-nav-item.active {
        background: var(--primary);
        color: white;
      }

      .settings-nav-item svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }

      .settings-content {
        flex: 1;
        padding: 20px 24px;
        overflow-y: auto;
      }

      .settings-tab {
        display: block;
      }

      .settings-tab[style*="display: none"] {
        display: none !important;
      }

      .settings-section {
        margin-bottom: 32px;
      }

      .settings-section:last-child {
        margin-bottom: 0;
      }

      .settings-section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .settings-description {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 16px;
        line-height: 1.5;
      }

      /* Collaborator Cards */
      .collaborator-cards {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .collaborator-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--bg-hover);
        border-radius: 10px;
        transition: all 0.15s;
      }

      .collaborator-card:hover {
        background: rgba(255, 255, 255, 0.08);
      }

      .collaborator-card-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        overflow: hidden;
      }

      .collaborator-card-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .collaborator-card-info {
        flex: 1;
        min-width: 0;
      }

      .collaborator-card-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .collaborator-card-email {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .collaborator-card-aliases {
        font-size: 10px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      .collaborator-default-badge {
        padding: 2px 8px;
        background: var(--primary);
        color: white;
        border-radius: 10px;
        font-size: 9px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .collaborator-card-actions {
        display: flex;
        gap: 4px;
      }

      .collaborator-card-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }

      .collaborator-card-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
      }

      .collaborator-card-btn.danger:hover {
        color: var(--danger);
      }

      .collaborator-card-btn svg {
        width: 14px;
        height: 14px;
      }

      /* Share Modal */
      .share-modal {
        width: 90%;
        max-width: 500px;
      }

      .share-modal-preview {
        background: var(--bg-hover);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 20px;
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .share-preview-art {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
        background: var(--bg-input);
      }

      .share-preview-art svg {
        width: 100%;
        height: 100%;
      }

      .share-preview-info {
        flex: 1;
        min-width: 0;
      }

      .share-preview-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .share-preview-meta {
        font-size: 12px;
        color: var(--text-muted);
      }

      .share-section {
        margin-bottom: 20px;
      }

      .share-section-title {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 10px;
      }

      .share-options {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .share-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: var(--bg-hover);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s;
      }

      .share-option:hover {
        background: rgba(255, 255, 255, 0.08);
      }

      .share-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--primary);
      }

      .share-option-label {
        flex: 1;
        font-size: 13px;
        color: var(--text);
      }

      .share-option-desc {
        font-size: 11px;
        color: var(--text-muted);
      }

      .share-link-container {
        display: flex;
        gap: 8px;
        margin-top: 16px;
      }

      .share-link-input {
        flex: 1;
        padding: 12px 14px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 13px;
        font-family: monospace;
      }

      .share-link-input:focus {
        outline: none;
        border-color: var(--primary);
      }

      .share-copy-btn {
        padding: 12px 20px;
        background: var(--primary);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .share-copy-btn:hover {
        background: var(--primary-hover);
      }

      .share-tracks-list {
        max-height: 200px;
        overflow-y: auto;
        background: var(--bg-hover);
        border-radius: 8px;
        padding: 8px;
      }

      .share-track-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 6px;
      }

      .share-track-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .share-track-art {
        width: 36px;
        height: 36px;
        border-radius: 4px;
        overflow: hidden;
        flex-shrink: 0;
      }

      .share-track-art svg {
        width: 100%;
        height: 100%;
      }

      .share-track-title {
        flex: 1;
        font-size: 13px;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Share button in ideas header */
      .share-selection-btn {
        display: none;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-soft);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
      }

      .share-selection-btn:hover {
        background: var(--bg-hover);
        border-color: var(--text-muted);
        color: var(--text);
      }

      .share-selection-btn.visible {
        display: flex;
      }

      .share-selection-btn svg {
        width: 14px;
        height: 14px;
      }

      .add-collaborator-card {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 16px;
        background: transparent;
        border: 2px dashed var(--border);
        border-radius: 10px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.15s;
        font-size: 13px;
      }

      .add-collaborator-card:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(139, 92, 246, 0.05);
      }

      .add-collaborator-card svg {
        width: 18px;
        height: 18px;
      }

      /* Collaborator Form */
      .collaborator-form {
        background: var(--bg-hover);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
      }

      .collaborator-form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 12px;
      }

      .collaborator-form-row.full {
        grid-template-columns: 1fr;
      }

      .collaborator-form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .collaborator-form-group label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      .collaborator-form-group input {
        padding: 10px 12px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        font-size: 13px;
        outline: none;
      }

      .collaborator-form-group input:focus {
        border-color: var(--primary);
      }

      .collaborator-form-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-soft);
        cursor: pointer;
      }

      .collaborator-form-checkbox input {
        width: 16px;
        height: 16px;
      }

      .collaborator-form-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }

      /* Artwork Style Preview (in filter panel) */
      .style-preview {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .style-preview.vibrant {
        background: linear-gradient(
          135deg,
          #ff3366 0%,
          #33ccff 50%,
          #ffcc00 100%
        );
      }

      .style-preview.vintage {
        background: linear-gradient(
          135deg,
          #c47d5e 0%,
          #319b8a 50%,
          #e8c9a0 100%
        );
      }

      .style-preview.minimal {
        background: linear-gradient(
          135deg,
          #2c2c2c 0%,
          #5a5a5a 50%,
          #9e9e9e 100%
        );
      }

      .artwork-style-options {
        display: flex;
        gap: 8px;
      }

      .artwork-style-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* View Toggle */
      .view-toggle {
        display: flex;
        gap: 4px;
        margin-right: 12px;
        background: var(--bg-input);
        border-radius: 6px;
        padding: 3px;
      }

      .view-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 28px;
        border: none;
        background: transparent;
        border-radius: 4px;
        cursor: pointer;
        color: var(--text-muted);
        transition: all 0.15s;
      }

      .view-btn:hover {
        color: var(--text);
        background: rgba(255, 255, 255, 0.05);
      }

      .view-btn.active {
        color: var(--primary);
        background: var(--primary-muted);
      }

      .view-btn svg {
        width: 16px;
        height: 16px;
      }

      /* Grid View */
      .ideas-grid-container {
        flex: 1;
        overflow-y: auto;
        padding: 0 16px 16px;
      }

      .ideas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 16px;
      }

      .grid-card {
        background: var(--bg-card);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
      }

      .grid-card:hover {
        transform: translateY(-2px);
        border-color: var(--border);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      }

      .grid-card.playing {
        border-color: var(--primary);
        box-shadow: 0 0 20px var(--primary-muted);
      }

      .grid-card-art {
        aspect-ratio: 1;
        position: relative;
        overflow: hidden;
        border-radius: 6px;
      }

      .grid-card-art svg {
        width: 100%;
        height: 100%;
      }

      .grid-card-art img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .grid-card-badges {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 4px;
      }

      .grid-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
      }

      .grid-badge.priority {
        background: rgba(239, 68, 68, 0.8);
        color: white;
      }

      .grid-badge.favorite {
        background: rgba(239, 68, 68, 0.9);
        color: #fff;
      }

      .grid-card-info {
        padding: 12px;
      }

      .grid-card-title {
        font-size: 13px;
        font-weight: 500;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 4px;
      }

      .grid-card-project {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 3px 8px;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 5px;
        font-size: 11px;
        font-weight: 500;
        color: var(--text-soft);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }

      .grid-card-project-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
      }

      .grid-card-project-thumb svg {
        width: 100%;
        height: 100%;
      }

      .grid-card-playing {
        position: absolute;
        bottom: 8px;
        left: 8px;
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: var(--accent);
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        color: white;
      }

      .grid-card-playing svg {
        width: 10px;
        height: 10px;
      }

      /* Collapsible Sidebar */
      .sidebar-toggle {
        position: absolute;
        top: 12px;
        left: 220px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--bg-card);
        border: 1px solid var(--border);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        transition: all 0.2s;
        z-index: 10;
      }

      .sidebar-toggle:hover {
        color: var(--text);
        background: var(--bg-input);
      }

      .sidebar-toggle svg {
        width: 14px;
        height: 14px;
        transition: transform 0.2s;
      }

      .sidebar.collapsed {
        width: 0;
        padding: 0;
        overflow: hidden;
        border-right: none;
      }

      .sidebar.collapsed + .sidebar-toggle {
        left: 0;
      }

      .sidebar.collapsed + .sidebar-toggle svg {
        transform: rotate(180deg);
      }

      .main-layout.sidebar-collapsed .sidebar {
        width: 0;
        padding: 0;
        overflow: hidden;
        border-right: none;
      }

      .main-layout.sidebar-collapsed .sidebar-toggle {
        left: 8px;
      }

      .main-layout.sidebar-collapsed .sidebar-toggle svg {
        transform: rotate(180deg);
      }

      /* Archive button */
      .btn-archive {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text-muted);
      }

      .btn-archive:hover {
        border-color: var(--warning);
        color: var(--warning);
      }

      .btn-archive.archived {
        background: rgba(251, 191, 36, 0.15);
        border-color: var(--warning);
        color: var(--warning);
      }

      .action-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }

      .action-buttons .btn {
        flex: 1;
        font-size: 12px;
        padding: 8px 12px;
      }

      /* Quick Actions - Icon buttons row */
      .quick-actions {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin: 12px 0;
      }

      .icon-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
      }

      .icon-btn:hover {
        border-color: var(--text-soft);
        color: var(--text);
        background: rgba(255, 255, 255, 0.05);
      }

      .icon-btn.active {
        border-color: var(--primary);
        color: var(--primary);
        background: var(--primary-muted);
      }

      .icon-btn.active.warning {
        border-color: var(--warning);
        color: var(--warning);
        background: rgba(245, 158, 11, 0.15);
      }

      .icon-btn svg {
        width: 18px;
        height: 18px;
      }

      /* Compact notes section */
      .notes-section {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .notes-textarea {
        width: 100%;
        min-height: 60px;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg-input);
        color: var(--text);
        font-size: 12px;
        resize: vertical;
        font-family: inherit;
      }

      .notes-textarea:focus {
        outline: none;
        border-color: var(--accent);
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 11px;
      }

      /* Excitement Rating */
      .excitement-rating {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2px;
        margin: 8px 0;
      }

      .excitement-label {
        font-size: 11px;
        color: var(--text-muted);
        margin-right: 8px;
      }

      .excitement-star {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: var(--text-muted);
        padding: 2px;
        transition: all 0.15s;
        line-height: 1;
      }

      .excitement-star:hover {
        transform: scale(1.2);
      }

      .excitement-star.active {
        color: #fbbf24;
      }

      .excitement-star.hovered {
        color: #fcd34d;
      }

      /* Mini stars for list/grid */
      .mini-stars {
        display: inline-flex;
        gap: 1px;
        font-size: 10px;
        color: #fbbf24;
        margin-left: 6px;
      }

      .mini-stars.empty {
        color: var(--text-muted);
        opacity: 0.3;
      }

      /* Sidebar Action Buttons (Discover & Ignite) */
      .sidebar-action-buttons {
        display: flex;
        gap: 8px;
        padding: 8px 12px;
        margin-top: auto;
      }

      .sidebar.collapsed .sidebar-action-buttons {
        flex-direction: column;
        padding: 6px;
        gap: 6px;
      }

      .sidebar-action-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
        background: var(--bg-hover);
        color: var(--text-soft);
        border: 1px solid var(--border);
      }

      .sidebar-action-btn:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .sidebar-action-btn svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
      }

      .sidebar-action-btn .badge {
        background: var(--secondary);
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 4px;
      }

      .sidebar-action-ignite {
        background: linear-gradient(135deg, var(--secondary) 0%, #f97316 100%);
        color: white;
        border-color: transparent;
      }

      .sidebar-action-ignite:hover {
        background: linear-gradient(135deg, #f97316 0%, var(--secondary) 100%);
        transform: translateY(-1px);
      }

      .sidebar.collapsed .sidebar-action-btn span {
        display: none;
      }

      .sidebar.collapsed .sidebar-action-btn {
        padding: 10px;
        justify-content: center;
      }

      /* Upload drop zone */
      .upload-zone {
        border: 2px dashed var(--border);
        border-radius: 8px;
        padding: 12px;
        margin: 8px;
        margin-top: 0;
        text-align: center;
        color: var(--text-muted);
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .sidebar.collapsed .upload-zone {
        padding: 10px;
        margin: 6px;
      }

      .sidebar.collapsed .upload-zone svg {
        width: 20px;
        height: 20px;
        margin: 0;
      }

      .upload-zone:hover {
        border-color: var(--primary);
        color: var(--text-soft);
      }

      .upload-zone.dragover {
        border-color: var(--primary);
        background: var(--primary-muted);
        color: var(--primary);
      }

      .upload-zone svg {
        width: 24px;
        height: 24px;
        margin-bottom: 4px;
        opacity: 0.5;
      }

      .upload-zone.dragover svg {
        opacity: 1;
      }

      .upload-zone-text {
        font-size: 11px;
      }

      .upload-progress {
        margin-top: 8px;
        font-size: 10px;
        color: var(--primary);
      }

      /* Filter button for excitement */
      .filter-btn svg {
        width: 12px;
        height: 12px;
        margin-right: 4px;
      }

      /* Player panel - hide favorites button since we have icon now */
      .player-favorite {
        display: none;
      }

      /* Discover button in sidebar - pulsing when there are unrated ideas */
      #discover-btn {
        position: relative;
      }

      #discover-btn .badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: var(--danger);
        color: white;
        font-size: 9px;
        padding: 2px 5px;
        border-radius: 8px;
        font-weight: 600;
        min-width: 16px;
        text-align: center;
      }

      /* ============ RESPONSIVE DESIGN ============ */

      /* Tablet - Hide sidebar by default, stack player below */
      @media (max-width: 1024px) {
        .main-layout {
          grid-template-columns: 1fr 320px;
        }

        .sidebar {
          display: none;
        }

        .main-layout.sidebar-collapsed .sidebar {
          display: none;
        }

        .sidebar-toggle {
          display: none;
        }
      }

      /* Mobile - Single column, player as bottom sheet */
      @media (max-width: 768px) {
        body {
          overflow: auto;
        }

        .nav-header {
          padding: 8px 12px;
        }

        .nav-tabs {
          width: 100%;
          justify-content: center;
        }

        .nav-tab {
          padding: 8px 12px;
          font-size: 12px;
        }

        .nav-tab svg {
          width: 16px;
          height: 16px;
          margin-right: 4px;
        }

        .main-layout {
          display: flex;
          flex-direction: column;
          grid-template-columns: none;
          height: auto;
          min-height: 100vh;
          padding-top: 52px;
        }

        .sidebar {
          display: none;
        }

        .sidebar-toggle {
          display: none;
        }

        /* Ideas Panel */
        .ideas-panel {
          flex: 1;
          min-height: 50vh;
        }

        .ideas-header {
          padding: 0 12px;
          flex-wrap: wrap;
          gap: 8px;
          min-height: 57px;
        }

        .ideas-title {
          font-size: 18px;
        }

        .ideas-actions {
          width: 100%;
          justify-content: space-between;
        }

        .view-toggle {
          margin-right: 8px;
        }

        .filter-row {
          padding: 8px 12px;
          gap: 6px;
          flex-wrap: wrap;
        }

        .filter-btn {
          padding: 6px 10px;
          font-size: 11px;
        }

        .ideas-table-container {
          padding: 0 8px;
        }

        .ideas-table th,
        .ideas-table td {
          padding: 10px 8px;
          font-size: 12px;
        }

        /* Hide some columns on mobile */
        .ideas-table th:nth-child(3),
        .ideas-table td:nth-child(3),
        .ideas-table th:nth-child(4),
        .ideas-table td:nth-child(4) {
          display: none;
        }

        .idea-thumbnail {
          width: 32px;
          height: 32px;
        }

        .idea-title-cell {
          gap: 8px;
        }

        /* Grid view adjustments */
        .ideas-grid {
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
          gap: 12px;
        }

        .grid-card-info {
          padding: 10px;
        }

        .grid-card-title {
          font-size: 12px;
        }

        .grid-card-project {
          font-size: 10px;
        }

        /* Player Panel - Bottom sheet style */
        .player-panel {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          width: 100%;
          height: auto;
          max-height: 70vh;
          border-radius: 20px 20px 0 0;
          border-top: 1px solid var(--border);
          border-right: none;
          transform: translateY(calc(100% - 80px));
          transition: transform 0.3s ease;
          z-index: 200;
        }

        .player-panel.expanded {
          transform: translateY(0);
        }

        .player-header {
          cursor: pointer;
          padding: 0 16px;
          min-height: 57px;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .player-header::before {
          content: "";
          width: 40px;
          height: 4px;
          background: var(--text-muted);
          border-radius: 2px;
          position: absolute;
          top: 8px;
        }

        .player-content {
          padding: 12px 16px 24px;
          max-height: calc(70vh - 50px);
          overflow-y: auto;
        }

        .album-art {
          max-width: 200px;
          margin: 0 auto 12px;
        }

        .now-playing-title {
          font-size: 16px;
          text-align: center;
        }

        .now-playing-project {
          font-size: 12px;
          text-align: center;
        }

        .audio-controls {
          margin: 12px 0;
        }

        .playback-buttons {
          gap: 16px;
        }

        .play-btn {
          width: 48px;
          height: 48px;
        }

        .excitement-rating {
          margin: 12px 0;
        }

        .quick-actions {
          margin: 12px 0;
        }

        .notes-section {
          margin-top: 12px;
        }

        .notes-textarea {
          min-height: 50px;
        }

        /* Add padding at bottom for player */
        .ideas-table-container,
        .ideas-grid-container {
          padding-bottom: 100px;
        }
      }

      /* Small phones */
      @media (max-width: 380px) {
        .nav-tab span {
          display: none;
        }

        .nav-tab svg {
          margin-right: 0;
        }

        .ideas-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .filter-btn {
          padding: 5px 8px;
          font-size: 10px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="nav-header">
      <div class="nav-tabs">
        <a href="living-piece-player.html" class="nav-tab">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M9 18V5l12-2v13" />
            <circle cx="6" cy="18" r="3" />
            <circle cx="18" cy="16" r="3" />
          </svg>
          Listening
        </a>
        <a href="living-piece-playlist.html" class="nav-tab">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 15V6" />
            <path d="M18.5 18a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" />
            <path d="M12 12H3" />
            <path d="M16 6H3" />
            <path d="M12 18H3" />
          </svg>
          Playlist
        </a>
        <a href="admin.html" class="nav-tab">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"
            />
          </svg>
          Admin
        </a>
        <a href="ideas.html" class="nav-tab active">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
            />
          </svg>
          Ideas
        </a>
      </div>
      <div style="display: flex; align-items: center; gap: 8px">
        <button
          class="nav-inbox-btn"
          onclick="openInboxModal()"
          title="Voice Memo Inbox"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
            />
            <polyline points="22,6 12,13 2,6" />
          </svg>
          <span class="inbox-badge" id="inbox-badge" style="display: none"
            >0</span
          >
        </button>
        <button
          class="nav-settings-btn"
          onclick="openSettingsModal()"
          title="Settings"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"
            />
          </svg>
        </button>
      </div>
    </nav>

    <!-- Main Layout -->
    <div class="main-layout" id="main-layout">
      <!-- Left: Projects Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-resize-handle" id="sidebar-resize"></div>
        <div class="sidebar-header">
          <div class="sidebar-header-row">
            <div class="sidebar-title">Projects</div>
            <div class="sidebar-header-actions">
              <button
                class="sidebar-settings-btn"
                onclick="openProjectSettings()"
                title="Project settings"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="3" />
                  <path
                    d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"
                  />
                </svg>
              </button>
              <button
                class="sidebar-collapse-btn"
                onclick="toggleSidebarCollapse()"
                title="Collapse sidebar"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="15 18 9 12 15 6" />
                </svg>
              </button>
            </div>
          </div>
          <input
            type="text"
            class="search-input"
            id="search-input"
            placeholder="Search ideas..."
          />
        </div>
        <div class="project-list" id="project-list">
          <div class="loading">Loading projects...</div>
        </div>

        <!-- Discover and Ignite Buttons -->
        <div class="sidebar-action-buttons">
          <a
            href="discover.html"
            class="sidebar-action-btn"
            id="discover-btn"
            style="display: none"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="10" />
              <path d="M12 16v-4M12 8h.01" />
            </svg>
            <span>Discover</span>
          </a>
          <a
            href="ignite.html"
            class="sidebar-action-btn sidebar-action-ignite"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M12 2c0 4-4 6-4 10a4 4 0 108 0c0-4-4-6-4-10z" />
            </svg>
            <span>Ignite</span>
          </a>
        </div>

        <!-- Upload Drop Zone -->
        <div
          class="upload-zone"
          id="upload-zone"
          onclick="document.getElementById('file-input').click()"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          <div class="upload-zone-text">Drop audio files or click</div>
          <div class="upload-progress" id="upload-progress"></div>
        </div>
        <input
          type="file"
          id="file-input"
          accept="audio/*"
          multiple
          style="display: none"
          onchange="handleFileSelect(event)"
        />
      </aside>

      <!-- Sidebar Toggle Button -->
      <button
        class="sidebar-toggle"
        id="sidebar-toggle"
        onclick="toggleSidebar()"
        title="Toggle sidebar"
      >
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <polyline points="15 18 9 12 15 6" />
        </svg>
      </button>

      <!-- Center: Ideas Table -->
      <main class="ideas-panel">
        <div class="ideas-header">
          <div style="display: flex; align-items: center">
            <span class="ideas-title" id="ideas-title">All Ideas</span>
            <span class="ideas-count" id="ideas-count"></span>
          </div>
          <div class="ideas-actions">
            <button
              class="share-selection-btn"
              id="share-selection-btn"
              onclick="openShareModal()"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="18" cy="5" r="3" />
                <circle cx="6" cy="12" r="3" />
                <circle cx="18" cy="19" r="3" />
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
              </svg>
              Share
            </button>
            <button class="btn btn-secondary" onclick="openFilterPanel()">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
              </svg>
              Filter
            </button>
            <button class="btn btn-ghost" onclick="saveCurrentView()">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
              </svg>
              Save View
            </button>
          </div>
        </div>

        <div class="filter-row">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="favorites">
            â™¥ Favorites
          </button>
          <button class="filter-btn" data-filter="high">High Priority</button>
          <button class="filter-btn" data-filter="excited">ðŸ”¥ Excited</button>

          <!-- Saved Views / Tabs (inline with filters) -->
          <div class="saved-views-tabs" id="saved-views-tabs">
            <!-- Rendered dynamically -->
          </div>

          <div style="flex: 1"></div>

          <!-- View Toggle -->
          <div class="view-toggle">
            <button
              class="view-btn active"
              data-view="list"
              onclick="setViewMode('list')"
              title="List View"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="8" y1="6" x2="21" y2="6" />
                <line x1="8" y1="12" x2="21" y2="12" />
                <line x1="8" y1="18" x2="21" y2="18" />
                <line x1="3" y1="6" x2="3.01" y2="6" />
                <line x1="3" y1="12" x2="3.01" y2="12" />
                <line x1="3" y1="18" x2="3.01" y2="18" />
              </svg>
            </button>
            <button
              class="view-btn"
              data-view="grid"
              onclick="setViewMode('grid')"
              title="Grid View"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="3" width="7" height="7" />
                <rect x="14" y="3" width="7" height="7" />
                <rect x="14" y="14" width="7" height="7" />
                <rect x="3" y="14" width="7" height="7" />
              </svg>
            </button>
          </div>
        </div>

        <!-- List View -->
        <div class="ideas-table-container" id="list-view">
          <table class="ideas-table">
            <thead
              id="ideas-thead"
              oncontextmenu="openColumnSettings(event)"
              title="Right-click to customize columns"
            >
              <tr id="ideas-header-row">
                <!-- Rendered dynamically -->
              </tr>
            </thead>
            <tbody id="ideas-body">
              <tr>
                <td colspan="6" class="loading">Loading ideas...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Grid View -->
        <div class="ideas-grid-container" id="grid-view" style="display: none">
          <div class="ideas-grid" id="ideas-grid">
            <div class="loading">Loading ideas...</div>
          </div>
        </div>
      </main>

      <!-- Right: Now Playing -->
      <aside class="player-panel" id="player-panel">
        <div class="player-resize-handle" id="player-resize"></div>
        <div class="player-header" id="player-header">
          <button
            class="player-collapse-btn"
            onclick="togglePlayerCollapse()"
            title="Collapse player"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </button>
          <div class="player-header-actions" id="player-header-actions"></div>
        </div>
        <div class="player-content" id="player-content">
          <div class="player-empty">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              style="
                width: 40px;
                height: 40px;
                margin-bottom: 12px;
                opacity: 0.3;
              "
            >
              <circle cx="12" cy="12" r="10" />
              <polygon points="10 8 16 12 10 16 10 8" />
            </svg>
            <div>Select an idea to play</div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Filter Panel Modal -->
    <div
      class="filter-panel-overlay"
      id="filter-panel-overlay"
      onclick="if(event.target === this) closeFilterPanel()"
    >
      <div class="filter-panel">
        <div class="filter-panel-header">
          <span class="filter-panel-title">Filter Ideas</span>
          <button class="filter-panel-close" onclick="closeFilterPanel()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              style="width: 18px; height: 18px"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="filter-panel-body" id="filter-panel-body">
          <!-- Rendered dynamically -->
        </div>
        <div class="filter-panel-footer">
          <button class="filter-clear-btn" onclick="clearAllFilters()">
            Clear All
          </button>
          <button class="filter-apply-btn" onclick="applyAdvancedFilters()">
            Apply Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Save View Modal -->
    <div
      class="modal-overlay"
      id="save-view-modal"
      onclick="if(event.target === this) closeSaveViewModal()"
    >
      <div class="modal-content" style="max-width: 400px">
        <div class="modal-header">
          <h3>Save Current View</h3>
          <button class="modal-close" onclick="closeSaveViewModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <p
            style="
              color: var(--text-soft);
              font-size: 13px;
              margin-bottom: 16px;
            "
          >
            Save your current filter settings as a reusable tab.
          </p>
          <input
            type="text"
            id="view-name-input"
            class="modal-input"
            placeholder="View name (e.g., 'Needs Mix', 'High Priority')"
          />
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeSaveViewModal()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="confirmSaveView()">
            Save View
          </button>
        </div>
      </div>
    </div>

    <!-- Hidden Audio Element -->
    <audio id="audio-player" preload="auto"></audio>

    <script>
      // Supabase Config
      const supabaseUrl = "https://cimngwcwvbspkcqdzqfg.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpbW5nd2N3dmJzcGtjcWR6cWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MzA1MDIsImV4cCI6MjA4MDEwNjUwMn0.L9Tvj4mlSjAtiSVMPkaegRF4laZl_E15ALZFdRhSzUg";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // State
      let allIdeas = [];
      let filteredIdeas = [];
      let currentIdea = null;
      let currentFilter = "all";
      let currentProject = null;
      let searchQuery = "";
      let isPlaying = false;
      let useUnsplash = false; // Toggle between generative SVG and Unsplash
      let unsplashCache = {}; // Cache Unsplash images
      let viewMode = "list"; // 'list' or 'grid'
      let selectedTracks = new Set(); // Multi-select track IDs

      // Arrays for inbox dropdowns
      let allProjects = [];
      let allTracks = [];

      // Build projects array from settings
      function buildProjectsArray() {
        allProjects = [];
        const settings = getProjectSettings();

        // Get projects from settings
        if (settings.customProjects) {
          settings.customProjects.forEach((name) => {
            allProjects.push({
              name: name,
              color: settings.colors?.[name] || "#666",
            });
          });
        }

        // Also get unique projects from tracks
        const trackProjects = new Set(
          allIdeas.map((t) => t.project).filter(Boolean)
        );
        trackProjects.forEach((name) => {
          if (!allProjects.find((p) => p.name === name)) {
            allProjects.push({
              name: name,
              color: settings.colors?.[name] || "#666",
            });
          }
        });

        // Sort alphabetically
        allProjects.sort((a, b) => a.name.localeCompare(b.name));
      }

      // Build tracks array from allIdeas
      function buildTracksArray() {
        allTracks = allIdeas
          .map((t) => ({
            id: t.id,
            title: t.title,
            project: t.project,
          }))
          .sort((a, b) => a.title.localeCompare(b.title));
      }

      // Track Selection Functions
      function toggleTrackSelection(trackId, event) {
        if (event) {
          event.stopPropagation();
        }

        if (selectedTracks.has(trackId)) {
          selectedTracks.delete(trackId);
        } else {
          selectedTracks.add(trackId);
        }

        renderIdeasTable();
        updatePanelForSelection();
      }

      function handleTrackClick(event, trackId) {
        // Check if Command (Mac) or Ctrl (Windows) is held
        if (event.metaKey || event.ctrlKey) {
          event.preventDefault();
          toggleTrackSelection(trackId, event);
          return;
        }

        // Normal click - clear selection and play
        if (selectedTracks.size > 0) {
          selectedTracks.clear();
        }
        window.playIdea(trackId);
      }

      function clearSelection() {
        selectedTracks.clear();
        renderIdeasTable();
        if (currentIdea) {
          renderPlayerPanel();
        }
      }

      function removeFromSelection(trackId) {
        selectedTracks.delete(trackId);
        renderIdeasTable();
        updatePanelForSelection();
      }

      function updatePanelForSelection() {
        if (selectedTracks.size > 1) {
          renderMultiSelectPanel();
        } else if (selectedTracks.size === 1) {
          // Single selection - play that track
          const trackId = Array.from(selectedTracks)[0];
          window.playIdea(trackId);
          selectedTracks.clear();
        } else if (currentIdea) {
          renderPlayerPanel();
        }
      }

      function renderMultiSelectPanel() {
        if (!playerContent) return;

        const selectedIdeas = allIdeas.filter((idea) =>
          selectedTracks.has(idea.id)
        );

        playerContent.innerHTML = `
    <div class="multi-select-panel">
      <div class="multi-select-header">
        <div class="multi-select-title">Selected Tracks</div>
        <div class="multi-select-count">${
          selectedIdeas.length
        } tracks selected</div>
      </div>
      
      <div class="multi-select-grid">
        ${selectedIdeas
          .map(
            (idea) => `
          <div class="multi-select-item" onclick="window.playIdea('${
            idea.id
          }'); clearSelection();">
            <div class="multi-select-thumb">
              ${
                idea.cover_image_url
                  ? `<img src="${escapeHtml(
                      idea.cover_image_url
                    )}" alt="" style="width: 100%; height: 100%; object-fit: cover;">`
                  : idea.thumbnail_url
                  ? `<img src="${escapeHtml(idea.thumbnail_url)}" alt="">`
                  : generateAlbumArt(idea.title)
              }
              <div class="multi-select-remove" onclick="event.stopPropagation(); removeFromSelection('${
                idea.id
              }')">Ã—</div>
            </div>
            <div class="multi-select-name">${escapeHtml(
              (idea.title || "").split(" - ").length > 1
                ? (idea.title || "").split(" - ").slice(1).join(" - ").trim()
                : idea.title
            )}</div>
          </div>
        `
          )
          .join("")}
      </div>
      
      <div class="multi-select-actions">
        <button class="btn btn-secondary" onclick="clearSelection()">Clear Selection</button>
        <button class="btn btn-primary" onclick="alert('Sharing feature coming soon!')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; margin-right: 6px;">
            <circle cx="18" cy="5" r="3"/>
            <circle cx="6" cy="12" r="3"/>
            <circle cx="18" cy="19" r="3"/>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
          </svg>
          Share
        </button>
      </div>
    </div>
  `;
      }

      // Stage System
      const STAGES = [
        {
          id: "seed",
          name: "Seed",
          desc: "Initial idea",
          icon: "ðŸŒ±",
          progress: 0,
          color: "#94a3b8",
        },
        {
          id: "sprout",
          name: "Sprout",
          desc: "Developing",
          icon: "ðŸŒ¿",
          progress: 20,
          color: "#a3e635",
        },
        {
          id: "sapling",
          name: "Sapling",
          desc: "In progress",
          icon: "ðŸª´",
          progress: 40,
          color: "#22c55e",
        },
        {
          id: "plant",
          name: "Plant",
          desc: "Maturing",
          icon: "ðŸŒ³",
          progress: 60,
          color: "#f59e0b",
        },
        {
          id: "tree",
          name: "Tree",
          desc: "Nearly complete",
          icon: "ðŸŽ„",
          progress: 80,
          color: "#f97316",
        },
        {
          id: "finished",
          name: "Finished",
          desc: "Complete",
          icon: "âœ¨",
          progress: 100,
          color: "#06b6d4",
        },
      ];

      let activeStageDropdown = null;

      // DOM Elements
      const audio = document.getElementById("audio-player");
      const projectList = document.getElementById("project-list");
      const ideasBody = document.getElementById("ideas-body");
      const ideasGrid = document.getElementById("ideas-grid");
      const listView = document.getElementById("list-view");
      const gridView = document.getElementById("grid-view");
      const ideasTitle = document.getElementById("ideas-title");
      const ideasCount = document.getElementById("ideas-count");
      const playerContent = document.getElementById("player-content");
      const searchInput = document.getElementById("search-input");

      // ============ GENERATIVE ALBUM ART ============

      // Hash function for consistent randomness
      function hashString(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = (hash << 5) - hash + char;
          hash = hash & hash;
        }
        return Math.abs(hash);
      }

      // Seeded random number generator
      function seededRandom(seed) {
        const x = Math.sin(seed) * 10000;
        return x - Math.floor(x);
      }

      // Artwork style palettes
      const artworkStyles = {
        vibrant: [
          // Bold primaries
          ["#FF3366", "#33CCFF", "#FFCC00", "#00CC99", "#9933FF", "#FF6600"],
          // Electric
          ["#00D4FF", "#FF0080", "#FFE600", "#00FF88", "#8B5CF6", "#FF4D4D"],
          // Sunset pop
          ["#FF6B35", "#F7C59F", "#2EC4B6", "#E71D36", "#011627", "#FDFFFC"],
          // Nordic bold
          ["#264653", "#2A9D8F", "#E9C46A", "#F4A261", "#E76F51", "#FFFFFF"],
          // Candy
          ["#FF69B4", "#00CED1", "#FFD700", "#FF6347", "#9370DB", "#00FA9A"],
          // Geometric
          ["#1A1A2E", "#16213E", "#0F3460", "#E94560", "#FF9F1C", "#00F5D4"],
          // Bauhaus
          ["#000000", "#FFFFFF", "#FF0000", "#0000FF", "#FFFF00", "#00FF00"],
          // Retro
          ["#F72585", "#7209B7", "#3A0CA3", "#4361EE", "#4CC9F0", "#FFFFFF"],
          // Earth pop
          ["#2D3436", "#00B894", "#FDCB6E", "#E17055", "#6C5CE7", "#00CEC9"],
          // Minimal bold
          ["#000000", "#FFFFFF", "#FF5733", "#33FF57", "#3357FF", "#FF33F5"],
        ],
        vintage: [
          // Terracotta ceramic
          ["#C47D5E", "#D4A574", "#E8C9A0", "#319B8A", "#2C7A6E", "#8B4D3B"],
          // Desert dusk
          ["#B5838D", "#E5989B", "#FFB4A2", "#D9AE94", "#8E7162", "#5C4033"],
          // Earthy moss
          ["#606C38", "#283618", "#FEFAE0", "#DDA15E", "#BC6C25", "#9B7B5B"],
          // Dusty sage
          ["#87A28E", "#6B8E7A", "#D4C5A9", "#C9B896", "#A67C52", "#8B7355"],
          // Muted coral
          ["#E07A5F", "#F2CC8F", "#81B29A", "#3D405B", "#F4F1DE", "#B08968"],
          // Canyon sunset
          ["#D08C60", "#997B66", "#886F68", "#7D6E7D", "#5E5B52", "#C4A77D"],
          // Warm ceramic
          ["#CB997E", "#DDBEA9", "#FFE8D6", "#B7B7A4", "#A5A58D", "#6B705C"],
          // Tuscan earth
          ["#9C6644", "#CC8B65", "#E9C46A", "#2A9D8F", "#264653", "#F4A261"],
          // Mediterranean clay
          ["#C19A6B", "#A67B5B", "#8B7355", "#6B8E7A", "#4A7C6F", "#DDD5B7"],
          // Rustic autumn
          ["#9B7B5B", "#C47D5E", "#E8C9A0", "#7A9B76", "#5E7D5A", "#D4A574"],
        ],
        minimal: [
          // Charcoal whisper
          ["#2C2C2C", "#404040", "#5A5A5A", "#787878", "#9E9E9E", "#F5F5F5"],
          // Warm gray
          ["#3D3D3D", "#5C524D", "#7A6F66", "#A69A8C", "#D4C8BA", "#F2EDE7"],
          // Deep espresso
          ["#1A1614", "#2D2822", "#4A433B", "#6B6055", "#8C8175", "#D4C8BA"],
          // Slate monochrome
          ["#1E293B", "#334155", "#475569", "#64748B", "#94A3B8", "#F1F5F9"],
          // Sepia tone
          ["#3B2F2F", "#5D4E4E", "#816E6E", "#A69393", "#D4BCBC", "#F2E9E9"],
          // Olive shadow
          ["#2D3329", "#454A40", "#5E6458", "#787F72", "#A3A89B", "#E8EBE4"],
          // Ink wash
          ["#0D0D0D", "#1F1F1F", "#363636", "#525252", "#7A7A7A", "#E5E5E5"],
          // Dusty brown
          ["#2E2821", "#4D443A", "#6B5E52", "#8A7B6C", "#B5A393", "#E8DFD5"],
          // Stone gray
          ["#3A3A3A", "#525252", "#6B6B6B", "#858585", "#ADADAD", "#F0F0F0"],
          // Muted taupe
          ["#3B3633", "#57504A", "#746B63", "#92877D", "#B5AAA0", "#E5DDD5"],
        ],
      };

      // Get current artwork style from localStorage
      function getArtworkStyle() {
        return localStorage.getItem("ideas-artwork-style") || "vintage";
      }

      // Set artwork style
      function setArtworkStyle(style) {
        localStorage.setItem("ideas-artwork-style", style);
        // Re-render to show new colors
        renderIdeasTable();
        renderRightPanel();
      }

      // Bold, vibrant color palettes
      function generatePalette(seed) {
        const style = getArtworkStyle();
        const palettes = artworkStyles[style] || artworkStyles.vintage;

        return palettes[seed % palettes.length];
      }

      // Generate SVG album art - Bold geometric style
      function generateAlbumArt(title, tags = "", project = "") {
        const seed = hashString(title + tags + project);
        const palette = generatePalette(seed);

        // Choose pattern based on seed
        const patternType = seed % 8;

        let svgContent = "";
        const bgColor = palette[seed % 2 === 0 ? 0 : palette.length - 1];

        switch (patternType) {
          case 0:
            svgContent = generateDiamondComposition(seed, palette);
            break;
          case 1:
            svgContent = generateCircleSquare(seed, palette);
            break;
          case 2:
            svgContent = generateTriangleGrid(seed, palette);
            break;
          case 3:
            svgContent = generateBoldStripes(seed, palette);
            break;
          case 4:
            svgContent = generateConcentricShapes(seed, palette);
            break;
          case 5:
            svgContent = generateCornerShapes(seed, palette);
            break;
          case 6:
            svgContent = generateCrossComposition(seed, palette);
            break;
          case 7:
            svgContent = generateMinimalCircles(seed, palette);
            break;
        }

        return `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
    <rect width="200" height="200" fill="${bgColor}"/>
    ${svgContent}
  </svg>`;
      }

      // Diamond with circles composition (like the reference)
      function generateDiamondComposition(seed, palette) {
        const bg1 = palette[1];
        const bg2 = palette[2];
        const diamond1 = palette[3];
        const diamond2 = palette[4];
        const circle1 = palette[2];
        const circle2 = palette[5] || palette[0];

        return `
    <!-- Corner triangles -->
    <polygon points="0,0 200,0 200,80" fill="${bg1}"/>
    <polygon points="0,200 0,120 80,200" fill="${bg2}"/>
    
    <!-- Central diamond -->
    <rect x="50" y="50" width="100" height="100" fill="${diamond1}" transform="rotate(45, 100, 100)"/>
    <rect x="70" y="70" width="60" height="60" fill="${diamond2}" transform="rotate(45, 100, 100)"/>
    <rect x="85" y="85" width="30" height="30" fill="#FFFFFF" transform="rotate(45, 100, 100)"/>
    <circle cx="100" cy="100" r="6" fill="#000000"/>
    
    <!-- Horizontal bar -->
    <rect x="0" y="85" width="200" height="30" fill="${palette[4]}" opacity="0.85"/>
    
    <!-- Corner circles -->
    <circle cx="35" cy="65" r="30" fill="${circle1}"/>
    <circle cx="165" cy="145" r="28" fill="${circle2}"/>
  `;
      }

      // Circle inside square
      function generateCircleSquare(seed, palette) {
        const size = 80 + (seed % 40);
        const offset = (200 - size) / 2;

        return `
    <rect x="${offset}" y="${offset}" width="${size}" height="${size}" fill="${
          palette[1]
        }"/>
    <circle cx="100" cy="100" r="${size / 2 - 10}" fill="${palette[2]}"/>
    <circle cx="100" cy="100" r="${size / 4}" fill="${palette[3]}"/>
    <polygon points="40,180 100,140 160,180" fill="${palette[4]}"/>
    <rect x="0" y="0" width="60" height="60" fill="${
      palette[5] || palette[0]
    }"/>
  `;
      }

      // Bold triangle grid
      function generateTriangleGrid(seed, palette) {
        return `
    <polygon points="0,0 100,0 0,100" fill="${palette[1]}"/>
    <polygon points="200,0 200,100 100,0" fill="${palette[2]}"/>
    <polygon points="0,200 0,100 100,200" fill="${palette[3]}"/>
    <polygon points="200,200 100,200 200,100" fill="${palette[4]}"/>
    <circle cx="100" cy="100" r="40" fill="${palette[5] || "#FFFFFF"}"/>
    <circle cx="100" cy="100" r="20" fill="${palette[0]}"/>
  `;
      }

      // Bold horizontal/vertical stripes with shape
      function generateBoldStripes(seed, palette) {
        const isHorizontal = seed % 2 === 0;
        let stripes = "";

        if (isHorizontal) {
          stripes = `
      <rect x="0" y="0" width="200" height="50" fill="${palette[1]}"/>
      <rect x="0" y="50" width="200" height="50" fill="${palette[2]}"/>
      <rect x="0" y="100" width="200" height="50" fill="${palette[3]}"/>
      <rect x="0" y="150" width="200" height="50" fill="${palette[4]}"/>
    `;
        } else {
          stripes = `
      <rect x="0" y="0" width="50" height="200" fill="${palette[1]}"/>
      <rect x="50" y="0" width="50" height="200" fill="${palette[2]}"/>
      <rect x="100" y="0" width="50" height="200" fill="${palette[3]}"/>
      <rect x="150" y="0" width="50" height="200" fill="${palette[4]}"/>
    `;
        }

        // Add focal shape
        const shapeType = (seed >> 4) % 3;
        if (shapeType === 0) {
          stripes += `<circle cx="100" cy="100" r="50" fill="${
            palette[5] || "#FFFFFF"
          }"/>`;
        } else if (shapeType === 1) {
          stripes += `<rect x="60" y="60" width="80" height="80" fill="${
            palette[5] || "#FFFFFF"
          }"/>`;
        } else {
          stripes += `<polygon points="100,40 150,140 50,140" fill="${
            palette[5] || "#FFFFFF"
          }"/>`;
        }

        return stripes;
      }

      // Concentric shapes
      function generateConcentricShapes(seed, palette) {
        const isCircle = seed % 2 === 0;

        if (isCircle) {
          return `
      <circle cx="100" cy="100" r="95" fill="${palette[1]}"/>
      <circle cx="100" cy="100" r="75" fill="${palette[2]}"/>
      <circle cx="100" cy="100" r="55" fill="${palette[3]}"/>
      <circle cx="100" cy="100" r="35" fill="${palette[4]}"/>
      <circle cx="100" cy="100" r="15" fill="${palette[5] || "#FFFFFF"}"/>
    `;
        } else {
          return `
      <rect x="5" y="5" width="190" height="190" fill="${palette[1]}"/>
      <rect x="25" y="25" width="150" height="150" fill="${palette[2]}"/>
      <rect x="45" y="45" width="110" height="110" fill="${palette[3]}"/>
      <rect x="65" y="65" width="70" height="70" fill="${palette[4]}"/>
      <rect x="85" y="85" width="30" height="30" fill="${
        palette[5] || "#FFFFFF"
      }"/>
    `;
        }
      }

      // Shapes in corners with center element
      function generateCornerShapes(seed, palette) {
        return `
    <!-- Corners -->
    <circle cx="0" cy="0" r="60" fill="${palette[1]}"/>
    <circle cx="200" cy="0" r="50" fill="${palette[2]}"/>
    <circle cx="0" cy="200" r="45" fill="${palette[3]}"/>
    <circle cx="200" cy="200" r="55" fill="${palette[4]}"/>
    
    <!-- Center -->
    <rect x="70" y="70" width="60" height="60" fill="${
      palette[5] || "#FFFFFF"
    }" transform="rotate(45, 100, 100)"/>
    <circle cx="100" cy="100" r="15" fill="${palette[0]}"/>
  `;
      }

      // Cross/plus composition
      function generateCrossComposition(seed, palette) {
        return `
    <rect x="75" y="0" width="50" height="200" fill="${palette[1]}"/>
    <rect x="0" y="75" width="200" height="50" fill="${palette[2]}"/>
    <circle cx="100" cy="100" r="35" fill="${palette[3]}"/>
    
    <!-- Corner accents -->
    <rect x="0" y="0" width="40" height="40" fill="${palette[4]}"/>
    <rect x="160" y="160" width="40" height="40" fill="${
      palette[5] || palette[4]
    }"/>
    <polygon points="160,0 200,0 200,40" fill="${palette[3]}"/>
    <polygon points="0,160 0,200 40,200" fill="${palette[3]}"/>
  `;
      }

      // Minimal circles composition
      function generateMinimalCircles(seed, palette) {
        const c1x = 30 + (seed % 40);
        const c1y = 30 + ((seed >> 2) % 40);
        const c2x = 130 + (seed % 50);
        const c2y = 120 + ((seed >> 3) % 60);

        return `
    <circle cx="${c1x}" cy="${c1y}" r="45" fill="${palette[1]}"/>
    <circle cx="${c2x}" cy="${c2y}" r="55" fill="${palette[2]}"/>
    <circle cx="100" cy="170" r="35" fill="${palette[3]}"/>
    
    <!-- Small accents -->
    <circle cx="170" cy="30" r="12" fill="${palette[4]}"/>
    <circle cx="30" cy="150" r="8" fill="${palette[5] || palette[4]}"/>
    
    <!-- Line accent -->
    <line x1="20" y1="100" x2="180" y2="100" stroke="${
      palette[4]
    }" stroke-width="3"/>
  `;
      }

      // Get search term for Unsplash based on idea metadata
      function getUnsplashSearchTerm(idea) {
        const tags = idea.tags?.toLowerCase() || "";
        const project = idea.project_name?.toLowerCase() || "";

        // Map tags/projects to visual search terms
        const mappings = {
          orchestral: "orchestra concert hall",
          electronic: "neon lights abstract",
          ambient: "misty forest nature",
          piano: "piano keys music",
          psychedelic: "colorful abstract art",
          cinematic: "dramatic landscape",
          rock: "electric guitar concert",
          acoustic: "acoustic guitar wood",
          experimental: "abstract art modern",
          folk: "nordic landscape mountains",
          aurora: "northern lights aurora",
          equinox: "sunset horizon golden",
          forest: "forest trees nature",
          ocean: "ocean waves water",
          mountain: "mountain peaks snow",
        };

        for (const [key, term] of Object.entries(mappings)) {
          if (tags.includes(key) || project.includes(key)) {
            return term;
          }
        }

        // Default to abstract/nature
        return "abstract colorful gradient";
      }

      // Fetch Unsplash image
      async function getUnsplashImage(idea) {
        const cacheKey = idea.id;
        if (unsplashCache[cacheKey]) {
          return unsplashCache[cacheKey];
        }

        const searchTerm = getUnsplashSearchTerm(idea);
        // Using Unsplash Source (no API key needed, but random images)
        // For consistent images, we use a seed based on the idea ID
        const seed = hashString(idea.id);
        const url = `https://source.unsplash.com/400x400/?${encodeURIComponent(
          searchTerm
        )}&sig=${seed}`;

        unsplashCache[cacheKey] = url;
        return url;
      }

      // Toggle between SVG and Unsplash
      function toggleAlbumArtMode() {
        useUnsplash = !useUnsplash;
        renderPlayerPanel();
      }

      // Generate small thumbnail for list
      function generateThumbnail(title, tags = "", project = "") {
        return generateAlbumArt(title, tags, project);
      }

      // Generate subdued project thumbnail (circular with gradients)
      function generateProjectThumbnail(project) {
        // Use the same color as the sidebar project icon
        const color = getProjectColor(project);

        // For Unassigned, show outline only
        if (!project || project === "Unassigned") {
          return `<div style="width: 100%; height: 100%; background: transparent; border: 1.5px dashed var(--text-muted); border-radius: 4px; opacity: 0.5;"></div>`;
        }

        return `<div style="width: 100%; height: 100%; background: ${color}; border-radius: 4px;"></div>`;
      }

      // Column configuration
      const DEFAULT_COLUMNS = [
        {
          id: "title",
          name: "Title",
          width: "30%",
          align: "left",
          sortable: true,
          sortKey: "title",
        },
        {
          id: "stage",
          name: "Stage",
          width: "60px",
          align: "center",
          sortable: true,
          sortKey: "stage",
        },
        {
          id: "project",
          name: "Project",
          width: "auto",
          align: "left",
          sortable: true,
          sortKey: "project_name",
        },
        {
          id: "due_date",
          name: "Due",
          width: "80px",
          align: "center",
          sortable: true,
          sortKey: "due_date",
        },
        {
          id: "tags",
          name: "Tags",
          width: "auto",
          align: "left",
          sortable: false,
        },
        {
          id: "priority",
          name: "Priority",
          width: "80px",
          align: "left",
          sortable: true,
          sortKey: "priority",
        },
        {
          id: "favorite",
          name: "Favorite",
          width: "50px",
          align: "center",
          sortable: true,
          sortKey: "is_favorite",
        },
      ];

      // Sorting state
      let currentSortColumn = null;
      let currentSortDirection = "asc"; // 'asc' or 'desc'

      function getColumnSettings() {
        const saved = localStorage.getItem("ideas-column-settings");
        if (saved) {
          return JSON.parse(saved);
        }
        return {
          order: DEFAULT_COLUMNS.map((c) => c.id),
          hidden: {},
        };
      }

      function saveColumnSettings(settings) {
        localStorage.setItem("ideas-column-settings", JSON.stringify(settings));
      }

      function getVisibleColumns() {
        const settings = getColumnSettings();
        return settings.order
          .filter((id) => !settings.hidden[id])
          .map((id) => DEFAULT_COLUMNS.find((c) => c.id === id))
          .filter(Boolean);
      }

      function renderTableHeader() {
        const columns = getVisibleColumns();
        const headerRow = document.getElementById("ideas-header-row");

        headerRow.innerHTML = columns
          .map((col) => {
            const style = [];
            if (col.width) style.push(`width: ${col.width}`);
            if (col.align === "center") style.push("text-align: center");

            const isSorted = currentSortColumn === col.sortKey;
            const sortIcon = isSorted
              ? currentSortDirection === "asc"
                ? " â†‘"
                : " â†“"
              : "";

            const sortableClass = col.sortable ? "sortable" : "";
            const sortedClass = isSorted ? "sorted" : "";
            const onclick = col.sortable
              ? `onclick="sortByColumn('${col.sortKey}')"`
              : "";

            return `<th class="${sortableClass} ${sortedClass}" style="${style.join(
              "; "
            )}" ${onclick}>${col.name}${sortIcon}</th>`;
          })
          .join("");
      }

      // Sort by column
      function sortByColumn(sortKey) {
        if (currentSortColumn === sortKey) {
          // Toggle direction
          currentSortDirection =
            currentSortDirection === "asc" ? "desc" : "asc";
        } else {
          currentSortColumn = sortKey;
          currentSortDirection = "asc";
        }

        renderTableHeader();
        sortAndRenderIdeas();
      }

      // Sort and render
      function sortAndRenderIdeas() {
        if (!currentSortColumn) {
          renderIdeasTable();
          return;
        }

        // Define sort order for stages
        const stageOrder = {
          seed: 0,
          demo: 1,
          arranged: 2,
          mixed: 3,
          mastered: 4,
          released: 5,
        };

        // Define sort order for priority
        const priorityOrder = {
          high: 0,
          medium: 1,
          low: 2,
          "": 3,
          null: 3,
          undefined: 3,
        };

        filteredIdeas.sort((a, b) => {
          let valA, valB;

          switch (currentSortColumn) {
            case "title":
              valA = (a.title || "").toLowerCase();
              valB = (b.title || "").toLowerCase();
              break;
            case "stage":
              valA = stageOrder[a.stage] ?? 99;
              valB = stageOrder[b.stage] ?? 99;
              break;
            case "project_name":
              valA = (a.project_name || "zzz").toLowerCase();
              valB = (b.project_name || "zzz").toLowerCase();
              break;
            case "due_date":
              valA = a.due_date ? new Date(a.due_date).getTime() : Infinity;
              valB = b.due_date ? new Date(b.due_date).getTime() : Infinity;
              break;
            case "priority":
              valA = priorityOrder[a.priority?.toLowerCase()] ?? 3;
              valB = priorityOrder[b.priority?.toLowerCase()] ?? 3;
              break;
            case "is_favorite":
              valA = a.is_favorite ? 0 : 1;
              valB = b.is_favorite ? 0 : 1;
              break;
            default:
              valA = a[currentSortColumn] || "";
              valB = b[currentSortColumn] || "";
          }

          let comparison = 0;
          if (valA < valB) comparison = -1;
          if (valA > valB) comparison = 1;

          return currentSortDirection === "asc" ? comparison : -comparison;
        });

        renderIdeasTable();
      }

      function openColumnSettings(event) {
        event.preventDefault();
        const modal = document.getElementById("column-settings-modal");
        modal.classList.add("open");
        renderColumnSettingsList();
      }

      function closeColumnSettings() {
        document
          .getElementById("column-settings-modal")
          .classList.remove("open");
        renderTableHeader();
        renderIdeasTable();
      }

      let columnDraggedId = null;

      function renderColumnSettingsList() {
        const settings = getColumnSettings();
        const container = document.getElementById("settings-column-list");

        let html = "";
        settings.order.forEach((colId) => {
          const col = DEFAULT_COLUMNS.find((c) => c.id === colId);
          if (!col) return;

          const isHidden = settings.hidden[colId];

          html += `
      <div class="settings-column-item" 
           data-column="${col.id}"
           draggable="true"
           ondragstart="handleColumnDragStart(event, '${col.id}')"
           ondragend="handleColumnDragEnd(event)"
           ondragover="handleColumnDragOver(event)"
           ondragleave="handleColumnDragLeave(event)"
           ondrop="handleColumnDrop(event, '${col.id}')">
        <span class="settings-column-drag">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <circle cx="9" cy="6" r="2"/>
            <circle cx="15" cy="6" r="2"/>
            <circle cx="9" cy="12" r="2"/>
            <circle cx="15" cy="12" r="2"/>
            <circle cx="9" cy="18" r="2"/>
            <circle cx="15" cy="18" r="2"/>
          </svg>
        </span>
        <span class="settings-column-name">${col.name}</span>
        <button class="settings-column-visibility ${isHidden ? "hidden" : ""}" 
                onclick="toggleColumnVisibility('${col.id}')"
                title="${isHidden ? "Show column" : "Hide column"}">
          ${
            isHidden
              ? `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
              <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
          `
              : `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          `
          }
        </button>
      </div>
    `;
        });

        container.innerHTML = html;
      }

      function toggleColumnVisibility(columnId) {
        const settings = getColumnSettings();
        settings.hidden[columnId] = !settings.hidden[columnId];
        saveColumnSettings(settings);
        renderColumnSettingsList();
      }

      function handleColumnDragStart(event, columnId) {
        columnDraggedId = columnId;
        event.currentTarget.classList.add("dragging");
        event.dataTransfer.effectAllowed = "move";
      }

      function handleColumnDragEnd(event) {
        event.currentTarget.classList.remove("dragging");
        columnDraggedId = null;
        document
          .querySelectorAll(".settings-column-item.drag-over")
          .forEach((el) => {
            el.classList.remove("drag-over");
          });
      }

      function handleColumnDragOver(event) {
        event.preventDefault();
        if (
          columnDraggedId &&
          event.currentTarget.dataset.column !== columnDraggedId
        ) {
          event.currentTarget.classList.add("drag-over");
        }
      }

      function handleColumnDragLeave(event) {
        event.currentTarget.classList.remove("drag-over");
      }

      function handleColumnDrop(event, targetColumnId) {
        event.preventDefault();
        event.currentTarget.classList.remove("drag-over");

        if (!columnDraggedId || columnDraggedId === targetColumnId) return;

        const settings = getColumnSettings();
        const fromIndex = settings.order.indexOf(columnDraggedId);
        const toIndex = settings.order.indexOf(targetColumnId);

        // Remove from old position
        settings.order.splice(fromIndex, 1);
        // Insert at new position
        settings.order.splice(toIndex, 0, columnDraggedId);

        saveColumnSettings(settings);
        renderColumnSettingsList();
      }

      // Initialize
      async function init() {
        loadViewMode();
        loadArtworkStyle();
        loadSidebarState();
        loadPlayerState();
        loadSavedViews();
        setupUploadZone();
        renderTableHeader();
        await loadIdeas();
        await loadSavedCollaborators(); // Load collaborators for auto-detection
        await loadVoiceMemos(); // Load voice memo inbox
        setupEventListeners();
      }

      // Load all ideas from Supabase
      async function loadIdeas() {
        try {
          const { data, error } = await supabase
            .from("idea_tracks")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          allIdeas = data || [];
          filteredIdeas = [...allIdeas];

          // Build arrays for inbox dropdowns
          buildProjectsArray();
          buildTracksArray();

          renderProjectList();
          renderIdeasTable();

          // Check for unrated ideas and show Discover button
          checkUnratedIdeas();
        } catch (err) {
          console.error("Error loading ideas:", err);
          ideasBody.innerHTML = `<tr><td colspan="5" style="color: var(--danger); padding: 20px;">Error loading ideas: ${err.message}</td></tr>`;
        }
      }

      // Check for unrated ideas and show/hide Discover button
      function checkUnratedIdeas() {
        const unratedCount = allIdeas.filter(
          (idea) =>
            !idea.is_archived && (!idea.excitement || idea.excitement === 0)
        ).length;

        const discoverBtn = document.getElementById("discover-btn");
        if (discoverBtn) {
          if (unratedCount > 0) {
            discoverBtn.style.display = "flex";
            // Add badge with count
            const existingBadge = discoverBtn.querySelector(".badge");
            if (existingBadge) existingBadge.remove();
            const badge = document.createElement("span");
            badge.className = "badge";
            badge.textContent = unratedCount;
            discoverBtn.appendChild(badge);
          } else {
            discoverBtn.style.display = "none";
          }
        }
      }

      // Get unique projects with counts (handles comma-separated multi-project entries)
      function getProjects() {
        const counts = {};

        allIdeas.forEach((idea) => {
          // Skip archived items for regular project counts
          if (idea.is_archived) return;

          const projectStr = idea.project_name || "Unassigned";
          // Split by comma to handle multi-project entries
          const projects = projectStr
            .split(",")
            .map((p) => p.trim())
            .filter((p) => p);

          projects.forEach((proj) => {
            counts[proj] = (counts[proj] || 0) + 1;
          });
        });

        // Include custom projects that may have no ideas yet
        const settings = getProjectSettings();
        if (settings.customProjects) {
          settings.customProjects.forEach((proj) => {
            if (!counts[proj]) {
              counts[proj] = 0;
            }
          });
        }

        return Object.entries(counts)
          .sort((a, b) => b[1] - a[1])
          .map(([name, count]) => ({ name, count }));
      }

      // Get archived count
      function getArchivedCount() {
        return allIdeas.filter((idea) => idea.is_archived).length;
      }

      // Get non-archived count
      function getActiveCount() {
        return allIdeas.filter((idea) => !idea.is_archived).length;
      }

      // Render project sidebar
      // Project color palette for icons
      const PROJECT_COLORS = [
        "#3B82F6", // blue
        "#8B5CF6", // violet
        "#EC4899", // pink
        "#F97316", // orange
        "#14B8A6", // teal
        "#EAB308", // yellow
        "#22C55E", // green
        "#F43F5E", // rose
        "#6366F1", // indigo
        "#06B6D4", // cyan
      ];

      function getProjectColor(projectName) {
        // Check for custom color first
        const settings = getProjectSettings();
        if (settings.colors && settings.colors[projectName]) {
          return settings.colors[projectName];
        }

        // Fall back to hash-based color
        const hash = hashString(projectName || "default");
        return PROJECT_COLORS[hash % PROJECT_COLORS.length];
      }

      function renderProjectList() {
        const projects = getProjects();
        const archivedCount = getArchivedCount();
        const hierarchy = getProjectHierarchy();
        const projectSettings = getProjectSettings();

        let html = `
    <div class="project-item ${!currentProject ? "active" : ""}" 
         onclick="selectProject(null)"
         ondragover="handleProjectDragOver(event)"
         ondragleave="handleProjectDragLeave(event)"
         ondrop="handleProjectDrop(event, null)">
      <span class="project-spacer"></span>
      <div class="project-icon" style="background: linear-gradient(135deg, var(--primary), var(--secondary));">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
        </svg>
      </div>
      <span class="project-name">All Ideas</span>
      <span class="project-count">${getActiveCount()}</span>
      <span class="project-shortcut">1</span>
    </div>
  `;

        // Render hierarchical projects (respecting custom order and visibility)
        html += renderProjectTree(
          hierarchy.roots,
          hierarchy.children,
          0,
          projectSettings,
          true
        );

        // Add Archive at the bottom with a divider
        if (archivedCount > 0) {
          html += `
      <div class="project-divider"></div>
      <div class="project-item ${currentProject === "Archive" ? "active" : ""}" 
           onclick="selectProject('Archive')" 
           title="Archive"
           ondragover="handleProjectDragOver(event)"
           ondragleave="handleProjectDragLeave(event)"
           ondrop="handleProjectDrop(event, 'Archive')">
        <span class="project-spacer"></span>
        <div class="project-icon" style="background: var(--text-muted);">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M21 8v13H3V8"/>
            <path d="M1 3h22v5H1z"/>
            <path d="M10 12h4"/>
          </svg>
        </div>
        <span class="project-name">Archive</span>
        <span class="project-count">${archivedCount}</span>
      </div>
    `;
        }

        projectList.innerHTML = html;
      }

      // Get project hierarchy (parent/child relationships)
      // Projects with "/" denote hierarchy, e.g. "Albums/Rock" means Rock is child of Albums
      function getProjectHierarchy() {
        const projects = getProjects();
        const roots = [];
        const children = {};
        const expandedState = JSON.parse(
          localStorage.getItem("ideas-project-expanded") || "{}"
        );
        const settings = getProjectSettings();
        const parentMap = settings.parents || {};

        projects.forEach((proj) => {
          // Check if this project has a parent set in settings
          const settingsParent = parentMap[proj.name];

          // Also check for "/" convention
          const parts = proj.name.split("/").map((p) => p.trim());
          const slashParent = parts.length > 1 ? parts[0] : null;

          // Settings parent takes precedence, then slash convention
          const parent = settingsParent || slashParent;

          if (parent && projects.some((p) => p.name === parent)) {
            // This is a child project
            if (!children[parent]) {
              children[parent] = [];
            }
            children[parent].push({
              ...proj,
              displayName: settingsParent
                ? proj.name
                : parts.slice(1).join("/"),
              expanded: expandedState[proj.name] !== false,
            });
          } else {
            // Root level project
            roots.push({
              ...proj,
              expanded: expandedState[proj.name] !== false,
            });
          }
        });

        // Sort roots and children by count (order will be applied in renderProjectTree)
        roots.sort((a, b) => b.count - a.count);
        Object.keys(children).forEach((parent) => {
          children[parent].sort((a, b) => b.count - a.count);
        });

        return { roots, children };
      }

      // Render project tree recursively
      // Track shortcut index globally for rendering
      let shortcutIndex = 2; // Start at 2 (1 is All Ideas)

      function renderProjectTree(
        projects,
        childrenMap,
        depth,
        settings = {},
        isRoot = false
      ) {
        let html = "";

        // Reset shortcut index at root level
        if (isRoot) {
          shortcutIndex = 2;
        }

        // Sort by custom order if available
        const sortedProjects = [...projects].sort((a, b) => {
          const orderA = settings.order?.[a.name] ?? 999;
          const orderB = settings.order?.[b.name] ?? 999;
          if (orderA !== orderB) return orderA - orderB;
          return b.count - a.count; // Fall back to count
        });

        sortedProjects.forEach((proj) => {
          // Check visibility
          if (settings.hidden?.[proj.name]) return;

          const color = getProjectColor(proj.name);
          const hasChildren =
            childrenMap[proj.name] && childrenMap[proj.name].length > 0;
          const isExpanded = proj.expanded !== false;
          const displayName = proj.displayName || proj.name;
          const indent = depth * 16;
          const currentShortcut = shortcutIndex <= 9 ? shortcutIndex : null;
          shortcutIndex++;

          html += `
      <div class="project-item-wrapper">
        <div class="project-item ${
          currentProject === proj.name ? "active" : ""
        }" 
             style="padding-left: ${8 + indent}px;"
             onclick="selectProject('${escapeHtml(proj.name)}')" 
             title="${escapeHtml(proj.name)}${
            currentShortcut ? " (Press " + currentShortcut + ")" : ""
          }"
             data-project="${escapeHtml(proj.name)}"
             ondragover="handleProjectDragOver(event)"
             ondragleave="handleProjectDragLeave(event)"
             ondrop="handleProjectDrop(event, '${escapeHtml(proj.name)}')">
          ${
            hasChildren
              ? `
            <button class="project-expand-btn ${isExpanded ? "expanded" : ""}" 
                    onclick="event.stopPropagation(); toggleProjectExpand('${escapeHtml(
                      proj.name
                    )}')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
            </button>
          `
              : '<span class="project-spacer"></span>'
          }
          <div class="project-icon ${
            proj.name === "Unassigned" ? "unassigned" : ""
          }" style="${
            proj.name === "Unassigned"
              ? "background: transparent; border: 1.5px dashed var(--text-muted); opacity: 0.5;"
              : `background: ${color};`
          }"></div>
          <span class="project-name">${escapeHtml(displayName)}</span>
          <span class="project-count">${proj.count}</span>
          ${
            currentShortcut
              ? `<span class="project-shortcut">${currentShortcut}</span>`
              : ""
          }
        </div>
        ${
          hasChildren
            ? `
          <div class="project-children ${isExpanded ? "" : "collapsed"}">
            ${renderProjectTree(
              childrenMap[proj.name],
              childrenMap,
              depth + 1,
              settings,
              false
            )}
          </div>
        `
            : ""
        }
      </div>
    `;
        });

        return html;
      }

      // Toggle project expand/collapse
      function toggleProjectExpand(projectName) {
        const state = JSON.parse(
          localStorage.getItem("ideas-project-expanded") || "{}"
        );
        state[projectName] = state[projectName] === false ? true : false;
        localStorage.setItem("ideas-project-expanded", JSON.stringify(state));
        renderProjectList();
      }

      // Project Settings Management
      function getProjectSettings() {
        return JSON.parse(
          localStorage.getItem("ideas-project-settings") || "{}"
        );
      }

      function saveProjectSettings(settings) {
        localStorage.setItem(
          "ideas-project-settings",
          JSON.stringify(settings)
        );
      }

      function openProjectSettings() {
        const modal = document.getElementById("project-settings-modal");
        modal.classList.add("open");
        renderSettingsProjectList();
      }

      function closeProjectSettings() {
        document
          .getElementById("project-settings-modal")
          .classList.remove("open");
        renderProjectList(); // Refresh sidebar with new settings
      }

      let settingsDraggedProject = null;

      function renderSettingsProjectList() {
        const projects = getProjects();
        const settings = getProjectSettings();
        const container = document.getElementById("settings-project-list");

        // Build hierarchy from settings
        const parentMap = settings.parents || {};
        const hiddenMap = settings.hidden || {};
        const orderMap = settings.order || {};

        // Separate into roots and children
        const roots = [];
        const childrenByParent = {};

        projects.forEach((proj) => {
          const parent = parentMap[proj.name];
          if (parent && projects.some((p) => p.name === parent)) {
            if (!childrenByParent[parent]) childrenByParent[parent] = [];
            childrenByParent[parent].push(proj);
          } else {
            roots.push(proj);
          }
        });

        // Sort by custom order
        roots.sort((a, b) => {
          const orderA = orderMap[a.name] ?? 999;
          const orderB = orderMap[b.name] ?? 999;
          if (orderA !== orderB) return orderA - orderB;
          return b.count - a.count;
        });

        Object.keys(childrenByParent).forEach((parent) => {
          childrenByParent[parent].sort((a, b) => {
            const orderA = orderMap[a.name] ?? 999;
            const orderB = orderMap[b.name] ?? 999;
            if (orderA !== orderB) return orderA - orderB;
            return b.count - a.count;
          });
        });

        let html = "";

        function renderItem(proj, isChild = false, parentName = null) {
          const color = getProjectColor(proj.name);
          const isHidden = hiddenMap[proj.name];
          const children = childrenByParent[proj.name] || [];

          html += `
      <div class="settings-project-item ${isChild ? "child" : ""}" 
           data-project="${escapeHtml(proj.name)}"
           draggable="true"
           ondragstart="handleSettingsItemDragStart(event, '${escapeHtml(
             proj.name
           )}')"
           ondragend="handleSettingsItemDragEnd(event)"
           ondragover="handleSettingsItemDragOver(event)"
           ondragleave="handleSettingsItemDragLeave(event)"
           ondrop="handleSettingsItemDrop(event, '${escapeHtml(proj.name)}')">
        <span class="settings-project-drag">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <circle cx="9" cy="6" r="2"/>
            <circle cx="15" cy="6" r="2"/>
            <circle cx="9" cy="12" r="2"/>
            <circle cx="15" cy="12" r="2"/>
            <circle cx="9" cy="18" r="2"/>
            <circle cx="15" cy="18" r="2"/>
          </svg>
        </span>
        <div class="settings-project-icon" style="background: ${color};"></div>
        <span class="settings-project-name" onclick="event.stopPropagation(); startProjectRename('${escapeHtml(
          proj.name
        )}', this)">${escapeHtml(proj.name)}</span>
        ${
          parentName
            ? `<span class="settings-project-parent">â†³ ${escapeHtml(
                parentName
              )}</span>`
            : ""
        }
        <button class="settings-project-visibility ${isHidden ? "hidden" : ""}" 
                onclick="toggleProjectVisibility('${escapeHtml(proj.name)}')"
                title="${isHidden ? "Show in sidebar" : "Hide from sidebar"}">
          ${
            isHidden
              ? `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
              <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
          `
              : `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          `
          }
        </button>
      </div>
    `;

          // Render children
          children.forEach((child) => renderItem(child, true, proj.name));
        }

        roots.forEach((proj) => renderItem(proj, false, null));

        container.innerHTML = html;
      }

      function toggleProjectVisibility(projectName) {
        const settings = getProjectSettings();
        if (!settings.hidden) settings.hidden = {};
        settings.hidden[projectName] = !settings.hidden[projectName];
        saveProjectSettings(settings);
        renderSettingsProjectList();
      }

      // ============ PROJECT RENAME ============

      function startProjectRename(projectName, element) {
        const currentName = projectName;
        const input = document.createElement("input");
        input.type = "text";
        input.className = "settings-project-name-input";
        input.value = currentName;

        element.replaceWith(input);
        input.focus();
        input.select();

        const finishRename = async () => {
          const newName = input.value.trim();
          if (newName && newName !== currentName) {
            await renameProject(currentName, newName);
          }
          renderSettingsProjectList();
        };

        input.addEventListener("blur", finishRename);
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            input.blur();
          } else if (e.key === "Escape") {
            input.value = currentName;
            input.blur();
          }
        });
      }

      async function renameProject(oldName, newName) {
        try {
          // Update all ideas with this project
          const ideasToUpdate = allIdeas.filter((idea) => {
            const projects = (idea.project_name || "")
              .split(",")
              .map((p) => p.trim());
            return projects.includes(oldName);
          });

          for (const idea of ideasToUpdate) {
            const projects = idea.project_name.split(",").map((p) => p.trim());
            const newProjects = projects.map((p) =>
              p === oldName ? newName : p
            );
            const newProjectName = newProjects.join(", ");

            await supabase
              .from("idea_tracks")
              .update({ project_name: newProjectName })
              .eq("id", idea.id);

            idea.project_name = newProjectName;
          }

          // Update settings
          const settings = getProjectSettings();

          // Update colors
          if (settings.colors && settings.colors[oldName]) {
            settings.colors[newName] = settings.colors[oldName];
            delete settings.colors[oldName];
          }

          // Update parents
          if (settings.parents) {
            Object.keys(settings.parents).forEach((key) => {
              if (settings.parents[key] === oldName) {
                settings.parents[key] = newName;
              }
              if (key === oldName) {
                settings.parents[newName] = settings.parents[oldName];
                delete settings.parents[oldName];
              }
            });
          }

          // Update order
          if (settings.order && settings.order[oldName] !== undefined) {
            settings.order[newName] = settings.order[oldName];
            delete settings.order[oldName];
          }

          // Update hidden
          if (settings.hidden && settings.hidden[oldName] !== undefined) {
            settings.hidden[newName] = settings.hidden[oldName];
            delete settings.hidden[oldName];
          }

          saveProjectSettings(settings);

          // Update current project if needed
          if (currentProject === oldName) {
            currentProject = newName;
          }

          renderProjectList();
          renderIdeasTable();
        } catch (err) {
          console.error("Error renaming project:", err);
        }
      }

      // ============ ADD NEW PROJECT ============

      let selectedNewProjectColor = "#64748B";

      function selectProjectColor(element) {
        document
          .querySelectorAll(".color-option")
          .forEach((el) => el.classList.remove("selected"));
        element.classList.add("selected");
        selectedNewProjectColor = element.dataset.color;
      }

      async function addNewProject() {
        const input = document.getElementById("new-project-name");
        const name = input.value.trim();

        if (!name) {
          input.focus();
          return;
        }

        // Check if project already exists
        const existingProjects = getProjects();
        if (
          existingProjects.some(
            (p) => p.name.toLowerCase() === name.toLowerCase()
          )
        ) {
          alert("A project with this name already exists");
          return;
        }

        // Save the color in settings
        const settings = getProjectSettings();
        if (!settings.colors) settings.colors = {};
        settings.colors[name] = selectedNewProjectColor;
        saveProjectSettings(settings);

        // Create a placeholder idea with this project to make it appear
        // Actually, we don't need to create an idea - the project will appear when used
        // But we need to store custom projects that have no ideas yet
        if (!settings.customProjects) settings.customProjects = [];
        if (!settings.customProjects.includes(name)) {
          settings.customProjects.push(name);
        }
        saveProjectSettings(settings);

        // Clear input
        input.value = "";

        // Reset color selection
        document
          .querySelectorAll(".color-option")
          .forEach((el) => el.classList.remove("selected"));
        document
          .querySelector('.color-option[data-color="#64748B"]')
          .classList.add("selected");
        selectedNewProjectColor = "#64748B";

        // Refresh the lists
        renderSettingsProjectList();
        renderProjectList();
      }

      function handleSettingsItemDragStart(event, projectName) {
        settingsDraggedProject = projectName;
        event.currentTarget.classList.add("dragging");
        event.dataTransfer.effectAllowed = "move";
        event.dataTransfer.setData("text/plain", projectName);
      }

      function handleSettingsItemDragEnd(event) {
        event.currentTarget.classList.remove("dragging");
        settingsDraggedProject = null;
        document
          .querySelectorAll(
            ".settings-project-item.drag-over, .settings-drop-zone.drag-over"
          )
          .forEach((el) => {
            el.classList.remove("drag-over");
          });
      }

      function handleSettingsItemDragOver(event) {
        event.preventDefault();
        if (
          settingsDraggedProject &&
          event.currentTarget.dataset.project !== settingsDraggedProject
        ) {
          event.currentTarget.classList.add("drag-over");
          // Show different visual if holding alt/option (makes it a sibling/reorder instead of child)
          if (event.altKey) {
            event.currentTarget.style.borderTopWidth = "3px";
            event.currentTarget.style.borderTopColor = "var(--primary)";
          } else {
            event.currentTarget.style.borderTopWidth = "";
            event.currentTarget.style.borderTopColor = "";
          }
        }
      }

      function handleSettingsItemDragLeave(event) {
        event.currentTarget.classList.remove("drag-over");
        event.currentTarget.style.borderTopWidth = "";
        event.currentTarget.style.borderTopColor = "";
      }

      function handleSettingsItemDrop(event, targetProjectName) {
        event.preventDefault();
        event.currentTarget.classList.remove("drag-over");
        event.currentTarget.style.borderTopWidth = "";
        event.currentTarget.style.borderTopColor = "";

        if (
          !settingsDraggedProject ||
          settingsDraggedProject === targetProjectName
        )
          return;

        const settings = getProjectSettings();
        if (!settings.parents) settings.parents = {};
        if (!settings.order) settings.order = {};

        if (event.altKey) {
          // Alt/Option held: reorder (place before target, same parent level)
          const targetParent = settings.parents[targetProjectName] || null;
          const targetOrder = settings.order[targetProjectName] ?? 999;

          // Set same parent as target
          if (targetParent) {
            settings.parents[settingsDraggedProject] = targetParent;
          } else {
            delete settings.parents[settingsDraggedProject];
          }

          // Set order just before target
          settings.order[settingsDraggedProject] = targetOrder - 0.5;

          // Normalize order values
          normalizeProjectOrder(settings);
        } else {
          // Default: make dragged project a child of target
          settings.parents[settingsDraggedProject] = targetProjectName;
        }

        saveProjectSettings(settings);
        renderSettingsProjectList();
      }

      // Normalize order values to integers
      function normalizeProjectOrder(settings) {
        const allProjects = Object.keys(settings.order || {});
        allProjects.sort(
          (a, b) => (settings.order[a] ?? 999) - (settings.order[b] ?? 999)
        );
        allProjects.forEach((proj, index) => {
          settings.order[proj] = index;
        });
      }

      function handleSettingsDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add("drag-over");
      }

      function handleSettingsDragLeave(event) {
        event.currentTarget.classList.remove("drag-over");
      }

      function handleSettingsDropToRoot(event) {
        event.preventDefault();
        event.currentTarget.classList.remove("drag-over");

        if (!settingsDraggedProject) return;

        const settings = getProjectSettings();
        if (!settings.parents) settings.parents = {};

        // Remove parent relationship (make it root level)
        delete settings.parents[settingsDraggedProject];

        saveProjectSettings(settings);
        renderSettingsProjectList();
      }

      // Drag and drop handlers
      let draggedIdeaId = null;

      function handleProjectDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add("drag-over");
      }

      function handleProjectDragLeave(event) {
        event.currentTarget.classList.remove("drag-over");
      }

      async function handleProjectDrop(event, projectName) {
        event.preventDefault();
        event.currentTarget.classList.remove("drag-over");

        if (!draggedIdeaId) return;

        const idea = allIdeas.find((i) => i.id === draggedIdeaId);
        if (!idea) return;

        // Handle archive specially
        if (projectName === "Archive") {
          await toggleArchive(draggedIdeaId);
          draggedIdeaId = null;
          return;
        }

        // Handle "All Ideas" (null) - remove from current project filter if any
        if (projectName === null) {
          draggedIdeaId = null;
          return;
        }

        // Update idea's project
        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ project_name: projectName })
            .eq("id", draggedIdeaId);

          if (error) throw error;

          idea.project_name = projectName;
          renderIdeasTable();
          renderProjectList();

          if (currentIdea?.id === draggedIdeaId) {
            renderPlayerPanel();
          }
        } catch (err) {
          console.error("Error updating project:", err);
          alert("Failed to move to project");
        }

        draggedIdeaId = null;
      }

      // Row drag handlers
      function handleRowDragStart(event, ideaId) {
        draggedIdeaId = ideaId;
        event.currentTarget.classList.add("dragging");
        event.dataTransfer.effectAllowed = "move";
        event.dataTransfer.setData("text/plain", ideaId);
      }

      function handleRowDragEnd(event) {
        event.currentTarget.classList.remove("dragging");
        // Remove drag-over from all project items
        document.querySelectorAll(".project-item.drag-over").forEach((el) => {
          el.classList.remove("drag-over");
        });
      }

      // Select a project filter
      function selectProject(projectName) {
        currentProject = projectName;
        renderProjectList();
        applyFilters();
      }

      // Get all child project names for a given project
      function getChildProjectNames(parentProject) {
        if (!parentProject) return [];

        const settings = getProjectSettings();
        const parentMap = settings.parents || {};
        const projects = getProjects();
        const childNames = [];

        // Find direct children (projects whose parent is this project)
        projects.forEach((proj) => {
          const projParent = parentMap[proj.name];
          // Check settings-based parent
          if (projParent === parentProject) {
            childNames.push(proj.name);
            // Recursively get grandchildren
            childNames.push(...getChildProjectNames(proj.name));
          }
          // Also check slash convention
          const parts = proj.name.split("/").map((p) => p.trim());
          if (parts.length > 1 && parts[0] === parentProject) {
            if (!childNames.includes(proj.name)) {
              childNames.push(proj.name);
            }
          }
        });

        return childNames;
      }

      // Apply all filters (project, search, favorites, priority, archive)
      function applyFilters() {
        // Get child projects for current project
        const childProjects = currentProject
          ? getChildProjectNames(currentProject)
          : [];
        const projectsToMatch = currentProject
          ? [currentProject, ...childProjects]
          : [];

        filteredIdeas = allIdeas.filter((idea) => {
          // Archive filter - hide archived unless viewing Archive
          if (currentProject === "Archive") {
            if (!idea.is_archived) return false;
          } else {
            if (idea.is_archived) return false;
          }

          // Project filter - check if ANY of the idea's projects match current project OR its children
          if (currentProject && currentProject !== "Archive") {
            const ideaProjects = (idea.project_name || "Unassigned")
              .split(",")
              .map((p) => p.trim());
            const hasMatchingProject = projectsToMatch.some((p) =>
              ideaProjects.includes(p)
            );
            if (!hasMatchingProject) return false;
          }

          // Search filter
          if (searchQuery) {
            const q = searchQuery.toLowerCase();
            const matchTitle = idea.title?.toLowerCase().includes(q);
            const matchTags = idea.tags?.toLowerCase().includes(q);
            const matchProject = idea.project_name?.toLowerCase().includes(q);
            if (!matchTitle && !matchTags && !matchProject) return false;
          }

          // Filter buttons
          if (currentFilter === "favorites" && !idea.is_favorite) return false;
          if (
            currentFilter === "high" &&
            idea.priority?.toLowerCase() !== "high"
          )
            return false;
          if (currentFilter === "excited" && (idea.excitement || 0) < 4)
            return false;

          // Advanced filters - Projects
          if (advancedFilters.projects.length > 0) {
            const ideaProjects = (idea.project_name || "")
              .split(",")
              .map((p) => p.trim());
            const hasMatchingProject = advancedFilters.projects.some((p) =>
              ideaProjects.includes(p)
            );
            if (!hasMatchingProject) return false;
          }

          // Advanced filters - Stages
          if (advancedFilters.stages.length > 0) {
            if (!advancedFilters.stages.includes(idea.stage || "seed"))
              return false;
          }

          // Advanced filters - Workflow Tags
          if (advancedFilters.workflowTags.length > 0) {
            const ideaTags = (idea.task_tags || "")
              .split(",")
              .map((t) => t.trim());
            const hasMatchingTag = advancedFilters.workflowTags.some((t) =>
              ideaTags.includes(t)
            );
            if (!hasMatchingTag) return false;
          }

          // Advanced filters - Due Dates
          if (advancedFilters.dueDates.length > 0) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = idea.due_date ? new Date(idea.due_date) : null;

            let matchesDueFilter = false;

            for (const filter of advancedFilters.dueDates) {
              if (filter === "overdue" && dueDate && dueDate < today)
                matchesDueFilter = true;
              if (
                filter === "today" &&
                dueDate &&
                dueDate.toDateString() === today.toDateString()
              )
                matchesDueFilter = true;
              if (filter === "week") {
                const weekFromNow = new Date(today);
                weekFromNow.setDate(weekFromNow.getDate() + 7);
                if (dueDate && dueDate >= today && dueDate <= weekFromNow)
                  matchesDueFilter = true;
              }
              if (filter === "no-date" && !dueDate) matchesDueFilter = true;
            }

            if (!matchesDueFilter) return false;
          }

          // Advanced filters - Priorities (Excitement)
          if (advancedFilters.priorities.length > 0) {
            let matchesPriority = false;
            const excitement = idea.excitement || 0;

            for (const filter of advancedFilters.priorities) {
              if (filter === "5" && excitement === 5) matchesPriority = true;
              if (filter === "4" && excitement >= 4) matchesPriority = true;
              if (filter === "3" && excitement >= 3) matchesPriority = true;
              if (filter === "unrated" && excitement === 0)
                matchesPriority = true;
            }

            if (!matchesPriority) return false;
          }

          return true;
        });

        // Update title
        if (currentProject === "Archive") {
          ideasTitle.textContent = "ðŸ“¦ Archive";
        } else if (activeViewId) {
          const view = savedViews.find((v) => v.id === activeViewId);
          ideasTitle.textContent = view ? view.name : "Saved View";
        } else if (hasActiveAdvancedFilters()) {
          ideasTitle.textContent = "ðŸ” Filtered View";
        } else if (currentFilter === "excited") {
          ideasTitle.textContent = "ðŸ”¥ High Excitement";
        } else if (currentProject) {
          ideasTitle.textContent = currentProject;
        } else if (currentFilter === "favorites") {
          ideasTitle.textContent = "Favorites";
        } else if (currentFilter === "high") {
          ideasTitle.textContent = "High Priority";
        } else {
          ideasTitle.textContent = "All Ideas";
        }

        // Apply sorting if active, otherwise just render
        if (currentSortColumn) {
          sortAndRenderIdeas();
        } else {
          renderIdeasTable();
        }
      }

      // Render ideas table
      function renderIdeasTable() {
        const visibleColumns = getVisibleColumns();
        ideasCount.textContent = `${filteredIdeas.length} ideas`;

        if (filteredIdeas.length === 0) {
          ideasBody.innerHTML = `
      <tr>
        <td colspan="${visibleColumns.length}">
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="M21 21l-4.35-4.35"/>
            </svg>
            <div>No ideas found</div>
          </div>
        </td>
      </tr>
    `;
          ideasGrid.innerHTML = `
      <div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;">
        No ideas found
      </div>
    `;
          return;
        }

        // Render list view
        ideasBody.innerHTML = filteredIdeas
          .map((idea) => {
            const isCurrentlyPlaying = currentIdea?.id === idea.id;
            const tags = idea.tags
              ? idea.tags
                  .split(",")
                  .map((t) => t.trim())
                  .filter((t) => t)
              : [];
            const priorityClass =
              idea.priority?.toLowerCase() === "high"
                ? "priority-high"
                : idea.priority?.toLowerCase() === "low"
                ? "priority-low"
                : "";

            // Split projects for display
            const projects = (idea.project_name || "Unassigned")
              .split(",")
              .map((p) => p.trim())
              .filter((p) => p);
            const primaryProject = projects[0];
            const hasMore = projects.length > 1;

            // Generate thumbnail - check for custom cover first
            const hasCustomCover =
              idea.cover_image_url && idea.cover_image_url.trim() !== "";
            const thumbnail = hasCustomCover
              ? `<img src="${escapeHtml(
                  idea.cover_image_url
                )}" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">`
              : generateThumbnail(
                  idea.title,
                  idea.tags || "",
                  idea.project_name || ""
                );

            // Mini stars for excitement
            const excitement = idea.excitement || 0;
            const miniStars =
              excitement > 0
                ? `<span class="mini-stars">${"â˜…".repeat(excitement)}</span>`
                : "";

            // Build cells based on visible columns
            const cells = visibleColumns
              .map((col) => {
                switch (col.id) {
                  case "title":
                    // Parse title: "Artist - Track Title" format
                    const titleParts = (idea.title || "").split(" - ");
                    const displayTitle =
                      titleParts.length > 1
                        ? titleParts.slice(1).join(" - ").trim()
                        : idea.title;
                    return `<td>
            <div class="idea-title-cell">
              <div class="idea-select-checkbox" onclick="event.stopPropagation(); toggleTrackSelection('${
                idea.id
              }', event)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg>
              </div>
              <div class="idea-thumbnail">${thumbnail}</div>
              <span class="idea-title">${escapeHtml(displayTitle)}</span>
              ${miniStars}
            </div>
          </td>`;
                  case "stage":
                    return `<td>${renderStageIndicator(idea)}</td>`;
                  case "project":
                    const isUnassigned = primaryProject === "Unassigned";
                    return `<td>
            <div class="idea-project-clickable" onclick="event.stopPropagation(); toggleProjectDropdown(event, '${
              idea.id
            }')">
              <span class="idea-project ${isUnassigned ? "unassigned" : ""}">
                <span class="idea-project-thumb">${generateProjectThumbnail(
                  primaryProject
                )}</span>
                ${escapeHtml(primaryProject)}
              </span>
              ${
                hasMore
                  ? `<span class="tag" style="margin-left: 4px;">+${
                      projects.length - 1
                    }</span>`
                  : ""
              }
            </div>
          </td>`;
                  case "tags":
                    return `<td>
            <div class="idea-tags-clickable" onclick="event.stopPropagation(); toggleTagsDropdown(event, '${
              idea.id
            }')">
              <div class="idea-tags">
                ${
                  tags.length > 0
                    ? tags
                        .slice(0, 3)
                        .map((t) => `<span class="tag">${escapeHtml(t)}</span>`)
                        .join("")
                    : '<span class="tag tag-empty">+ Add tags</span>'
                }
                ${
                  tags.length > 3
                    ? `<span class="tag">+${tags.length - 3}</span>`
                    : ""
                }
              </div>
            </div>
          </td>`;
                  case "due_date":
                    return `<td>
            <div class="due-date-badge ${getDueDateClass(
              idea.due_date
            )}" onclick="event.stopPropagation(); openDueDateModal('${
                      idea.id
                    }')">
              ${idea.due_date ? formatDueDate(idea.due_date) : "+ Due"}
            </div>
          </td>`;
                  case "priority":
                    return `<td>
            <div class="idea-priority-clickable" onclick="event.stopPropagation(); togglePriorityDropdown(event, '${
              idea.id
            }')">
              ${
                idea.priority
                  ? `<span class="priority-badge ${priorityClass}">${escapeHtml(
                      idea.priority
                    )}</span>`
                  : '<span class="priority-badge priority-empty">+ Add</span>'
              }
            </div>
          </td>`;
                  case "favorite":
                    return `<td>
            <button class="favorite-btn ${
              idea.is_favorite ? "active" : ""
            }" onclick="event.stopPropagation(); toggleFavorite('${idea.id}')">
              <svg viewBox="0 0 24 24" fill="${
                idea.is_favorite ? "currentColor" : "none"
              }" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
            </button>
          </td>`;
                  default:
                    return "<td></td>";
                }
              })
              .join("");

            const isSelected = selectedTracks.has(idea.id);

            return `
      <tr class="${isCurrentlyPlaying ? "playing" : ""} ${
              isSelected ? "selected" : ""
            }" 
          data-track-id="${idea.id}"
          onclick="handleTrackClick(event, '${idea.id}')"
          draggable="true"
          ondragstart="handleRowDragStart(event, '${idea.id}')"
          ondragend="handleRowDragEnd(event)">
        ${cells}
      </tr>
    `;
          })
          .join("");

        // Render grid view
        ideasGrid.innerHTML = filteredIdeas
          .map((idea) => {
            const isCurrentlyPlaying = currentIdea?.id === idea.id;
            const isHighPriority = idea.priority?.toLowerCase() === "high";
            const isFavorite = idea.is_favorite;

            // Split projects for display
            const projects = (idea.project_name || "Unassigned")
              .split(",")
              .map((p) => p.trim())
              .filter((p) => p);
            const primaryProject = projects[0];

            // Parse title: "Artist - Track Title" format
            const gridTitleParts = (idea.title || "").split(" - ");
            const gridDisplayTitle =
              gridTitleParts.length > 1
                ? gridTitleParts.slice(1).join(" - ").trim()
                : idea.title;

            // Generate album art - check for custom cover first
            const hasCustomCover =
              idea.cover_image_url && idea.cover_image_url.trim() !== "";
            const albumArt = hasCustomCover
              ? `<img src="${escapeHtml(
                  idea.cover_image_url
                )}" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">`
              : generateAlbumArt(
                  idea.title,
                  idea.tags || "",
                  idea.project_name || ""
                );

            // Excitement indicator
            const excitement = idea.excitement || 0;
            const excitementBadge =
              excitement >= 4
                ? '<span class="grid-badge" style="background: rgba(251, 191, 36, 0.9); color: #000;">ðŸ”¥</span>'
                : "";

            return `
      <div class="grid-card ${isCurrentlyPlaying ? "playing" : ""}" 
           onclick="playIdea('${idea.id}')"
           draggable="true"
           ondragstart="handleRowDragStart(event, '${idea.id}')"
           ondragend="handleRowDragEnd(event)">
        <div class="grid-card-art">
          ${albumArt}
          <div class="grid-card-badges">
            ${excitementBadge}
            ${
              isHighPriority
                ? '<span class="grid-badge priority">HIGH</span>'
                : ""
            }
            ${isFavorite ? '<span class="grid-badge favorite">â™¥</span>' : ""}
          </div>
          ${
            isCurrentlyPlaying
              ? `
            <div class="grid-card-playing">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
              </svg>
              Playing
            </div>
          `
              : ""
          }
        </div>
        <div class="grid-card-info">
          <div class="grid-card-title">${escapeHtml(gridDisplayTitle)}</div>
          <div class="grid-card-project">
            <span class="grid-card-project-thumb">${generateProjectThumbnail(
              primaryProject
            )}</span>
            ${escapeHtml(primaryProject)}
          </div>
        </div>
      </div>
    `;
          })
          .join("");

        // Update share button visibility
        updateShareButtonVisibility();
      }

      // Set view mode
      function setViewMode(mode) {
        viewMode = mode;

        // Update buttons
        document.querySelectorAll(".view-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.view === mode);
        });

        // Toggle views
        if (mode === "list") {
          listView.style.display = "block";
          gridView.style.display = "none";
        } else {
          listView.style.display = "none";
          gridView.style.display = "block";
        }

        // Save preference
        localStorage.setItem("ideas-view-mode", mode);
      }

      // Load saved view mode
      function loadViewMode() {
        const savedMode = localStorage.getItem("ideas-view-mode") || "list";
        setViewMode(savedMode);
      }

      // Select artwork style
      function selectArtworkStyle(style) {
        localStorage.setItem("ideas-artwork-style", style);

        // Re-render filter panel to show active state
        renderFilterPanelBody();

        // Re-render to show new colors
        renderIdeasTable();
        renderRightPanel();
      }

      // Load saved artwork style (called on init, no UI update needed)
      function loadArtworkStyle() {
        // Style is loaded from localStorage by getArtworkStyle()
        // No UI to update on init since filter panel renders dynamically
      }

      // Toggle sidebar visibility
      function toggleSidebar() {
        const mainLayout = document.getElementById("main-layout");
        mainLayout.classList.toggle("sidebar-collapsed");

        // Save preference
        localStorage.setItem(
          "ideas-sidebar-collapsed",
          mainLayout.classList.contains("sidebar-collapsed")
        );
      }

      // Toggle sidebar collapse (icon-only mode)
      function toggleSidebarCollapse() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("collapsed");

        // Save preference
        localStorage.setItem(
          "ideas-sidebar-icon-only",
          sidebar.classList.contains("collapsed")
        );
      }

      // ============ PLAYER PANEL COLLAPSE ============

      function togglePlayerCollapse() {
        const playerPanel = document.getElementById("player-panel");
        playerPanel.classList.toggle("collapsed");

        // Save preference
        localStorage.setItem(
          "ideas-player-collapsed",
          playerPanel.classList.contains("collapsed")
        );
      }

      function loadPlayerState() {
        const collapsed =
          localStorage.getItem("ideas-player-collapsed") === "true";
        if (collapsed) {
          const playerPanel = document.getElementById("player-panel");
          if (playerPanel) playerPanel.classList.add("collapsed");
        }

        // Setup resize functionality
        setupPlayerResize();
      }

      function setupPlayerResize() {
        const playerPanel = document.getElementById("player-panel");
        const resizeHandle = document.getElementById("player-resize");

        if (!resizeHandle || !playerPanel) return;

        let isResizing = false;
        let startX, startWidth;

        resizeHandle.addEventListener("mousedown", (e) => {
          isResizing = true;
          startX = e.clientX;
          startWidth = playerPanel.offsetWidth;
          resizeHandle.classList.add("dragging");
          document.body.style.cursor = "ew-resize";
          document.body.style.userSelect = "none";
        });

        document.addEventListener("mousemove", (e) => {
          if (!isResizing) return;

          // Resize from left edge (opposite direction from sidebar)
          const diff = startX - e.clientX;
          const newWidth = Math.max(80, Math.min(500, startWidth + diff));
          playerPanel.style.width = newWidth + "px";

          // If dragged very small, collapse
          if (newWidth <= 100) {
            playerPanel.classList.add("collapsed");
          } else {
            playerPanel.classList.remove("collapsed");
          }
        });

        document.addEventListener("mouseup", () => {
          if (isResizing) {
            isResizing = false;
            resizeHandle.classList.remove("dragging");
            document.body.style.cursor = "";
            document.body.style.userSelect = "";

            // Save state
            localStorage.setItem(
              "ideas-player-collapsed",
              playerPanel.classList.contains("collapsed")
            );
            if (!playerPanel.classList.contains("collapsed")) {
              localStorage.setItem(
                "ideas-player-width",
                playerPanel.offsetWidth
              );
            }
          }
        });

        // Load saved width
        const savedWidth = localStorage.getItem("ideas-player-width");
        if (savedWidth && !playerPanel.classList.contains("collapsed")) {
          playerPanel.style.width = savedWidth + "px";
        }
      }

      // Load sidebar state
      function loadSidebarState() {
        const collapsed =
          localStorage.getItem("ideas-sidebar-collapsed") === "true";
        if (collapsed) {
          document
            .getElementById("main-layout")
            .classList.add("sidebar-collapsed");
        }

        const iconOnly =
          localStorage.getItem("ideas-sidebar-icon-only") === "true";
        if (iconOnly) {
          document.getElementById("sidebar").classList.add("collapsed");
        }

        // Setup resize functionality
        setupSidebarResize();
      }

      // Setup sidebar resize
      function setupSidebarResize() {
        const sidebar = document.getElementById("sidebar");
        const resizeHandle = document.getElementById("sidebar-resize");

        if (!resizeHandle) return;

        let isResizing = false;
        let startX, startWidth;

        resizeHandle.addEventListener("mousedown", (e) => {
          isResizing = true;
          startX = e.clientX;
          startWidth = sidebar.offsetWidth;
          resizeHandle.classList.add("dragging");
          document.body.style.cursor = "ew-resize";
          document.body.style.userSelect = "none";
          e.preventDefault();
        });

        document.addEventListener("mousemove", (e) => {
          if (!isResizing) return;

          const width = startWidth + (e.clientX - startX);
          const minWidth = 60;
          const maxWidth = 400;

          if (width >= minWidth && width <= maxWidth) {
            sidebar.style.width = width + "px";

            // Auto-collapse if dragged too narrow
            if (width < 120) {
              sidebar.classList.add("collapsed");
            } else {
              sidebar.classList.remove("collapsed");
            }
          }
        });

        document.addEventListener("mouseup", () => {
          if (isResizing) {
            isResizing = false;
            resizeHandle.classList.remove("dragging");
            document.body.style.cursor = "";
            document.body.style.userSelect = "";

            // Save width
            localStorage.setItem("ideas-sidebar-width", sidebar.style.width);
            localStorage.setItem(
              "ideas-sidebar-icon-only",
              sidebar.classList.contains("collapsed")
            );
          }
        });

        // Load saved width
        const savedWidth = localStorage.getItem("ideas-sidebar-width");
        if (savedWidth) {
          sidebar.style.width = savedWidth;
        }
      }

      // Share idea
      // ============ INBOX SYSTEM ============

      let allVoiceMemos = [];
      let filteredVoiceMemos = [];
      let inboxFilter = "all";
      let inboxSearchQuery = "";
      let currentMemoAudio = null;
      let currentMemoId = null;

      // Web Audio API for effects
      let audioContext = null;
      let sourceNode = null;
      let gainNode = null;
      let dryGainNode = null;
      let wetGainNode = null;
      let convolverNode = null;
      let reverbImpulse = null;
      let currentPitch = 0;
      let currentReverbMix = 0;

      // Initialize audio context and create reverb impulse
      async function initAudioContext() {
        if (audioContext) return;

        audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Create gain nodes
        gainNode = audioContext.createGain();
        dryGainNode = audioContext.createGain();
        wetGainNode = audioContext.createGain();

        // Create convolver for reverb
        convolverNode = audioContext.createConvolver();

        // Generate a large plate reverb impulse response (5 seconds)
        const sampleRate = audioContext.sampleRate;
        const length = sampleRate * 5; // 5 second reverb
        const impulse = audioContext.createBuffer(2, length, sampleRate);

        for (let channel = 0; channel < 2; channel++) {
          const channelData = impulse.getChannelData(channel);
          for (let i = 0; i < length; i++) {
            // Exponential decay with some randomness for natural sound
            const decay = Math.exp((-3 * i) / length);
            channelData[i] = (Math.random() * 2 - 1) * decay;
          }
        }

        convolverNode.buffer = impulse;

        // Connect dry/wet routing
        dryGainNode.connect(gainNode);
        convolverNode.connect(wetGainNode);
        wetGainNode.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Set initial mix (dry only)
        dryGainNode.gain.value = 1;
        wetGainNode.gain.value = 0;
      }

      // Dropbox settings
      const DROPBOX_INBOX_PATH = "/Inbox";
      const DROPBOX_ACCESS_TOKEN =
        "sl.u.AGLqkJaditvWJr9bR3XbI3yHVAXYVi9NXaSftXMpVRuA5gndp9X4Kb_CCN6gAYJsAvif_3G2uxmLwKid2K5tAcnLjZ2EFfDE7YNNKcm9XHq9lt_c9xReyxLMOWktmOp1yq0tNoBhcZBu6jmso0bdKuDrtaepQZGwS25jKdSr8Jo5TBaFIZg4uVEcfk-U9-shKt5inQSXeph6xYhHG2J1bYjRmpGd9hw9I-t8M51jVcJ8xvth9oC5mLFFyMZ3-Q7KHReAn34fNmTTQAjWuEJ0o9dgFGAm1BgIfRbwTrlEe3JfEob3haU6w377ke4Yzvxug2o9_OV7bwQWoQsyzThG9pNNdCgLmHvuj3dM0_QnUMgnsmJ3QbWUhW-Laji44sJOU69HchK7CZDoi5cySOy6f_H1lMKN28tKtw8zvTZrxKLL15Y1Q4SO0r5on5ROPgx_de_EiicgHjyct2t3J_MMn2nB5kUx2x7_ptAXZcfcGZBq7H3AeKQSdJVZsc8wxS_rDM20x_flIuMzSDvOcrhcg5B8_4CdW1nMULdP0HdJ6RPp1vS9NFR2QMC0FtEyOzgyXj2i-VDyM1e-o7DAqYxPyrmHD7JA3wijBuaPRG1EzkEZKxqsegVhe4KLyZuBydJuXHVMoFIX1JaivGe7Tqw18kRmagPeBzmNXvRGlO-TBwS49y5NVNkar6B97e8Y7B9aotJuS2siud6T6IBaUw9x7vCxufEgXwzR_1HW2f5F-joHczG-A5aHIJlGaWOXSW-YLR3mjwwq_7CrNpN6B94RjaNEt5LLeVmgvVzK_Lm83HvXCiXlKX5EyzF07KcpYaz9-g4BJi5v2dyl5ZklAjv6_uMF4QN1aQ2abpgpa3Oy8_vKqz9br3DUK_iAN6kJnmtOtXtKHW6tRKpiw6ZPfCI_p5FlWibX4ZLXBMuI6Wmmk0sS3G-xd5jDQl9vhp7skaFKeGvoopr7sm1VUahbwc_774CwL7Ctz4bz9IRprEdJ5S3YP5enWr2RPfDyqCA30uvj_FxZuHTAKClOKxcmyATzlMeiwdE3tXm9p3MsKCSbjbtXUQVyneei9WA2XEAhzA8CchPTXX12Opnkudbplg4N1YYnVLn9oyxkI1GSfxfYmGpgc83AD7n_8n5kGriBdDigHYhxC-ofxvIZBSBBov4ePwps3FICJ5ZLi8WQU1LAV4HYXcVXkmccnsuc1g2Es3v_6Iyjy7m40-aphypxVYt3qzRcZyoLlvhbYxdjubCB8TP7zfJc19H_tJUSts9lF7a9NvPWdBEbBVhDoXYwk8riIJttSszgr3y95vvmue8rI4SKdw";
      let dropboxAccessToken = DROPBOX_ACCESS_TOKEN;

      // Load voice memos from database
      async function loadVoiceMemos() {
        try {
          const { data, error } = await supabase
            .from("voice_memos")
            .select("*")
            .order("created_at", { ascending: false });

          if (error) throw error;

          allVoiceMemos = data || [];
          updateInboxBadge();
        } catch (err) {
          console.error("Error loading voice memos:", err);
        }
      }

      // Sync from Dropbox Inbox folder
      async function syncDropboxInbox() {
        const syncBtn = document.getElementById("sync-dropbox-btn");
        const syncIcon = document.getElementById("sync-icon");

        // Show loading state
        if (syncBtn) {
          syncBtn.disabled = true;
          syncBtn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; animation: spin 1s linear infinite;">
        <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="8"/>
      </svg>
      Syncing...
    `;
        }

        try {
          // List files in Dropbox /Inbox folder
          const listResponse = await fetch(
            "https://api.dropboxapi.com/2/files/list_folder",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${dropboxAccessToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                path: DROPBOX_INBOX_PATH,
                recursive: false,
                include_media_info: true,
              }),
            }
          );

          if (!listResponse.ok) {
            const errorData = await listResponse.json();
            if (errorData.error?.[".tag"] === "invalid_access_token") {
              localStorage.removeItem("dropbox_access_token");
              dropboxAccessToken = "";
              throw new Error("Invalid access token. Please try again.");
            }
            throw new Error(
              errorData.error_summary || "Failed to list Dropbox folder"
            );
          }

          const listData = await listResponse.json();
          const audioFiles = listData.entries.filter(
            (entry) =>
              entry[".tag"] === "file" &&
              /\.(mp3|wav|m4a|aac|ogg|flac|aiff)$/i.test(entry.name)
          );

          if (audioFiles.length === 0) {
            showToast("No audio files found in /Inbox");
            return;
          }

          // Get existing audio URLs to avoid duplicates
          const existingUrls = new Set(
            allVoiceMemos.map((m) => m.dropbox_path).filter(Boolean)
          );
          const newFiles = audioFiles.filter(
            (f) => !existingUrls.has(f.path_lower)
          );

          if (newFiles.length === 0) {
            showToast("All files already synced");
            return;
          }

          // Process each new file
          let syncedCount = 0;
          for (const file of newFiles) {
            try {
              // Get a shared link for the file
              let sharedLink;
              try {
                const linkResponse = await fetch(
                  "https://api.dropboxapi.com/2/sharing/create_shared_link_with_settings",
                  {
                    method: "POST",
                    headers: {
                      Authorization: `Bearer ${dropboxAccessToken}`,
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      path: file.path_lower,
                      settings: {
                        requested_visibility: "public",
                      },
                    }),
                  }
                );

                if (linkResponse.ok) {
                  const linkData = await linkResponse.json();
                  sharedLink = linkData.url.replace("?dl=0", "?dl=1");
                } else {
                  // Link might already exist, try to get it
                  const existingLinkResponse = await fetch(
                    "https://api.dropboxapi.com/2/sharing/list_shared_links",
                    {
                      method: "POST",
                      headers: {
                        Authorization: `Bearer ${dropboxAccessToken}`,
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({
                        path: file.path_lower,
                        direct_only: true,
                      }),
                    }
                  );

                  if (existingLinkResponse.ok) {
                    const existingLinkData = await existingLinkResponse.json();
                    if (existingLinkData.links?.length > 0) {
                      sharedLink = existingLinkData.links[0].url.replace(
                        "?dl=0",
                        "?dl=1"
                      );
                    }
                  }
                }
              } catch (linkErr) {
                console.error("Error getting shared link:", linkErr);
              }

              if (!sharedLink) {
                console.warn("Could not get shared link for:", file.name);
                continue;
              }

              // Parse title from filename (remove extension)
              const title = file.name.replace(/\.[^/.]+$/, "");

              // Get duration from media info if available
              const duration = file.media_info?.metadata?.duration
                ? Math.round(file.media_info.metadata.duration / 1000)
                : null;

              // Insert into database
              const { error: insertError } = await supabase
                .from("voice_memos")
                .insert({
                  title: title,
                  audio_url: sharedLink,
                  dropbox_path: file.path_lower,
                  duration: duration,
                  is_listened: false,
                  created_at: file.client_modified || new Date().toISOString(),
                });

              if (insertError) {
                console.error("Error inserting memo:", insertError);
              } else {
                syncedCount++;
              }
            } catch (fileErr) {
              console.error("Error processing file:", file.name, fileErr);
            }
          }

          // Reload memos
          await loadVoiceMemos();
          filterInbox();

          showToast(
            `Synced ${syncedCount} new voice memo${
              syncedCount !== 1 ? "s" : ""
            }!`
          );
        } catch (err) {
          console.error("Dropbox sync error:", err);
          showToast("Sync failed: " + err.message, "error");
        } finally {
          // Reset button
          if (syncBtn) {
            syncBtn.disabled = false;
            syncBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
          <path d="M23 4v6h-6M1 20v-6h6"/>
          <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
        </svg>
        Sync Dropbox
      `;
          }
        }
      }

      // Update the inbox badge count
      function updateInboxBadge() {
        const badge = document.getElementById("inbox-badge");
        const unlistenedCount = allVoiceMemos.filter(
          (m) => !m.is_listened
        ).length;

        if (badge) {
          if (unlistenedCount > 0) {
            badge.textContent = unlistenedCount > 99 ? "99+" : unlistenedCount;
            badge.style.display = "flex";
          } else {
            badge.style.display = "none";
          }
        }
      }

      // Open inbox modal
      function openInboxModal() {
        const modal = document.getElementById("inbox-modal");
        if (modal) {
          modal.classList.add("open");
          filterInbox();
        }
      }

      // Close inbox modal
      function closeInboxModal() {
        const modal = document.getElementById("inbox-modal");
        if (modal) {
          modal.classList.remove("open");
        }
        // Stop any playing audio
        if (currentMemoAudio) {
          currentMemoAudio.pause();
          currentMemoAudio = null;
          currentMemoId = null;
        }
        // Reset player bar
        const playerBar = document.getElementById("inbox-player-bar");
        if (playerBar) playerBar.classList.remove("active");
      }

      // Set inbox filter
      function setInboxFilter(filter) {
        inboxFilter = filter;

        // Update button states
        document.querySelectorAll(".inbox-filter-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.filter === filter);
        });

        filterInbox();
      }

      // Filter inbox memos
      function filterInbox() {
        const searchInput = document.getElementById("inbox-search");
        inboxSearchQuery = searchInput?.value?.toLowerCase() || "";

        filteredVoiceMemos = allVoiceMemos.filter((memo) => {
          // Search filter
          const matchesSearch =
            !inboxSearchQuery ||
            memo.title?.toLowerCase().includes(inboxSearchQuery) ||
            memo.notes?.toLowerCase().includes(inboxSearchQuery) ||
            memo.project_name?.toLowerCase().includes(inboxSearchQuery);

          // Category filter
          let matchesFilter = true;
          switch (inboxFilter) {
            case "unassigned":
              matchesFilter = !memo.track_id;
              break;
            case "assigned":
              matchesFilter = !!memo.track_id;
              break;
            case "favorite":
              matchesFilter = memo.is_favorite;
              break;
          }

          return matchesSearch && matchesFilter;
        });

        renderInboxList();
      }

      // Render inbox list
      function renderInboxList() {
        const container = document.getElementById("inbox-list");
        if (!container) return;

        if (filteredVoiceMemos.length === 0) {
          container.innerHTML = `
      <div class="inbox-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
          <polyline points="22,6 12,13 2,6"/>
        </svg>
        <div>No voice memos found</div>
        <p style="font-size: 12px; margin-top: 8px;">Voice memos will appear here when synced from Dropbox</p>
      </div>
    `;
          return;
        }

        // Get unique colors for mic icons
        const memoColors = [
          "#ef4444",
          "#f97316",
          "#eab308",
          "#22c55e",
          "#3b82f6",
          "#8b5cf6",
          "#ec4899",
        ];

        container.innerHTML = `
    <table class="inbox-table">
      <thead>
        <tr>
          <th>Voice Memo</th>
          <th>Project</th>
          <th>Track</th>
          <th>Excitement</th>
          <th>Duration</th>
          <th>Date Created</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        ${filteredVoiceMemos
          .map((memo, index) => {
            const color = memoColors[index % memoColors.length];
            const track = memo.track_id
              ? allIdeas.find((i) => i.id === memo.track_id)
              : null;
            const excitement = memo.excitement || 0;
            const isNew = !memo.is_listened;
            const memoArtwork = generateAlbumArt(
              memo.title || "Untitled",
              memo.notes || "",
              memo.project_name || ""
            );

            return `
            <tr onclick="selectMemo('${memo.id}')" data-memo-id="${memo.id}">
              <td>
                <div class="inbox-memo-cell">
                  <div class="inbox-memo-artwork">
                    ${memoArtwork}
                  </div>
                  <div class="inbox-memo-info">
                    <div class="inbox-memo-title">
                      ${isNew ? '<span class="new-dot"></span>' : ""}
                      ${escapeHtml(memo.title || "Untitled Memo")}
                      ${
                        memo.is_favorite
                          ? '<span style="color: #ef4444;">â¤ï¸</span>'
                          : ""
                      }
                    </div>
                    ${
                      memo.notes
                        ? `<div class="inbox-memo-notes">${escapeHtml(
                            memo.notes
                          )}</div>`
                        : ""
                    }
                  </div>
                </div>
              </td>
              <td onclick="event.stopPropagation()">
                <div class="inbox-cell-clickable" onclick="openInboxProjectDropdown('${
                  memo.id
                }', event)">
                  ${
                    memo.project_name
                      ? `<span class="inbox-project-badge" style="background: ${getProjectColor(
                          memo.project_name
                        )}20; color: ${getProjectColor(memo.project_name)};">
                        <span class="inbox-project-dot" style="background: ${getProjectColor(
                          memo.project_name
                        )};"></span>
                        ${escapeHtml(memo.project_name)}
                       </span>`
                      : '<span class="inbox-unassigned">Unassigned</span>'
                  }
                </div>
              </td>
              <td onclick="event.stopPropagation()">
                <div class="inbox-cell-clickable" onclick="openInboxTrackDropdown('${
                  memo.id
                }', event)">
                  ${
                    track
                      ? `<span class="inbox-track-badge">${escapeHtml(
                          track.title
                        )}</span>`
                      : '<span class="inbox-unassigned">Unassigned</span>'
                  }
                </div>
              </td>
              <td onclick="event.stopPropagation()">
                <div class="inbox-excitement" id="inbox-stars-${memo.id}">
                  ${[1, 2, 3, 4, 5]
                    .map(
                      (i) => `
                    <span class="inbox-excitement-star ${
                      i <= excitement ? "filled" : ""
                    }" 
                          onclick="setMemoExcitement('${memo.id}', ${i})"
                          onmouseenter="previewMemoStars('${memo.id}', ${i})"
                          onmouseleave="resetMemoStars('${memo.id}')">â˜…</span>
                  `
                    )
                    .join("")}
                </div>
              </td>
              <td class="inbox-duration" id="inbox-duration-${
                memo.id
              }">${formatDuration(memo.duration)}</td>
              <td class="inbox-date">${formatRelativeDate(memo.created_at)}</td>
              <td>
                <div class="inbox-actions" onclick="event.stopPropagation()">
                  <button class="inbox-action-btn" onclick="downloadMemo('${
                    memo.id
                  }')" title="Download">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                      <polyline points="7 10 12 15 17 10"/>
                      <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                  </button>
                  <div class="inbox-more-btn">
                    <button class="inbox-action-btn" onclick="toggleInboxMoreMenu('${
                      memo.id
                    }')" title="More">
                      <svg viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="12" cy="5" r="2"/>
                        <circle cx="12" cy="12" r="2"/>
                        <circle cx="12" cy="19" r="2"/>
                      </svg>
                    </button>
                    <div class="inbox-more-menu" id="inbox-more-${memo.id}">
                      <div class="inbox-more-item promote" onclick="promoteToTrack('${
                        memo.id
                      }')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M12 19V5M5 12l7-7 7 7"/>
                        </svg>
                        Promote to Track
                      </div>
                      <div class="inbox-more-item archive" onclick="archiveMemo('${
                        memo.id
                      }')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        Archive
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          `;
          })
          .join("")}
      </tbody>
    </table>
  `;

        // Preserve highlighting if a memo is currently playing
        if (currentMemoId) {
          highlightMemoRow(currentMemoId);
        }
      }

      // Format duration
      function formatDuration(seconds) {
        if (!seconds) return "--:--";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, "0")}`;
      }

      // Format relative date
      function formatRelativeDate(dateStr) {
        if (!dateStr) return "";
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        const diffWeeks = Math.floor(diffDays / 7);

        if (diffMins < 60)
          return `${diffMins} min${diffMins !== 1 ? "s" : ""} ago`;
        if (diffHours < 24)
          return `${diffHours} hour${diffHours !== 1 ? "s" : ""} ago`;
        if (diffDays < 7)
          return `${diffDays} day${diffDays !== 1 ? "s" : ""} ago`;
        if (diffWeeks < 4)
          return `${diffWeeks} week${diffWeeks !== 1 ? "s" : ""} ago`;
        return date.toLocaleDateString();
      }

      // Select a memo (mark as listened)
      async function selectMemo(id) {
        const memo = allVoiceMemos.find((m) => m.id === id);
        if (!memo) return;

        // Mark as listened if not already
        if (!memo.is_listened) {
          try {
            await supabase
              .from("voice_memos")
              .update({ is_listened: true })
              .eq("id", id);

            memo.is_listened = true;
            updateInboxBadge();
            renderInboxList();
          } catch (err) {
            console.error("Error marking memo as listened:", err);
          }
        }

        // Highlight selected row
        highlightMemoRow(id);

        // Play the audio
        playMemoAudio(memo);
      }

      // Highlight the playing memo row
      function highlightMemoRow(id) {
        // Remove playing class from all rows
        document.querySelectorAll(".inbox-table tr.playing").forEach((row) => {
          row.classList.remove("playing");
        });

        // Add playing class to selected row
        const row = document.querySelector(`tr[data-memo-id="${id}"]`);
        if (row) {
          row.classList.add("playing");
        }
      }

      // Convert Dropbox URL to streamable format
      function getStreamableDropboxUrl(url) {
        if (!url) return url;

        if (url.includes("dropbox.com")) {
          // Convert www.dropbox.com to dl.dropboxusercontent.com for streaming
          // Also handle ?dl=0 or ?dl=1 parameter
          let streamUrl = url
            .replace("www.dropbox.com", "dl.dropboxusercontent.com")
            .replace("?dl=0", "")
            .replace("?dl=1", "")
            .replace("&dl=0", "")
            .replace("&dl=1", "");

          // Remove any trailing ? if no other params
          if (streamUrl.endsWith("?")) {
            streamUrl = streamUrl.slice(0, -1);
          }

          return streamUrl;
        }

        return url;
      }

      // Play memo audio
      async function playMemoAudio(memo) {
        // Initialize audio context on first use
        await initAudioContext();

        // Resume context if suspended (browser autoplay policy)
        if (audioContext.state === "suspended") {
          await audioContext.resume();
        }

        // Stop main track player if playing
        if (audio && !audio.paused) {
          audio.pause();
          isPlaying = false;
          renderPlayerPanel();
        }

        // Stop current audio if playing
        if (currentMemoAudio) {
          currentMemoAudio.pause();
          currentMemoAudio.removeEventListener(
            "timeupdate",
            updateInboxPlayerProgress
          );
          currentMemoAudio.removeEventListener(
            "loadedmetadata",
            updateInboxPlayerDuration
          );
          currentMemoAudio.removeEventListener("ended", onMemoEnded);
          if (sourceNode) {
            sourceNode.disconnect();
            sourceNode = null;
          }
        }

        if (!memo.audio_url) {
          showToast("No audio URL available", "error");
          return;
        }

        currentMemoId = memo.id;
        const streamUrl = getStreamableDropboxUrl(memo.audio_url);
        currentMemoAudio = new Audio(streamUrl);
        currentMemoAudio.crossOrigin = "anonymous";

        // Apply current pitch setting
        const pitchSlider = document.getElementById("inbox-pitch-slider");
        if (pitchSlider) {
          const semitones = parseInt(pitchSlider.value) || 0;
          // Convert semitones to playback rate (2^(semitones/12))
          currentMemoAudio.playbackRate = Math.pow(2, semitones / 12);
          currentMemoAudio.preservesPitch = false;
        }

        // Connect to Web Audio API
        sourceNode = audioContext.createMediaElementSource(currentMemoAudio);
        sourceNode.connect(dryGainNode);
        sourceNode.connect(convolverNode);

        // Apply current reverb setting
        setReverbMix(currentReverbMix);

        // Setup event listeners
        currentMemoAudio.addEventListener(
          "timeupdate",
          updateInboxPlayerProgress
        );
        currentMemoAudio.addEventListener(
          "loadedmetadata",
          updateInboxPlayerDuration
        );
        currentMemoAudio.addEventListener("ended", onMemoEnded);
        currentMemoAudio.addEventListener("play", updateInboxPlayPauseIcon);
        currentMemoAudio.addEventListener("pause", updateInboxPlayPauseIcon);

        // Show player bar
        const playerBar = document.getElementById("inbox-player-bar");
        if (playerBar) playerBar.classList.add("active");

        // Update title
        const titleEl = document.getElementById("inbox-player-title");
        if (titleEl) titleEl.textContent = memo.title || "Untitled Memo";

        // Update artwork
        const artworkEl = document.getElementById("inbox-player-artwork");
        if (artworkEl) {
          const artwork = generateAlbumArt(
            memo.title || "Untitled",
            memo.notes || "",
            memo.project_name || ""
          );
          artworkEl.innerHTML = artwork;
        }

        // Reset effects display
        const pitchValue = document.getElementById("inbox-pitch-value");
        const reverbValue = document.getElementById("inbox-reverb-value");
        if (pitchValue)
          pitchValue.textContent = `${
            currentPitch > 0 ? "+" : ""
          }${currentPitch} st`;
        if (reverbValue) reverbValue.textContent = `${currentReverbMix}%`;

        currentMemoAudio.play().catch((err) => {
          console.error("Error playing memo:", err);
          showToast("Error playing audio", "error");
        });
      }

      // Update player progress
      function updateInboxPlayerProgress() {
        if (!currentMemoAudio) return;

        const current = currentMemoAudio.currentTime;
        const duration = currentMemoAudio.duration || 0;

        const currentTimeEl = document.getElementById("inbox-current-time");
        const progressFill = document.getElementById("inbox-progress-fill");

        if (currentTimeEl) currentTimeEl.textContent = formatDuration(current);
        if (progressFill && duration > 0) {
          progressFill.style.width = `${(current / duration) * 100}%`;
        }
      }

      // Update duration when loaded
      function updateInboxPlayerDuration() {
        if (!currentMemoAudio || !currentMemoId) return;

        const duration = currentMemoAudio.duration;
        const formatted = formatDuration(duration);

        // Update player duration
        const playerDurationEl = document.getElementById(
          "inbox-player-duration"
        );
        if (playerDurationEl) playerDurationEl.textContent = formatted;

        // Update table cell duration
        const tableDurationEl = document.getElementById(
          `inbox-duration-${currentMemoId}`
        );
        if (tableDurationEl) tableDurationEl.textContent = formatted;

        // Also update in local data and database if it was missing
        const memo = allVoiceMemos.find((m) => m.id === currentMemoId);
        if (memo && !memo.duration && duration) {
          memo.duration = Math.round(duration);
          // Update in database
          supabase
            .from("voice_memos")
            .update({ duration: Math.round(duration) })
            .eq("id", currentMemoId)
            .then(() => {});
        }
      }

      // Handle memo ended
      function onMemoEnded() {
        updateInboxPlayPauseIcon();
        const progressFill = document.getElementById("inbox-progress-fill");
        if (progressFill) progressFill.style.width = "0%";
      }

      // Update play/pause icon
      function updateInboxPlayPauseIcon() {
        const icon = document.getElementById("inbox-play-icon");
        if (!icon) return;

        if (currentMemoAudio && !currentMemoAudio.paused) {
          icon.innerHTML =
            '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
        } else {
          icon.innerHTML = '<polygon points="6 3 20 12 6 21 6 3"/>';
        }
      }

      // Toggle memo playback
      function toggleMemoPlayback() {
        if (!currentMemoAudio) return;

        if (currentMemoAudio.paused) {
          currentMemoAudio.play();
        } else {
          currentMemoAudio.pause();
        }
      }

      // Seek memo audio
      function seekMemoAudio(event) {
        if (!currentMemoAudio) return;

        const bar = document.getElementById("inbox-progress-bar");
        const rect = bar.getBoundingClientRect();
        const percent = (event.clientX - rect.left) / rect.width;
        currentMemoAudio.currentTime = percent * currentMemoAudio.duration;
      }

      // Set memo volume
      function setMemoVolume(value) {
        if (gainNode) {
          gainNode.gain.value = value / 100;
        }
      }

      // Set reverb wet/dry mix
      function setReverbMix(percent) {
        currentReverbMix = percent;
        if (!dryGainNode || !wetGainNode) return;

        const wet = percent / 100;
        const dry = 1 - wet * 0.5; // Keep dry mostly present

        dryGainNode.gain.value = dry;
        wetGainNode.gain.value = wet;
      }

      // Set pitch (using playbackRate)
      function setMemoPitch(semitones) {
        currentPitch = parseInt(semitones);

        const valueEl = document.getElementById("inbox-pitch-value");
        if (valueEl) {
          const sign = currentPitch > 0 ? "+" : "";
          valueEl.textContent = `${sign}${currentPitch} st`;
        }

        if (currentMemoAudio) {
          // Convert semitones to playback rate (2^(semitones/12))
          const rate = Math.pow(2, currentPitch / 12);
          currentMemoAudio.playbackRate = rate;
          currentMemoAudio.preservesPitch = false;
        }
      }

      // Set reverb amount
      function setMemoReverb(value) {
        const percent = parseInt(value);

        const valueEl = document.getElementById("inbox-reverb-value");
        if (valueEl) valueEl.textContent = `${percent}%`;

        setReverbMix(percent);
      }

      // Toggle more menu
      function toggleInboxMoreMenu(memoId) {
        // Close all other menus
        document.querySelectorAll(".inbox-more-menu.open").forEach((menu) => {
          if (menu.id !== `inbox-more-${memoId}`) {
            menu.classList.remove("open");
          }
        });

        const menu = document.getElementById(`inbox-more-${memoId}`);
        if (menu) menu.classList.toggle("open");
      }

      // Close more menus when clicking outside
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".inbox-more-btn")) {
          document.querySelectorAll(".inbox-more-menu.open").forEach((menu) => {
            menu.classList.remove("open");
          });
        }
        // Close inbox dropdowns
        if (
          !e.target.closest(".inbox-dropdown") &&
          !e.target.closest(".inbox-cell-clickable")
        ) {
          closeInboxDropdowns();
        }
      });

      // Archive memo (remove from inbox)
      async function archiveMemo(id) {
        try {
          const { error } = await supabase
            .from("voice_memos")
            .delete()
            .eq("id", id);

          if (error) throw error;

          // Remove from local array
          allVoiceMemos = allVoiceMemos.filter((m) => m.id !== id);
          filterInbox();
          updateInboxBadge();
          showToast("Memo archived");
        } catch (err) {
          console.error("Error archiving memo:", err);
          showToast("Error archiving memo", "error");
        }
      }

      // Close inbox dropdowns
      function closeInboxDropdowns() {
        document.querySelectorAll(".inbox-dropdown").forEach((d) => d.remove());
        document
          .querySelectorAll(".inbox-more-menu.open")
          .forEach((m) => m.classList.remove("open"));
      }

      // Open project dropdown for inbox memo
      function openInboxProjectDropdown(memoId, event) {
        event.stopPropagation();
        closeInboxDropdowns();

        const cell = event.currentTarget;
        const rect = cell.getBoundingClientRect();

        const dropdown = document.createElement("div");
        dropdown.className = "inbox-dropdown";
        dropdown.style.position = "fixed";
        dropdown.style.left = `${rect.left}px`;
        dropdown.style.top = `${rect.bottom + 4}px`;

        const memo = allVoiceMemos.find((m) => m.id === memoId);

        dropdown.innerHTML = `
    <input type="text" class="inbox-dropdown-search" placeholder="Search projects..." oninput="filterInboxProjectDropdown(this.value, '${memoId}')">
    <div class="inbox-dropdown-items" id="inbox-project-items-${memoId}">
      <div class="inbox-dropdown-item ${
        !memo?.project_name ? "selected" : ""
      }" onclick="event.stopPropagation(); setMemoProject('${memoId}', null)">
        <span style="color: var(--text-muted);">Unassigned</span>
      </div>
      ${allProjects
        .map(
          (p) => `
        <div class="inbox-dropdown-item ${
          memo?.project_name === p.name ? "selected" : ""
        }" onclick="event.stopPropagation(); setMemoProject('${memoId}', '${escapeHtml(
            p.name
          )}')">
          <div class="inbox-dropdown-item-color" style="background: ${
            p.color || "#666"
          }"></div>
          ${escapeHtml(p.name)}
        </div>
      `
        )
        .join("")}
    </div>
  `;

        document.body.appendChild(dropdown);
        dropdown.querySelector(".inbox-dropdown-search").focus();
      }

      // Filter project dropdown
      function filterInboxProjectDropdown(query, memoId) {
        const container = document.getElementById(
          `inbox-project-items-${memoId}`
        );
        if (!container) return;

        const memo = allVoiceMemos.find((m) => m.id === memoId);
        const filtered = allProjects.filter((p) =>
          p.name.toLowerCase().includes(query.toLowerCase())
        );

        container.innerHTML = `
    <div class="inbox-dropdown-item ${
      !memo?.project_name ? "selected" : ""
    }" onclick="event.stopPropagation(); setMemoProject('${memoId}', null)">
      <span style="color: var(--text-muted);">Unassigned</span>
    </div>
    ${filtered
      .map(
        (p) => `
      <div class="inbox-dropdown-item ${
        memo?.project_name === p.name ? "selected" : ""
      }" onclick="event.stopPropagation(); setMemoProject('${memoId}', '${escapeHtml(
          p.name
        )}')">
        <div class="inbox-dropdown-item-color" style="background: ${
          p.color || "#666"
        }"></div>
        ${escapeHtml(p.name)}
      </div>
    `
      )
      .join("")}
  `;
      }

      // Set memo project
      async function setMemoProject(memoId, projectName) {
        try {
          const { error } = await supabase
            .from("voice_memos")
            .update({ project_name: projectName })
            .eq("id", memoId);

          if (error) throw error;

          // Update local
          const memo = allVoiceMemos.find((m) => m.id === memoId);
          if (memo) memo.project_name = projectName;

          closeInboxDropdowns();
          filterInbox();
        } catch (err) {
          console.error("Error updating memo project:", err);
          showToast("Error updating project", "error");
        }
      }

      // Open track dropdown for inbox memo
      function openInboxTrackDropdown(memoId, event) {
        event.stopPropagation();
        closeInboxDropdowns();

        const cell = event.currentTarget;
        const rect = cell.getBoundingClientRect();

        const dropdown = document.createElement("div");
        dropdown.className = "inbox-dropdown";
        dropdown.style.position = "fixed";
        dropdown.style.left = `${rect.left}px`;
        dropdown.style.top = `${rect.bottom + 4}px`;

        const memo = allVoiceMemos.find((m) => m.id === memoId);

        dropdown.innerHTML = `
    <input type="text" class="inbox-dropdown-search" placeholder="Search tracks..." oninput="filterInboxTrackDropdown(this.value, '${memoId}')">
    <div class="inbox-dropdown-items" id="inbox-track-items-${memoId}">
      <div class="inbox-dropdown-item ${
        !memo?.track_id ? "selected" : ""
      }" onclick="event.stopPropagation(); setMemoTrack('${memoId}', null)">
        <span style="color: var(--text-muted);">Unassigned</span>
      </div>
      ${allTracks
        .map(
          (t) => `
        <div class="inbox-dropdown-item ${
          memo?.track_id === t.id ? "selected" : ""
        }" onclick="event.stopPropagation(); setMemoTrack('${memoId}', '${
            t.id
          }')">
          ${escapeHtml(t.title)}
        </div>
      `
        )
        .join("")}
    </div>
  `;

        document.body.appendChild(dropdown);
        dropdown.querySelector(".inbox-dropdown-search").focus();
      }

      // Filter track dropdown
      function filterInboxTrackDropdown(query, memoId) {
        const container = document.getElementById(
          `inbox-track-items-${memoId}`
        );
        if (!container) return;

        const memo = allVoiceMemos.find((m) => m.id === memoId);
        const filtered = allTracks.filter((t) =>
          t.title.toLowerCase().includes(query.toLowerCase())
        );

        container.innerHTML = `
    <div class="inbox-dropdown-item ${
      !memo?.track_id ? "selected" : ""
    }" onclick="event.stopPropagation(); setMemoTrack('${memoId}', null)">
      <span style="color: var(--text-muted);">Unassigned</span>
    </div>
    ${filtered
      .map(
        (t) => `
      <div class="inbox-dropdown-item ${
        memo?.track_id === t.id ? "selected" : ""
      }" onclick="event.stopPropagation(); setMemoTrack('${memoId}', '${
          t.id
        }')">
        ${escapeHtml(t.title)}
      </div>
    `
      )
      .join("")}
  `;
      }

      // Set memo track
      async function setMemoTrack(memoId, trackId) {
        try {
          const { error } = await supabase
            .from("voice_memos")
            .update({ track_id: trackId })
            .eq("id", memoId);

          if (error) throw error;

          // Update local
          const memo = allVoiceMemos.find((m) => m.id === memoId);
          if (memo) memo.track_id = trackId;

          closeInboxDropdowns();
          filterInbox();
        } catch (err) {
          console.error("Error updating memo track:", err);
          showToast("Error updating track", "error");
        }
      }

      // Set memo excitement rating
      async function setMemoExcitement(memoId, rating) {
        const memo = allVoiceMemos.find((m) => m.id === memoId);
        if (!memo) return;

        // Toggle off if clicking same rating
        const newRating = memo.excitement === rating ? 0 : rating;

        try {
          const { error } = await supabase
            .from("voice_memos")
            .update({ excitement: newRating })
            .eq("id", memoId);

          if (error) throw error;

          memo.excitement = newRating;
          updateMemoStars(memoId, newRating);
        } catch (err) {
          console.error("Error updating memo excitement:", err);
          showToast("Error updating rating", "error");
        }
      }

      // Update stars display
      function updateMemoStars(memoId, rating) {
        const container = document.getElementById(`inbox-stars-${memoId}`);
        if (!container) return;

        const stars = container.querySelectorAll(".inbox-excitement-star");
        stars.forEach((star, i) => {
          if (i < rating) {
            star.classList.add("filled");
          } else {
            star.classList.remove("filled");
          }
        });
      }

      // Preview stars on hover
      function previewMemoStars(memoId, rating) {
        const container = document.getElementById(`inbox-stars-${memoId}`);
        if (!container) return;

        const stars = container.querySelectorAll(".inbox-excitement-star");
        stars.forEach((star, i) => {
          if (i < rating) {
            star.classList.add("filled");
          } else {
            star.classList.remove("filled");
          }
        });
      }

      // Reset stars to actual value
      function resetMemoStars(memoId) {
        const memo = allVoiceMemos.find((m) => m.id === memoId);
        if (!memo) return;

        updateMemoStars(memoId, memo.excitement || 0);
      }

      // Download memo
      function downloadMemo(id) {
        const memo = allVoiceMemos.find((m) => m.id === id);
        if (!memo?.audio_url) {
          showToast("No audio URL available", "error");
          return;
        }

        // Convert to direct download if Dropbox
        let url = memo.audio_url;
        if (url.includes("dropbox.com")) {
          url = url.includes("?") ? url + "&dl=1" : url + "?dl=1";
        }

        window.open(url, "_blank");
      }

      // Promote memo to track
      async function promoteToTrack(id) {
        const memo = allVoiceMemos.find((m) => m.id === id);
        if (!memo) return;

        if (
          !confirm(
            `Promote "${memo.title || "Untitled Memo"}" to a full track?`
          )
        ) {
          return;
        }

        try {
          // Create new idea_track from memo
          const newTrack = {
            title: memo.title || "Untitled Track",
            audio_url: memo.audio_url,
            dropbox_url: memo.audio_url,
            project_name: memo.project_name || null,
            notes: memo.notes || null,
            excitement: memo.excitement || 0,
            stage: "Idea",
            priority: "Medium",
            is_favorite: memo.is_favorite || false,
            created_at: memo.created_at,
          };

          const { data: track, error: trackError } = await supabase
            .from("idea_tracks")
            .insert(newTrack)
            .select()
            .single();

          if (trackError) throw trackError;

          // Delete the memo
          const { error: deleteError } = await supabase
            .from("voice_memos")
            .delete()
            .eq("id", id);

          if (deleteError) throw deleteError;

          // Update local state
          allVoiceMemos = allVoiceMemos.filter((m) => m.id !== id);
          allIdeas.unshift(track);

          updateInboxBadge();
          filterInbox();
          applyFilters();

          showToast("Promoted to track!");
        } catch (err) {
          console.error("Error promoting memo:", err);
          showToast("Error promoting memo: " + err.message, "error");
        }
      }

      // Get memos for a specific track (for Files tab)
      function getMemosForTrack(trackId) {
        return allVoiceMemos.filter((m) => m.track_id === trackId);
      }

      // Render file inbox section in Files tab
      function renderFileInbox(trackId) {
        const memos = getMemosForTrack(trackId);

        if (memos.length === 0) {
          return "";
        }

        return `
    <div class="file-inbox-section">
      <div class="file-inbox-header">
        <span class="file-inbox-title">Voice Memos</span>
      </div>
      ${memos
        .map(
          (memo) => `
        <div class="file-inbox-item" data-memo-id="${memo.id}">
          <div class="file-inbox-item-header">
            <span class="file-inbox-item-title">${escapeHtml(
              memo.title || "Untitled Memo"
            )}</span>
          </div>
          <div class="file-inbox-player">
            <button class="file-inbox-play-btn" onclick="playFileMemo('${
              memo.id
            }')" title="Play">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <polygon points="6 3 20 12 6 21 6 3"/>
              </svg>
            </button>
            <div class="file-inbox-progress" id="file-progress-${memo.id}">
              <div class="file-inbox-progress-fill" id="file-progress-fill-${
                memo.id
              }"></div>
            </div>
            <span class="file-inbox-time">${formatDuration(
              memo.duration
            )}</span>
            <button class="file-inbox-download" onclick="downloadMemo('${
              memo.id
            }')" title="Download">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
            </button>
          </div>
          ${
            memo.notes
              ? `<div class="file-inbox-notes">${escapeHtml(memo.notes)}</div>`
              : ""
          }
        </div>
      `
        )
        .join("")}
    </div>
  `;
      }

      // Play file memo in Files tab
      function playFileMemo(id) {
        const memo = allVoiceMemos.find((m) => m.id === id);
        if (!memo?.audio_url) {
          showToast("No audio URL available", "error");
          return;
        }

        // If clicking on currently playing memo, toggle play/pause
        if (currentMemoId === id && currentMemoAudio) {
          if (currentMemoAudio.paused) {
            currentMemoAudio.play();
            updateFileMemoPlayButton(id, true);
          } else {
            currentMemoAudio.pause();
            updateFileMemoPlayButton(id, false);
          }
          return;
        }

        // Stop main track player if playing
        if (audio && !audio.paused) {
          audio.pause();
          isPlaying = false;
          renderPlayerPanel();
        }

        // Stop current memo audio if playing different memo
        if (currentMemoAudio) {
          currentMemoAudio.pause();
          // Reset previous button
          if (currentMemoId) {
            updateFileMemoPlayButton(currentMemoId, false);
          }
        }

        currentMemoId = id;
        const streamUrl = getStreamableDropboxUrl(memo.audio_url);
        currentMemoAudio = new Audio(streamUrl);

        // Update progress bar
        currentMemoAudio.addEventListener("timeupdate", () => {
          const fill = document.getElementById(`file-progress-fill-${id}`);
          if (fill && currentMemoAudio.duration) {
            const percent =
              (currentMemoAudio.currentTime / currentMemoAudio.duration) * 100;
            fill.style.width = percent + "%";
          }
        });

        currentMemoAudio.addEventListener("ended", () => {
          const fill = document.getElementById(`file-progress-fill-${id}`);
          if (fill) fill.style.width = "0%";
          updateFileMemoPlayButton(id, false);
        });

        currentMemoAudio.addEventListener("play", () => {
          updateFileMemoPlayButton(id, true);
        });

        currentMemoAudio.addEventListener("pause", () => {
          updateFileMemoPlayButton(id, false);
        });

        currentMemoAudio.play().catch((err) => {
          console.error("Error playing memo:", err);
          showToast("Error playing audio", "error");
        });
      }

      // Update file memo play button icon
      function updateFileMemoPlayButton(memoId, isPlaying) {
        const item = document.querySelector(
          `.file-inbox-item[data-memo-id="${memoId}"]`
        );
        if (!item) return;

        const btn = item.querySelector(".file-inbox-play-btn");
        if (!btn) return;

        if (isPlaying) {
          btn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="currentColor">
        <rect x="6" y="4" width="4" height="16"/>
        <rect x="14" y="4" width="4" height="16"/>
      </svg>
    `;
          btn.title = "Pause";
        } else {
          btn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="currentColor">
        <polygon points="6 3 20 12 6 21 6 3"/>
      </svg>
    `;
          btn.title = "Play";
        }
      }

      // ============ SHARE SYSTEM ============

      let shareModalTrackIds = [];
      let generatedShareLink = null;

      async function shareIdea(id) {
        shareModalTrackIds = [id];
        openShareModal();
      }

      function openShareModal(trackIds = null) {
        if (trackIds) {
          shareModalTrackIds = trackIds;
        } else if (shareModalTrackIds.length === 0) {
          // Use current filtered ideas
          shareModalTrackIds = filteredIdeas.map((i) => i.id);
        }

        if (shareModalTrackIds.length === 0) {
          showToast("No tracks to share");
          return;
        }

        generatedShareLink = null;

        const tracks = shareModalTrackIds
          .map((id) => allIdeas.find((i) => i.id === id))
          .filter(Boolean);
        const isSingleTrack = tracks.length === 1;

        let modal = document.getElementById("share-modal");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "share-modal";
          modal.className = "modal-overlay";
          modal.onclick = (e) => {
            if (e.target === modal) closeShareModal();
          };
          document.body.appendChild(modal);
        }

        const defaultName = isSingleTrack
          ? tracks[0].title
          : `${tracks.length} Selected Tracks`;

        modal.innerHTML = `
    <div class="modal-content share-modal">
      <div class="modal-header">
        <h3>${isSingleTrack ? "Share Track" : "Share Playlist"}</h3>
        <button class="modal-close" onclick="closeShareModal()">Ã—</button>
      </div>
      <div class="modal-body">
        ${
          isSingleTrack
            ? `
          <div class="share-modal-preview">
            <div class="share-preview-art">
              ${generateAlbumArt(
                tracks[0].title,
                tracks[0].tags || "",
                tracks[0].project_name || ""
              )}
            </div>
            <div class="share-preview-info">
              <div class="share-preview-title">${escapeHtml(
                tracks[0].title
              )}</div>
              <div class="share-preview-meta">${escapeHtml(
                tracks[0].project_name || "Unassigned"
              )}</div>
            </div>
          </div>
        `
            : `
          <div class="share-section">
            <div class="share-section-title">Playlist Name</div>
            <input type="text" class="metadata-input" id="share-playlist-name" 
                   placeholder="Enter playlist name..." value="${escapeHtml(
                     defaultName
                   )}">
          </div>
          <div class="share-section">
            <div class="share-section-title">Tracks (${tracks.length})</div>
            <div class="share-tracks-list">
              ${tracks
                .map(
                  (t) => `
                <div class="share-track-item">
                  <div class="share-track-art">
                    ${generateAlbumArt(
                      t.title,
                      t.tags || "",
                      t.project_name || ""
                    )}
                  </div>
                  <div class="share-track-title">${escapeHtml(t.title)}</div>
                </div>
              `
                )
                .join("")}
            </div>
          </div>
        `
        }
        
        <div class="share-section">
          <div class="share-section-title">Downloadables</div>
          <div class="share-options">
            <label class="share-option">
              <input type="checkbox" id="share-dl-audio" checked>
              <div>
                <div class="share-option-label">Audio Files</div>
                <div class="share-option-desc">Allow downloading audio bounces</div>
              </div>
            </label>
            <label class="share-option">
              <input type="checkbox" id="share-dl-project">
              <div>
                <div class="share-option-label">Project Files</div>
                <div class="share-option-desc">Show project file paths (if available)</div>
              </div>
            </label>
          </div>
        </div>
        
        <div class="share-section">
          <div class="share-section-title">Visible Info</div>
          <div class="share-options">
            <label class="share-option">
              <input type="checkbox" id="share-show-stage" checked>
              <div class="share-option-label">Stage</div>
            </label>
            <label class="share-option">
              <input type="checkbox" id="share-show-tags" checked>
              <div class="share-option-label">Tags / Workflows</div>
            </label>
            <label class="share-option">
              <input type="checkbox" id="share-show-collaborators">
              <div class="share-option-label">Collaborators</div>
            </label>
          </div>
        </div>
        
        <div id="share-link-section" style="display: none;">
          <div class="share-section-title">Share Link</div>
          <div class="share-link-container">
            <input type="text" class="share-link-input" id="share-link-input" readonly>
            <button class="share-copy-btn" onclick="copyShareLink()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
              Copy
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeShareModal()">Cancel</button>
        <button class="btn btn-primary" id="share-generate-btn" onclick="generateShareLink()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
            <circle cx="18" cy="5" r="3"/>
            <circle cx="6" cy="12" r="3"/>
            <circle cx="18" cy="19" r="3"/>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
          </svg>
          Generate Link
        </button>
      </div>
    </div>
  `;

        modal.classList.add("open");
      }

      function closeShareModal() {
        const modal = document.getElementById("share-modal");
        if (modal) modal.classList.remove("open");
        shareModalTrackIds = [];
        generatedShareLink = null;
      }

      async function generateShareLink() {
        const isSingleTrack = shareModalTrackIds.length === 1;
        const name = isSingleTrack
          ? allIdeas.find((i) => i.id === shareModalTrackIds[0])?.title ||
            "Shared Track"
          : document.getElementById("share-playlist-name")?.value?.trim() ||
            "Shared Playlist";

        const shareData = {
          name: name,
          track_ids: shareModalTrackIds,
          allow_audio_download:
            document.getElementById("share-dl-audio")?.checked ?? true,
          allow_project_download:
            document.getElementById("share-dl-project")?.checked ?? false,
          show_stage:
            document.getElementById("share-show-stage")?.checked ?? true,
          show_tags:
            document.getElementById("share-show-tags")?.checked ?? true,
          show_collaborators:
            document.getElementById("share-show-collaborators")?.checked ??
            false,
          created_at: new Date().toISOString(),
        };

        try {
          const { data, error } = await supabase
            .from("share_links")
            .insert(shareData)
            .select()
            .single();

          if (error) throw error;

          generatedShareLink = `${window.location.origin}/share.html?id=${data.id}`;

          // Show the link section
          document.getElementById("share-link-section").style.display = "block";
          document.getElementById("share-link-input").value =
            generatedShareLink;

          // Update button to show success
          const btn = document.getElementById("share-generate-btn");
          btn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
      Link Generated!
    `;
          btn.disabled = true;

          showToast("Share link generated!");
        } catch (err) {
          console.error("Error generating share link:", err);
          showToast("Error generating link: " + err.message, "error");
        }
      }

      function copyShareLink() {
        const input = document.getElementById("share-link-input");
        if (input && input.value) {
          navigator.clipboard
            .writeText(input.value)
            .then(() => {
              showToast("Link copied to clipboard!");
            })
            .catch(() => {
              // Fallback
              input.select();
              document.execCommand("copy");
              showToast("Link copied!");
            });
        }
      }

      // Update share button visibility based on current view
      function updateShareButtonVisibility() {
        const btn = document.getElementById("share-selection-btn");
        if (btn) {
          const hasTracksToShare = filteredIdeas.length > 0;
          btn.classList.toggle("visible", hasTracksToShare);
          btn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="18" cy="5" r="3"/>
        <circle cx="6" cy="12" r="3"/>
        <circle cx="18" cy="19" r="3"/>
        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
      </svg>
      Share${filteredIdeas.length > 1 ? ` (${filteredIdeas.length})` : ""}
    `;
        }
      }

      // Toggle archive status
      async function toggleArchive(id) {
        const idea = allIdeas.find((i) => i.id === id);
        if (!idea) return;

        const newArchiveState = !idea.is_archived;

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ is_archived: newArchiveState })
            .eq("id", id);

          if (error && error.message) throw error;

          // Update local state
          idea.is_archived = newArchiveState;
          if (currentIdea?.id === id) {
            currentIdea.is_archived = newArchiveState;
          }

          // If we just archived and we're not viewing Archive, remove from filtered list
          if (newArchiveState && currentProject !== "Archive") {
            applyFilters();
          }

          renderIdeasTable();
          renderPlayerPanel();
          renderProjectList();

          // Show feedback
          showToast(
            newArchiveState ? "Moved to Archive" : "Restored from Archive"
          );
        } catch (err) {
          console.error("Error toggling archive:", err);
          alert(
            "Failed to update archive status: " +
              (err.message || "Unknown error")
          );
        }
      }

      // Open in Dropbox
      function openInDropbox() {
        if (currentIdea?.dropbox_url) {
          const previewUrl = currentIdea.dropbox_url.replace("dl=1", "dl=0");
          window.open(previewUrl, "_blank");
        }
      }

      // Open Project folder using local server
      function openProject() {
        if (currentIdea?.project_folder_path) {
          // Build the local file path for Dropbox
          const localPath =
            "/Users/arnsmacbook/Dropbox/Apps/IdeaVault" +
            currentIdea.project_folder_path;

          console.log("Opening folder:", localPath);

          // Call local server to open folder
          fetch(
            "http://localhost:9123/open?path=" + encodeURIComponent(localPath)
          ).catch(() => {
            alert(
              "Folder opener not running. Start it with:\npython3 ~/open-folder-server.py &"
            );
          });
        }
      }

      // Project file linking functions
      function openProjectFile() {
        if (currentIdea?.project_file_path) {
          const filePath = currentIdea.project_file_path;

          console.log("Opening project file:", filePath);

          // Call local server to open the file
          fetch(
            "http://localhost:9123/open?path=" + encodeURIComponent(filePath)
          ).catch(() => {
            alert(
              "File opener not running. Start it with:\npython3 ~/open-folder-server.py &"
            );
          });
        }
      }

      function showProjectFileInput() {
        const row = document.getElementById("project-file-input-row");
        if (row) {
          row.style.display = "flex";
          const input = document.getElementById("project-file-path-input");
          if (input) input.focus();
        }
      }

      function hideProjectFileInput() {
        const row = document.getElementById("project-file-input-row");
        if (row) row.style.display = "none";
      }

      async function saveProjectFilePath() {
        if (!currentIdea) return;

        const pathInput = document.getElementById("project-file-path-input");
        const dropboxInput = document.getElementById(
          "project-dropbox-url-input"
        );
        const newPath = pathInput?.value?.trim() || null;
        const newDropboxUrl = dropboxInput?.value?.trim() || null;

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({
              project_file_path: newPath,
              project_dropbox_url: newDropboxUrl,
            })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.project_file_path = newPath;
          currentIdea.project_dropbox_url = newDropboxUrl;
          const idx = allIdeas.findIndex((i) => i.id === currentIdea.id);
          if (idx !== -1) {
            allIdeas[idx].project_file_path = newPath;
            allIdeas[idx].project_dropbox_url = newDropboxUrl;
          }

          hideProjectFileInput();
          renderPlayerPanel();
          showToast(newPath ? "Project file linked" : "Project file removed");
        } catch (err) {
          console.error("Error saving project file path:", err);
          alert("Error: " + err.message);
        }
      }

      // ============ EXCITEMENT RATING ============

      async function setExcitement(level) {
        if (!currentIdea) return;

        // If clicking the same level, toggle it off
        const newLevel = currentIdea.excitement === level ? 0 : level;

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ excitement: newLevel })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.excitement = newLevel;
          renderPlayerPanel();
          renderIdeasTable();
        } catch (err) {
          console.error("Error setting excitement:", err);
        }
      }

      function previewExcitement(level) {
        const stars = document.querySelectorAll(".excitement-star");
        stars.forEach((star, i) => {
          star.classList.toggle("hovered", i < level);
        });
      }

      function resetExcitementPreview() {
        const stars = document.querySelectorAll(".excitement-star");
        const currentLevel = currentIdea?.excitement || 0;
        stars.forEach((star, i) => {
          star.classList.remove("hovered");
        });
      }

      // ============ FILE UPLOAD ============

      // Setup drag and drop
      function setupUploadZone() {
        const uploadZone = document.getElementById("upload-zone");

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          uploadZone.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });

        ["dragenter", "dragover"].forEach((eventName) => {
          uploadZone.addEventListener(
            eventName,
            () => uploadZone.classList.add("dragover"),
            false
          );
        });

        ["dragleave", "drop"].forEach((eventName) => {
          uploadZone.addEventListener(
            eventName,
            () => uploadZone.classList.remove("dragover"),
            false
          );
        });

        uploadZone.addEventListener("drop", handleDrop, false);
      }

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      function handleDrop(e) {
        const files = e.dataTransfer.files;
        handleFiles(files);
      }

      function handleFileSelect(e) {
        const files = e.target.files;
        handleFiles(files);
      }

      async function handleFiles(files) {
        const audioFiles = Array.from(files).filter((f) =>
          f.type.startsWith("audio/")
        );

        if (audioFiles.length === 0) {
          alert("Please drop audio files (WAV, MP3, M4A, etc.)");
          return;
        }

        const progressEl = document.getElementById("upload-progress");

        for (let i = 0; i < audioFiles.length; i++) {
          const file = audioFiles[i];
          progressEl.textContent = `Uploading ${i + 1}/${audioFiles.length}: ${
            file.name
          }`;

          try {
            await uploadAudioFile(file);
          } catch (err) {
            console.error("Upload failed:", err);
            progressEl.textContent = `Failed: ${file.name}`;
            await new Promise((r) => setTimeout(r, 2000));
          }
        }

        progressEl.textContent = `âœ“ Uploaded ${audioFiles.length} file(s)`;
        setTimeout(() => {
          progressEl.textContent = "";
        }, 3000);

        // Reload ideas
        await loadIdeas();
      }

      async function uploadAudioFile(file) {
        // Generate a unique ID for this idea
        const ideaId = crypto.randomUUID();

        // Clean filename for storage
        const cleanName = file.name.replace(/[^a-zA-Z0-9.-]/g, "-");
        const storagePath = `${ideaId}/${cleanName}`;

        // Upload to Supabase Storage
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from("idea-bounces")
          .upload(storagePath, file, {
            contentType: file.type,
            upsert: true,
          });

        if (uploadError) throw uploadError;

        // Get public URL
        const { data: urlData } = supabase.storage
          .from("idea-bounces")
          .getPublicUrl(storagePath);

        // Create database entry
        const title = file.name.replace(/\.[^/.]+$/, "").replace(/[-_]/g, " ");

        // Get collaborators - first detect from title, then add defaults
        let collaborators = detectCollaboratorsFromTitle(title);
        if (collaborators.length === 0) {
          collaborators = getDefaultCollaborators();
        }

        const { error: dbError } = await supabase.from("idea_tracks").insert({
          id: ideaId,
          title: title,
          supabase_url: urlData.publicUrl,
          project_name: "Unassigned",
          is_favorite: false,
          is_archived: false,
          excitement: 0,
          collaborators: collaborators.length > 0 ? collaborators : null,
        });

        if (dbError) throw dbError;
      }

      // Play an idea
      // Loading state
      let isLoading = false;
      let currentVersions = []; // All versions of current track

      window.playIdea = function (id) {
        const idea = allIdeas.find((i) => i.id === id);
        if (!idea) return;

        // Stop any playing memo audio
        if (currentMemoAudio) {
          currentMemoAudio.pause();
          if (currentMemoId) {
            updateFileMemoPlayButton(currentMemoId, false);
          }
        }

        currentIdea = idea;
        isLoading = true;
        isPlaying = false;

        // Load comments and bookmarks for this track
        loadComments(id);
        loadBookmarks(id);
        currentBookmarkTab = "general"; // Reset to general tab

        // Find all versions of this track (same base_name)
        if (idea.base_name) {
          currentVersions = allIdeas
            .filter(
              (i) =>
                i.base_name &&
                i.base_name.toLowerCase() === idea.base_name.toLowerCase()
            )
            .sort((a, b) => {
              // Sort by version number descending (newest first)
              const vA = parseFloat(a.version) || 0;
              const vB = parseFloat(b.version) || 0;
              return vB - vA;
            });
          console.log(
            `Found ${currentVersions.length} versions for "${idea.base_name}":`,
            currentVersions.map((v) => v.version)
          );
        } else {
          currentVersions = [idea];
          console.log("No base_name, single version only");
        }

        // Update table to show playing state
        renderIdeasTable();
        renderPlayerPanel();

        // Prefer supabase_url (direct playback), fallback to dropbox_url
        const audioUrl = idea.supabase_url || idea.dropbox_url;

        if (audioUrl) {
          // Reset audio
          audio.pause();
          audio.currentTime = 0;

          // Set source and try to play
          audio.src = audioUrl;
          audio.load();

          audio
            .play()
            .then(() => {
              isLoading = false;
              isPlaying = true;
              renderPlayerPanel();
            })
            .catch((err) => {
              console.error("Playback error:", err);
              isLoading = false;
              isPlaying = false;
              renderPlayerPanel();
            });
        } else {
          isLoading = false;
          renderPlayerPanel();
        }
      };

      // Switch to a different version
      window.switchVersion = function (versionId) {
        const version = currentVersions.find((v) => v.id === versionId);
        if (version) {
          closeVersionDropdown();
          window.playIdea(version.id);
        }
      };

      // ============ VERSION DROPDOWN ============

      let versionDropdownOpen = false;

      function toggleVersionDropdown(event) {
        event.stopPropagation();

        if (versionDropdownOpen) {
          closeVersionDropdown();
          return;
        }

        // Close other dropdowns
        closeAllStageDropdowns();
        closeAllPriorityDropdowns();
        closeAllProjectDropdowns();
        closeAllTagsDropdowns();

        const wrapper = event.currentTarget.parentElement;

        // Create dropdown
        const dropdown = document.createElement("div");
        dropdown.className = "version-dropdown";
        dropdown.id = "version-dropdown-active";

        if (currentVersions.length > 1) {
          dropdown.innerHTML = currentVersions
            .map(
              (v) => `
      <div class="version-dropdown-item ${
        v.id === currentIdea.id ? "active" : ""
      }" 
           onclick="event.stopPropagation(); switchVersion('${v.id}')">
        <span>v${v.version || "1.0"}</span>
        ${v.id === currentIdea.id ? '<span class="version-check">âœ“</span>' : ""}
      </div>
    `
            )
            .join("");
        } else {
          dropdown.innerHTML = `
      <div class="version-dropdown-empty">
        Only one version exists.<br>
        Upload more versions with the same base name to see them here.
      </div>
    `;
        }

        wrapper.appendChild(dropdown);
        versionDropdownOpen = true;

        // Close on outside click
        setTimeout(() => {
          document.addEventListener(
            "click",
            closeVersionDropdownOnOutsideClick
          );
        }, 10);
      }

      function closeVersionDropdown() {
        const dropdown = document.getElementById("version-dropdown-active");
        if (dropdown) dropdown.remove();
        versionDropdownOpen = false;
        document.removeEventListener(
          "click",
          closeVersionDropdownOnOutsideClick
        );
      }

      function closeVersionDropdownOnOutsideClick(event) {
        if (
          !event.target.closest(".version-dropdown") &&
          !event.target.closest(".version-selector-btn")
        ) {
          closeVersionDropdown();
        }
      }

      // ============ STAGE SYSTEM ============

      function getStage(stageId) {
        return STAGES.find((s) => s.id === stageId) || STAGES[0];
      }

      function renderStageIndicator(idea) {
        const stage = getStage(idea.stage || "seed");
        const circumference = 2 * Math.PI * 17; // radius 17
        const offset = circumference - (stage.progress / 100) * circumference;

        return `
    <div class="stage-cell">
      <div class="stage-indicator stage-${stage.id}" data-idea-id="${idea.id}" onclick="event.stopPropagation(); toggleStageDropdown(event, '${idea.id}')">
        <svg class="stage-ring" viewBox="0 0 40 40">
          <circle class="stage-ring-bg" cx="20" cy="20" r="17"/>
          <circle class="stage-ring-progress" cx="20" cy="20" r="17" 
                  stroke-dasharray="${circumference}" 
                  stroke-dashoffset="${offset}"
                  style="stroke: ${stage.color};"/>
        </svg>
        <span class="stage-icon">${stage.icon}</span>
      </div>
    </div>
  `;
      }

      function toggleStageDropdown(event, ideaId) {
        event.preventDefault();
        event.stopPropagation();

        // Close any existing dropdown
        closeAllStageDropdowns();
        closeAllPriorityDropdowns();

        const idea = allIdeas.find((i) => i.id === ideaId);
        if (!idea) return;

        const stage = getStage(idea.stage || "seed");

        // Add class to body to disable table interactions
        document.body.classList.add("dropdown-open");

        // Create overlay to capture all clicks and mouse events
        const overlay = document.createElement("div");
        overlay.id = "stage-dropdown-overlay";
        overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9998;
    background: rgba(0,0,0,0.3);
    cursor: default;
  `;
        overlay.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeAllStageDropdowns();
          closeAllPriorityDropdowns();
        };
        document.body.appendChild(overlay);

        // Create dropdown
        const dropdown = document.createElement("div");
        dropdown.id = "stage-dropdown-active";
        dropdown.className = "stage-dropdown";
        dropdown.onclick = (e) => e.stopPropagation();
        dropdown.innerHTML = STAGES.map(
          (s) => `
    <div class="stage-dropdown-item ${s.id === stage.id ? "active" : ""}" 
         onclick="event.stopPropagation(); setStage('${idea.id}', '${s.id}')">
      <span class="stage-dropdown-icon">${s.icon}</span>
      <div class="stage-dropdown-info">
        <div class="stage-dropdown-name">${s.name}</div>
        <div class="stage-dropdown-desc">${s.desc}</div>
      </div>
      ${s.id === stage.id ? '<span class="stage-dropdown-check">âœ“</span>' : ""}
    </div>
  `
        ).join("");

        // Position dropdown near click
        const rect = event.currentTarget.getBoundingClientRect();
        dropdown.style.top = rect.bottom + 8 + "px";
        dropdown.style.left = rect.left + rect.width / 2 - 100 + "px"; // Center it

        // Add to body
        document.body.appendChild(dropdown);

        // Make sure it's on screen
        const dropdownRect = dropdown.getBoundingClientRect();
        if (dropdownRect.right > window.innerWidth) {
          dropdown.style.left =
            window.innerWidth - dropdownRect.width - 16 + "px";
        }
        if (dropdownRect.left < 0) {
          dropdown.style.left = "16px";
        }
        if (dropdownRect.bottom > window.innerHeight) {
          dropdown.style.top = rect.top - dropdownRect.height - 8 + "px";
        }

        activeStageDropdown = ideaId;
      }

      function closeAllStageDropdowns() {
        document.body.classList.remove("dropdown-open");

        const overlay = document.getElementById("stage-dropdown-overlay");
        if (overlay) overlay.remove();

        const dropdown = document.getElementById("stage-dropdown-active");
        if (dropdown) dropdown.remove();

        activeStageDropdown = null;
      }

      async function setStage(ideaId, stageId) {
        closeAllStageDropdowns();
        closeAllPriorityDropdowns();

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ stage: stageId })
            .eq("id", ideaId);

          if (error) throw error;

          // Update local data
          const idea = allIdeas.find((i) => i.id === ideaId);
          if (idea) idea.stage = stageId;

          if (currentIdea?.id === ideaId) {
            currentIdea.stage = stageId;
          }

          renderIdeasTable();
        } catch (err) {
          console.error("Error updating stage:", err);
        }
      }

      // ============ PROJECT DROPDOWN ============

      let activeProjectDropdown = null;

      function toggleProjectDropdown(event, ideaId) {
        event.stopPropagation();

        // Close any other dropdowns
        closeAllProjectDropdowns();
        closeAllTagsDropdowns();
        closeAllStageDropdowns();
        closeAllPriorityDropdowns();

        if (activeProjectDropdown === ideaId) {
          closeAllProjectDropdowns();
          return;
        }

        const idea = allIdeas.find((i) => i.id === ideaId);
        if (!idea) return;

        // Get current projects for this idea
        const currentProjects = (idea.project_name || "")
          .split(",")
          .map((p) => p.trim())
          .filter((p) => p && p !== "Unassigned");

        // Add class to body to disable table interactions
        document.body.classList.add("dropdown-open");

        // Create overlay
        const overlay = document.createElement("div");
        overlay.id = "project-dropdown-overlay";
        overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9998;
    background: rgba(0,0,0,0.3);
    cursor: default;
  `;
        overlay.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeAllProjectDropdowns();
        };
        document.body.appendChild(overlay);

        // Create dropdown
        const dropdown = document.createElement("div");
        dropdown.id = "project-dropdown-active";
        dropdown.className = "project-dropdown";
        dropdown.onclick = (e) => e.stopPropagation();

        const checkSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`;

        // Get all projects
        const projectsList = getProjects();

        dropdown.innerHTML = projectsList
          .map((proj) => {
            const isSelected = currentProjects.some(
              (p) => p.toLowerCase() === proj.name.toLowerCase()
            );
            const color = getProjectColor(proj.name);
            return `
      <div class="project-dropdown-item ${isSelected ? "selected" : ""}" 
           onclick="event.stopPropagation(); toggleProjectSelection('${
             idea.id
           }', '${escapeHtml(proj.name)}')">
        <div class="project-dropdown-checkbox">${checkSvg}</div>
        <div class="project-dropdown-thumb" style="background: ${color};"></div>
        <span class="project-dropdown-name">${escapeHtml(proj.name)}</span>
      </div>
    `;
          })
          .join("");

        // Position dropdown near click
        const rect = event.currentTarget.getBoundingClientRect();
        dropdown.style.top = rect.bottom + 4 + "px";
        dropdown.style.left = rect.left + "px";

        document.body.appendChild(dropdown);

        // Make sure it's on screen
        const dropdownRect = dropdown.getBoundingClientRect();
        if (dropdownRect.right > window.innerWidth) {
          dropdown.style.left =
            window.innerWidth - dropdownRect.width - 16 + "px";
        }
        if (dropdownRect.bottom > window.innerHeight) {
          dropdown.style.top = rect.top - dropdownRect.height - 4 + "px";
        }

        activeProjectDropdown = ideaId;
      }

      function closeAllProjectDropdowns() {
        document.body.classList.remove("dropdown-open");

        const overlay = document.getElementById("project-dropdown-overlay");
        if (overlay) overlay.remove();

        const dropdown = document.getElementById("project-dropdown-active");
        if (dropdown) dropdown.remove();

        activeProjectDropdown = null;
      }

      // ============ PRIORITY DROPDOWN ============

      const PRIORITY_OPTIONS = [
        { id: "high", label: "High", color: "#ef4444" },
        { id: "medium", label: "Medium", color: "#f59e0b" },
        { id: "low", label: "Low", color: "#6b7280" },
      ];

      let activePriorityDropdown = null;

      function togglePriorityDropdown(event, ideaId) {
        event.stopPropagation();

        // Close any other dropdowns
        closeAllProjectDropdowns();
        closeAllTagsDropdowns();
        closeAllStageDropdowns();
        closeAllPriorityDropdowns();
        closeAllPriorityDropdowns();

        if (activePriorityDropdown === ideaId) {
          closeAllPriorityDropdowns();
          return;
        }

        const idea = allIdeas.find((i) => i.id === ideaId);
        if (!idea) return;

        const currentPriority = idea.priority?.toLowerCase() || "";

        // Add class to body to disable table interactions
        document.body.classList.add("dropdown-open");

        // Create overlay
        const overlay = document.createElement("div");
        overlay.id = "priority-dropdown-overlay";
        overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9998;
    background: rgba(0,0,0,0.3);
    cursor: default;
  `;
        overlay.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeAllPriorityDropdowns();
        };
        document.body.appendChild(overlay);

        // Create dropdown
        const dropdown = document.createElement("div");
        dropdown.id = "priority-dropdown-active";
        dropdown.className = "priority-dropdown";
        dropdown.onclick = (e) => e.stopPropagation();

        const checkSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`;

        dropdown.innerHTML = `
    ${PRIORITY_OPTIONS.map((opt) => {
      const isSelected = currentPriority === opt.id;
      return `
        <div class="priority-dropdown-item ${isSelected ? "selected" : ""}" 
             onclick="event.stopPropagation(); setPriorityForIdea('${
               idea.id
             }', '${opt.id}')">
          <div class="priority-dropdown-checkbox">${checkSvg}</div>
          <div class="priority-dropdown-dot" style="background: ${
            opt.color
          };"></div>
          <span class="priority-dropdown-name">${opt.label}</span>
        </div>
      `;
    }).join("")}
    <div class="priority-dropdown-divider"></div>
    <div class="priority-dropdown-item ${!currentPriority ? "selected" : ""}" 
         onclick="event.stopPropagation(); setPriorityForIdea('${
           idea.id
         }', '')">
      <div class="priority-dropdown-checkbox">${checkSvg}</div>
      <span class="priority-dropdown-name" style="color: var(--text-muted);">No Priority</span>
    </div>
  `;

        // Position dropdown near click
        const rect = event.currentTarget.getBoundingClientRect();
        dropdown.style.top = rect.bottom + 4 + "px";
        dropdown.style.left = rect.left + "px";

        document.body.appendChild(dropdown);

        // Make sure it's on screen
        const dropdownRect = dropdown.getBoundingClientRect();
        if (dropdownRect.right > window.innerWidth) {
          dropdown.style.left =
            window.innerWidth - dropdownRect.width - 16 + "px";
        }
        if (dropdownRect.bottom > window.innerHeight) {
          dropdown.style.top = rect.top - dropdownRect.height - 4 + "px";
        }

        activePriorityDropdown = ideaId;
      }

      function closeAllPriorityDropdowns() {
        document.body.classList.remove("dropdown-open");

        const overlay = document.getElementById("priority-dropdown-overlay");
        if (overlay) overlay.remove();

        const dropdown = document.getElementById("priority-dropdown-active");
        if (dropdown) dropdown.remove();

        activePriorityDropdown = null;
      }

      async function setPriorityForIdea(ideaId, priority) {
        const idea = allIdeas.find((i) => i.id === ideaId);
        if (!idea) return;

        const priorityValue = priority
          ? priority.charAt(0).toUpperCase() + priority.slice(1)
          : null;

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ priority: priorityValue })
            .eq("id", ideaId);

          if (error) throw error;

          // Update local data
          idea.priority = priorityValue;
          if (currentIdea?.id === ideaId) {
            currentIdea.priority = priorityValue;
          }

          closeAllPriorityDropdowns();
          renderIdeasTable();
        } catch (err) {
          console.error("Error updating priority:", err);
        }
      }

      async function toggleProjectSelection(ideaId, projectName) {
        const idea = allIdeas.find((i) => i.id === ideaId);
        if (!idea) return;

        // Get current projects
        let currentProjects = (idea.project_name || "")
          .split(",")
          .map((p) => p.trim())
          .filter((p) => p && p !== "Unassigned");

        // Toggle selection
        const index = currentProjects.findIndex(
          (p) => p.toLowerCase() === projectName.toLowerCase()
        );
        if (index >= 0) {
          currentProjects.splice(index, 1);
        } else {
          currentProjects.push(projectName);
        }

        // If no projects, set to Unassigned
        const newProjectName =
          currentProjects.length > 0
            ? currentProjects.join(", ")
            : "Unassigned";

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ project_name: newProjectName })
            .eq("id", ideaId);

          if (error) throw error;

          // Update local data
          idea.project_name = newProjectName;
          if (currentIdea?.id === ideaId) {
            currentIdea.project_name = newProjectName;
          }

          // Re-render dropdown to show updated selection
          closeAllProjectDropdowns();

          // Small delay to let the animation finish before re-opening
          setTimeout(() => {
            const row = document.querySelector(`tr[onclick*="${ideaId}"]`);
            if (row) {
              const projectCell = row.querySelector(".idea-project-clickable");
              if (projectCell) {
                const fakeEvent = {
                  stopPropagation: () => {},
                  currentTarget: projectCell,
                  preventDefault: () => {},
                };
                toggleProjectDropdown(fakeEvent, ideaId);
              }
            }
          }, 50);

          renderIdeasTable();
          renderProjectList();
        } catch (err) {
          console.error("Error updating projects:", err);
        }
      }

      // ============ TAGS DROPDOWN ============

      let activeTagsDropdown = null;
      let allUniqueTags = [];

      function getAllUniqueTags() {
        const tagSet = new Set();
        allIdeas.forEach((idea) => {
          if (idea.tags) {
            idea.tags
              .split(",")
              .map((t) => t.trim())
              .filter((t) => t)
              .forEach((t) => tagSet.add(t));
          }
        });
        return Array.from(tagSet).sort((a, b) =>
          a.toLowerCase().localeCompare(b.toLowerCase())
        );
      }

      function toggleTagsDropdown(event, ideaId) {
        event.stopPropagation();

        // Close any other dropdowns
        closeAllTagsDropdowns();
        closeAllProjectDropdowns();
        closeAllStageDropdowns();
        closeAllPriorityDropdowns();

        if (activeTagsDropdown === ideaId) {
          closeAllTagsDropdowns();
          return;
        }

        const idea = allIdeas.find((i) => i.id === ideaId);
        if (!idea) return;

        // Get current tags for this idea
        const currentTags = (idea.tags || "")
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t);

        // Get all unique tags
        allUniqueTags = getAllUniqueTags();

        // Add class to body to disable table interactions
        document.body.classList.add("dropdown-open");

        // Create overlay
        const overlay = document.createElement("div");
        overlay.id = "tags-dropdown-overlay";
        overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9998;
    background: rgba(0,0,0,0.3);
    cursor: default;
  `;
        overlay.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeAllTagsDropdowns();
        };
        document.body.appendChild(overlay);

        // Create dropdown
        const dropdown = document.createElement("div");
        dropdown.id = "tags-dropdown-active";
        dropdown.className = "tags-dropdown";
        dropdown.onclick = (e) => e.stopPropagation();

        renderTagsDropdownContent(dropdown, ideaId, currentTags, "");

        // Position dropdown near click
        const rect = event.currentTarget.getBoundingClientRect();
        dropdown.style.top = rect.bottom + 4 + "px";
        dropdown.style.left = rect.left + "px";

        document.body.appendChild(dropdown);

        // Make sure it's on screen
        const dropdownRect = dropdown.getBoundingClientRect();
        if (dropdownRect.right > window.innerWidth) {
          dropdown.style.left =
            window.innerWidth - dropdownRect.width - 16 + "px";
        }
        if (dropdownRect.bottom > window.innerHeight) {
          dropdown.style.top = rect.top - dropdownRect.height - 4 + "px";
        }

        // Focus search input
        const searchInput = dropdown.querySelector("input");
        if (searchInput) searchInput.focus();

        activeTagsDropdown = ideaId;
      }

      function renderTagsDropdownContent(
        dropdown,
        ideaId,
        currentTags,
        searchFilter
      ) {
        const checkSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>`;

        // Filter tags by search
        const filteredTags = searchFilter
          ? allUniqueTags.filter((t) =>
              t.toLowerCase().includes(searchFilter.toLowerCase())
            )
          : allUniqueTags;

        // Check if search term is a new tag
        const isNewTag =
          searchFilter &&
          !allUniqueTags.some(
            (t) => t.toLowerCase() === searchFilter.toLowerCase()
          );

        dropdown.innerHTML = `
    <div class="tags-dropdown-search">
      <input type="text" placeholder="Search or create tag..." value="${escapeHtml(
        searchFilter
      )}" 
             oninput="handleTagsSearch('${ideaId}', this.value)"
             onkeydown="handleTagsKeydown(event, '${ideaId}', this.value)">
    </div>
    ${filteredTags
      .map((tag) => {
        const isSelected = currentTags.some(
          (t) => t.toLowerCase() === tag.toLowerCase()
        );
        return `
        <div class="tags-dropdown-item ${isSelected ? "selected" : ""}" 
             onclick="event.stopPropagation(); toggleTagSelection('${ideaId}', '${escapeHtml(
          tag
        )}')">
          <div class="tags-dropdown-checkbox">${checkSvg}</div>
          <span class="tags-dropdown-name">${escapeHtml(tag)}</span>
        </div>
      `;
      })
      .join("")}
    ${
      isNewTag
        ? `
      <div class="tags-dropdown-create" onclick="event.stopPropagation(); createAndSelectTag('${ideaId}', '${escapeHtml(
            searchFilter
          )}')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Create "${escapeHtml(searchFilter)}"
      </div>
    `
        : ""
    }
  `;
      }

      function handleTagsSearch(ideaId, searchValue) {
        const idea = allIdeas.find((i) => i.id === ideaId);
        if (!idea) return;

        const currentTags = (idea.tags || "")
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t);
        const dropdown = document.getElementById("tags-dropdown-active");
        if (dropdown) {
          renderTagsDropdownContent(dropdown, ideaId, currentTags, searchValue);
          // Keep focus on input
          const input = dropdown.querySelector("input");
          if (input) {
            input.focus();
            input.setSelectionRange(searchValue.length, searchValue.length);
          }
        }
      }

      function handleTagsKeydown(event, ideaId, searchValue) {
        if (event.key === "Enter" && searchValue.trim()) {
          event.preventDefault();
          const isNewTag = !allUniqueTags.some(
            (t) => t.toLowerCase() === searchValue.toLowerCase()
          );
          if (isNewTag) {
            createAndSelectTag(ideaId, searchValue.trim());
          }
        }
      }

      function closeAllTagsDropdowns() {
        document.body.classList.remove("dropdown-open");

        const overlay = document.getElementById("tags-dropdown-overlay");
        if (overlay) overlay.remove();

        const dropdown = document.getElementById("tags-dropdown-active");
        if (dropdown) dropdown.remove();

        activeTagsDropdown = null;
      }

      async function toggleTagSelection(ideaId, tagName) {
        const idea = allIdeas.find((i) => i.id === ideaId);
        if (!idea) return;

        // Get current tags
        let currentTags = (idea.tags || "")
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t);

        // Toggle selection
        const index = currentTags.findIndex(
          (t) => t.toLowerCase() === tagName.toLowerCase()
        );
        if (index >= 0) {
          currentTags.splice(index, 1);
        } else {
          currentTags.push(tagName);
        }

        const newTags = currentTags.join(", ");

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ tags: newTags })
            .eq("id", ideaId);

          if (error) throw error;

          // Update local data
          idea.tags = newTags;
          if (currentIdea?.id === ideaId) {
            currentIdea.tags = newTags;
          }

          // Re-render dropdown
          const dropdown = document.getElementById("tags-dropdown-active");
          const searchInput = dropdown?.querySelector("input");
          const searchValue = searchInput?.value || "";
          if (dropdown) {
            renderTagsDropdownContent(
              dropdown,
              ideaId,
              currentTags,
              searchValue
            );
            // Restore focus
            const input = dropdown.querySelector("input");
            if (input) {
              input.focus();
              input.setSelectionRange(searchValue.length, searchValue.length);
            }
          }

          renderIdeasTable();
        } catch (err) {
          console.error("Error updating tags:", err);
        }
      }

      async function createAndSelectTag(ideaId, tagName) {
        const idea = allIdeas.find((i) => i.id === ideaId);
        if (!idea) return;

        // Get current tags and add new one
        let currentTags = (idea.tags || "")
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t);
        currentTags.push(tagName);

        const newTags = currentTags.join(", ");

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ tags: newTags })
            .eq("id", ideaId);

          if (error) throw error;

          // Update local data
          idea.tags = newTags;
          if (currentIdea?.id === ideaId) {
            currentIdea.tags = newTags;
          }

          // Update unique tags list
          allUniqueTags = getAllUniqueTags();

          // Re-render dropdown with cleared search
          const dropdown = document.getElementById("tags-dropdown-active");
          if (dropdown) {
            renderTagsDropdownContent(dropdown, ideaId, currentTags, "");
            const input = dropdown.querySelector("input");
            if (input) input.focus();
          }

          renderIdeasTable();
        } catch (err) {
          console.error("Error creating tag:", err);
        }
      }

      // ============ TASK TAGS ============

      const TASK_TAG_LABELS = {
        "needs-lyrics": "Needs Lyrics",
        "needs-mix": "Needs Mix",
        "needs-master": "Needs Master",
        "needs-vocals": "Needs Vocals",
        "needs-arrangement": "Needs Arrangement",
        "needs-rework": "Needs Rework",
      };

      function renderTaskTags(tagString) {
        if (!tagString) return "";
        const tags = tagString
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t);
        return tags
          .map(
            (tag) => `
    <span class="task-tag ${tag}">
      ${TASK_TAG_LABELS[tag] || tag}
    </span>
  `
          )
          .join("");
      }

      function toggleTagDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById("tag-dropdown");
        dropdown.style.display =
          dropdown.style.display === "none" ? "block" : "none";

        // Close when clicking outside
        if (dropdown.style.display === "block") {
          setTimeout(() => {
            document.addEventListener("click", closeTagDropdown, {
              once: true,
            });
          }, 0);
        }
      }

      function closeTagDropdown() {
        const dropdown = document.getElementById("tag-dropdown");
        if (dropdown) dropdown.style.display = "none";
      }

      // All available task tags
      const ALL_TASK_TAGS = [
        { id: "needs-lyrics", label: "Needs Lyrics", color: "#A78BFA" },
        { id: "needs-mix", label: "Needs Mix", color: "#F472B6" },
        { id: "needs-master", label: "Needs Master", color: "#5EEAD4" },
        { id: "needs-vocals", label: "Needs Vocals", color: "#FBBF24" },
        {
          id: "needs-arrangement",
          label: "Needs Arrangement",
          color: "#60A5FA",
        },
        { id: "needs-rework", label: "Needs Rework", color: "#FB7185" },
      ];

      function renderTagDropdownItems() {
        if (!currentIdea) return "";
        const currentTags = currentIdea.task_tags
          ? currentIdea.task_tags
              .split(",")
              .map((t) => t.trim())
              .filter((t) => t)
          : [];

        return ALL_TASK_TAGS.map((tag) => {
          const isActive = currentTags.includes(tag.id);
          return `
      <div class="tag-dropdown-item ${
        isActive ? "active" : ""
      }" onclick="event.stopPropagation(); toggleTaskTag('${tag.id}')">
        <span class="tag-dot" style="background: ${tag.color};"></span>
        <span class="tag-label">${tag.label}</span>
        <span class="tag-check">${isActive ? "âœ“" : ""}</span>
      </div>
    `;
        }).join("");
      }

      async function toggleTaskTag(tagName) {
        if (!currentIdea) return;

        // Parse existing tags
        const currentTags = currentIdea.task_tags
          ? currentIdea.task_tags
              .split(",")
              .map((t) => t.trim())
              .filter((t) => t)
          : [];

        let newTags;
        if (currentTags.includes(tagName)) {
          // Remove tag
          newTags = currentTags.filter((t) => t !== tagName);
        } else {
          // Add tag
          newTags = [...currentTags, tagName];
        }

        const newTagString = newTags.join(",");

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ task_tags: newTagString || null })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.task_tags = newTagString;

          // Update in allIdeas too
          const idx = allIdeas.findIndex((i) => i.id === currentIdea.id);
          if (idx !== -1) allIdeas[idx].task_tags = newTagString;

          // Re-render the dropdown and tags without closing dropdown
          const tagsContainer = document.getElementById("task-tags-container");
          if (tagsContainer) {
            const dropdown = document.getElementById("tag-dropdown");
            const dropdownVisible =
              dropdown && dropdown.style.display !== "none";

            renderPlayerPanel();

            // Keep dropdown open
            if (dropdownVisible) {
              const newDropdown = document.getElementById("tag-dropdown");
              if (newDropdown) newDropdown.style.display = "block";
            }
          }
        } catch (err) {
          console.error("Error toggling task tag:", err);
        }
      }

      // Legacy functions for backwards compatibility
      async function addTaskTag(tagName) {
        if (!currentIdea) return;
        closeTagDropdown();

        // Parse existing tags
        const currentTags = currentIdea.task_tags
          ? currentIdea.task_tags
              .split(",")
              .map((t) => t.trim())
              .filter((t) => t)
          : [];

        // Check if already exists
        if (currentTags.includes(tagName)) return;

        // Add new tag
        currentTags.push(tagName);
        const newTagString = currentTags.join(",");

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ task_tags: newTagString })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.task_tags = newTagString;

          // Update in allIdeas too
          const idx = allIdeas.findIndex((i) => i.id === currentIdea.id);
          if (idx !== -1) allIdeas[idx].task_tags = newTagString;

          renderPlayerPanel();
        } catch (err) {
          console.error("Error adding task tag:", err);
        }
      }

      async function removeTaskTag(tagName) {
        if (!currentIdea) return;

        // Parse existing tags
        const currentTags = currentIdea.task_tags
          ? currentIdea.task_tags
              .split(",")
              .map((t) => t.trim())
              .filter((t) => t)
          : [];

        // Remove the tag
        const newTags = currentTags.filter((t) => t !== tagName);
        const newTagString = newTags.join(",");

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ task_tags: newTagString || null })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.task_tags = newTagString;

          // Update in allIdeas too
          const idx = allIdeas.findIndex((i) => i.id === currentIdea.id);
          if (idx !== -1) allIdeas[idx].task_tags = newTagString;

          renderPlayerPanel();
        } catch (err) {
          console.error("Error removing task tag:", err);
        }
      }

      // Open in new tab (fallback for playback issues)
      function openInNewTab() {
        if (currentIdea?.dropbox_url) {
          // Convert dl=1 to dl=0 for browser preview
          const previewUrl = currentIdea.dropbox_url.replace("dl=1", "dl=0");
          window.open(previewUrl, "_blank");
        }
      }

      // Render player panel
      function renderPlayerPanel() {
        const headerActions = document.getElementById("player-header-actions");

        if (!currentIdea) {
          headerActions.innerHTML = "";
          playerContent.innerHTML = `
      <div class="player-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 40px; height: 40px; margin-bottom: 12px; opacity: 0.3;">
          <circle cx="12" cy="12" r="10"/>
          <polygon points="10 8 16 12 10 16 10 8"/>
        </svg>
        <div>Select an idea to play</div>
      </div>
    `;
          return;
        }

        // Update header action buttons
        headerActions.innerHTML = `
    <button class="player-header-btn ${
      currentIdea.is_favorite ? "active" : ""
    }" onclick="toggleFavorite('${currentIdea.id}')" title="${
          currentIdea.is_favorite ? "Remove from favorites" : "Add to favorites"
        }">
      <svg viewBox="0 0 24 24" fill="${
        currentIdea.is_favorite ? "currentColor" : "none"
      }" stroke="currentColor" stroke-width="2">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
      </svg>
      <span class="player-header-btn-label">Fav</span>
    </button>
    ${
      currentIdea.project_folder_path
        ? `
      <button class="player-header-btn" onclick="openProject()" title="Open Project Folder">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
        </svg>
        <span class="player-header-btn-label">Open</span>
      </button>
    `
        : ""
    }
    <button class="player-header-btn" onclick="shareIdea('${
      currentIdea.id
    }')" title="Share">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="18" cy="5" r="3"/>
        <circle cx="6" cy="12" r="3"/>
        <circle cx="18" cy="19" r="3"/>
        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
      </svg>
      <span class="player-header-btn-label">Share</span>
    </button>
    <button class="player-header-btn danger ${
      currentIdea.is_archived ? "active" : ""
    }" onclick="toggleArchive('${currentIdea.id}')" title="${
          currentIdea.is_archived ? "Unarchive" : "Archive"
        }">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="21 8 21 21 3 21 3 8"/>
        <rect x="1" y="3" width="22" height="5"/>
      </svg>
      <span class="player-header-btn-label">Archive</span>
    </button>
  `;

        // Play button content based on state
        let playBtnContent;
        if (isLoading) {
          playBtnContent = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
      <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="8"/>
    </svg>`;
        } else if (isPlaying) {
          playBtnContent = `<svg viewBox="0 0 24 24" fill="currentColor">
      <rect x="6" y="4" width="4" height="16" rx="1"/>
      <rect x="14" y="4" width="4" height="16" rx="1"/>
    </svg>`;
        } else {
          playBtnContent = `<svg viewBox="0 0 24 24" fill="currentColor">
      <polygon points="6 3 20 12 6 21 6 3"/>
    </svg>`;
        }

        // Generate album art
        const albumArtSvg = generateAlbumArt(
          currentIdea.title,
          currentIdea.tags || "",
          currentIdea.project_name || ""
        );
        const unsplashUrl = `https://source.unsplash.com/400x400/?${encodeURIComponent(
          getUnsplashSearchTerm(currentIdea)
        )}&sig=${hashString(currentIdea.id)}`;

        // Check for custom cover image first
        const hasCustomCover =
          currentIdea.cover_image_url &&
          currentIdea.cover_image_url.trim() !== "";

        let albumArtHtml;
        if (hasCustomCover) {
          albumArtHtml = `<img src="${escapeHtml(
            currentIdea.cover_image_url
          )}" alt="Album art" loading="lazy" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else if (useUnsplash) {
          albumArtHtml = `<img src="${unsplashUrl}" alt="Album art" loading="lazy" onerror="this.style.display='none'">`;
        } else {
          albumArtHtml = albumArtSvg;
        }

        // Version selector - always show as clickable
        const versionHtml = (() => {
          const hasMultipleVersions = currentVersions.length > 1;
          const currentVersion = currentIdea.version || "1.0";

          return `
      <div class="version-selector-wrapper">
        <button class="version-selector-btn" onclick="toggleVersionDropdown(event)">
          v${currentVersion}
          ${
            hasMultipleVersions
              ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>`
              : ""
          }
        </button>
      </div>
    `;
        })();

        // Excitement stars
        const excitementHtml = [1, 2, 3, 4, 5]
          .map(
            (n) => `
    <button class="inline-excitement-star ${
      (currentIdea.excitement || 0) >= n ? "active" : ""
    }" 
            onclick="event.stopPropagation(); setExcitement(${n})"
            onmouseenter="previewInlineExcitement(${n})"
            onmouseleave="resetInlineExcitementPreview()">
      â˜…
    </button>
  `
          )
          .join("");

        playerContent.innerHTML = `
    <style>
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>
    
    <!-- Mini Player Content (shown when collapsed) -->
    <div class="mini-player-content">
      <div class="album-art-container mini-album-art">
        <div class="album-art">
          ${albumArtHtml}
        </div>
        <div class="mini-circular-progress">
          <svg viewBox="0 0 72 72">
            <circle class="progress-bg" cx="36" cy="36" r="34"/>
            <circle class="progress-fill" cx="36" cy="36" r="34" 
                    stroke-dasharray="${2 * Math.PI * 34}" 
                    stroke-dashoffset="${2 * Math.PI * 34}"
                    id="mini-progress-circle"/>
          </svg>
        </div>
        <div class="mini-play-overlay" onclick="togglePlay()">
          ${
            isPlaying
              ? `<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>`
              : `<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 20 12 6 21 6 3"/></svg>`
          }
        </div>
      </div>
      
      <div class="mini-track-info">
        <div class="mini-track-title">${escapeHtml(currentIdea.title)}</div>
        <span class="mini-version">v${currentIdea.version || "1.0"}</span>
      </div>
      
      <div class="mini-stars">
        ${[1, 2, 3, 4, 5]
          .map(
            (n) => `
          <span class="star ${
            (currentIdea.excitement || 0) >= n ? "active" : ""
          }" 
                onclick="event.stopPropagation(); setExcitement(${n})">â˜…</span>
        `
          )
          .join("")}
      </div>
      
      <div class="mini-tags">
        ${(currentIdea.task_tags || "")
          .split(",")
          .filter((t) => t.trim())
          .slice(0, 3)
          .map((tag) => {
            const colors = {
              "needs-lyrics": "#A78BFA",
              "needs-mix": "#F472B6",
              "needs-master": "#5EEAD4",
              "needs-vocals": "#FBBF24",
              "needs-arrangement": "#60A5FA",
              "needs-rework": "#FB7185",
            };
            const color = colors[tag.trim()] || "#6B7280";
            const label = tag
              .trim()
              .replace("needs-", "")
              .charAt(0)
              .toUpperCase();
            return `<span class="mini-task-tag" style="background: ${color};" title="${tag.trim()}">${label}</span>`;
          })
          .join("")}
      </div>
      
      ${
        Array.isArray(currentIdea.collaborators) &&
        currentIdea.collaborators.length > 0
          ? `
        <div class="mini-collaborators" onclick="switchPlayerTab('collaborators')" title="Team Members">
          ${currentIdea.collaborators
            .slice(0, 3)
            .map((collab) => {
              if (collab.image_url) {
                return `<div class="mini-collab-avatar"><img src="${escapeHtml(
                  collab.image_url
                )}" alt="${escapeHtml(collab.name)}"></div>`;
              } else {
                const initials = (collab.name || "U")
                  .split(" ")
                  .map((n) => n[0])
                  .join("")
                  .slice(0, 2)
                  .toUpperCase();
                return `<div class="mini-collab-avatar">${initials}</div>`;
              }
            })
            .join("")}
          ${
            currentIdea.collaborators.length > 3
              ? `<div class="mini-collab-avatar mini-collab-more">+${
                  currentIdea.collaborators.length - 3
                }</div>`
              : ""
          }
        </div>
      `
          : ""
      }
      
      ${
        currentIdea.priority
          ? `
        <div class="mini-priority">
          <span class="mini-priority-badge ${currentIdea.priority.toLowerCase()}">${
              currentIdea.priority
            }</span>
        </div>
      `
          : ""
      }
      
      ${
        currentIdea.due_date
          ? `
        <div class="mini-due-date ${getDueDateClass(
          currentIdea.due_date
        )}" onclick="openDueDateModal('${currentIdea.id}')" title="Due Date">
          ${formatDueDate(currentIdea.due_date)}
        </div>
      `
          : ""
      }
    </div>
    
    <!-- Full Player Content (shown when expanded) -->
    <div class="full-player-content">
    <!-- Album Art with Overlay Controls -->
    <div class="album-art-container">
      <!-- Progress Ring -->
      <div class="album-progress-ring" id="album-progress-ring">
        <svg viewBox="0 0 100 100" preserveAspectRatio="none">
          <rect class="progress-bg" x="2" y="2" width="96" height="96" rx="10" ry="10"/>
          <rect class="progress-fill" id="progress-ring-fill" x="2" y="2" width="96" height="96" rx="10" ry="10" 
                style="stroke-dasharray: 384; stroke-dashoffset: 384;"/>
        </svg>
      </div>
      <div class="album-art-wrapper">
        <div class="album-art">
          ${albumArtHtml}
        </div>
        
        <!-- Frosted Glass Track Info -->
        <div class="album-art-frosted">
          ${(() => {
            const parts = (currentIdea.title || "").split(" - ");
            const hasArtist = parts.length > 1;
            const artistName = hasArtist ? parts[0].trim() : "";
            const trackTitle = hasArtist
              ? parts.slice(1).join(" - ").trim()
              : currentIdea.title;
            const projects = (currentIdea.project_name || "Unassigned")
              .split(",")
              .map((p) => p.trim())
              .filter((p) => p);
            const primaryProject = projects[0];
            const moreCount = projects.length - 1;
            const excitement = currentIdea.excitement || 0;
            const version = currentIdea.version || "";
            const stage = getStage(currentIdea.stage || "seed");
            const isFavorite = currentIdea.is_favorite;

            // Determine category label and color
            let categoryLabel = stage.name.toUpperCase();
            let categoryColor = stage.color;
            if (isFavorite) {
              categoryLabel = "â™¥ FAVORITE";
              categoryColor = "#ef4444";
            }

            return `
              <div class="frosted-info">
                <div class="frosted-category" style="color: ${categoryColor};">${categoryLabel}</div>
                <div class="frosted-header">
                  ${
                    hasArtist
                      ? `<div class="frosted-artist">${escapeHtml(
                          artistName
                        )}</div>`
                      : ""
                  }
                  ${
                    version
                      ? `<span class="frosted-version">v${escapeHtml(
                          version
                        )}</span>`
                      : ""
                  }
                </div>
                <div class="frosted-title-row">
                  <div class="frosted-title">${escapeHtml(trackTitle)}</div>
                  <div class="frosted-rating">
                    ${[1, 2, 3, 4, 5]
                      .map(
                        (i) =>
                          `<button class="frosted-star ${
                            i <= excitement ? "filled" : ""
                          }" onclick="setExcitement(${i})">${
                            i <= excitement ? "â˜…" : "â˜†"
                          }</button>`
                      )
                      .join("")}
                  </div>
                </div>
                <div class="frosted-meta">
                  <span class="frosted-project" onclick="event.stopPropagation(); toggleProjectDropdown(event, '${
                    currentIdea.id
                  }')" title="${projects.join(", ")}">
                    <span class="frosted-project-thumb">${generateProjectThumbnail(
                      primaryProject
                    )}</span>
                    ${escapeHtml(primaryProject)}
                  </span>
                  ${
                    moreCount > 0
                      ? `<span class="frosted-more" title="${projects
                          .slice(1)
                          .join(", ")}">+${moreCount}</span>`
                      : ""
                  }
                </div>
              </div>
              
              <div class="frosted-player">
                <div class="frosted-progress">
                  <div class="frosted-progress-bar" onclick="seekAudio(event)">
                    <div class="frosted-progress-fill" id="progress-bar"></div>
                  </div>
                  <div class="frosted-time">
                    <span id="current-time">0:00</span>
                    <span id="duration">0:00</span>
                  </div>
                </div>
                <div class="frosted-controls">
                  <button class="frosted-skip-btn" onclick="skipBack()">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <polygon points="19 20 9 12 19 4 19 20"/>
                      <rect x="5" y="4" width="2" height="16"/>
                    </svg>
                  </button>
                  <button class="frosted-play-btn" onclick="togglePlay()" ${
                    isLoading ? "disabled" : ""
                  }>
                    ${playBtnContent}
                  </button>
                  <button class="frosted-skip-btn" onclick="skipForward()">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <polygon points="5 4 15 12 5 20 5 4"/>
                      <rect x="17" y="4" width="2" height="16"/>
                    </svg>
                  </button>
                </div>
              </div>
            `;
          })()}
        </div>
        
        <div class="album-art-left-overlay">
          <div class="album-art-due-date ${getDueDateClass(
            currentIdea.due_date
          )}" onclick="openDueDateModal('${currentIdea.id}')">
            ${
              currentIdea.due_date
                ? formatDueDate(currentIdea.due_date)
                : "ðŸ“… Due"
            }
          </div>
          ${renderCollaboratorAvatars(currentIdea.collaborators)}
        </div>
        <button class="album-art-info" onclick="openTrackInfoModal()" title="Track Details">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
          </svg>
        </button>
        <button class="album-art-toggle" onclick="toggleAlbumArtMode()">
          ${
            hasCustomCover
              ? "ðŸ–¼ï¸ Custom"
              : useUnsplash
              ? "âœ¨ Generative"
              : "ðŸ“· Photo"
          }
        </button>
      </div>
    </div>
    
    <!-- Workflow Tags -->
    <div class="workflow-tags-section" id="task-tags-container">
      ${(() => {
        const tags = (currentIdea.task_tags || "")
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t);
        const chips = tags
          .map((tagId) => {
            const tag = ALL_TASK_TAGS.find((t) => t.id === tagId);
            if (!tag) return "";
            return `<span class="workflow-chip" style="background: ${tag.color}20; color: ${tag.color};">
            <span class="workflow-chip-dot" style="background: ${tag.color};"></span>
            ${tag.label}
          </span>`;
          })
          .join("");
        return chips;
      })()}
      <div class="workflow-edit-wrapper">
        <button class="workflow-edit-btn" onclick="toggleTagDropdown(event)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 10px; height: 10px;">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          Edit
        </button>
        <div class="tag-dropdown" id="tag-dropdown" style="display: none;">
          ${renderTagDropdownItems()}
        </div>
      </div>
    </div>
    
    <!-- Tab Navigation -->
    <div class="player-tabs">
      <button class="player-tab ${
        currentPlayerTab === "info" ? "active" : ""
      }" onclick="switchPlayerTab('info')" data-tab="info">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="16" x2="12" y2="12"/>
          <line x1="12" y1="8" x2="12.01" y2="8"/>
        </svg>
        Info
      </button>
      <button class="player-tab ${
        currentPlayerTab === "comments" ? "active" : ""
      }" onclick="switchPlayerTab('comments')" data-tab="comments">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        Chat
      </button>
      <button class="player-tab ${
        currentPlayerTab === "collaborators" ? "active" : ""
      }" onclick="switchPlayerTab('collaborators')" data-tab="collaborators">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        Team
      </button>
      <button class="player-tab ${
        currentPlayerTab === "todo" ? "active" : ""
      }" onclick="switchPlayerTab('todo')" data-tab="todo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 11l3 3L22 4"/>
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
        </svg>
        Todo
      </button>
      <button class="player-tab ${
        currentPlayerTab === "files" ? "active" : ""
      }" onclick="switchPlayerTab('files')" data-tab="files">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
        Files
      </button>
    </div>
    
    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Info Tab -->
      <div class="tab-panel ${
        currentPlayerTab === "info" ? "active" : ""
      }" id="tab-info">
        <div class="info-tab-content">
          <div class="info-section">
            <div class="info-section-title">Track Status</div>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Stage</span>
                <span class="info-value">${(() => {
                  const stage = getStage(currentIdea.stage || "seed");
                  return `<span style="color: ${stage.color};">${stage.icon} ${stage.name}</span>`;
                })()}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Priority</span>
                <span class="info-value ${
                  currentIdea.priority
                    ? "priority-" + currentIdea.priority.toLowerCase()
                    : ""
                }">${currentIdea.priority || "Not set"}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Due Date</span>
                <span class="info-value ${getDueDateClass(
                  currentIdea.due_date
                )}">${
          currentIdea.due_date ? formatDueDate(currentIdea.due_date) : "Not set"
        }</span>
              </div>
              <div class="info-item">
                <span class="info-label">Created</span>
                <span class="info-value">${
                  currentIdea.created_at
                    ? new Date(currentIdea.created_at).toLocaleDateString()
                    : "Unknown"
                }</span>
              </div>
            </div>
          </div>
          
          <div class="info-section">
            <div class="info-section-title">Tags</div>
            <div class="info-tags">
              ${
                (currentIdea.tags || "")
                  .split(",")
                  .filter((t) => t.trim())
                  .map(
                    (tag) =>
                      `<span class="info-tag">${escapeHtml(tag.trim())}</span>`
                  )
                  .join("") || '<span class="info-empty">No tags</span>'
              }
            </div>
          </div>
        </div>
      </div>
      
      <!-- Notes Tab -->
      <div class="tab-panel" id="tab-notes" style="${
        getTabVisibility().notes === false ? "display:none;" : ""
      }">
        <div class="tab-panel-header">
          <span class="tab-panel-title">Track Notes</span>
          <button class="bookmark-add-btn" onclick="openBookmarkModal()" title="Add Bookmark">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Bookmark
          </button>
        </div>
        
        <!-- Bookmark Tabs (only shown when bookmarks exist) -->
        <div class="bookmark-tabs" id="bookmark-tabs">
          ${renderBookmarkTabs(currentIdea.id)}
        </div>
        
        <div class="bookmark-content" id="bookmark-content">
          <textarea class="notes-textarea" id="notes-textarea" placeholder="${getCurrentBookmarkPlaceholder()}" oninput="markNotesDirty()">${escapeHtml(
          getCurrentBookmarkNotes()
        )}</textarea>
          <button class="tab-save-btn" id="notes-save-btn" onclick="saveNotes()">Save</button>
        </div>
      </div>
      
      <!-- Comments Tab -->
      <div class="tab-panel ${
        currentPlayerTab === "comments" ? "active" : ""
      }" id="tab-comments">
        <div class="comments-container">
          <div class="comments-list" id="comments-list">
            ${renderComments(currentIdea.id)}
          </div>
          <div class="comment-input-wrapper">
            <div class="comment-options">
              <label class="timestamp-toggle">
                <input type="checkbox" id="comment-timestamp-toggle" onchange="updateTimestampPreview()">
                <span class="timestamp-toggle-switch"></span>
                Attach timestamp
              </label>
              <span class="timestamp-preview" id="timestamp-preview"></span>
            </div>
            <div class="comment-input-row">
              <textarea class="comment-input" id="comment-input" placeholder="Add a comment..." rows="1" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();addComment();}"></textarea>
              <button class="comment-send-btn" onclick="addComment()" title="Send comment">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"/>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Collaborators Tab -->
      <div class="tab-panel ${
        currentPlayerTab === "collaborators" ? "active" : ""
      }" id="tab-collaborators">
        <div class="tab-panel-header">
          <span class="tab-panel-title">Team & Splits</span>
        </div>
        <div class="collaborators-list" id="collaborators-list">
          ${renderCollaborators(currentIdea.collaborators)}
          <div class="add-collaborator-picker" id="add-collaborator-picker">
            <button class="add-collaborator-btn" onclick="toggleCollaboratorPicker()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add collaborator
            </button>
            <div class="collaborator-picker-dropdown" id="collaborator-picker-dropdown" style="display: none;">
              ${renderSavedCollaboratorsPicker()}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Todo Tab -->
      <div class="tab-panel ${
        currentPlayerTab === "todo" ? "active" : ""
      }" id="tab-todo">
        <div class="tab-panel-header">
          <span class="tab-panel-title">Tasks</span>
        </div>
        <div class="todo-list" id="todo-list">
          ${renderTodoItems(currentIdea.todos || [])}
        </div>
        <input class="add-todo-input" type="text" placeholder="Add a task and press Enter..." onkeypress="if(event.key==='Enter'){addTodoItem(this.value);this.value='';}">
      </div>
      
      <!-- Files Tab -->
      <div class="tab-panel ${
        currentPlayerTab === "files" ? "active" : ""
      }" id="tab-files">
        <div class="tab-panel-header">
          <span class="tab-panel-title">Referenced Files</span>
        </div>
        <div class="files-list">
          ${
            currentIdea.audio_url
              ? `
            <div class="file-item">
              <div class="file-icon audio">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18V5l12-2v13"/>
                  <circle cx="6" cy="18" r="3"/>
                  <circle cx="18" cy="16" r="3"/>
                </svg>
              </div>
              <div class="file-details">
                <span class="file-name">${escapeHtml(
                  currentIdea.title || "Audio File"
                )}.wav</span>
                <span class="file-meta">Audio â€¢ Main Track</span>
              </div>
              <button class="file-action" onclick="window.open('${escapeHtml(
                currentIdea.audio_url
              )}', '_blank')" title="Open">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                  <polyline points="15 3 21 3 21 9"/>
                  <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
              </button>
            </div>
          `
              : ""
          }
          
          <!-- Project File Section -->
          ${(() => {
            const projectPath = currentIdea.project_file_path || "";
            const ext = projectPath.split(".").pop()?.toLowerCase() || "";
            const fileName = projectPath.split("/").pop() || "Project File";

            // Determine icon and color based on extension
            let iconSvg, iconColor, dawName;
            if (ext === "als" || ext === "alp") {
              iconColor = "#00D8A2";
              dawName = "Ableton Live";
              iconSvg =
                '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="4" height="18" rx="1"/><rect x="10" y="3" width="4" height="18" rx="1"/><rect x="17" y="3" width="4" height="18" rx="1"/></svg>';
            } else if (ext === "logicx" || ext === "logic") {
              iconColor = "#8B5CF6";
              dawName = "Logic Pro";
              iconSvg =
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>';
            } else if (ext === "flp") {
              iconColor = "#FF6B00";
              dawName = "FL Studio";
              iconSvg =
                '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.5L19 8l-7 3.5L5 8l7-3.5z"/></svg>';
            } else if (ext === "ptx" || ext === "ptf") {
              iconColor = "#1D9BF0";
              dawName = "Pro Tools";
              iconSvg =
                '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/><circle cx="12" cy="12" r="4"/></svg>';
            } else if (ext === "cpr") {
              iconColor = "#C9302C";
              dawName = "Cubase";
              iconSvg =
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7v10l10 5 10-5V7L12 2z"/></svg>';
            } else if (ext === "rpp") {
              iconColor = "#4CAF50";
              dawName = "Reaper";
              iconSvg =
                '<svg viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/><path d="M8 12l3 3 5-5" stroke="white" stroke-width="2" fill="none"/></svg>';
            } else {
              iconColor = "#10B981";
              dawName = "Project";
              iconSvg =
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>';
            }

            return `
          <div class="file-item project-file-item">
            <div class="file-icon" style="background: ${
              projectPath ? iconColor : "var(--bg-input)"
            };">
              ${iconSvg}
            </div>
            <div class="file-details" style="flex: 1;">
              <span class="file-name">${
                projectPath ? escapeHtml(fileName) : "Project File"
              }</span>
              ${
                projectPath
                  ? `
                <span class="file-meta">${dawName} â€¢ ${escapeHtml(
                      projectPath.substring(0, projectPath.lastIndexOf("/"))
                    )}</span>
              `
                  : `
                <span class="file-meta text-muted">No project file linked</span>
              `
              }
            </div>
            ${
              projectPath
                ? `
              <button class="file-action" onclick="openProjectFile()" title="Open Project">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                  <polyline points="15 3 21 3 21 9"/>
                  <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
              </button>
            `
                : ""
            }
            <button class="file-action" onclick="showProjectFileInput()" title="${
              projectPath ? "Edit" : "Link"
            } Project File">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </button>
          </div>`;
          })()}
          
          <!-- Project File Input (hidden by default) -->
          <div class="project-file-input-row" id="project-file-input-row" style="display: none;">
            <div style="display: flex; flex-direction: column; gap: 8px; flex: 1;">
              <input type="text" class="metadata-input" id="project-file-path-input" 
                     placeholder="/path/to/project.als or .logicx, .flp, etc." 
                     value="${escapeHtml(currentIdea.project_file_path || "")}">
              <input type="text" class="metadata-input" id="project-dropbox-url-input" 
                     placeholder="Dropbox share link (optional, for sharing)" 
                     value="${escapeHtml(
                       currentIdea.project_dropbox_url || ""
                     )}">
            </div>
            <div style="display: flex; gap: 4px; align-self: flex-start; margin-top: 4px;">
              <button class="btn btn-sm btn-primary" onclick="saveProjectFilePath()">Save</button>
              <button class="btn btn-sm btn-secondary" onclick="hideProjectFileInput()">Cancel</button>
            </div>
          </div>
          
          ${
            currentIdea.project_folder_path
              ? `
            <div class="file-item">
              <div class="file-icon folder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
              </div>
              <div class="file-details">
                <span class="file-name">Project Folder</span>
                <span class="file-meta">${escapeHtml(
                  currentIdea.project_folder_path
                )}</span>
              </div>
              <button class="file-action" onclick="openProject()" title="Open Folder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                  <polyline points="15 3 21 3 21 9"/>
                  <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
              </button>
            </div>
          `
              : ""
          }
          
          ${
            !currentIdea.audio_url &&
            !currentIdea.project_folder_path &&
            !currentIdea.project_file_path
              ? `
            <div class="files-empty" style="margin-top: 12px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 32px; height: 32px; opacity: 0.3; margin-bottom: 8px;">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              <span>No additional files linked</span>
            </div>
          `
              : ""
          }
          
          ${renderFileInbox(currentIdea.id)}
        </div>
      </div>
    </div>
    </div><!-- end full-player-content -->
  `;

        // Setup change tracking
        setupTabChangeTracking();
      }

      // Toggle play/pause
      function togglePlay() {
        if (audio.paused) {
          audio.play();
          isPlaying = true;
        } else {
          audio.pause();
          isPlaying = false;
        }
        renderPlayerPanel();
      }

      // Skip controls
      function skipBack() {
        audio.currentTime = Math.max(0, audio.currentTime - 10);
      }

      function skipForward() {
        audio.currentTime = Math.min(audio.duration, audio.currentTime + 10);
      }

      // Seek audio
      function seekAudio(event) {
        const rect = event.currentTarget.getBoundingClientRect();
        const percent = (event.clientX - rect.left) / rect.width;
        audio.currentTime = percent * audio.duration;
      }

      // Tab switching
      let currentPlayerTab = "info";
      let notesDirty = false;
      let metadataDirty = false;

      function switchPlayerTab(tabName) {
        // Check if the tab is visible - info and files are always visible
        const visibility = getTabVisibility();
        if (
          visibility[tabName] === false &&
          tabName !== "info" &&
          tabName !== "files"
        ) {
          // Find first visible tab
          const tabs = ["info", "comments", "collaborators", "todo", "files"];
          tabName =
            tabs.find(
              (t) => visibility[t] !== false || t === "info" || t === "files"
            ) || "info";
        }

        currentPlayerTab = tabName;

        // Update tab buttons
        document.querySelectorAll(".player-tab").forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.tab === tabName);
        });

        // Update tab panels
        document.querySelectorAll(".tab-panel").forEach((panel) => {
          panel.classList.toggle("active", panel.id === `tab-${tabName}`);
        });
      }

      // Setup change tracking for tabs
      function setupTabChangeTracking() {
        notesDirty = false;
        metadataDirty = false;

        // Reset save button states
        const notesSaveBtn = document.getElementById("notes-save-btn");
        const metadataSaveBtn = document.getElementById("metadata-save-btn");
        if (notesSaveBtn) notesSaveBtn.classList.remove("visible", "saved");
        if (metadataSaveBtn)
          metadataSaveBtn.classList.remove("visible", "saved");
      }

      // Mark notes as dirty (changed)
      function markNotesDirty() {
        notesDirty = true;
        const btn = document.getElementById("notes-save-btn");
        if (btn) {
          btn.classList.add("visible");
          btn.classList.remove("saved");
          btn.textContent = "Save";
        }
      }

      // Mark metadata as dirty
      function markMetadataDirty() {
        metadataDirty = true;
        const btn = document.getElementById("metadata-save-btn");
        if (btn) {
          btn.classList.add("visible");
          btn.classList.remove("saved");
          btn.textContent = "Save";
        }
      }

      // Render collaborators
      function renderCollaborators(collaborators) {
        if (!collaborators) return "";

        const collabs =
          typeof collaborators === "string"
            ? JSON.parse(collaborators)
            : collaborators;
        if (!collabs || collabs.length === 0) return "";

        return collabs
          .map((c, i) => {
            const avatarContent = c.image_url
              ? `<img src="${escapeHtml(c.image_url)}" alt="${escapeHtml(
                  c.name || ""
                )}">`
              : c.name?.charAt(0)?.toUpperCase() || "?";

            const splitVal = c.split_percent || c.split;
            const splitBadge = splitVal
              ? `<span class="collaborator-badge split">${splitVal}%</span>`
              : "";

            const proBadge = c.pro_name
              ? `<span class="collaborator-badge pro">${escapeHtml(
                  c.pro_name
                )}</span>`
              : "";

            const ipiBadge = c.ipi_number
              ? `<span class="collaborator-badge">IPI: ${escapeHtml(
                  c.ipi_number
                )}</span>`
              : "";

            return `
    <div class="collaborator-item" onclick="openCollaboratorModal(${i})">
      <div class="collaborator-avatar">${avatarContent}</div>
      <div class="collaborator-info">
        <div class="collaborator-name">${escapeHtml(c.name || "Unknown")}</div>
        <div class="collaborator-role">${escapeHtml(
          c.role || "Contributor"
        )}</div>
        ${
          splitBadge || proBadge || ipiBadge
            ? `
          <div class="collaborator-meta">
            ${splitBadge}${proBadge}${ipiBadge}
          </div>
        `
            : ""
        }
      </div>
      <div class="collaborator-actions">
        <button class="player-header-btn" onclick="event.stopPropagation(); openCollaboratorModal(${i})" title="Edit">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
        </button>
        <button class="player-header-btn danger" onclick="event.stopPropagation(); removeCollaborator(${i})" title="Remove">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
    </div>
  `;
          })
          .join("");
      }

      // Save metadata (BPM, Key, Genre, Tags)
      async function saveMetadata() {
        if (!currentIdea || !metadataDirty) return;

        const bpm = document.getElementById("meta-bpm")?.value || null;
        const musical_key = document.getElementById("meta-key")?.value || null;
        const genre = document.getElementById("meta-genre")?.value || null;
        const tags = document.getElementById("meta-tags")?.value || null;

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ bpm, musical_key, genre, tags })
            .eq("id", currentIdea.id);

          if (error) throw error;

          // Update local data
          currentIdea.bpm = bpm;
          currentIdea.musical_key = musical_key;
          currentIdea.genre = genre;
          currentIdea.tags = tags;

          const idx = allIdeas.findIndex((i) => i.id === currentIdea.id);
          if (idx !== -1) {
            allIdeas[idx].bpm = bpm;
            allIdeas[idx].musical_key = musical_key;
            allIdeas[idx].genre = genre;
            allIdeas[idx].tags = tags;
          }

          // Show saved feedback
          metadataDirty = false;
          const btn = document.getElementById("metadata-save-btn");
          if (btn) {
            btn.classList.add("saved");
            btn.textContent = "Saved!";
            setTimeout(() => {
              btn.classList.remove("visible", "saved");
              btn.textContent = "Save";
            }, 1500);
          }

          // Update table view
          renderIdeasTable();
        } catch (err) {
          console.error("Error saving metadata:", err);
          alert("Error saving: " + err.message);
        }
      }

      // Inline excitement preview
      function previewInlineExcitement(level) {
        const stars = document.querySelectorAll(".inline-excitement-star");
        stars.forEach((star, i) => {
          star.classList.toggle("hovered", i < level);
        });
      }

      function resetInlineExcitementPreview() {
        const stars = document.querySelectorAll(".inline-excitement-star");
        stars.forEach((star) => star.classList.remove("hovered"));
      }

      // Update metadata
      async function updateMetadata(field, value) {
        if (!currentIdea) return;

        try {
          const update = {};
          update[field] = value || null;

          const { error } = await supabase
            .from("idea_tracks")
            .update(update)
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea[field] = value;

          // Update in allIdeas
          const idx = allIdeas.findIndex((i) => i.id === currentIdea.id);
          if (idx !== -1) allIdeas[idx][field] = value;
        } catch (err) {
          console.error("Error updating metadata:", err);
        }
      }

      // Collaborators with Modal
      let editingCollaboratorIndex = null;

      function openCollaboratorModal(index = null) {
        if (!currentIdea || index === null) return;

        editingCollaboratorIndex = index;

        let collaborators = currentIdea.collaborators;
        if (typeof collaborators === "string") {
          collaborators = JSON.parse(collaborators);
        }
        collaborators = collaborators || [];

        const collab = collaborators[index];
        if (!collab) return;

        // Create or show modal
        let modal = document.getElementById("collaborator-modal");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "collaborator-modal";
          modal.className = "modal-overlay";
          modal.onclick = (e) => {
            if (e.target === modal) closeCollaboratorModal();
          };
          document.body.appendChild(modal);
        }

        modal.innerHTML = `
    <div class="modal-content" style="max-width: 380px;">
      <div class="modal-header">
        <h3>Edit Collaborator</h3>
        <button class="modal-close" onclick="closeCollaboratorModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 12px; background: var(--bg-hover); border-radius: 10px;">
          <div class="collaborator-avatar" style="width: 48px; height: 48px; font-size: 18px;">
            ${
              collab.image_url
                ? `<img src="${escapeHtml(collab.image_url)}" alt="${escapeHtml(
                    collab.name
                  )}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`
                : collab.name?.charAt(0)?.toUpperCase() || "?"
            }
          </div>
          <div>
            <div style="font-weight: 600; color: var(--text);">${escapeHtml(
              collab.name || "Unknown"
            )}</div>
            <div style="font-size: 11px; color: var(--text-muted);">Editing for this track only</div>
          </div>
        </div>
        <div class="metadata-grid" style="grid-template-columns: 100px 1fr;">
          <span class="metadata-label">Role</span>
          <input class="metadata-input" type="text" id="collab-role" placeholder="Producer, Vocalist, Mixer..." value="${escapeHtml(
            collab.role || ""
          )}">
          
          <span class="metadata-label">Split %</span>
          <input class="metadata-input" type="number" id="collab-split" placeholder="50" min="0" max="100" value="${
            collab.split_percent || collab.split || ""
          }">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCollaboratorModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveTrackCollaborator()">Save</button>
      </div>
    </div>
  `;

        modal.classList.add("open");
        document.getElementById("collab-role").focus();
      }

      function closeCollaboratorModal() {
        const modal = document.getElementById("collaborator-modal");
        if (modal) modal.classList.remove("open");
        editingCollaboratorIndex = null;
      }

      // Save track-specific collaborator edits (role and split only)
      async function saveTrackCollaborator() {
        if (!currentIdea || editingCollaboratorIndex === null) return;

        const role =
          document.getElementById("collab-role")?.value?.trim() ||
          "Collaborator";
        const split_percent =
          parseInt(document.getElementById("collab-split")?.value) || null;

        let collaborators = currentIdea.collaborators;
        if (typeof collaborators === "string") {
          collaborators = JSON.parse(collaborators);
        }
        collaborators = collaborators || [];

        if (editingCollaboratorIndex >= collaborators.length) return;

        // Update only role and split, preserve everything else
        collaborators[editingCollaboratorIndex] = {
          ...collaborators[editingCollaboratorIndex],
          role,
          split_percent,
        };

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ collaborators: JSON.stringify(collaborators) })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.collaborators = collaborators;
          closeCollaboratorModal();
          refreshCollaboratorsList();
          showToast("Collaborator updated");
        } catch (err) {
          console.error("Error saving collaborator:", err);
          alert("Error: " + err.message);
        }
      }

      async function saveCollaborator() {
        if (!currentIdea) return;

        const name = document.getElementById("collab-name")?.value?.trim();
        if (!name) {
          alert("Name is required");
          return;
        }

        const role =
          document.getElementById("collab-role")?.value?.trim() ||
          "Contributor";
        const image_url =
          document.getElementById("collab-image")?.value?.trim() || null;
        const pro_name =
          document.getElementById("collab-pro")?.value?.trim() || null;
        const ipi_number =
          document.getElementById("collab-ipi")?.value?.trim() || null;
        const split_percent =
          parseInt(document.getElementById("collab-split")?.value) || null;

        let collaborators = currentIdea.collaborators;
        if (typeof collaborators === "string") {
          collaborators = JSON.parse(collaborators);
        }
        collaborators = collaborators || [];

        const collabData = {
          name,
          role,
          image_url,
          pro_name,
          ipi_number,
          split_percent,
        };

        if (editingCollaboratorIndex !== null) {
          collaborators[editingCollaboratorIndex] = collabData;
        } else {
          collaborators.push(collabData);
        }

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ collaborators: JSON.stringify(collaborators) })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.collaborators = collaborators;
          closeCollaboratorModal();
          refreshCollaboratorsList();
        } catch (err) {
          console.error("Error saving collaborator:", err);
          alert("Error saving: " + err.message);
        }
      }

      async function removeCollaborator(index) {
        if (!currentIdea) return;
        if (!confirm("Remove this collaborator?")) return;

        let collaborators = currentIdea.collaborators;
        if (typeof collaborators === "string") {
          collaborators = JSON.parse(collaborators);
        }
        collaborators = collaborators || [];

        if (index >= collaborators.length) return;

        collaborators.splice(index, 1);

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({
              collaborators:
                collaborators.length > 0 ? JSON.stringify(collaborators) : null,
            })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.collaborators = collaborators;
          refreshCollaboratorsList();
        } catch (err) {
          console.error("Error removing collaborator:", err);
        }
      }

      function refreshCollaboratorsList() {
        const list = document.getElementById("collaborators-list");
        if (list && currentIdea) {
          list.innerHTML =
            renderCollaborators(currentIdea.collaborators) +
            `
      <div class="add-collaborator-picker" id="add-collaborator-picker">
        <button class="add-collaborator-btn" onclick="toggleCollaboratorPicker()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Add collaborator
        </button>
        <div class="collaborator-picker-dropdown" id="collaborator-picker-dropdown" style="display: none;">
          ${renderSavedCollaboratorsPicker()}
        </div>
      </div>
    `;
        }
      }

      // Render saved collaborators picker dropdown
      function renderSavedCollaboratorsPicker() {
        if (!savedCollaborators || savedCollaborators.length === 0) {
          return `
      <div class="picker-empty">
        No saved collaborators yet.<br>
        <a onclick="closeCollaboratorPicker(); openSettingsModal();">Add in Settings</a>
      </div>
    `;
        }

        // Get current track's collaborator IDs to mark as already added
        let currentCollabs = currentIdea?.collaborators || [];
        if (typeof currentCollabs === "string") {
          currentCollabs = JSON.parse(currentCollabs);
        }
        const currentIds = currentCollabs.map((c) => c.id).filter(Boolean);

        const items = savedCollaborators
          .map((collab) => {
            const initials = (collab.name || "U")
              .split(" ")
              .map((n) => n[0])
              .join("")
              .slice(0, 2)
              .toUpperCase();
            const isAdded = currentIds.includes(collab.id);

            return `
      <button class="picker-item ${isAdded ? "disabled" : ""}" 
              onclick="${
                isAdded ? "" : `addSavedCollaboratorToTrack('${collab.id}')`
              }"
              ${isAdded ? "disabled" : ""}>
        <div class="picker-item-avatar">
          ${
            collab.image_url
              ? `<img src="${escapeHtml(collab.image_url)}" alt="${escapeHtml(
                  collab.name
                )}">`
              : initials
          }
        </div>
        <div class="picker-item-info">
          <div class="picker-item-name">${escapeHtml(collab.name)}</div>
          <div class="picker-item-meta">
            ${collab.default_role || "Collaborator"}${
              collab.default_split ? ` â€¢ ${collab.default_split}%` : ""
            }
          </div>
        </div>
        ${
          isAdded
            ? `
          <svg class="picker-item-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        `
            : ""
        }
      </button>
    `;
          })
          .join("");

        return `
    <div class="picker-header">
      Select Collaborator
      <button class="picker-close" onclick="closeCollaboratorPicker()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    ${items}
  `;
      }

      function toggleCollaboratorPicker() {
        const dropdown = document.getElementById(
          "collaborator-picker-dropdown"
        );
        if (dropdown) {
          const isOpen = dropdown.style.display !== "none";
          dropdown.style.display = isOpen ? "none" : "block";
          if (!isOpen) {
            // Refresh the picker content when opening
            dropdown.innerHTML = renderSavedCollaboratorsPicker();
          }
        }
      }

      function closeCollaboratorPicker() {
        const dropdown = document.getElementById(
          "collaborator-picker-dropdown"
        );
        if (dropdown) {
          dropdown.style.display = "none";
        }
      }

      async function addSavedCollaboratorToTrack(savedCollabId) {
        if (!currentIdea) return;

        const savedCollab = savedCollaborators.find(
          (c) => c.id === savedCollabId
        );
        if (!savedCollab) return;

        let collaborators = currentIdea.collaborators;
        if (typeof collaborators === "string") {
          collaborators = JSON.parse(collaborators);
        }
        collaborators = collaborators || [];

        // Check if already added
        if (collaborators.some((c) => c.id === savedCollabId)) {
          showToast("Collaborator already added");
          return;
        }

        // Add the collaborator with their saved defaults
        const collabData = {
          id: savedCollab.id,
          name: savedCollab.name,
          role: savedCollab.default_role || "Collaborator",
          image_url: savedCollab.image_url || null,
          split_percent: savedCollab.default_split || null,
        };

        collaborators.push(collabData);

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ collaborators: JSON.stringify(collaborators) })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.collaborators = collaborators;
          closeCollaboratorPicker();
          refreshCollaboratorsList();
          showToast(`Added ${savedCollab.name}`);
        } catch (err) {
          console.error("Error adding collaborator:", err);
          alert("Error: " + err.message);
        }
      }

      // ============ BOOKMARK SYSTEM ============

      let trackBookmarks = {}; // Cache bookmarks by track ID
      let currentBookmarkTab = "general";
      let bookmarkModalState = {
        startTime: 0,
        endTime: 10,
        isPlaying: false,
        duration: 0,
      };

      // Load bookmarks from localStorage
      function loadBookmarks(trackId) {
        if (!trackId) return;

        try {
          const saved = localStorage.getItem(`ideas-bookmarks-${trackId}`);
          if (saved) {
            trackBookmarks[trackId] = JSON.parse(saved);
          } else {
            trackBookmarks[trackId] = [];
          }
        } catch (e) {
          trackBookmarks[trackId] = [];
        }
      }

      // Save bookmarks to localStorage
      function saveBookmarks(trackId) {
        if (!trackId) return;
        localStorage.setItem(
          `ideas-bookmarks-${trackId}`,
          JSON.stringify(trackBookmarks[trackId] || [])
        );
      }

      // Get current bookmark notes based on active bookmark tab
      function getCurrentBookmarkNotes() {
        if (!currentIdea) return "";

        if (currentBookmarkTab === "general") {
          return currentIdea.notes || "";
        }

        const bookmarks = trackBookmarks[currentIdea.id] || [];
        const bookmark = bookmarks.find((b) => b.id === currentBookmarkTab);
        return bookmark ? bookmark.notes || "" : currentIdea.notes || "";
      }

      // Get current bookmark placeholder
      function getCurrentBookmarkPlaceholder() {
        if (!currentIdea || currentBookmarkTab === "general") {
          return "Add notes about this track...";
        }

        const bookmarks = trackBookmarks[currentIdea.id] || [];
        const bookmark = bookmarks.find((b) => b.id === currentBookmarkTab);
        return bookmark
          ? `Notes for "${bookmark.name}"...`
          : "Add notes about this track...";
      }

      // Render bookmark tabs
      function renderBookmarkTabs(trackId) {
        const bookmarks = trackBookmarks[trackId] || [];
        if (bookmarks.length === 0) return "";

        return bookmarks
          .map(
            (bm) => `
    <button class="bookmark-tab ${
      currentBookmarkTab === bm.id ? "active" : ""
    }" 
            data-bookmark="${bm.id}" 
            onclick="event.stopPropagation(); switchBookmarkTab('${bm.id}')">
      ðŸ”– ${escapeHtml(bm.name)}
      <span class="bookmark-delete" onclick="event.stopPropagation(); deleteBookmark('${
        bm.id
      }')" title="Delete">Ã—</span>
    </button>
  `
          )
          .join("");
      }

      // Switch bookmark tab
      function switchBookmarkTab(bookmarkId) {
        currentBookmarkTab = bookmarkId;

        // Update tab active states
        document.querySelectorAll(".bookmark-tab").forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.bookmark === bookmarkId);
        });

        // Load the appropriate notes
        const textarea = document.getElementById("notes-textarea");
        if (!textarea || !currentIdea) return;

        if (bookmarkId === "general") {
          textarea.value = currentIdea.notes || "";
          textarea.placeholder = "Add notes about this track...";
        } else {
          const bookmarks = trackBookmarks[currentIdea.id] || [];
          const bookmark = bookmarks.find((b) => b.id === bookmarkId);
          if (bookmark) {
            textarea.value = bookmark.notes || "";
            textarea.placeholder = `Notes for "${bookmark.name}"...`;

            // Seek to bookmark start time (don't trigger re-render)
            if (audio && audio.src && !audio.paused) {
              audio.currentTime = bookmark.startTime;
            }
          } else {
            // Bookmark not found, switch back to general
            currentBookmarkTab = "general";
            textarea.value = currentIdea.notes || "";
            textarea.placeholder = "Add notes about this track...";
          }
        }
      }

      // Delete bookmark
      function deleteBookmark(bookmarkId) {
        if (!currentIdea) return;
        if (!confirm("Delete this bookmark?")) return;

        trackBookmarks[currentIdea.id] = (
          trackBookmarks[currentIdea.id] || []
        ).filter((b) => b.id !== bookmarkId);
        saveBookmarks(currentIdea.id);

        if (currentBookmarkTab === bookmarkId) {
          currentBookmarkTab = "general";
        }

        // Re-render tabs
        const tabsContainer = document.getElementById("bookmark-tabs");
        if (tabsContainer) {
          tabsContainer.innerHTML = renderBookmarkTabs(currentIdea.id);
        }

        switchBookmarkTab(currentBookmarkTab);
      }

      // Open bookmark modal
      function openBookmarkModal() {
        if (!currentIdea) return;

        // Initialize state
        const duration = audio?.duration || 180;
        bookmarkModalState = {
          startTime: 0,
          endTime: Math.min(30, duration),
          isPlaying: false,
          duration: duration,
        };

        let modal = document.getElementById("bookmark-modal-overlay");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "bookmark-modal-overlay";
          modal.className = "modal-overlay";
          modal.onclick = (e) => {
            if (e.target === modal) closeBookmarkModal();
          };
          document.body.appendChild(modal);
        }

        // Generate fake waveform bars
        const waveformBars = Array.from(
          { length: 100 },
          () =>
            `<div class="bookmark-waveform-bar" style="height: ${
              10 + Math.random() * 30
            }px;"></div>`
        ).join("");

        const startPercent = (bookmarkModalState.startTime / duration) * 100;
        const endPercent = (bookmarkModalState.endTime / duration) * 100;

        modal.innerHTML = `
    <div class="bookmark-modal">
      <div class="bookmark-modal-header">
        <span class="bookmark-modal-title">Add Bookmark</span>
        <button class="bookmark-modal-close" onclick="closeBookmarkModal()">Ã—</button>
      </div>
      <div class="bookmark-modal-body">
        <input type="text" class="bookmark-name-input" id="bookmark-name-input" placeholder="Bookmark name (e.g., Intro, Chorus, Bridge)..." autofocus>
        
        <div class="bookmark-timeline-container">
          <div class="bookmark-timeline-label">
            <span>Select Duration</span>
            <span class="bookmark-time-selected" id="bookmark-duration-display">
              ${formatTime(bookmarkModalState.startTime)} - ${formatTime(
          bookmarkModalState.endTime
        )}
            </span>
          </div>
          <div class="bookmark-timeline" id="bookmark-timeline" onmousedown="startTimelineClick(event)">
            <div class="bookmark-waveform">${waveformBars}</div>
            <div class="bookmark-selection" id="bookmark-selection" style="left: ${startPercent}%; width: ${
          endPercent - startPercent
        }%;">
              <div class="bookmark-handle bookmark-handle-start" onmousedown="startHandleDrag(event, 'start')"></div>
              <div class="bookmark-handle bookmark-handle-end" onmousedown="startHandleDrag(event, 'end')"></div>
            </div>
            <div class="bookmark-playhead" id="bookmark-playhead" style="left: ${startPercent}%;"></div>
          </div>
          <div class="bookmark-time-display">
            <span>0:00</span>
            <span>${formatTime(duration)}</span>
          </div>
        </div>
        
        <div class="bookmark-controls">
          <button class="bookmark-play-btn" id="bookmark-play-btn" onclick="toggleBookmarkPlay()">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <polygon points="6 3 20 12 6 21 6 3"/>
            </svg>
          </button>
        </div>
        
        <textarea class="bookmark-note-input" id="bookmark-note-input" placeholder="Add a note for this section (optional)..."></textarea>
      </div>
      <div class="bookmark-modal-footer">
        <button class="btn btn-secondary" onclick="closeBookmarkModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveBookmark()">Save Bookmark</button>
      </div>
    </div>
  `;

        modal.classList.add("open");
      }

      // Close bookmark modal
      function closeBookmarkModal() {
        const modal = document.getElementById("bookmark-modal-overlay");
        if (modal) modal.classList.remove("open");

        // Stop playback if playing
        if (bookmarkModalState.isPlaying) {
          bookmarkModalState.isPlaying = false;
        }
      }

      // Handle timeline click
      function startTimelineClick(event) {
        if (
          event.target.classList.contains("bookmark-handle") ||
          event.target.classList.contains("bookmark-handle-start") ||
          event.target.classList.contains("bookmark-handle-end")
        ) {
          return;
        }

        const timeline = document.getElementById("bookmark-timeline");
        const rect = timeline.getBoundingClientRect();
        const clickPercent = (event.clientX - rect.left) / rect.width;
        const clickTime = clickPercent * bookmarkModalState.duration;

        // Seek audio to clicked position
        if (audio && audio.src) {
          audio.currentTime = clickTime;
        }

        updateBookmarkPlayhead();
      }

      // Handle drag for start/end handles
      let currentDragHandle = null;

      function startHandleDrag(event, handle) {
        event.stopPropagation();
        currentDragHandle = handle;

        document.addEventListener("mousemove", handleDrag);
        document.addEventListener("mouseup", stopHandleDrag);
      }

      function handleDrag(event) {
        if (!currentDragHandle) return;

        const timeline = document.getElementById("bookmark-timeline");
        const rect = timeline.getBoundingClientRect();
        let percent = Math.max(
          0,
          Math.min(1, (event.clientX - rect.left) / rect.width)
        );
        let time = percent * bookmarkModalState.duration;

        if (currentDragHandle === "start") {
          bookmarkModalState.startTime = Math.min(
            time,
            bookmarkModalState.endTime - 1
          );
        } else {
          bookmarkModalState.endTime = Math.max(
            time,
            bookmarkModalState.startTime + 1
          );
        }

        updateBookmarkSelection();
      }

      function stopHandleDrag() {
        currentDragHandle = null;
        document.removeEventListener("mousemove", handleDrag);
        document.removeEventListener("mouseup", stopHandleDrag);
      }

      // Update selection visual
      function updateBookmarkSelection() {
        const selection = document.getElementById("bookmark-selection");
        const display = document.getElementById("bookmark-duration-display");
        const duration = bookmarkModalState.duration;

        const startPercent = (bookmarkModalState.startTime / duration) * 100;
        const endPercent = (bookmarkModalState.endTime / duration) * 100;

        if (selection) {
          selection.style.left = `${startPercent}%`;
          selection.style.width = `${endPercent - startPercent}%`;
        }

        if (display) {
          display.textContent = `${formatTime(
            bookmarkModalState.startTime
          )} - ${formatTime(bookmarkModalState.endTime)}`;
        }
      }

      // Update playhead position
      function updateBookmarkPlayhead() {
        const playhead = document.getElementById("bookmark-playhead");
        if (!playhead || !audio) return;

        const percent = (audio.currentTime / bookmarkModalState.duration) * 100;
        playhead.style.left = `${percent}%`;
      }

      // Toggle bookmark playback
      function toggleBookmarkPlay() {
        if (!audio || !audio.src) return;

        const btn = document.getElementById("bookmark-play-btn");

        if (bookmarkModalState.isPlaying) {
          audio.pause();
          bookmarkModalState.isPlaying = false;
          if (btn)
            btn.innerHTML =
              '<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 20 12 6 21 6 3"/></svg>';
        } else {
          audio.currentTime = bookmarkModalState.startTime;
          audio.play();
          bookmarkModalState.isPlaying = true;
          if (btn)
            btn.innerHTML =
              '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>';

          // Monitor playback to stop at end time
          const checkPlayback = () => {
            if (!bookmarkModalState.isPlaying) return;

            updateBookmarkPlayhead();

            if (audio.currentTime >= bookmarkModalState.endTime) {
              audio.pause();
              audio.currentTime = bookmarkModalState.startTime;
              bookmarkModalState.isPlaying = false;
              if (btn)
                btn.innerHTML =
                  '<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 20 12 6 21 6 3"/></svg>';
              return;
            }

            requestAnimationFrame(checkPlayback);
          };
          checkPlayback();
        }
      }

      // Save bookmark
      function saveBookmark() {
        if (!currentIdea) return;

        const nameInput = document.getElementById("bookmark-name-input");
        const noteInput = document.getElementById("bookmark-note-input");

        const name = nameInput?.value?.trim() || "Section";
        const notes = noteInput?.value?.trim() || "";

        const bookmark = {
          id: "bm_" + Date.now(),
          name: name,
          startTime: bookmarkModalState.startTime,
          endTime: bookmarkModalState.endTime,
          notes: notes,
          createdAt: new Date().toISOString(),
        };

        if (!trackBookmarks[currentIdea.id]) {
          trackBookmarks[currentIdea.id] = [];
        }

        trackBookmarks[currentIdea.id].push(bookmark);
        saveBookmarks(currentIdea.id);

        closeBookmarkModal();

        // Re-render tabs
        const tabsContainer = document.getElementById("bookmark-tabs");
        if (tabsContainer) {
          tabsContainer.innerHTML = renderBookmarkTabs(currentIdea.id);
        }

        // Switch to new bookmark
        switchBookmarkTab(bookmark.id);
      }

      // Modify saveNotes to handle bookmarks
      const originalSaveNotes =
        typeof saveNotes === "function" ? saveNotes : null;

      // ============ COMMENTS SYSTEM ============

      let trackComments = {}; // Cache comments by track ID

      // Default user image for "You" comments
      const DEFAULT_USER_IMAGE =
        "https://cdn.prod.website-files.com/65b19285607e503b8ea1a011/65fb8d5b173218f57c274e33_IMG_8213-scaled-e1685401885912-270x300.jpg";

      function renderComments(trackId) {
        const comments = trackComments[trackId] || [];
        const currentUserName =
          localStorage.getItem("ideas-user-name") || "You";

        if (comments.length === 0) {
          return `
      <div class="comments-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <div>No comments yet</div>
        <div style="font-size: 11px; opacity: 0.7;">Be the first to add feedback</div>
      </div>
    `;
        }

        return comments
          .map((c) => {
            const timeAgo = formatTimeAgo(c.created_at);
            const timestampHtml =
              c.timestamp_start !== null
                ? `
      <span class="comment-timestamp" onclick="event.stopPropagation(); seekToTimestamp(${
        c.timestamp_start
      }, ${c.timestamp_end || "null"})">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        ${formatTime(c.timestamp_start)}${
                    c.timestamp_end ? " - " + formatTime(c.timestamp_end) : ""
                  }
      </span>
    `
                : "";

            // Check if this is the current user's comment
            const isCurrentUser =
              c.user_name === currentUserName || c.user_name === "You";
            const avatarHtml = isCurrentUser
              ? `<img src="${DEFAULT_USER_IMAGE}" alt="${escapeHtml(
                  c.user_name || "You"
                )}">`
              : (c.user_name || "U").charAt(0).toUpperCase();

            return `
      <div class="comment-item">
        <div class="comment-avatar">${avatarHtml}</div>
        <div class="comment-content">
          <div class="comment-header">
            <span class="comment-author">${escapeHtml(
              c.user_name || "Unknown"
            )}</span>
            <span class="comment-time">${timeAgo}</span>
            ${timestampHtml}
          </div>
          <div class="comment-text">${escapeHtml(c.content)}</div>
        </div>
      </div>
    `;
          })
          .join("");
      }

      function formatTimeAgo(dateStr) {
        if (!dateStr) return "";
        const date = new Date(dateStr);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) return "just now";
        if (seconds < 3600) return Math.floor(seconds / 60) + "m ago";
        if (seconds < 86400) return Math.floor(seconds / 3600) + "h ago";
        if (seconds < 604800) return Math.floor(seconds / 86400) + "d ago";
        return date.toLocaleDateString();
      }

      async function loadComments(trackId) {
        if (!trackId) return;

        try {
          const { data, error } = await supabase
            .from("track_comments")
            .select("*")
            .eq("track_id", trackId)
            .order("created_at", { ascending: true });

          if (error) throw error;

          trackComments[trackId] = data || [];

          // Refresh display if viewing this track
          if (currentIdea?.id === trackId) {
            const list = document.getElementById("comments-list");
            if (list) list.innerHTML = renderComments(trackId);
          }
        } catch (err) {
          console.error("Error loading comments:", err);
          trackComments[trackId] = [];
        }
      }

      async function addComment() {
        if (!currentIdea) return;

        const input = document.getElementById("comment-input");
        const content = input?.value?.trim();
        if (!content) return;

        const timestampToggle = document.getElementById(
          "comment-timestamp-toggle"
        );
        const attachTimestamp = timestampToggle?.checked || false;

        const timestamp_start = attachTimestamp
          ? Math.floor(audio.currentTime)
          : null;
        const timestamp_end = null; // Could add range selection later

        // Get user name from localStorage or default
        const user_name = localStorage.getItem("ideas-user-name") || "You";

        const comment = {
          track_id: currentIdea.id,
          user_name,
          content,
          timestamp_start,
          timestamp_end,
          created_at: new Date().toISOString(),
        };

        try {
          const { data, error } = await supabase
            .from("track_comments")
            .insert([comment])
            .select();

          if (error) throw error;

          // Add to local cache
          if (!trackComments[currentIdea.id])
            trackComments[currentIdea.id] = [];
          trackComments[currentIdea.id].push(data[0] || comment);

          // Clear input
          input.value = "";

          // Refresh display
          const list = document.getElementById("comments-list");
          if (list) {
            list.innerHTML = renderComments(currentIdea.id);
            list.scrollTop = list.scrollHeight;
          }
        } catch (err) {
          console.error("Error adding comment:", err);
          alert("Error adding comment: " + err.message);
        }
      }

      function updateTimestampPreview() {
        const toggle = document.getElementById("comment-timestamp-toggle");
        const preview = document.getElementById("timestamp-preview");

        if (toggle?.checked && audio) {
          preview.textContent = "@ " + formatTime(audio.currentTime);
        } else {
          preview.textContent = "";
        }
      }

      function seekToTimestamp(start, end) {
        if (audio && start !== null) {
          audio.currentTime = start;
          if (!isPlaying) {
            audio.play();
            isPlaying = true;
            renderPlayerPanel();
          }
        }
      }

      // Update timestamp preview periodically when toggle is on
      setInterval(() => {
        const toggle = document.getElementById("comment-timestamp-toggle");
        if (toggle?.checked) {
          updateTimestampPreview();
        }
      }, 1000);

      // Todo items
      function renderTodoItems(todos) {
        if (!todos || todos.length === 0) return "";

        const items = typeof todos === "string" ? JSON.parse(todos) : todos;

        return items
          .map(
            (todo, i) => `
    <div class="todo-item ${todo.done ? "completed" : ""}">
      <div class="todo-checkbox ${
        todo.done ? "checked" : ""
      }" onclick="toggleTodo(${i})">
        ${
          todo.done
            ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="width:10px;height:10px;"><polyline points="20 6 9 17 4 12"/></svg>'
            : ""
        }
      </div>
      <span class="todo-text">${escapeHtml(todo.text)}</span>
      <button class="todo-delete" onclick="deleteTodo(${i})" title="Delete">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
  `
          )
          .join("");
      }

      async function addTodoItem(text) {
        if (!text || !currentIdea) return;

        const todos = currentIdea.todos
          ? typeof currentIdea.todos === "string"
            ? JSON.parse(currentIdea.todos)
            : currentIdea.todos
          : [];
        todos.push({ text, done: false });

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ todos: JSON.stringify(todos) })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.todos = todos;

          // Clear input and re-render
          const input = document.querySelector(".add-todo-input");
          if (input) input.value = "";

          const todoList = document.getElementById("todo-list");
          if (todoList) todoList.innerHTML = renderTodoItems(todos);
        } catch (err) {
          console.error("Error adding todo:", err);
        }
      }

      async function toggleTodo(index) {
        if (!currentIdea) return;

        const todos = currentIdea.todos
          ? typeof currentIdea.todos === "string"
            ? JSON.parse(currentIdea.todos)
            : currentIdea.todos
          : [];
        if (index >= todos.length) return;

        todos[index].done = !todos[index].done;

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ todos: JSON.stringify(todos) })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.todos = todos;

          const todoList = document.getElementById("todo-list");
          if (todoList) todoList.innerHTML = renderTodoItems(todos);
        } catch (err) {
          console.error("Error toggling todo:", err);
        }
      }

      async function deleteTodo(index) {
        if (!currentIdea) return;

        const todos = currentIdea.todos
          ? typeof currentIdea.todos === "string"
            ? JSON.parse(currentIdea.todos)
            : currentIdea.todos
          : [];
        if (index >= todos.length) return;

        todos.splice(index, 1);

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ todos: todos.length > 0 ? JSON.stringify(todos) : null })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.todos = todos;

          const todoList = document.getElementById("todo-list");
          if (todoList) todoList.innerHTML = renderTodoItems(todos);
        } catch (err) {
          console.error("Error deleting todo:", err);
        }
      }

      // Update progress bar
      audio.addEventListener("timeupdate", () => {
        const progressBar = document.getElementById("progress-bar");
        const currentTimeEl = document.getElementById("current-time");
        const durationEl = document.getElementById("duration");
        const miniProgressCircle = document.getElementById(
          "mini-progress-circle"
        );
        const progressRingFill = document.getElementById("progress-ring-fill");

        if (progressBar && audio.duration) {
          const percent = (audio.currentTime / audio.duration) * 100;
          progressBar.style.width = percent + "%";
        }

        // Update mini circular progress
        if (miniProgressCircle && audio.duration) {
          const circumference = 2 * Math.PI * 34; // radius 34
          const percent = audio.currentTime / audio.duration;
          const offset = circumference - percent * circumference;
          miniProgressCircle.style.strokeDashoffset = offset;
        }

        // Update album art progress ring (rounded rect perimeter: 2*width + 2*height - 8*radius + 2*pi*radius)
        // For 96x96 rect with r=10: 2*96 + 2*96 - 8*10 + 2*pi*10 â‰ˆ 384 - 80 + 62.8 â‰ˆ 367
        if (progressRingFill && audio.duration) {
          const perimeter = 384; // Approximate perimeter
          const percent = audio.currentTime / audio.duration;
          const offset = perimeter - percent * perimeter;
          progressRingFill.style.strokeDashoffset = offset;
        }

        if (currentTimeEl) {
          currentTimeEl.textContent = formatTime(audio.currentTime);
        }

        if (durationEl && audio.duration) {
          durationEl.textContent = formatTime(audio.duration);
        }
      });

      audio.addEventListener("ended", () => {
        isPlaying = false;
        // Autoplay next track in the current view
        navigateTrackList(1);
      });

      audio.addEventListener("play", () => {
        isLoading = false;
        isPlaying = true;
        renderPlayerPanel();
      });

      audio.addEventListener("pause", () => {
        isPlaying = false;
      });

      audio.addEventListener("canplaythrough", () => {
        isLoading = false;
        renderPlayerPanel();
      });

      audio.addEventListener("error", (e) => {
        console.error("Audio error:", e);
        isLoading = false;
        isPlaying = false;
        renderPlayerPanel();
      });

      audio.addEventListener("loadstart", () => {
        isLoading = true;
      });

      // Format time as m:ss
      function formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return "0:00";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, "0")}`;
      }

      // ============ DUE DATE SYSTEM ============

      const MONTH_NAMES = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
      ];
      const DAY_NAMES = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];

      let dueDateModalIdeaId = null;
      let dueDateSelectedDate = null;
      let dueDateCurrentMonth = new Date();

      function formatDueDate(dateStr) {
        if (!dateStr) return "";
        const date = new Date(dateStr);
        return `${date.getDate()} ${MONTH_NAMES[date.getMonth()]}`;
      }

      function getDueDateClass(dateStr) {
        if (!dateStr) return "empty";

        const date = new Date(dateStr);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        date.setHours(0, 0, 0, 0);

        const diffDays = Math.ceil((date - today) / (1000 * 60 * 60 * 24));

        if (diffDays < 0) return "red"; // Overdue
        if (diffDays <= 3) return "red";
        if (diffDays <= 7) return "orange";
        return "green";
      }

      function openDueDateModal(ideaId) {
        dueDateModalIdeaId = ideaId;
        const idea = allIdeas.find((i) => i.id === ideaId);

        if (idea?.due_date) {
          dueDateSelectedDate = new Date(idea.due_date);
          dueDateCurrentMonth = new Date(idea.due_date);
        } else {
          dueDateSelectedDate = null;
          dueDateCurrentMonth = new Date();
        }

        const modal = document.getElementById("due-date-modal");
        modal.classList.add("open");

        // Update title with track name
        document.getElementById("due-date-track-name").textContent =
          idea?.title || "Unknown";

        renderDueDateCalendar();
      }

      function closeDueDateModal() {
        document.getElementById("due-date-modal").classList.remove("open");
        dueDateModalIdeaId = null;
      }

      function renderDueDateCalendar() {
        const container = document.getElementById("due-date-calendar");
        const monthYear = document.getElementById("due-date-month-year");

        const year = dueDateCurrentMonth.getFullYear();
        const month = dueDateCurrentMonth.getMonth();

        monthYear.textContent = `${MONTH_NAMES[month]} ${year}`;

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let html = "";

        // Day headers
        DAY_NAMES.forEach((day) => {
          html += `<div class="calendar-day-header">${day}</div>`;
        });

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
          const day = daysInPrevMonth - i;
          const date = new Date(year, month - 1, day);
          html += `<div class="calendar-day other-month" onclick="selectDueDate(${year}, ${
            month - 1
          }, ${day})">${day}</div>`;
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          date.setHours(0, 0, 0, 0);

          const isToday = date.getTime() === today.getTime();
          const isSelected =
            dueDateSelectedDate &&
            dueDateSelectedDate.getFullYear() === year &&
            dueDateSelectedDate.getMonth() === month &&
            dueDateSelectedDate.getDate() === day;
          const isPast = date < today;

          let classes = "calendar-day";
          if (isToday) classes += " today";
          if (isSelected) classes += " selected";
          if (isPast) classes += " past";

          html += `<div class="${classes}" onclick="selectDueDate(${year}, ${month}, ${day})">${day}</div>`;
        }

        // Next month days to fill grid
        const totalCells = firstDay + daysInMonth;
        const remainingCells = (7 - (totalCells % 7)) % 7;
        for (let day = 1; day <= remainingCells; day++) {
          html += `<div class="calendar-day other-month" onclick="selectDueDate(${year}, ${
            month + 1
          }, ${day})">${day}</div>`;
        }

        container.innerHTML = html;

        // Update quick buttons
        updateQuickButtons();
      }

      function updateQuickButtons() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        document.querySelectorAll(".due-date-quick-btn").forEach((btn) => {
          const days = parseInt(btn.dataset.days);
          const targetDate = new Date(today);
          targetDate.setDate(today.getDate() + days);

          const isSelected =
            dueDateSelectedDate &&
            dueDateSelectedDate.getFullYear() === targetDate.getFullYear() &&
            dueDateSelectedDate.getMonth() === targetDate.getMonth() &&
            dueDateSelectedDate.getDate() === targetDate.getDate();

          btn.classList.toggle("selected", isSelected);
        });
      }

      function selectDueDate(year, month, day) {
        dueDateSelectedDate = new Date(year, month, day);
        dueDateCurrentMonth = new Date(year, month, 1);
        renderDueDateCalendar();
      }

      function selectQuickDueDate(days) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        dueDateSelectedDate = new Date(today);
        dueDateSelectedDate.setDate(today.getDate() + days);
        dueDateCurrentMonth = new Date(dueDateSelectedDate);
        renderDueDateCalendar();
      }

      function prevMonth() {
        dueDateCurrentMonth.setMonth(dueDateCurrentMonth.getMonth() - 1);
        renderDueDateCalendar();
      }

      function nextMonth() {
        dueDateCurrentMonth.setMonth(dueDateCurrentMonth.getMonth() + 1);
        renderDueDateCalendar();
      }

      async function clearDueDate() {
        if (!dueDateModalIdeaId) return;

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ due_date: null })
            .eq("id", dueDateModalIdeaId);

          if (error) throw error;

          const idea = allIdeas.find((i) => i.id === dueDateModalIdeaId);
          if (idea) idea.due_date = null;
          if (currentIdea?.id === dueDateModalIdeaId)
            currentIdea.due_date = null;

          closeDueDateModal();
          renderIdeasTable();
          renderPlayerPanel();
        } catch (err) {
          console.error("Error clearing due date:", err);
        }
      }

      async function saveDueDate() {
        if (!dueDateModalIdeaId || !dueDateSelectedDate) return;

        const dateStr = dueDateSelectedDate.toISOString().split("T")[0];

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ due_date: dateStr })
            .eq("id", dueDateModalIdeaId);

          if (error) throw error;

          const idea = allIdeas.find((i) => i.id === dueDateModalIdeaId);
          if (idea) idea.due_date = dateStr;
          if (currentIdea?.id === dueDateModalIdeaId)
            currentIdea.due_date = dateStr;

          closeDueDateModal();
          renderIdeasTable();
          renderPlayerPanel();
        } catch (err) {
          console.error("Error saving due date:", err);
        }
      }

      // Toggle favorite
      async function toggleFavorite(id) {
        const idea = allIdeas.find((i) => i.id === id);
        if (!idea) return;

        const newValue = !idea.is_favorite;

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ is_favorite: newValue })
            .eq("id", id);

          if (error) throw error;

          idea.is_favorite = newValue;
          if (currentIdea?.id === id) {
            currentIdea.is_favorite = newValue;
          }

          renderIdeasTable();
          renderPlayerPanel();

          // Show feedback
          showToast(
            newValue ? "â˜… Added to Favorites" : "Removed from Favorites"
          );
        } catch (err) {
          console.error("Error updating favorite:", err);
        }
      }

      // Save notes
      async function saveNotes() {
        if (!currentIdea) return;

        const textarea = document.getElementById("notes-textarea");
        if (!textarea) return;

        const notes = textarea.value;

        // Check if we're saving a bookmark note or general notes
        if (currentBookmarkTab !== "general") {
          // Save bookmark note locally
          const bookmarks = trackBookmarks[currentIdea.id] || [];
          const bookmark = bookmarks.find((b) => b.id === currentBookmarkTab);
          if (bookmark) {
            bookmark.notes = notes;
            saveBookmarks(currentIdea.id);

            // Show saved feedback
            const btn = document.getElementById("notes-save-btn");
            if (btn) {
              btn.classList.add("saved");
              btn.textContent = "Saved!";
              setTimeout(() => {
                btn.classList.remove("visible", "saved");
                btn.textContent = "Save";
              }, 1500);
            }
          }
          return;
        }

        // Save general notes to database
        if (!notesDirty) return;

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ notes: notes || null })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.notes = notes;
          const idea = allIdeas.find((i) => i.id === currentIdea.id);
          if (idea) idea.notes = notes;

          // Show saved feedback
          notesDirty = false;
          const btn = document.getElementById("notes-save-btn");
          if (btn) {
            btn.classList.add("saved");
            btn.textContent = "Saved!";
            setTimeout(() => {
              btn.classList.remove("visible", "saved");
              btn.textContent = "Save";
            }, 1500);
          }
        } catch (err) {
          console.error("Error saving notes:", err);
          alert("Error saving notes: " + err.message);
        }
      }

      // Export filtered ideas as CSV
      function exportCSV() {
        const headers = [
          "title",
          "project_name",
          "tags",
          "priority",
          "is_favorite",
          "notes",
          "dropbox_url",
        ];
        const rows = [headers.join(",")];

        filteredIdeas.forEach((idea) => {
          const row = headers.map((h) => {
            let val = idea[h] ?? "";
            if (typeof val === "boolean") val = val ? "true" : "false";
            // Escape CSV
            val = String(val);
            if (val.includes(",") || val.includes('"') || val.includes("\n")) {
              val = '"' + val.replace(/"/g, '""') + '"';
            }
            return val;
          });
          rows.push(row.join(","));
        });

        const csv = rows.join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `ideas-export-${new Date()
          .toISOString()
          .slice(0, 10)}.csv`;
        a.click();

        URL.revokeObjectURL(url);
      }

      // Setup event listeners
      function setupEventListeners() {
        // Search input
        searchInput.addEventListener("input", (e) => {
          searchQuery = e.target.value;
          applyFilters();
        });

        // Filter buttons
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            document
              .querySelectorAll(".filter-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            currentFilter = btn.dataset.filter;
            applyFilters();
          });
        });

        // Mobile player panel toggle
        const playerPanel = document.querySelector(".player-panel");
        const playerHeader = document.querySelector(".player-header");

        if (playerHeader) {
          playerHeader.addEventListener("click", () => {
            if (window.innerWidth <= 768) {
              playerPanel.classList.toggle("expanded");
            }
          });
        }

        // Expand player when a track is selected on mobile
        const originalPlayIdea = window.playIdea;
        window.playIdea = function (id) {
          originalPlayIdea(id);
          if (window.innerWidth <= 768) {
            playerPanel.classList.add("expanded");
          }
        };

        // Keyboard shortcuts
        document.addEventListener("keydown", handleKeyboardShortcuts);
      }

      // Keyboard shortcuts handler
      function handleKeyboardShortcuts(e) {
        // Cmd+F / Ctrl+F to focus search - works even when typing
        if ((e.metaKey || e.ctrlKey) && e.key === "f") {
          e.preventDefault();
          const searchInput = document.getElementById("search-input");
          if (searchInput) {
            searchInput.focus();
            searchInput.select();
          }
          return;
        }

        // Don't trigger when typing in inputs
        const activeEl = document.activeElement;
        const isTyping =
          activeEl &&
          (activeEl.tagName === "INPUT" ||
            activeEl.tagName === "TEXTAREA" ||
            activeEl.isContentEditable);

        if (isTyping) return;

        // Check if inbox modal is open
        const inboxModal = document.getElementById("inbox-modal");
        const isInboxOpen = inboxModal && inboxModal.classList.contains("open");

        if (isInboxOpen) {
          // Handle inbox-specific shortcuts
          handleInboxKeyboard(e);
          return;
        }

        switch (e.code) {
          case "Space":
            // Toggle play/pause
            if (currentIdea) {
              e.preventDefault();
              e.stopPropagation();
              togglePlay();
            }
            break;

          case "ArrowUp":
            // Select previous track
            e.preventDefault();
            navigateTrackList(-1);
            break;

          case "ArrowDown":
            // Select next track
            e.preventDefault();
            navigateTrackList(1);
            break;

          case "ArrowLeft":
            // Skip back 10 seconds
            if (currentIdea && audio.src) {
              e.preventDefault();
              skipBack();
            }
            break;

          case "ArrowRight":
            // Skip forward 10 seconds
            if (currentIdea && audio.src) {
              e.preventDefault();
              skipForward();
            }
            break;
        }
      }

      // Handle keyboard shortcuts when inbox modal is open
      function handleInboxKeyboard(e) {
        switch (e.code) {
          case "Space":
            // Toggle play/pause inbox audio
            e.preventDefault();
            e.stopPropagation();
            toggleMemoPlayback();
            break;

          case "ArrowUp":
            // Select previous memo
            e.preventDefault();
            navigateInboxList(-1);
            break;

          case "ArrowDown":
            // Select next memo
            e.preventDefault();
            navigateInboxList(1);
            break;

          case "ArrowLeft":
            // Seek back 5 seconds
            if (currentMemoAudio) {
              e.preventDefault();
              currentMemoAudio.currentTime = Math.max(
                0,
                currentMemoAudio.currentTime - 5
              );
            }
            break;

          case "ArrowRight":
            // Seek forward 5 seconds
            if (currentMemoAudio) {
              e.preventDefault();
              currentMemoAudio.currentTime = Math.min(
                currentMemoAudio.duration || 0,
                currentMemoAudio.currentTime + 5
              );
            }
            break;
        }
      }

      // Navigate up/down in inbox list
      function navigateInboxList(direction) {
        if (!filteredVoiceMemos.length) return;

        let currentIndex = -1;
        if (currentMemoId) {
          currentIndex = filteredVoiceMemos.findIndex(
            (m) => m.id === currentMemoId
          );
        }

        let newIndex;
        if (currentIndex === -1) {
          // No memo selected, select first or last based on direction
          newIndex = direction > 0 ? 0 : filteredVoiceMemos.length - 1;
        } else {
          newIndex = currentIndex + direction;
          // Wrap around
          if (newIndex < 0) newIndex = filteredVoiceMemos.length - 1;
          if (newIndex >= filteredVoiceMemos.length) newIndex = 0;
        }

        const newMemo = filteredVoiceMemos[newIndex];
        if (newMemo) {
          selectMemo(newMemo.id);

          // Scroll the row into view
          const row = document.querySelector(`tr[onclick*="${newMemo.id}"]`);
          if (row) {
            row.scrollIntoView({ behavior: "smooth", block: "nearest" });
          }
        }
      }

      // Navigate up/down in track list
      function navigateTrackList(direction) {
        if (!filteredIdeas.length) return;

        let currentIndex = -1;
        if (currentIdea) {
          currentIndex = filteredIdeas.findIndex(
            (i) => i.id === currentIdea.id
          );
        }

        let newIndex;
        if (currentIndex === -1) {
          // No track selected, select first or last based on direction
          newIndex = direction > 0 ? 0 : filteredIdeas.length - 1;
        } else {
          newIndex = currentIndex + direction;
          // Wrap around
          if (newIndex < 0) newIndex = filteredIdeas.length - 1;
          if (newIndex >= filteredIdeas.length) newIndex = 0;
        }

        const newIdea = filteredIdeas[newIndex];
        if (newIdea) {
          window.playIdea(newIdea.id);

          // Scroll the row into view
          const row = document.querySelector(`[data-idea-id="${newIdea.id}"]`);
          if (row) {
            row.scrollIntoView({ behavior: "smooth", block: "nearest" });
          }
        }
      }

      // ============ ADVANCED FILTER SYSTEM ============

      let advancedFilters = {
        projects: [],
        stages: [],
        workflowTags: [],
        dueDates: [],
        priorities: [],
      };

      let savedViews = [];
      let activeViewId = null;

      // Load saved views from localStorage
      function loadSavedViews() {
        try {
          const saved = localStorage.getItem("ideas-saved-views");
          if (saved) {
            savedViews = JSON.parse(saved);
          }
        } catch (e) {
          console.error("Error loading saved views:", e);
          savedViews = [];
        }
        renderSavedViewsTabs();
      }

      // Save views to localStorage
      function persistSavedViews() {
        localStorage.setItem("ideas-saved-views", JSON.stringify(savedViews));
      }

      // Render saved views tabs
      function renderSavedViewsTabs() {
        const container = document.getElementById("saved-views-tabs");

        if (!container) return;

        if (savedViews.length === 0) {
          container.innerHTML = "";
          return;
        }

        container.innerHTML = savedViews
          .map(
            (view) => `
    <div class="saved-view-tab ${activeViewId === view.id ? "active" : ""}" 
         onclick="activateSavedView('${view.id}')"
         data-view-id="${view.id}">
      <span>${escapeHtml(view.name)}</span>
      <span class="view-delete" onclick="event.stopPropagation(); deleteSavedView('${
        view.id
      }')" title="Delete view">Ã—</span>
    </div>
  `
          )
          .join("");
      }

      // Activate a saved view
      function activateSavedView(viewId) {
        const view = savedViews.find((v) => v.id === viewId);
        if (!view) return;

        // Toggle off if already active
        if (activeViewId === viewId) {
          activeViewId = null;
          advancedFilters = {
            projects: [],
            stages: [],
            workflowTags: [],
            dueDates: [],
            priorities: [],
          };
        } else {
          activeViewId = viewId;
          advancedFilters = { ...view.filters };
        }

        renderSavedViewsTabs();
        applyFilters();
      }

      // Delete a saved view
      function deleteSavedView(viewId) {
        if (!confirm("Delete this saved view?")) return;

        savedViews = savedViews.filter((v) => v.id !== viewId);
        if (activeViewId === viewId) {
          activeViewId = null;
          advancedFilters = {
            projects: [],
            stages: [],
            workflowTags: [],
            dueDates: [],
            priorities: [],
          };
          applyFilters();
        }

        persistSavedViews();
        renderSavedViewsTabs();
      }

      // Open filter panel
      function openFilterPanel() {
        const overlay = document.getElementById("filter-panel-overlay");
        overlay.classList.add("open");
        renderFilterPanelBody();
      }

      // Close filter panel
      function closeFilterPanel() {
        const overlay = document.getElementById("filter-panel-overlay");
        overlay.classList.remove("open");
      }

      // Render filter panel body
      function renderFilterPanelBody() {
        const body = document.getElementById("filter-panel-body");
        if (!body) return;

        // Get unique individual projects (split combined values)
        const projectSet = new Set();
        allIdeas.forEach((idea) => {
          if (idea.project_name) {
            idea.project_name.split(",").forEach((p) => {
              const trimmed = p.trim();
              if (trimmed && trimmed !== "Unassigned") {
                projectSet.add(trimmed);
              }
            });
          }
        });
        const projects = [...projectSet].sort();

        body.innerHTML = `
    <!-- Projects -->
    <div class="filter-section">
      <div class="filter-section-title">Projects</div>
      <div class="filter-options">
        ${projects
          .map((p) => {
            const color = getProjectColor(p);
            return `
          <div class="filter-option ${
            advancedFilters.projects.includes(p) ? "selected" : ""
          }" 
               onclick="toggleFilterOption('projects', '${escapeHtml(p).replace(
                 /'/g,
                 "\\'"
               )}')">
            <span class="option-dot" style="background: ${color};"></span>
            ${escapeHtml(p)}
          </div>
        `;
          })
          .join("")}
        ${
          projects.length === 0
            ? '<span style="color: var(--text-muted); font-size: 12px;">No projects</span>'
            : ""
        }
      </div>
    </div>
    
    <!-- Stages -->
    <div class="filter-section">
      <div class="filter-section-title">Stage</div>
      <div class="filter-options">
        ${STAGES.map(
          (s) => `
          <div class="filter-option ${
            advancedFilters.stages.includes(s.id) ? "selected" : ""
          }" 
               onclick="toggleFilterOption('stages', '${s.id}')">
            ${s.icon} ${s.name}
          </div>
        `
        ).join("")}
      </div>
    </div>
    
    <!-- Workflow Tags -->
    <div class="filter-section">
      <div class="filter-section-title">Workflow Status</div>
      <div class="filter-options">
        ${ALL_TASK_TAGS.map(
          (tag) => `
          <div class="filter-option ${
            advancedFilters.workflowTags.includes(tag.id) ? "selected" : ""
          }" 
               onclick="toggleFilterOption('workflowTags', '${tag.id}')">
            <span class="option-dot" style="background: ${tag.color};"></span>
            ${tag.label}
          </div>
        `
        ).join("")}
      </div>
    </div>
    
    <!-- Due Date -->
    <div class="filter-section">
      <div class="filter-section-title">Due Date</div>
      <div class="filter-options">
        <div class="filter-option ${
          advancedFilters.dueDates.includes("overdue") ? "selected" : ""
        }" 
             onclick="toggleFilterOption('dueDates', 'overdue')">
          ðŸ”´ Overdue
        </div>
        <div class="filter-option ${
          advancedFilters.dueDates.includes("today") ? "selected" : ""
        }" 
             onclick="toggleFilterOption('dueDates', 'today')">
          ðŸ“… Due Today
        </div>
        <div class="filter-option ${
          advancedFilters.dueDates.includes("week") ? "selected" : ""
        }" 
             onclick="toggleFilterOption('dueDates', 'week')">
          ðŸ“† This Week
        </div>
        <div class="filter-option ${
          advancedFilters.dueDates.includes("no-date") ? "selected" : ""
        }" 
             onclick="toggleFilterOption('dueDates', 'no-date')">
          âšª No Due Date
        </div>
      </div>
    </div>
    
    <!-- Priority (Excitement) -->
    <div class="filter-section">
      <div class="filter-section-title">Priority / Excitement</div>
      <div class="filter-options">
        <div class="filter-option ${
          advancedFilters.priorities.includes("5") ? "selected" : ""
        }" 
             onclick="toggleFilterOption('priorities', '5')">
          â˜…â˜…â˜…â˜…â˜… (5)
        </div>
        <div class="filter-option ${
          advancedFilters.priorities.includes("4") ? "selected" : ""
        }" 
             onclick="toggleFilterOption('priorities', '4')">
          â˜…â˜…â˜…â˜… (4+)
        </div>
        <div class="filter-option ${
          advancedFilters.priorities.includes("3") ? "selected" : ""
        }" 
             onclick="toggleFilterOption('priorities', '3')">
          â˜…â˜…â˜… (3+)
        </div>
        <div class="filter-option ${
          advancedFilters.priorities.includes("unrated") ? "selected" : ""
        }" 
             onclick="toggleFilterOption('priorities', 'unrated')">
          â˜† Unrated
        </div>
      </div>
    </div>
    
    <!-- Artwork Style -->
    <div class="filter-section">
      <div class="filter-section-title">Artwork Style</div>
      <div class="filter-options artwork-style-options">
        <div class="filter-option artwork-style-item ${
          getArtworkStyle() === "vibrant" ? "selected" : ""
        }" 
             onclick="selectArtworkStyle('vibrant')">
          <span class="style-preview vibrant"></span>
          Vibrant
        </div>
        <div class="filter-option artwork-style-item ${
          getArtworkStyle() === "vintage" ? "selected" : ""
        }" 
             onclick="selectArtworkStyle('vintage')">
          <span class="style-preview vintage"></span>
          Vintage
        </div>
        <div class="filter-option artwork-style-item ${
          getArtworkStyle() === "minimal" ? "selected" : ""
        }" 
             onclick="selectArtworkStyle('minimal')">
          <span class="style-preview minimal"></span>
          Minimal
        </div>
      </div>
    </div>
  `;
      }

      // Toggle filter option
      function toggleFilterOption(category, value) {
        const arr = advancedFilters[category];
        const idx = arr.indexOf(value);

        if (idx === -1) {
          arr.push(value);
        } else {
          arr.splice(idx, 1);
        }

        renderFilterPanelBody();
      }

      // Clear all filters
      function clearAllFilters() {
        advancedFilters = {
          projects: [],
          stages: [],
          workflowTags: [],
          dueDates: [],
          priorities: [],
        };
        activeViewId = null;
        renderFilterPanelBody();
        renderSavedViewsTabs();
        applyFilters();
      }

      // Apply advanced filters
      function applyAdvancedFilters() {
        closeFilterPanel();
        activeViewId = null; // Clear active view since we're using custom filters
        renderSavedViewsTabs();
        applyFilters();
      }

      // Check if any advanced filters are active
      function hasActiveAdvancedFilters() {
        return (
          advancedFilters.projects.length > 0 ||
          advancedFilters.stages.length > 0 ||
          advancedFilters.workflowTags.length > 0 ||
          advancedFilters.dueDates.length > 0 ||
          advancedFilters.priorities.length > 0
        );
      }

      // Save current view
      function saveCurrentView() {
        if (!hasActiveAdvancedFilters()) {
          alert("Please set some filters first before saving a view.");
          openFilterPanel();
          return;
        }

        document.getElementById("save-view-modal").classList.add("open");
        document.getElementById("view-name-input").value = "";
        document.getElementById("view-name-input").focus();
      }

      // Close save view modal
      function closeSaveViewModal() {
        document.getElementById("save-view-modal").classList.remove("open");
      }

      // Confirm save view
      function confirmSaveView() {
        const name = document.getElementById("view-name-input").value.trim();
        if (!name) {
          alert("Please enter a name for this view.");
          return;
        }

        const newView = {
          id: "view_" + Date.now(),
          name: name,
          filters: { ...advancedFilters },
        };

        savedViews.push(newView);
        persistSavedViews();
        renderSavedViewsTabs();
        closeSaveViewModal();

        // Activate the new view
        activeViewId = newView.id;
        renderSavedViewsTabs();
      }

      // Escape HTML
      function escapeHtml(str) {
        if (!str) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      // ============ TRACK SETTINGS MODAL ============

      function openTrackSettingsModal() {
        if (!currentIdea) return;

        const tabVisibility = getTabVisibility();

        let modal = document.getElementById("track-settings-modal");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "track-settings-modal";
          modal.className = "modal-overlay";
          modal.onclick = (e) => {
            if (e.target === modal) closeTrackSettingsModal();
          };
          document.body.appendChild(modal);
        }

        modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Track Settings</h3>
        <button class="modal-close" onclick="closeTrackSettingsModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="metadata-grid" style="grid-template-columns: 110px 1fr;">
          <span class="metadata-label">Display Name</span>
          <input class="metadata-input" type="text" id="track-title" value="${escapeHtml(
            currentIdea.title || ""
          )}">
          
          <span class="metadata-label">Audio File URL</span>
          <input class="metadata-input" type="text" id="track-audio-url" placeholder="https://..." value="${escapeHtml(
            currentIdea.supabase_url || currentIdea.dropbox_url || ""
          )}">
          
          <span class="metadata-label">Project File</span>
          <input class="metadata-input" type="text" id="track-project-file" placeholder="Path to .als, .logicx, etc." value="${escapeHtml(
            currentIdea.project_file_path || ""
          )}">
          
          <span class="metadata-label">BPM</span>
          <input class="metadata-input" type="text" id="track-bpm" placeholder="120" value="${escapeHtml(
            currentIdea.bpm || ""
          )}">
          
          <span class="metadata-label">Key</span>
          <input class="metadata-input" type="text" id="track-key" placeholder="C minor" value="${escapeHtml(
            currentIdea.musical_key || ""
          )}">
          
          <span class="metadata-label">Genre</span>
          <input class="metadata-input" type="text" id="track-genre" placeholder="Electronic" value="${escapeHtml(
            currentIdea.genre || ""
          )}">
          
          <span class="metadata-label">Tags</span>
          <input class="metadata-input" type="text" id="track-tags" placeholder="ambient, synth, dark" value="${escapeHtml(
            currentIdea.tags || ""
          )}">
          
          <span class="metadata-label">Version</span>
          <input class="metadata-input" type="text" id="track-version" placeholder="1.0" value="${escapeHtml(
            currentIdea.version || ""
          )}">
          
          <span class="metadata-label">Base Name</span>
          <input class="metadata-input" type="text" id="track-base-name" placeholder="For version grouping" value="${escapeHtml(
            currentIdea.base_name || ""
          )}">
        </div>
        
        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
          <div style="font-size: 12px; font-weight: 500; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">Visible Tabs</div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <label class="tab-toggle-label">
              <input type="checkbox" id="tab-toggle-notes" ${
                tabVisibility.notes !== false ? "checked" : ""
              }>
              <span class="tab-toggle-text">Notes</span>
            </label>
            <label class="tab-toggle-label">
              <input type="checkbox" id="tab-toggle-comments" ${
                tabVisibility.comments !== false ? "checked" : ""
              }>
              <span class="tab-toggle-text">Comments</span>
            </label>
            <label class="tab-toggle-label">
              <input type="checkbox" id="tab-toggle-team" ${
                tabVisibility.collaborators !== false ? "checked" : ""
              }>
              <span class="tab-toggle-text">Team</span>
            </label>
            <label class="tab-toggle-label">
              <input type="checkbox" id="tab-toggle-todo" ${
                tabVisibility.todo !== false ? "checked" : ""
              }>
              <span class="tab-toggle-text">Todo</span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeTrackSettingsModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveTrackSettings()">Save Changes</button>
      </div>
    </div>
  `;

        modal.classList.add("open");
        document.getElementById("track-title").focus();
      }

      function closeTrackSettingsModal() {
        const modal = document.getElementById("track-settings-modal");
        if (modal) modal.classList.remove("open");
      }

      async function saveTrackSettings() {
        if (!currentIdea) return;

        const title = document.getElementById("track-title")?.value?.trim();
        const audioUrl = document
          .getElementById("track-audio-url")
          ?.value?.trim();
        const projectFilePath = document
          .getElementById("track-project-file")
          ?.value?.trim();
        const bpm = document.getElementById("track-bpm")?.value?.trim();
        const musicalKey = document.getElementById("track-key")?.value?.trim();
        const genre = document.getElementById("track-genre")?.value?.trim();
        const tags = document.getElementById("track-tags")?.value?.trim();
        const version = document.getElementById("track-version")?.value?.trim();
        const baseName = document
          .getElementById("track-base-name")
          ?.value?.trim();

        // Save tab visibility settings
        const tabVisibility = {
          notes: document.getElementById("tab-toggle-notes")?.checked !== false,
          comments:
            document.getElementById("tab-toggle-comments")?.checked !== false,
          collaborators:
            document.getElementById("tab-toggle-team")?.checked !== false,
          todo: document.getElementById("tab-toggle-todo")?.checked !== false,
        };
        setTabVisibility(tabVisibility);

        if (!title) {
          alert("Display name is required");
          return;
        }

        const updates = {
          title,
          supabase_url: audioUrl || null,
          project_file_path: projectFilePath || null,
          bpm: bpm || null,
          musical_key: musicalKey || null,
          genre: genre || null,
          tags: tags || null,
          version: version || null,
          base_name: baseName || null,
        };

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update(updates)
            .eq("id", currentIdea.id);

          if (error) throw error;

          // Update local data
          Object.assign(currentIdea, updates);

          const idx = allIdeas.findIndex((i) => i.id === currentIdea.id);
          if (idx !== -1) {
            Object.assign(allIdeas[idx], updates);
          }

          closeTrackSettingsModal();
          renderPlayerPanel();
          renderIdeasTable();
        } catch (err) {
          console.error("Error saving track settings:", err);
          alert("Error saving: " + err.message);
        }
      }

      // ============ TAB VISIBILITY ============

      function getTabVisibility() {
        return JSON.parse(localStorage.getItem("ideas-tab-visibility") || "{}");
      }

      function setTabVisibility(visibility) {
        localStorage.setItem(
          "ideas-tab-visibility",
          JSON.stringify(visibility)
        );
      }

      // ============ COLLABORATOR AVATARS ============

      function renderCollaboratorAvatars(collaborators) {
        if (
          !collaborators ||
          !Array.isArray(collaborators) ||
          collaborators.length === 0
        ) {
          return "";
        }

        const maxDisplay = 3;
        const displayCollabs = collaborators.slice(0, maxDisplay);
        const remaining = collaborators.length - maxDisplay;

        let html =
          '<div class="album-collaborator-avatars" onclick="switchPlayerTab(\'collaborators\')" title="Team Members">';

        displayCollabs.forEach((collab) => {
          if (collab.image_url) {
            html += `<div class="album-collaborator-avatar"><img src="${escapeHtml(
              collab.image_url
            )}" alt="${escapeHtml(collab.name)}"></div>`;
          } else {
            const initials = (collab.name || "U")
              .split(" ")
              .map((n) => n[0])
              .join("")
              .slice(0, 2)
              .toUpperCase();
            html += `<div class="album-collaborator-avatar">${initials}</div>`;
          }
        });

        if (remaining > 0) {
          html += `<div class="album-collaborator-avatar album-collaborator-more">+${remaining}</div>`;
        }

        html += "</div>";
        return html;
      }

      // ============ TRACK INFO MODAL ============

      function openTrackInfoModal() {
        if (!currentIdea) return;

        let modal = document.getElementById("track-info-modal");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "track-info-modal";
          modal.className = "modal-overlay";
          modal.onclick = (e) => {
            if (e.target === modal) closeTrackInfoModal();
          };
          document.body.appendChild(modal);
        }

        const idea = currentIdea;
        const createdDate = idea.created_at
          ? new Date(idea.created_at).toLocaleDateString()
          : "Unknown";
        const updatedDate = idea.updated_at
          ? new Date(idea.updated_at).toLocaleDateString()
          : "Unknown";
        const hasCustomImage =
          idea.cover_image_url && idea.cover_image_url.trim() !== "";

        // Generate album art preview
        const albumArtSvg = generateAlbumArt(
          idea.title,
          idea.tags || "",
          idea.project_name || ""
        );

        modal.innerHTML = `
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h3>Track Details</h3>
        <button class="modal-close" onclick="closeTrackInfoModal()">Ã—</button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        
        <!-- Cover Image Section -->
        <div class="info-section" style="text-align: center;">
          <div class="cover-image-preview" id="cover-image-preview">
            ${
              hasCustomImage
                ? `<img src="${escapeHtml(
                    idea.cover_image_url
                  )}" alt="Cover" style="width: 120px; height: 120px; border-radius: 8px; object-fit: cover;">`
                : `<div style="width: 120px; height: 120px; border-radius: 8px; overflow: hidden; margin: 0 auto;">${albumArtSvg}</div>`
            }
          </div>
          <div style="display: flex; gap: 8px; justify-content: center; margin-top: 12px;">
            <label class="btn btn-secondary btn-sm" style="cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Upload Image
              <input type="file" accept="image/*" onchange="uploadCoverImage(this)" style="display: none;">
            </label>
            ${
              hasCustomImage
                ? `
              <button class="btn btn-secondary btn-sm" onclick="useGeneratedArt()" style="display: inline-flex; align-items: center; gap: 6px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                  <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                  <path d="M3 3v5h5"/>
                </svg>
                Use Generated
              </button>
            `
                : ""
            }
          </div>
        </div>
        
        <!-- Basic Info -->
        <div class="info-section">
          <div class="info-section-title">Basic Info</div>
          <div class="metadata-grid" style="grid-template-columns: 100px 1fr;">
            <span class="metadata-label">Title</span>
            <input class="metadata-input" type="text" id="info-title" value="${escapeHtml(
              idea.title || ""
            )}">
            
            <span class="metadata-label">Project</span>
            <input class="metadata-input" type="text" id="info-project" value="${escapeHtml(
              idea.project_name || ""
            )}">
            
            <span class="metadata-label">Stage</span>
            <select class="metadata-input" id="info-stage">
              <option value="seed" ${
                idea.stage === "seed" ? "selected" : ""
              }>ðŸŒ± Seed</option>
              <option value="sprout" ${
                idea.stage === "sprout" ? "selected" : ""
              }>ðŸŒ¿ Sprout</option>
              <option value="sapling" ${
                idea.stage === "sapling" ? "selected" : ""
              }>ðŸŒ³ Sapling</option>
              <option value="bloom" ${
                idea.stage === "bloom" ? "selected" : ""
              }>ðŸŒ¸ Bloom</option>
              <option value="harvest" ${
                idea.stage === "harvest" ? "selected" : ""
              }>âœ¨ Harvest</option>
            </select>
          </div>
        </div>
        
        <!-- Audio Details -->
        <div class="info-section">
          <div class="info-section-title">Audio Details</div>
          <div class="metadata-grid" style="grid-template-columns: 100px 1fr;">
            <span class="metadata-label">BPM</span>
            <input class="metadata-input" type="text" id="info-bpm" placeholder="120" value="${escapeHtml(
              idea.bpm || ""
            )}">
            
            <span class="metadata-label">Key</span>
            <input class="metadata-input" type="text" id="info-key" placeholder="C minor" value="${escapeHtml(
              idea.musical_key || ""
            )}">
            
            <span class="metadata-label">Genre</span>
            <input class="metadata-input" type="text" id="info-genre" placeholder="Electronic" value="${escapeHtml(
              idea.genre || ""
            )}">
            
            <span class="metadata-label">Tags</span>
            <input class="metadata-input" type="text" id="info-tags" placeholder="ambient, synth" value="${escapeHtml(
              idea.tags || ""
            )}">
            
            <span class="metadata-label">Duration</span>
            <input class="metadata-input" type="text" id="info-duration" value="${escapeHtml(
              idea.duration || ""
            )}" placeholder="3:45">
          </div>
        </div>
        
        <!-- Version & Grouping -->
        <div class="info-section">
          <div class="info-section-title">Version</div>
          <div class="metadata-grid" style="grid-template-columns: 100px 1fr;">
            <span class="metadata-label">Version</span>
            <input class="metadata-input" type="text" id="info-version" placeholder="1.0" value="${escapeHtml(
              idea.version || ""
            )}">
            
            <span class="metadata-label">Base Name</span>
            <input class="metadata-input" type="text" id="info-base-name" placeholder="For grouping versions" value="${escapeHtml(
              idea.base_name || ""
            )}">
          </div>
        </div>
        
        <!-- File Paths -->
        <div class="info-section">
          <div class="info-section-title">Files</div>
          <div class="metadata-grid" style="grid-template-columns: 100px 1fr;">
            <span class="metadata-label">Audio URL</span>
            <input class="metadata-input" type="text" id="info-audio-url" placeholder="https://..." value="${escapeHtml(
              idea.supabase_url || idea.dropbox_url || ""
            )}">
            
            <span class="metadata-label">Project File</span>
            <input class="metadata-input" type="text" id="info-project-file" placeholder=".als, .logicx path" value="${escapeHtml(
              idea.project_file_path || ""
            )}">
          </div>
        </div>
        
        <!-- Dates -->
        <div class="info-section">
          <div class="info-section-title">Dates</div>
          <div class="metadata-grid" style="grid-template-columns: 100px 1fr;">
            <span class="metadata-label">Due Date</span>
            <input class="metadata-input" type="date" id="info-due-date" value="${
              idea.due_date || ""
            }">
            
            <span class="metadata-label">Created</span>
            <span class="metadata-value" style="font-size: 11px; color: var(--text-muted);">${createdDate}</span>
            
            <span class="metadata-label">Updated</span>
            <span class="metadata-value" style="font-size: 11px; color: var(--text-muted);">${updatedDate}</span>
          </div>
        </div>
        
        <!-- Description -->
        <div class="info-section">
          <div class="info-section-title">Description</div>
          <textarea class="metadata-input" id="info-description" rows="2" placeholder="Add a description..." style="resize: vertical;">${escapeHtml(
            idea.description || ""
          )}</textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeTrackInfoModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveTrackInfo()">Save Changes</button>
      </div>
    </div>
  `;

        modal.classList.add("open");
      }

      // Upload cover image
      async function uploadCoverImage(input) {
        if (!input.files || !input.files[0] || !currentIdea) return;

        const file = input.files[0];
        const maxSize = 5 * 1024 * 1024; // 5MB

        if (file.size > maxSize) {
          alert("Image must be less than 5MB");
          return;
        }

        try {
          // Upload to Supabase storage
          const fileExt = file.name.split(".").pop();
          const fileName = `${currentIdea.id}_cover.${fileExt}`;
          const filePath = `covers/${fileName}`;

          const { data: uploadData, error: uploadError } =
            await supabase.storage
              .from("idea-covers")
              .upload(filePath, file, { upsert: true });

          if (uploadError) throw uploadError;

          // Get public URL
          const { data: urlData } = supabase.storage
            .from("idea-covers")
            .getPublicUrl(filePath);

          const coverUrl = urlData.publicUrl + "?t=" + Date.now(); // Cache bust

          // Update database
          const { error: updateError } = await supabase
            .from("idea_tracks")
            .update({ cover_image_url: coverUrl })
            .eq("id", currentIdea.id);

          if (updateError) throw updateError;

          // Update local data
          currentIdea.cover_image_url = coverUrl;
          const idx = allIdeas.findIndex((i) => i.id === currentIdea.id);
          if (idx !== -1) allIdeas[idx].cover_image_url = coverUrl;

          // Update preview
          const preview = document.getElementById("cover-image-preview");
          if (preview) {
            preview.innerHTML = `<img src="${coverUrl}" alt="Cover" style="width: 120px; height: 120px; border-radius: 8px; object-fit: cover;">`;
          }

          // Re-open modal to show "Use Generated" button
          openTrackInfoModal();
          renderPlayerPanel();
          renderIdeasTable();

          showToast("Cover image uploaded");
        } catch (err) {
          console.error("Error uploading cover:", err);
          alert("Error uploading image: " + err.message);
        }
      }

      // Switch back to generated art
      async function useGeneratedArt() {
        if (!currentIdea) return;

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update({ cover_image_url: null })
            .eq("id", currentIdea.id);

          if (error) throw error;

          currentIdea.cover_image_url = null;
          const idx = allIdeas.findIndex((i) => i.id === currentIdea.id);
          if (idx !== -1) allIdeas[idx].cover_image_url = null;

          openTrackInfoModal();
          renderPlayerPanel();
          renderIdeasTable();

          showToast("Using generated artwork");
        } catch (err) {
          console.error("Error:", err);
          alert("Error: " + err.message);
        }
      }

      function closeTrackInfoModal() {
        const modal = document.getElementById("track-info-modal");
        if (modal) modal.classList.remove("open");
      }

      async function saveTrackInfo() {
        if (!currentIdea) return;

        const updates = {
          title:
            document.getElementById("info-title")?.value?.trim() ||
            currentIdea.title,
          project_name:
            document.getElementById("info-project")?.value?.trim() || null,
          stage: document.getElementById("info-stage")?.value || "seed",
          bpm: document.getElementById("info-bpm")?.value?.trim() || null,
          musical_key:
            document.getElementById("info-key")?.value?.trim() || null,
          genre: document.getElementById("info-genre")?.value?.trim() || null,
          tags: document.getElementById("info-tags")?.value?.trim() || null,
          duration:
            document.getElementById("info-duration")?.value?.trim() || null,
          supabase_url:
            document.getElementById("info-audio-url")?.value?.trim() || null,
          project_file_path:
            document.getElementById("info-project-file")?.value?.trim() || null,
          version:
            document.getElementById("info-version")?.value?.trim() || null,
          base_name:
            document.getElementById("info-base-name")?.value?.trim() || null,
          due_date: document.getElementById("info-due-date")?.value || null,
          description:
            document.getElementById("info-description")?.value?.trim() || null,
        };

        try {
          const { error } = await supabase
            .from("idea_tracks")
            .update(updates)
            .eq("id", currentIdea.id);

          if (error) throw error;

          // Update local data
          Object.assign(currentIdea, updates);

          const idx = allIdeas.findIndex((i) => i.id === currentIdea.id);
          if (idx !== -1) {
            Object.assign(allIdeas[idx], updates);
          }

          closeTrackInfoModal();
          renderPlayerPanel();
          renderIdeasTable();
          renderProjectList();

          showToast("Track info saved");
        } catch (err) {
          console.error("Error saving track info:", err);
          alert("Error saving: " + err.message);
        }
      }

      // ============ KEYBOARD SHORTCUTS ============

      function getOrderedProjectList() {
        // Returns the list of projects in sidebar order
        const orderedList = [];

        // 1 = All Ideas
        orderedList.push({ name: null, label: "All Ideas" });

        // Get visible projects from sidebar hierarchy
        const hierarchy = getProjectHierarchy();
        const settings = getProjectSettings();

        function addFromHierarchy(items) {
          items.forEach((proj) => {
            if (!settings.hidden?.[proj.name]) {
              orderedList.push({ name: proj.name, label: proj.name });
              // Add children (nested projects)
              const children = hierarchy.children[proj.name];
              if (children) {
                addFromHierarchy(children);
              }
            }
          });
        }

        addFromHierarchy(hierarchy.roots);

        // Archive at the end (if exists)
        if (getArchivedCount() > 0) {
          orderedList.push({ name: "Archive", label: "Archive" });
        }

        return orderedList;
      }

      document.addEventListener("keydown", (e) => {
        // ESC to close any open modal
        if (e.key === "Escape") {
          // Close inbox modal first (and its dropdowns)
          const inboxModal = document.getElementById("inbox-modal");
          if (inboxModal && inboxModal.classList.contains("open")) {
            // First close any inbox dropdowns
            closeInboxDropdowns();
            // Check if any dropdown was closed
            const hasDropdown = document.querySelector(
              ".inbox-dropdown, .inbox-more-menu.open"
            );
            if (!hasDropdown) {
              closeInboxModal();
            }
            return;
          }

          // Close due date modal
          const dueDateModal = document.getElementById("due-date-modal");
          if (dueDateModal && dueDateModal.classList.contains("open")) {
            closeDueDateModal();
            return;
          }

          // Close collaborator modal
          const collabModal = document.getElementById("collaborator-modal");
          if (collabModal && collabModal.classList.contains("open")) {
            closeCollaboratorModal();
            return;
          }

          // Close track settings modal
          const trackSettingsModal = document.getElementById(
            "track-settings-modal"
          );
          if (
            trackSettingsModal &&
            trackSettingsModal.classList.contains("open")
          ) {
            closeTrackSettingsModal();
            return;
          }

          // Close project settings modal
          const projectSettingsModal = document.querySelector(
            ".project-settings-modal.open"
          );
          if (projectSettingsModal) {
            closeProjectSettings();
            return;
          }

          // Close track info modal
          const trackInfoModal = document.getElementById("track-info-modal");
          if (trackInfoModal && trackInfoModal.classList.contains("open")) {
            closeTrackInfoModal();
            return;
          }

          // Close any dropdown
          closeTagDropdown();
          closeAllStageDropdowns();
          closeAllPriorityDropdowns();
          return;
        }

        // Don't trigger shortcuts when typing in inputs
        if (e.target.matches("input, textarea, [contenteditable]")) return;

        // Don't trigger if modal is open (including inbox)
        const hasOpenModal = document.querySelector(
          ".modal-overlay.open, .project-settings-modal.open, #collaborator-modal.open, #track-settings-modal.open, #inbox-modal.open"
        );
        if (hasOpenModal) return;

        const key = e.key.toLowerCase();

        // Q = Toggle Left Sidebar
        if (key === "q" && !e.ctrlKey && !e.metaKey && !e.altKey) {
          e.preventDefault();
          toggleSidebarCollapse();
          return;
        }

        // E = Toggle Right Sidebar (Player Panel)
        if (key === "e" && !e.ctrlKey && !e.metaKey && !e.altKey) {
          e.preventDefault();
          togglePlayerCollapse();
          return;
        }

        // Number keys 1-9 for project navigation
        if (/^[1-9]$/.test(key) && !e.ctrlKey && !e.metaKey && !e.altKey) {
          const idx = parseInt(key) - 1;
          const projectList = getOrderedProjectList();

          if (idx < projectList.length) {
            e.preventDefault();
            const proj = projectList[idx];
            selectProject(proj.name);
          }
          return;
        }

        // Z = Toggle Favorite
        if (key === "z" && !e.ctrlKey && !e.metaKey && !e.altKey) {
          if (currentIdea) {
            e.preventDefault();
            toggleFavorite(currentIdea.id);
          }
          return;
        }

        // X = Toggle Archive
        if (key === "x" && !e.ctrlKey && !e.metaKey && !e.altKey) {
          if (currentIdea) {
            e.preventDefault();
            toggleArchive(currentIdea.id);
          }
          return;
        }

        // Note: Space and Arrow keys are handled by handleKeyboardShortcuts()
      });

      // Simple toast notification
      function showToast(message) {
        let toast = document.getElementById("toast-notification");
        if (!toast) {
          toast = document.createElement("div");
          toast.id = "toast-notification";
          toast.style.cssText = `
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 12px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      z-index: 10000;
      transition: transform 0.3s ease;
    `;
          document.body.appendChild(toast);
        }

        toast.textContent = message;
        toast.style.transform = "translateX(-50%) translateY(0)";

        setTimeout(() => {
          toast.style.transform = "translateX(-50%) translateY(100px)";
        }, 2000);
      }

      // ============ SETTINGS MODAL & COLLABORATORS ============

      let savedCollaborators = [];

      function openSettingsModal() {
        document.getElementById("settings-modal").classList.add("open");
        loadSavedCollaborators();
      }

      function closeSettingsModal() {
        document.getElementById("settings-modal").classList.remove("open");
        hideCollaboratorForm();
      }

      function switchSettingsTab(tabId) {
        // Update nav buttons
        document.querySelectorAll(".settings-nav-item").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.tab === tabId);
        });

        // Update tab content
        document.querySelectorAll(".settings-tab").forEach((tab) => {
          tab.style.display = "none";
        });
        document.getElementById(`settings-tab-${tabId}`).style.display =
          "block";
      }

      async function loadSavedCollaborators() {
        try {
          const { data, error } = await supabase
            .from("collaborators")
            .select("*")
            .order("is_default", { ascending: false })
            .order("name");

          if (error) throw error;

          savedCollaborators = data || [];
          renderCollaboratorsList();
        } catch (err) {
          console.error("Error loading collaborators:", err);
          // Table might not exist yet
          savedCollaborators = [];
          renderCollaboratorsList();
        }
      }

      function renderCollaboratorsList() {
        const container = document.getElementById("collaborators-list");

        if (savedCollaborators.length === 0) {
          container.innerHTML = `
      <button class="add-collaborator-card" onclick="showAddCollaboratorForm()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Add your first collaborator
      </button>
    `;
          return;
        }

        container.innerHTML = savedCollaborators
          .map((collab) => {
            const initials = (collab.name || "U")
              .split(" ")
              .map((n) => n[0])
              .join("")
              .slice(0, 2)
              .toUpperCase();
            const aliases = collab.aliases ? collab.aliases.join(", ") : "";

            return `
      <div class="collaborator-card">
        <div class="collaborator-card-avatar">
          ${
            collab.image_url
              ? `<img src="${escapeHtml(collab.image_url)}" alt="${escapeHtml(
                  collab.name
                )}">`
              : initials
          }
        </div>
        <div class="collaborator-card-info">
          <div class="collaborator-card-name">
            ${escapeHtml(collab.name)}
            ${
              collab.is_default
                ? '<span class="collaborator-default-badge">Default</span>'
                : ""
            }
          </div>
          ${
            collab.email
              ? `<div class="collaborator-card-email">${escapeHtml(
                  collab.email
                )}</div>`
              : ""
          }
          ${
            aliases
              ? `<div class="collaborator-card-aliases">Aliases: ${escapeHtml(
                  aliases
                )}</div>`
              : ""
          }
        </div>
        <div class="collaborator-card-meta" style="text-align: right; margin-right: 12px;">
          ${
            collab.default_split
              ? `<div style="font-size: 14px; font-weight: 600; color: var(--text);">${collab.default_split}%</div>`
              : ""
          }
          ${
            collab.default_role
              ? `<div style="font-size: 10px; color: var(--text-muted);">${escapeHtml(
                  collab.default_role
                )}</div>`
              : ""
          }
        </div>
        <div class="collaborator-card-actions">
          <button class="collaborator-card-btn" onclick="toggleDefaultCollaborator('${
            collab.id
          }')" title="${
              collab.is_default ? "Remove from defaults" : "Set as default"
            }">
            <svg viewBox="0 0 24 24" fill="${
              collab.is_default ? "currentColor" : "none"
            }" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
          </button>
          <button class="collaborator-card-btn" onclick="editCollaborator('${
            collab.id
          }')" title="Edit">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
          </button>
          <button class="collaborator-card-btn danger" onclick="deleteCollaborator('${
            collab.id
          }')" title="Delete">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
        </div>
      </div>
    `;
          })
          .join("");
      }

      function showAddCollaboratorForm() {
        document.getElementById("collaborator-form").style.display = "block";
        document.getElementById("collab-edit-id").value = "";
        document.getElementById("collab-name").value = "";
        document.getElementById("collab-email").value = "";
        document.getElementById("collab-split").value = "";
        document.getElementById("collab-role").value = "";
        document.getElementById("collab-aliases").value = "";
        document.getElementById("collab-image").value = "";
        document.getElementById("collab-default").checked = false;
        document.getElementById("collab-name").focus();
      }

      function hideCollaboratorForm() {
        document.getElementById("collaborator-form").style.display = "none";
      }

      function editCollaborator(id) {
        const collab = savedCollaborators.find((c) => c.id === id);
        if (!collab) return;

        document.getElementById("collaborator-form").style.display = "block";
        document.getElementById("collab-edit-id").value = id;
        document.getElementById("collab-name").value = collab.name || "";
        document.getElementById("collab-email").value = collab.email || "";
        document.getElementById("collab-split").value =
          collab.default_split || "";
        document.getElementById("collab-role").value =
          collab.default_role || "";
        document.getElementById("collab-aliases").value = collab.aliases
          ? collab.aliases.join(", ")
          : "";
        document.getElementById("collab-image").value = collab.image_url || "";
        document.getElementById("collab-default").checked =
          collab.is_default || false;
      }

      async function saveCollaborator() {
        const editId = document.getElementById("collab-edit-id").value;
        const name = document.getElementById("collab-name").value.trim();

        if (!name) {
          alert("Name is required");
          return;
        }

        const aliasesStr = document
          .getElementById("collab-aliases")
          .value.trim();
        const aliases = aliasesStr
          ? aliasesStr
              .split(",")
              .map((a) => a.trim())
              .filter((a) => a)
          : [];

        const collaboratorData = {
          name: name,
          email: document.getElementById("collab-email").value.trim() || null,
          default_split:
            parseInt(document.getElementById("collab-split").value) || null,
          default_role:
            document.getElementById("collab-role").value.trim() || null,
          aliases: aliases.length > 0 ? aliases : null,
          image_url:
            document.getElementById("collab-image").value.trim() || null,
          is_default: document.getElementById("collab-default").checked,
        };

        try {
          if (editId) {
            // Update existing
            const { error } = await supabase
              .from("collaborators")
              .update(collaboratorData)
              .eq("id", editId);

            if (error) throw error;
            showToast("Collaborator updated");
          } else {
            // Insert new
            const { error } = await supabase
              .from("collaborators")
              .insert(collaboratorData);

            if (error) throw error;
            showToast("Collaborator added");
          }

          hideCollaboratorForm();
          await loadSavedCollaborators();
        } catch (err) {
          console.error("Error saving collaborator:", err);
          alert("Error: " + err.message);
        }
      }

      async function deleteCollaborator(id) {
        const collab = savedCollaborators.find((c) => c.id === id);
        if (!collab) return;

        if (!confirm(`Delete collaborator "${collab.name}"?`)) return;

        try {
          const { error } = await supabase
            .from("collaborators")
            .delete()
            .eq("id", id);

          if (error) throw error;

          showToast("Collaborator deleted");
          await loadSavedCollaborators();
        } catch (err) {
          console.error("Error deleting collaborator:", err);
          alert("Error: " + err.message);
        }
      }

      async function toggleDefaultCollaborator(id) {
        const collab = savedCollaborators.find((c) => c.id === id);
        if (!collab) return;

        try {
          const { error } = await supabase
            .from("collaborators")
            .update({ is_default: !collab.is_default })
            .eq("id", id);

          if (error) throw error;

          showToast(
            collab.is_default ? "Removed from defaults" : "Added to defaults"
          );
          await loadSavedCollaborators();
        } catch (err) {
          console.error("Error toggling default:", err);
          alert("Error: " + err.message);
        }
      }

      // Auto-detect collaborators from track title (e.g., "Arn x Josh - Track Name")
      function detectCollaboratorsFromTitle(title) {
        if (!title || !savedCollaborators.length) return [];

        const detected = [];
        const beforeDash = title.split(" - ")[0];

        // Split by common separators: x, X, &, feat., ft., ,
        const parts = beforeDash.split(/\s+(?:x|X|&|feat\.?|ft\.?)\s+|,\s*/);

        for (const part of parts) {
          const cleanPart = part.trim().toLowerCase();
          if (!cleanPart) continue;

          // Check each collaborator's name and aliases
          for (const collab of savedCollaborators) {
            const nameMatch = collab.name.toLowerCase() === cleanPart;
            const aliasMatch =
              collab.aliases &&
              collab.aliases.some((a) => a.toLowerCase() === cleanPart);

            if (nameMatch || aliasMatch) {
              if (!detected.find((d) => d.id === collab.id)) {
                detected.push({
                  id: collab.id,
                  name: collab.name,
                  role: collab.default_role || "Collaborator",
                  split: collab.default_split || 0,
                  image_url: collab.image_url,
                });
              }
            }
          }
        }

        return detected;
      }

      // Get default collaborators to add to new tracks
      function getDefaultCollaborators() {
        return savedCollaborators
          .filter((c) => c.is_default)
          .map((c) => ({
            id: c.id,
            name: c.name,
            role: c.default_role || "Collaborator",
            split: c.default_split || 0,
            image_url: c.image_url,
          }));
      }

      // Initialize on load
      init();
    </script>

    <!-- Project Settings Modal -->
    <div
      class="project-settings-modal"
      id="project-settings-modal"
      onclick="if(event.target === this) closeProjectSettings()"
    >
      <div class="project-settings-content">
        <div class="project-settings-header">
          <h3>Project Settings</h3>
          <button
            class="project-settings-close"
            onclick="closeProjectSettings()"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="project-settings-body">
          <div class="project-settings-hint">
            Drag projects to nest them under others. Hold
            <kbd
              style="
                background: var(--bg-hover);
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 11px;
              "
              >âŒ¥ Alt</kbd
            >
            while dropping to reorder instead. Click the name to rename.
          </div>
          <div class="settings-project-list" id="settings-project-list">
            <!-- Rendered dynamically -->
          </div>
          <div
            class="settings-drop-zone"
            id="settings-root-zone"
            ondragover="handleSettingsDragOver(event)"
            ondragleave="handleSettingsDragLeave(event)"
            ondrop="handleSettingsDropToRoot(event)"
          >
            Drop here to make root-level
          </div>

          <!-- Add New Project Section -->
          <div class="add-project-section">
            <div class="add-project-header">Add New Project</div>
            <div class="add-project-row">
              <input
                type="text"
                id="new-project-name"
                placeholder="Project name..."
                class="add-project-input"
              />
              <div class="add-project-color-picker">
                <div
                  class="color-option"
                  data-color="#8B5CF6"
                  style="background: #8b5cf6"
                  onclick="selectProjectColor(this)"
                ></div>
                <div
                  class="color-option"
                  data-color="#06B6D4"
                  style="background: #06b6d4"
                  onclick="selectProjectColor(this)"
                ></div>
                <div
                  class="color-option"
                  data-color="#10B981"
                  style="background: #10b981"
                  onclick="selectProjectColor(this)"
                ></div>
                <div
                  class="color-option"
                  data-color="#F59E0B"
                  style="background: #f59e0b"
                  onclick="selectProjectColor(this)"
                ></div>
                <div
                  class="color-option"
                  data-color="#EF4444"
                  style="background: #ef4444"
                  onclick="selectProjectColor(this)"
                ></div>
                <div
                  class="color-option"
                  data-color="#EC4899"
                  style="background: #ec4899"
                  onclick="selectProjectColor(this)"
                ></div>
                <div
                  class="color-option"
                  data-color="#6366F1"
                  style="background: #6366f1"
                  onclick="selectProjectColor(this)"
                ></div>
                <div
                  class="color-option selected"
                  data-color="#64748B"
                  style="background: #64748b"
                  onclick="selectProjectColor(this)"
                ></div>
              </div>
              <button class="add-project-btn" onclick="addNewProject()">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Add
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Column Settings Modal -->
    <div
      class="column-settings-modal"
      id="column-settings-modal"
      onclick="if(event.target === this) closeColumnSettings()"
    >
      <div class="column-settings-content">
        <div class="column-settings-header">
          <h3>Column Settings</h3>
          <button class="column-settings-close" onclick="closeColumnSettings()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="column-settings-body">
          <div class="column-settings-hint">
            Drag to reorder columns. Click the eye icon to show/hide columns.
          </div>
          <div class="settings-column-list" id="settings-column-list">
            <!-- Rendered dynamically -->
          </div>
        </div>
      </div>
    </div>

    <!-- Due Date Modal -->
    <div
      class="due-date-modal"
      id="due-date-modal"
      onclick="if(event.target === this) closeDueDateModal()"
    >
      <div class="due-date-content">
        <div class="due-date-header">
          <div>
            <h3>Set Due Date</h3>
            <div class="subtitle" id="due-date-track-name">Track Name</div>
          </div>
          <button class="due-date-close" onclick="closeDueDateModal()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="due-date-body">
          <div class="due-date-quick-btns">
            <button
              class="due-date-quick-btn"
              data-days="0"
              onclick="selectQuickDueDate(0)"
            >
              Today
            </button>
            <button
              class="due-date-quick-btn"
              data-days="1"
              onclick="selectQuickDueDate(1)"
            >
              Tomorrow
            </button>
            <button
              class="due-date-quick-btn"
              data-days="3"
              onclick="selectQuickDueDate(3)"
            >
              +3 days
            </button>
            <button
              class="due-date-quick-btn"
              data-days="7"
              onclick="selectQuickDueDate(7)"
            >
              +7 days
            </button>
            <button
              class="due-date-quick-btn"
              data-days="14"
              onclick="selectQuickDueDate(14)"
            >
              +14 days
            </button>
          </div>

          <div class="calendar-nav">
            <button class="calendar-nav-btn" onclick="prevMonth()">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="15 18 9 12 15 6" />
              </svg>
            </button>
            <span class="calendar-month-year" id="due-date-month-year"
              >December 2025</span
            >
            <button class="calendar-nav-btn" onclick="nextMonth()">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="9 6 15 12 9 18" />
              </svg>
            </button>
          </div>

          <div class="calendar-grid" id="due-date-calendar">
            <!-- Rendered dynamically -->
          </div>
        </div>
        <div class="due-date-footer">
          <button class="due-date-btn clear" onclick="clearDueDate()">
            Clear
          </button>
          <button class="due-date-btn update" onclick="saveDueDate()">
            Update
          </button>
        </div>
      </div>
    </div>

    <!-- Platform Settings Modal -->
    <div
      class="modal-overlay"
      id="settings-modal"
      onclick="if(event.target === this) closeSettingsModal()"
    >
      <div class="modal-content settings-modal">
        <div class="modal-header">
          <h2>Settings</h2>
          <button class="modal-close" onclick="closeSettingsModal()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="settings-sidebar">
            <button
              class="settings-nav-item active"
              onclick="switchSettingsTab('collaborators')"
              data-tab="collaborators"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
              </svg>
              Collaborators
            </button>
            <button
              class="settings-nav-item"
              onclick="switchSettingsTab('storage')"
              data-tab="storage"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
                />
              </svg>
              Storage
            </button>
            <button
              class="settings-nav-item"
              onclick="switchSettingsTab('account')"
              data-tab="account"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" />
              </svg>
              Account
            </button>
          </div>
          <div class="settings-content">
            <!-- Collaborators Tab -->
            <div class="settings-tab active" id="settings-tab-collaborators">
              <div class="settings-section">
                <div class="settings-section-title">
                  Saved Collaborators
                  <button
                    class="btn btn-sm btn-primary"
                    onclick="showAddCollaboratorForm()"
                  >
                    <svg
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      style="width: 12px; height: 12px"
                    >
                      <line x1="12" y1="5" x2="12" y2="19" />
                      <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    Add
                  </button>
                </div>
                <p class="settings-description">
                  Manage your collaborators here. Default collaborators will be
                  automatically added to every new track. Add aliases to
                  auto-detect collaborators from track titles (e.g., "Arn x Josh
                  - Track Name").
                </p>

                <!-- Add/Edit Collaborator Form (hidden by default) -->
                <div
                  class="collaborator-form"
                  id="collaborator-form"
                  style="display: none"
                >
                  <div class="collaborator-form-row">
                    <div class="collaborator-form-group">
                      <label>Name *</label>
                      <input
                        type="text"
                        id="collab-name"
                        placeholder="Full name"
                      />
                    </div>
                    <div class="collaborator-form-group">
                      <label>Email</label>
                      <input
                        type="email"
                        id="collab-email"
                        placeholder="email@example.com"
                      />
                    </div>
                  </div>
                  <div class="collaborator-form-row">
                    <div class="collaborator-form-group">
                      <label>Default Split %</label>
                      <input
                        type="number"
                        id="collab-split"
                        placeholder="50"
                        min="0"
                        max="100"
                      />
                    </div>
                    <div class="collaborator-form-group">
                      <label>Default Role</label>
                      <input
                        type="text"
                        id="collab-role"
                        placeholder="Producer, Vocalist, etc."
                      />
                    </div>
                  </div>
                  <div class="collaborator-form-row full">
                    <div class="collaborator-form-group">
                      <label>Aliases (comma-separated)</label>
                      <input
                        type="text"
                        id="collab-aliases"
                        placeholder="Arn, ARN, A.R.N"
                      />
                    </div>
                  </div>
                  <div class="collaborator-form-row full">
                    <div class="collaborator-form-group">
                      <label>Image URL</label>
                      <input
                        type="text"
                        id="collab-image"
                        placeholder="https://..."
                      />
                    </div>
                  </div>
                  <label class="collaborator-form-checkbox">
                    <input type="checkbox" id="collab-default" />
                    Add to all new tracks by default
                  </label>
                  <input type="hidden" id="collab-edit-id" />
                  <div class="collaborator-form-actions">
                    <button
                      class="btn btn-secondary"
                      onclick="hideCollaboratorForm()"
                    >
                      Cancel
                    </button>
                    <button
                      class="btn btn-primary"
                      onclick="saveCollaborator()"
                    >
                      Save Collaborator
                    </button>
                  </div>
                </div>

                <!-- Collaborators List -->
                <div class="collaborator-cards" id="collaborators-list">
                  <div class="loading">Loading collaborators...</div>
                </div>
              </div>
            </div>

            <!-- Storage Tab -->
            <div
              class="settings-tab"
              id="settings-tab-storage"
              style="display: none"
            >
              <div class="settings-section">
                <div class="settings-section-title">Dropbox Connection</div>
                <p class="settings-description">
                  Connect your Dropbox to sync project files and voice notes.
                  Currently using a shared sync folder.
                </p>
                <div
                  style="
                    padding: 20px;
                    background: var(--bg-hover);
                    border-radius: 8px;
                    text-align: center;
                  "
                >
                  <p style="color: var(--text-muted); margin-bottom: 12px">
                    Dropbox integration coming soon
                  </p>
                  <button class="btn btn-secondary" disabled>
                    Connect Dropbox
                  </button>
                </div>
              </div>
            </div>

            <!-- Account Tab -->
            <div
              class="settings-tab"
              id="settings-tab-account"
              style="display: none"
            >
              <div class="settings-section">
                <div class="settings-section-title">Account</div>
                <p class="settings-description">
                  Multi-user authentication coming soon. You'll be able to sign
                  in with Google and manage your profile.
                </p>
                <div
                  style="
                    padding: 20px;
                    background: var(--bg-hover);
                    border-radius: 8px;
                    text-align: center;
                  "
                >
                  <p style="color: var(--text-muted); margin-bottom: 12px">
                    Authentication coming soon
                  </p>
                  <button class="btn btn-secondary" disabled>
                    Sign in with Google
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Inbox Modal -->
    <div
      class="inbox-modal-overlay"
      id="inbox-modal"
      onclick="if(event.target === this) closeInboxModal()"
    >
      <div class="inbox-modal">
        <div class="inbox-header">
          <div class="inbox-header-left">
            <div class="inbox-icon">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
                />
                <polyline points="22,6 12,13 2,6" />
              </svg>
            </div>
            <div>
              <div class="inbox-title">Inbox</div>
              <div class="inbox-subtitle">Voice memos and quick ideas</div>
            </div>
          </div>
          <button class="inbox-close" onclick="closeInboxModal()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              style="width: 20px; height: 20px"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="inbox-toolbar">
          <input
            type="text"
            class="inbox-search"
            placeholder="Search voice memos..."
            id="inbox-search"
            oninput="filterInbox()"
          />
          <div class="inbox-filters">
            <button
              class="inbox-filter-btn active"
              data-filter="all"
              onclick="setInboxFilter('all')"
            >
              All
            </button>
            <button
              class="inbox-filter-btn"
              data-filter="unassigned"
              onclick="setInboxFilter('unassigned')"
            >
              Unassigned
            </button>
            <button
              class="inbox-filter-btn"
              data-filter="assigned"
              onclick="setInboxFilter('assigned')"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                style="width: 12px; height: 12px"
              >
                <path
                  d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
                />
              </svg>
              Assigned
            </button>
            <button
              class="inbox-filter-btn"
              data-filter="favorite"
              onclick="setInboxFilter('favorite')"
            >
              <svg
                viewBox="0 0 24 24"
                fill="currentColor"
                stroke="currentColor"
                stroke-width="2"
                style="width: 12px; height: 12px"
              >
                <path
                  d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                />
              </svg>
              Favorite
            </button>
          </div>
          <button
            class="btn btn-secondary"
            onclick="syncDropboxInbox()"
            id="sync-dropbox-btn"
            style="margin-left: auto"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              style="width: 16px; height: 16px"
              id="sync-icon"
            >
              <path d="M23 4v6h-6M1 20v-6h6" />
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              />
            </svg>
            Sync Dropbox
          </button>
        </div>
        <div class="inbox-list" id="inbox-list">
          <!-- Rendered dynamically -->
        </div>
        <div class="inbox-player-bar" id="inbox-player-bar">
          <div class="inbox-player-info">
            <div class="inbox-player-artwork" id="inbox-player-artwork">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"
                />
                <path
                  d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"
                />
              </svg>
            </div>
            <div class="inbox-player-title" id="inbox-player-title">
              No track playing
            </div>
          </div>
          <div class="inbox-player-controls">
            <button
              class="inbox-player-btn main"
              id="inbox-play-pause-btn"
              onclick="toggleMemoPlayback()"
            >
              <svg viewBox="0 0 24 24" fill="currentColor" id="inbox-play-icon">
                <polygon points="6 3 20 12 6 21 6 3" />
              </svg>
            </button>
          </div>
          <div class="inbox-player-progress">
            <span class="inbox-player-time current" id="inbox-current-time"
              >0:00</span
            >
            <div
              class="inbox-progress-bar"
              id="inbox-progress-bar"
              onclick="seekMemoAudio(event)"
            >
              <div class="inbox-progress-fill" id="inbox-progress-fill"></div>
            </div>
            <span class="inbox-player-time" id="inbox-player-duration"
              >0:00</span
            >
          </div>
          <div class="inbox-player-volume">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              style="width: 18px; height: 18px; color: var(--text-muted)"
            >
              <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
              <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
            </svg>
            <input
              type="range"
              class="inbox-volume-slider"
              min="0"
              max="100"
              value="80"
              onchange="setMemoVolume(this.value)"
            />
          </div>
          <div class="inbox-player-effects">
            <div class="inbox-effect-control">
              <span class="inbox-effect-label">Pitch</span>
              <input
                type="range"
                class="inbox-effect-slider pitch"
                min="-12"
                max="12"
                value="0"
                id="inbox-pitch-slider"
                oninput="setMemoPitch(this.value)"
              />
              <span class="inbox-effect-value" id="inbox-pitch-value"
                >0 st</span
              >
            </div>
            <div class="inbox-effect-control">
              <span class="inbox-effect-label">Reverb</span>
              <input
                type="range"
                class="inbox-effect-slider reverb"
                min="0"
                max="100"
                value="0"
                id="inbox-reverb-slider"
                oninput="setMemoReverb(this.value)"
              />
              <span class="inbox-effect-value" id="inbox-reverb-value">0%</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
