<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Ignite ‚Äî Sample Discovery</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --bg: #0a0a0a;
    --bg-card: #111111;
    --bg-hover: #1a1a1a;
    --bg-input: #161616;
    --border: rgba(255, 255, 255, 0.08);
    --text: #f0f0f0;
    --text-soft: #a0a0a0;
    --text-muted: #606060;
    --accent: #f97316;
    --accent-hover: #fb923c;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --heart: #f97316;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Header */
  .header {
    text-align: center;
    padding: 40px 20px 20px;
  }

  .header h1 {
    font-size: 32px;
    font-weight: 600;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #f97316, #ea580c);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header p {
    color: var(--text-soft);
    font-size: 16px;
  }

  .back-link {
    position: absolute;
    top: 20px;
    left: 20px;
    color: var(--text-muted);
    text-decoration: none;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: var(--text);
  }

  .back-link svg {
    width: 18px;
    height: 18px;
  }

  /* Upload Screen */
  .upload-screen {
    max-width: 500px;
    margin: 0 auto;
    padding: 20px;
  }

  .upload-zone-large {
    border: 2px dashed var(--border);
    border-radius: 16px;
    padding: 60px 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--bg-card);
  }

  .upload-zone-large:hover {
    border-color: var(--accent);
    background: rgba(249, 115, 22, 0.05);
  }

  .upload-zone-large.dragover {
    border-color: var(--accent);
    background: rgba(249, 115, 22, 0.1);
  }

  .upload-zone-large svg {
    width: 64px;
    height: 64px;
    color: var(--accent);
    margin-bottom: 16px;
    opacity: 0.7;
  }

  .upload-zone-large h3 {
    font-size: 18px;
    margin-bottom: 8px;
  }

  .upload-zone-large p {
    color: var(--text-muted);
    font-size: 14px;
    margin-bottom: 16px;
  }

  .upload-zone-large .formats {
    font-size: 12px;
    color: var(--text-muted);
  }

  .upload-progress-large {
    margin-top: 20px;
    padding: 16px;
    background: var(--bg);
    border-radius: 8px;
    display: none;
  }

  .upload-progress-large.visible {
    display: block;
  }

  .upload-progress-text {
    font-size: 13px;
    margin-bottom: 8px;
    color: var(--text-soft);
  }

  .upload-progress-bar {
    height: 4px;
    background: var(--bg-hover);
    border-radius: 2px;
    overflow: hidden;
  }

  .upload-progress-fill {
    height: 100%;
    background: var(--accent);
    width: 0%;
    transition: width 0.2s;
  }

  /* Or divider */
  .divider {
    display: flex;
    align-items: center;
    margin: 30px 0;
    color: var(--text-muted);
    font-size: 13px;
  }

  .divider::before,
  .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .divider span {
    padding: 0 16px;
  }

  /* Start from pool button */
  .btn-start-pool {
    width: 100%;
    padding: 16px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .btn-start-pool:hover {
    border-color: var(--accent);
    background: rgba(249, 115, 22, 0.05);
  }

  .btn-start-pool:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-start-pool svg {
    width: 20px;
    height: 20px;
  }

  .pool-count {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 12px;
    text-align: center;
  }

  /* Staged samples section */
  .staged-section {
    margin-top: 24px;
    padding: 20px;
    background: var(--bg-card);
    border-radius: 12px;
    border: 1px solid var(--border);
  }

  .staged-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .staged-header h3 {
    font-size: 16px;
    font-weight: 600;
  }

  .staged-count {
    font-size: 13px;
    color: var(--accent);
    background: rgba(249, 115, 22, 0.15);
    padding: 4px 12px;
    border-radius: 12px;
  }

  .staged-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    max-height: 120px;
    overflow-y: auto;
    margin-bottom: 16px;
  }

  .staged-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--bg);
    border-radius: 6px;
    font-size: 12px;
    color: var(--text-soft);
  }

  .staged-item svg {
    width: 14px;
    height: 14px;
    color: var(--accent);
  }

  .staged-actions {
    display: flex;
    gap: 12px;
  }

  .btn-add-more {
    flex: 1;
    padding: 12px 16px;
    background: var(--bg);
    border: 1px dashed var(--border);
    border-radius: 8px;
    color: var(--text-soft);
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
  }

  .btn-add-more:hover {
    border-color: var(--text-muted);
    color: var(--text);
  }

  .btn-add-more svg {
    width: 16px;
    height: 16px;
  }

  .btn-begin-session {
    flex: 2;
    padding: 14px 24px;
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s;
  }

  .btn-begin-session:hover {
    background: var(--accent-hover);
    transform: translateY(-1px);
  }

  .btn-begin-session svg {
    width: 18px;
    height: 18px;
  }

  .share-section {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }

  .btn-share {
    padding: 10px 16px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-soft);
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
  }

  .btn-share:hover {
    border-color: var(--text-muted);
    color: var(--text);
  }

  .btn-share svg {
    width: 16px;
    height: 16px;
  }

  .share-status {
    font-size: 12px;
    color: var(--success);
  }

  /* Discovery Screen (same as discover.html) */
  .discovery-screen {
    display: none;
  }

  .discovery-screen.visible {
    display: block;
  }

  .progress-container {
    text-align: center;
    margin-bottom: 20px;
  }

  .progress-text {
    font-size: 14px;
    color: var(--text-muted);
  }

  .progress-bar-bg {
    width: 200px;
    height: 4px;
    background: var(--bg-card);
    border-radius: 2px;
    margin: 10px auto 0;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  /* Card Container */
  .card-container {
    position: relative;
    width: 100%;
    max-width: 400px;
    margin: 0 auto;
    padding: 0 20px;
    min-height: 400px;
  }

  /* Discovery Card */
  .discovery-card {
    position: relative;
    width: 100%;
    background: var(--bg-card);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    cursor: grab;
    user-select: none;
    touch-action: none;
  }

  .discovery-card:active {
    cursor: grabbing;
  }

  .discovery-card.swiping-left {
    animation: swipeLeft 0.3s ease forwards;
  }

  .discovery-card.swiping-right {
    animation: swipeRight 0.3s ease forwards;
  }

  .discovery-card.swiping-down {
    animation: swipeDown 0.3s ease forwards;
  }

  @keyframes swipeLeft {
    to {
      transform: translateX(-150%) rotate(-15deg);
      opacity: 0;
    }
  }

  @keyframes swipeRight {
    to {
      transform: translateX(150%) rotate(15deg);
      opacity: 0;
    }
  }

  @keyframes swipeDown {
    to {
      transform: translateY(150%);
      opacity: 0;
    }
  }

  /* Swipe indicators */
  .swipe-indicator {
    position: absolute;
    top: 20px;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 16px;
    opacity: 0;
    transition: opacity 0.15s;
    pointer-events: none;
    z-index: 10;
  }

  .swipe-indicator.left {
    right: 20px;
    background: rgba(100, 100, 100, 0.9);
    color: white;
  }

  .swipe-indicator.right {
    left: 20px;
    background: rgba(249, 115, 22, 0.9);
    color: white;
  }

  .swipe-indicator.visible {
    opacity: 1;
  }

  /* Card Art */
  .card-art {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    background: var(--bg);
    overflow: hidden;
  }

  .card-art svg {
    width: 100%;
    height: 100%;
  }

  .card-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 60px 20px 20px;
    background: linear-gradient(transparent, rgba(0,0,0,0.9));
  }

  .card-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 4px;
    line-height: 1.2;
    word-break: break-word;
  }

  .card-meta {
    font-size: 13px;
    color: var(--text-soft);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .sample-type {
    display: inline-block;
    padding: 2px 8px;
    background: rgba(249, 115, 22, 0.2);
    color: var(--accent);
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
  }

  /* Card Info */
  .card-info {
    padding: 16px 20px;
  }

  /* Audio Player */
  .audio-player {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .play-btn-small {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--bg);
    border: 2px solid var(--border);
    color: var(--text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  .play-btn-small:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .play-btn-small svg {
    width: 18px;
    height: 18px;
  }

  .waveform-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .waveform {
    height: 32px;
    background: var(--bg);
    border-radius: 6px;
    position: relative;
    overflow: hidden;
    cursor: pointer;
  }

  .waveform-progress {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    background: rgba(249, 115, 22, 0.3);
    pointer-events: none;
  }

  .waveform-bars {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 100%;
    padding: 4px 8px;
    gap: 2px;
  }

  .waveform-bar {
    flex: 1;
    background: var(--text-muted);
    border-radius: 1px;
    transition: background 0.1s;
  }

  .waveform-bar.active {
    background: var(--accent);
  }

  .audio-time {
    font-size: 12px;
    color: var(--text-muted);
    text-align: right;
  }

  /* Loop toggle */
  .loop-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 12px;
    font-size: 13px;
    color: var(--text-muted);
  }

  .loop-toggle button {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
  }

  .loop-toggle button.active {
    background: rgba(249, 115, 22, 0.15);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    padding: 30px 20px;
  }

  .action-btn {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 2px solid var(--border);
    background: var(--bg-card);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .action-btn svg {
    width: 28px;
    height: 28px;
  }

  .action-btn.skip {
    color: var(--text-muted);
  }

  .action-btn.skip:hover {
    color: var(--text);
    border-color: var(--text-muted);
    transform: scale(1.1);
  }

  .action-btn.pass {
    color: var(--text-muted);
  }

  .action-btn.pass:hover {
    color: var(--text);
    border-color: var(--text-muted);
    transform: scale(1.1);
  }

  .action-btn.fire {
    color: var(--accent);
    border-color: rgba(249, 115, 22, 0.3);
  }

  .action-btn.fire:hover {
    background: rgba(249, 115, 22, 0.15);
    border-color: var(--accent);
    transform: scale(1.1);
  }

  /* Stats */
  .stats {
    display: flex;
    justify-content: center;
    gap: 60px;
    padding: 20px;
    margin-top: 10px;
  }

  .stat {
    text-align: center;
  }

  .stat-number {
    font-size: 32px;
    font-weight: 700;
    line-height: 1;
  }

  .stat-number.fire {
    color: var(--accent);
  }

  .stat-number.passed {
    color: var(--text-muted);
  }

  .stat-number.remaining {
    color: var(--text);
  }

  .stat-label {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 4px;
  }

  /* Keyboard hints */
  .keyboard-hints {
    text-align: center;
    padding: 10px;
    color: var(--text-muted);
    font-size: 12px;
  }

  .keyboard-hints kbd {
    display: inline-block;
    padding: 2px 8px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-family: inherit;
    margin: 0 2px;
  }

  /* Results Screen */
  .results-screen {
    display: none;
    padding: 20px;
    max-width: 800px;
    margin: 0 auto;
  }

  .results-screen.visible {
    display: block;
  }

  .results-header {
    text-align: center;
    margin-bottom: 30px;
  }

  .results-header h2 {
    font-size: 28px;
    margin-bottom: 8px;
  }

  .results-header p {
    color: var(--text-soft);
  }

  .results-stats {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 40px;
  }

  .results-section {
    margin-bottom: 30px;
  }

  .results-section h3 {
    font-size: 16px;
    color: var(--text-soft);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .results-section h3 .count {
    background: var(--bg-card);
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 13px;
  }

  /* Results Grid */
  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
  }

  .result-card {
    background: var(--bg-card);
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .result-card:hover {
    transform: translateY(-2px);
  }

  .result-card-art {
    aspect-ratio: 1;
    position: relative;
  }

  .result-card-art svg {
    width: 100%;
    height: 100%;
  }

  .result-card-play {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.4);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .result-card:hover .result-card-play {
    opacity: 1;
  }

  .result-card-play svg {
    width: 48px;
    height: 48px;
    color: white;
  }

  .result-card-info {
    padding: 12px;
  }

  .result-card-title {
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Download button */
  .download-btn {
    display: block;
    width: 100%;
    max-width: 400px;
    margin: 30px auto;
    padding: 16px 32px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .download-btn:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
  }

  .download-btn:disabled {
    background: var(--text-muted);
    cursor: not-allowed;
    transform: none;
  }

  .back-to-ideas {
    display: block;
    text-align: center;
    color: var(--text-soft);
    margin-top: 16px;
    text-decoration: none;
  }

  .back-to-ideas:hover {
    color: var(--text);
  }

  .results-actions {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .btn-new-session {
    padding: 12px 24px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    text-decoration: none;
    font-size: 14px;
    transition: all 0.2s;
  }

  .btn-new-session:hover {
    border-color: var(--accent);
    background: rgba(249, 115, 22, 0.1);
  }

  .btn-clear-favorites {
    padding: 12px 24px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-muted);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-clear-favorites:hover {
    border-color: var(--danger);
    color: var(--danger);
  }

  /* Mobile */
  @media (max-width: 480px) {
    .header {
      padding: 20px 16px 12px;
    }

    .header h1 {
      font-size: 24px;
    }

    .upload-zone-large {
      padding: 40px 24px;
    }

    .upload-zone-large svg {
      width: 48px;
      height: 48px;
    }

    .card-container {
      padding: 0 16px;
      min-height: auto;
    }

    .card-title {
      font-size: 16px;
    }

    .action-buttons {
      gap: 16px;
      padding: 16px;
    }

    .action-btn {
      width: 54px;
      height: 54px;
    }

    .action-btn svg {
      width: 22px;
      height: 22px;
    }

    .stats {
      gap: 30px;
      padding: 16px;
    }

    .stat-number {
      font-size: 26px;
    }

    .keyboard-hints {
      display: none;
    }

    .results-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
  }

  @media (max-width: 360px) {
    .action-btn {
      width: 48px;
      height: 48px;
    }

    .action-btn svg {
      width: 20px;
      height: 20px;
    }
  }
</style>
</head>
<body>

<a href="ideas.html" class="back-link">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M19 12H5M12 19l-7-7 7-7"/>
  </svg>
  Back to Ideas
</a>

<!-- Upload Screen -->
<div id="upload-screen" class="upload-screen">
  <div class="header">
    <h1>üî• Ignite</h1>
    <p>Discover hidden gems in your sample library</p>
  </div>

  <div class="upload-zone-large" id="upload-zone" onclick="document.getElementById('file-input').click()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
      <polyline points="17 8 12 3 7 8"/>
      <line x1="12" y1="3" x2="12" y2="15"/>
    </svg>
    <h3>Drop samples here</h3>
    <p>Drag & drop audio files or folders</p>
    <div class="formats">WAV, MP3, AIFF, M4A supported</div>
  </div>

  <div class="upload-progress-large" id="upload-progress">
    <div class="upload-progress-text" id="upload-progress-text">Uploading...</div>
    <div class="upload-progress-bar">
      <div class="upload-progress-fill" id="upload-progress-fill"></div>
    </div>
  </div>

  <!-- Staged samples section -->
  <div class="staged-section" id="staged-section" style="display: none;">
    <div class="staged-header">
      <h3>üéµ Ready to ignite</h3>
      <span class="staged-count" id="staged-count">0 samples</span>
    </div>
    <div class="staged-list" id="staged-list"></div>
    <div class="staged-actions">
      <button class="btn-add-more" onclick="document.getElementById('file-input').click()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        Add more samples
      </button>
      <button class="btn-begin-session" id="btn-begin-session" onclick="beginSession()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="5 3 19 12 5 21 5 3"/>
        </svg>
        Begin Session
      </button>
    </div>
    <div class="share-section">
      <button class="btn-share" onclick="copyShareLink()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="18" cy="5" r="3"/>
          <circle cx="6" cy="12" r="3"/>
          <circle cx="18" cy="19" r="3"/>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
          <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
        </svg>
        Copy link for mobile
      </button>
      <span class="share-status" id="share-status"></span>
    </div>
  </div>

  <input type="file" id="file-input" accept="audio/*" multiple webkitdirectory style="display: none;" onchange="handleFileSelect(event)" />

  <div class="divider" id="divider-or"><span>or</span></div>

  <button class="btn-start-pool" id="btn-start-pool" onclick="startFromPool()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polygon points="5 3 19 12 5 21 5 3"/>
    </svg>
    Start from existing pool
  </button>
  <div class="pool-count" id="pool-count">Loading sample pool...</div>
</div>

<!-- Discovery Screen -->
<div id="discovery-screen" class="discovery-screen">
  <div class="header" style="padding-top: 20px;">
    <h1>üî• Ignite</h1>
  </div>

  <div class="progress-container">
    <div class="progress-text" id="progress-text">1 of 100</div>
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progress-bar"></div>
    </div>
  </div>

  <div class="card-container" id="card-container">
    <!-- Cards inserted here -->
  </div>

  <div class="action-buttons">
    <button class="action-btn pass" id="btn-pass" title="Pass (‚Üê)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    <button class="action-btn skip" id="btn-skip" title="Skip (‚Üì)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="6 9 12 15 18 9"/>
      </svg>
    </button>
    <button class="action-btn fire" id="btn-fire" title="Fire! (‚Üí)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </svg>
    </button>
  </div>

  <div class="stats">
    <div class="stat">
      <div class="stat-number fire" id="stat-fire">0</div>
      <div class="stat-label">üî• Fire</div>
    </div>
    <div class="stat">
      <div class="stat-number passed" id="stat-passed">0</div>
      <div class="stat-label">Passed</div>
    </div>
    <div class="stat">
      <div class="stat-number remaining" id="stat-remaining">0</div>
      <div class="stat-label">Remaining</div>
    </div>
  </div>

  <div class="keyboard-hints">
    <kbd>‚Üê</kbd> Pass &nbsp;&nbsp; <kbd>‚Üì</kbd> Skip &nbsp;&nbsp; <kbd>‚Üí</kbd> Fire &nbsp;&nbsp; <kbd>Space</kbd> Play/Pause &nbsp;&nbsp; <kbd>L</kbd> Loop
  </div>
</div>

<!-- Results Screen -->
<div id="results-screen" class="results-screen">
  <div class="results-header">
    <h2>Session Complete! üî•</h2>
    <p>Here are your favorites</p>
  </div>

  <div class="results-stats">
    <div class="stat">
      <div class="stat-number fire" id="final-fire">0</div>
      <div class="stat-label">üî• Fire</div>
    </div>
    <div class="stat">
      <div class="stat-number passed" id="final-passed">0</div>
      <div class="stat-label">Passed</div>
    </div>
    <div class="stat">
      <div class="stat-number" id="final-skipped">0</div>
      <div class="stat-label">Skipped</div>
    </div>
  </div>

  <div class="results-section" id="fire-section">
    <h3>üî• Your Picks <span class="count" id="fire-count">0</span></h3>
    <div class="results-grid" id="fire-list"></div>
  </div>

  <button class="download-btn" id="download-btn">
    Download All Favorites
  </button>

  <div class="results-actions">
    <a href="ignite.html" class="btn-new-session">Start New Session</a>
    <button class="btn-clear-favorites" onclick="clearFavorites()">Clear All Favorites History</button>
  </div>

  <a href="ideas.html" class="back-to-ideas">Return to Ideas</a>
</div>

<!-- Audio -->
<audio id="audio" preload="auto"></audio>

<script>
// Supabase
const SUPABASE_URL = 'https://cimngwcwvbspkcqdzqfg.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpbW5nd2N3dmJzcGtjcWR6cWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MzA1MDIsImV4cCI6MjA4MDEwNjUwMn0.L9Tvj4mlSjAtiSVMPkaegRF4laZl_E15ALZFdRhSzUg';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const BUCKET_NAME = 'audio';
const FOLDER_NAME = 'sample-pool';

// Helper to get public URL
function getPublicUrl(filename) {
  return `${SUPABASE_URL}/storage/v1/object/public/${BUCKET_NAME}/${FOLDER_NAME}/${encodeURIComponent(filename)}`;
}

// State
let samples = [];
let stagedSamples = []; // Samples ready to be played
let currentIndex = 0;
let fireSamples = [];
let passedSamples = [];
let skippedSamples = [];
let isPlaying = false;
let isLooping = true;
let audio = document.getElementById('audio');
let currentCard = null;
let sessionId = null; // For shareable links

// DOM
const uploadScreen = document.getElementById('upload-screen');
const discoveryScreen = document.getElementById('discovery-screen');
const resultsScreen = document.getElementById('results-screen');
const cardContainer = document.getElementById('card-container');

// Load pool count on start
async function loadPoolCount() {
  try {
    const { data, error } = await supabase.storage.from(BUCKET_NAME).list(FOLDER_NAME, { limit: 1000 });
    if (error) throw error;
    
    console.log('Storage list result:', data); // Debug
    
    // Filter for audio files - check both with and without metadata property
    const audioFiles = (data || []).filter(f => {
      if (!f.name) return false;
      // Skip folder entries (they have id property or are .emptyFolderPlaceholder)
      if (f.name === '.emptyFolderPlaceholder') return false;
      return /\.(wav|mp3|aiff|aif|m4a)$/i.test(f.name);
    });
    
    const count = audioFiles.length;
    console.log('Audio files found:', count, audioFiles.map(f => f.name)); // Debug
    
    const poolCountEl = document.getElementById('pool-count');
    const poolBtn = document.getElementById('btn-start-pool');
    
    if (poolCountEl) {
      poolCountEl.textContent = count > 0 
        ? `${count} samples in your pool`
        : 'Pool is empty - upload some samples!';
    }
    
    if (poolBtn) {
      poolBtn.disabled = count === 0;
    }
    
    return count;
  } catch (err) {
    console.error('Error loading pool:', err);
    const poolCountEl = document.getElementById('pool-count');
    if (poolCountEl) {
      poolCountEl.textContent = 'Could not load pool - check console';
    }
    return 0;
  }
}

// Start from existing pool
async function startFromPool() {
  try {
    const { data, error } = await supabase.storage.from(BUCKET_NAME).list(FOLDER_NAME, { limit: 1000 });
    if (error) throw error;
    
    console.log('Starting from pool, raw data:', data);
    
    // Filter for audio files
    const audioFiles = (data || []).filter(f => {
      if (!f.name) return false;
      if (f.name === '.emptyFolderPlaceholder') return false;
      return /\.(wav|mp3|aiff|aif|m4a)$/i.test(f.name);
    });
    
    console.log('Filtered audio files:', audioFiles.length);
    
    if (audioFiles.length === 0) {
      alert('No samples found in pool. Please upload some samples first.');
      return;
    }
    
    // Get list of already favorited samples from localStorage (simple approach)
    const favoritedIds = JSON.parse(localStorage.getItem('ignite_favorites') || '[]');
    
    // Build samples list, excluding already favorited ones
    samples = audioFiles
      .filter(f => !favoritedIds.includes(f.name))
      .map(f => ({
        id: f.name, // Use filename as ID for tracking
        name: f.name.replace(/\.[^/.]+$/, '').replace(/[-_]/g, ' ').replace(/^\d+-/, ''), // Remove timestamp prefix too
        filename: f.name,
        url: getPublicUrl(f.name),
        type: detectSampleType(f.name)
      }));
    
    console.log('Samples to play:', samples.length);
    
    if (samples.length === 0) {
      alert('All samples have been reviewed! Clear your favorites to start fresh.');
      return;
    }
    
    samples = shuffleArray(samples);
    startDiscovery();
  } catch (err) {
    console.error('Error starting from pool:', err);
    alert('Failed to load samples: ' + err.message);
  }
}

// Upload handling
const uploadZone = document.getElementById('upload-zone');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
  uploadZone.addEventListener(e, preventDefault, false);
  document.body.addEventListener(e, preventDefault, false);
});

['dragenter', 'dragover'].forEach(e => {
  uploadZone.addEventListener(e, () => uploadZone.classList.add('dragover'), false);
});

['dragleave', 'drop'].forEach(e => {
  uploadZone.addEventListener(e, () => uploadZone.classList.remove('dragover'), false);
});

uploadZone.addEventListener('drop', handleDrop, false);

function preventDefault(e) {
  e.preventDefault();
  e.stopPropagation();
}

function handleDrop(e) {
  const items = e.dataTransfer.items;
  const files = [];
  
  // Handle folder drops
  const promises = [];
  for (let i = 0; i < items.length; i++) {
    const item = items[i].webkitGetAsEntry();
    if (item) {
      promises.push(traverseFileTree(item, files));
    }
  }
  
  Promise.all(promises).then(() => {
    if (files.length > 0) {
      uploadFiles(files);
    }
  });
}

function handleFileSelect(e) {
  const files = Array.from(e.target.files).filter(f => /\.(wav|mp3|aiff|aif|m4a)$/i.test(f.name));
  if (files.length > 0) {
    uploadFiles(files);
  }
}

function traverseFileTree(item, files) {
  return new Promise((resolve) => {
    if (item.isFile) {
      item.file(file => {
        if (/\.(wav|mp3|aiff|aif|m4a)$/i.test(file.name)) {
          files.push(file);
        }
        resolve();
      });
    } else if (item.isDirectory) {
      const reader = item.createReader();
      reader.readEntries(entries => {
        Promise.all(entries.map(entry => traverseFileTree(entry, files))).then(resolve);
      });
    } else {
      resolve();
    }
  });
}

async function uploadFiles(files) {
  const progressEl = document.getElementById('upload-progress');
  const progressText = document.getElementById('upload-progress-text');
  const progressFill = document.getElementById('upload-progress-fill');
  
  progressEl.classList.add('visible');
  
  const uploaded = [];
  
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const progress = ((i + 1) / files.length) * 100;
    
    progressText.textContent = `Uploading ${i + 1} of ${files.length}: ${file.name}`;
    progressFill.style.width = progress + '%';
    
    try {
      // Clean filename
      const cleanName = file.name.replace(/[^a-zA-Z0-9.-]/g, '-');
      const uniqueName = `${Date.now()}-${cleanName}`;
      const storagePath = `${FOLDER_NAME}/${uniqueName}`;
      
      const { error } = await supabase.storage
        .from(BUCKET_NAME)
        .upload(storagePath, file, { contentType: file.type, upsert: true });
      
      if (!error) {
        uploaded.push({
          id: uniqueName, // For tracking favorites
          name: file.name.replace(/\.[^/.]+$/, '').replace(/[-_]/g, ' '),
          filename: uniqueName,
          url: getPublicUrl(uniqueName),
          type: detectSampleType(file.name)
        });
      }
    } catch (err) {
      console.error('Upload error:', err);
    }
  }
  
  progressText.textContent = `‚úì Uploaded ${uploaded.length} samples`;
  
  if (uploaded.length > 0) {
    // Add to staged samples instead of starting immediately
    stagedSamples = stagedSamples.concat(uploaded);
    updateStagedUI();
    
    // Hide progress after a moment
    setTimeout(() => {
      progressEl.classList.remove('visible');
    }, 1500);
  }
}

// Update the staged samples UI
function updateStagedUI() {
  const section = document.getElementById('staged-section');
  const list = document.getElementById('staged-list');
  const count = document.getElementById('staged-count');
  const divider = document.getElementById('divider-or');
  const poolBtn = document.getElementById('btn-start-pool');
  const poolCount = document.getElementById('pool-count');
  
  if (stagedSamples.length > 0) {
    section.style.display = 'block';
    divider.style.display = 'none';
    poolBtn.style.display = 'none';
    poolCount.style.display = 'none';
    
    count.textContent = `${stagedSamples.length} sample${stagedSamples.length !== 1 ? 's' : ''}`;
    
    // Show sample types summary
    const typeCounts = {};
    stagedSamples.forEach(s => {
      typeCounts[s.type] = (typeCounts[s.type] || 0) + 1;
    });
    
    list.innerHTML = Object.entries(typeCounts).map(([type, num]) => `
      <div class="staged-item">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18V5l12-2v13"/>
          <circle cx="6" cy="18" r="3"/>
          <circle cx="18" cy="16" r="3"/>
        </svg>
        ${num} ${type}${num !== 1 ? 's' : ''}
      </div>
    `).join('');
    
    // Generate session ID for sharing
    if (!sessionId) {
      sessionId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }
  } else {
    section.style.display = 'none';
    divider.style.display = 'flex';
    poolBtn.style.display = 'flex';
    poolCount.style.display = 'block';
  }
}

// Begin the discovery session
function beginSession() {
  if (stagedSamples.length === 0) return;
  
  samples = shuffleArray(stagedSamples);
  startDiscovery();
}

// Copy share link
function copyShareLink() {
  const url = new URL(window.location.href);
  url.searchParams.set('session', 'pool'); // For now, just link to pool
  
  navigator.clipboard.writeText(url.toString()).then(() => {
    document.getElementById('share-status').textContent = '‚úì Link copied!';
    setTimeout(() => {
      document.getElementById('share-status').textContent = '';
    }, 3000);
  }).catch(() => {
    document.getElementById('share-status').textContent = 'Failed to copy';
  });
}

// Clear all favorites history
function clearFavorites() {
  if (confirm('Clear all favorites history? This will let you re-discover all samples in future sessions.')) {
    localStorage.removeItem('ignite_favorites');
    alert('Favorites history cleared!');
  }
}

function detectSampleType(filename) {
  const lower = filename.toLowerCase();
  if (/drum|break|beat|kick|snare|hat|perc/i.test(lower)) return 'Drums';
  if (/bass/i.test(lower)) return 'Bass';
  if (/vocal|vox|voice/i.test(lower)) return 'Vocal';
  if (/synth|pad|lead|arp/i.test(lower)) return 'Synth';
  if (/guitar|gtr/i.test(lower)) return 'Guitar';
  if (/piano|keys|organ/i.test(lower)) return 'Keys';
  if (/string|orchestra|violin|cello/i.test(lower)) return 'Strings';
  if (/loop/i.test(lower)) return 'Loop';
  if (/fx|sfx|effect|riser|impact/i.test(lower)) return 'FX';
  return 'Sample';
}

function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function startDiscovery() {
  uploadScreen.style.display = 'none';
  discoveryScreen.classList.add('visible');
  updateStats();
  renderCurrentCard();
}

function updateStats() {
  const remaining = samples.length - currentIndex;
  document.getElementById('stat-fire').textContent = fireSamples.length;
  document.getElementById('stat-passed').textContent = passedSamples.length;
  document.getElementById('stat-remaining').textContent = remaining;
  
  const progress = samples.length > 0 ? (currentIndex / samples.length) * 100 : 0;
  document.getElementById('progress-bar').style.width = progress + '%';
  document.getElementById('progress-text').textContent = `${currentIndex + 1} of ${samples.length}`;
}

// Album art generation
function hashString(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash = hash & hash;
  }
  return Math.abs(hash);
}

function generateAlbumArt(name, type) {
  const seed = hashString(name + type);
  const palettes = [
    ['#FF6B35', '#F7C59F', '#2EC4B6', '#E71D36', '#011627'],
    ['#FF3366', '#33CCFF', '#FFCC00', '#00CC99', '#9933FF'],
    ['#00D4FF', '#FF0080', '#FFE600', '#00FF88', '#8B5CF6'],
    ['#F72585', '#7209B7', '#3A0CA3', '#4361EE', '#4CC9F0'],
    ['#264653', '#2A9D8F', '#E9C46A', '#F4A261', '#E76F51'],
    ['#1A1A2E', '#16213E', '#0F3460', '#E94560', '#FF9F1C'],
  ];
  const palette = palettes[seed % palettes.length];
  const pattern = seed % 6;
  
  let svg = `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">`;
  svg += `<rect width="200" height="200" fill="${palette[0]}"/>`;
  
  if (pattern === 0) {
    svg += `<circle cx="100" cy="100" r="70" fill="${palette[1]}"/>`;
    svg += `<circle cx="100" cy="100" r="40" fill="${palette[2]}"/>`;
    svg += `<circle cx="100" cy="100" r="15" fill="${palette[3]}"/>`;
  } else if (pattern === 1) {
    svg += `<rect x="40" y="40" width="120" height="120" fill="${palette[1]}" transform="rotate(45, 100, 100)"/>`;
    svg += `<circle cx="100" cy="100" r="35" fill="${palette[2]}"/>`;
  } else if (pattern === 2) {
    svg += `<polygon points="100,20 180,180 20,180" fill="${palette[1]}"/>`;
    svg += `<circle cx="100" cy="120" r="30" fill="${palette[2]}"/>`;
  } else if (pattern === 3) {
    for (let i = 0; i < 5; i++) {
      svg += `<rect x="${20 + i * 35}" y="40" width="25" height="${60 + (seed >> i) % 80}" fill="${palette[1 + i % 4]}" rx="4"/>`;
    }
  } else if (pattern === 4) {
    svg += `<circle cx="50" cy="50" r="40" fill="${palette[1]}"/>`;
    svg += `<circle cx="150" cy="150" r="40" fill="${palette[2]}"/>`;
    svg += `<circle cx="50" cy="150" r="30" fill="${palette[3]}"/>`;
    svg += `<circle cx="150" cy="50" r="30" fill="${palette[4]}"/>`;
  } else {
    svg += `<rect x="0" y="80" width="200" height="40" fill="${palette[1]}"/>`;
    svg += `<rect x="80" y="0" width="40" height="200" fill="${palette[2]}"/>`;
    svg += `<circle cx="100" cy="100" r="25" fill="${palette[3]}"/>`;
  }
  
  svg += `</svg>`;
  return svg;
}

function generateWaveformBars() {
  let bars = '';
  for (let i = 0; i < 40; i++) {
    const height = 20 + Math.random() * 60;
    bars += `<div class="waveform-bar" style="height: ${height}%"></div>`;
  }
  return bars;
}

function renderCurrentCard() {
  if (currentIndex >= samples.length) {
    showResults();
    return;
  }

  const sample = samples[currentIndex];
  const albumArt = generateAlbumArt(sample.name, sample.type);
  
  const card = document.createElement('div');
  card.className = 'discovery-card';
  card.innerHTML = `
    <div class="swipe-indicator left">PASS</div>
    <div class="swipe-indicator right">üî• FIRE</div>
    <div class="card-art">
      ${albumArt}
      <div class="card-overlay">
        <div class="card-title">${escapeHtml(sample.name)}</div>
        <div class="card-meta">
          <span class="sample-type">${sample.type}</span>
        </div>
      </div>
    </div>
    <div class="card-info">
      <div class="audio-player">
        <button class="play-btn-small" onclick="togglePlayback(event)">
          <svg class="play-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
          <svg class="pause-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
            <rect x="6" y="4" width="4" height="16"/>
            <rect x="14" y="4" width="4" height="16"/>
          </svg>
        </button>
        <div class="waveform-container">
          <div class="waveform" onclick="seekAudio(event)">
            <div class="waveform-progress" id="waveform-progress"></div>
            <div class="waveform-bars">${generateWaveformBars()}</div>
          </div>
          <div class="audio-time">
            <span id="current-time">0:00</span> / <span id="duration">--:--</span>
          </div>
        </div>
      </div>
      <div class="loop-toggle">
        <button class="${isLooping ? 'active' : ''}" onclick="toggleLoop()">üîÅ Loop</button>
      </div>
    </div>
  `;

  const oldCard = cardContainer.querySelector('.discovery-card');
  if (oldCard) oldCard.remove();

  cardContainer.appendChild(card);
  currentCard = card;

  // Setup audio
  audio.src = sample.url;
  audio.loop = isLooping;
  audio.load();
  
  // Auto-play
  audio.oncanplaythrough = () => {
    audio.play().then(() => {
      isPlaying = true;
      updatePlayButton();
    }).catch(() => {});
    audio.oncanplaythrough = null;
  };

  setupCardInteraction(card);
  updateStats();
}

function updatePlayButton() {
  const playIcon = document.querySelector('.play-icon');
  const pauseIcon = document.querySelector('.pause-icon');
  if (playIcon && pauseIcon) {
    playIcon.style.display = isPlaying ? 'none' : 'block';
    pauseIcon.style.display = isPlaying ? 'block' : 'none';
  }
}

function setupCardInteraction(card) {
  let startX = 0, startY = 0, currentX = 0, currentY = 0, isDragging = false;
  const threshold = 40;

  const onStart = (e) => {
    if (e.target.closest('.audio-player') || e.target.closest('.loop-toggle')) return;
    isDragging = true;
    const point = e.touches ? e.touches[0] : e;
    startX = point.clientX;
    startY = point.clientY;
    currentX = 0;
    currentY = 0;
  };

  const onMove = (e) => {
    if (!isDragging) return;
    const point = e.touches ? e.touches[0] : e;
    currentX = point.clientX - startX;
    currentY = point.clientY - startY;
    card.style.transform = `translate(${currentX}px, ${currentY}px) rotate(${currentX * 0.03}deg)`;
    
    const left = card.querySelector('.swipe-indicator.left');
    const right = card.querySelector('.swipe-indicator.right');
    if (currentX < -20) { left.classList.add('visible'); right.classList.remove('visible'); }
    else if (currentX > 20) { right.classList.add('visible'); left.classList.remove('visible'); }
    else { left.classList.remove('visible'); right.classList.remove('visible'); }
  };

  const onEnd = () => {
    if (!isDragging) return;
    isDragging = false;
    
    if (currentX < -threshold) triggerSwipe('left');
    else if (currentX > threshold) triggerSwipe('right');
    else if (currentY > threshold) triggerSwipe('down');
    else {
      card.style.transition = 'transform 0.15s ease-out';
      card.style.transform = '';
      card.querySelector('.swipe-indicator.left').classList.remove('visible');
      card.querySelector('.swipe-indicator.right').classList.remove('visible');
      setTimeout(() => { card.style.transition = ''; }, 150);
    }
  };

  card.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
  card.addEventListener('touchstart', onStart, { passive: true });
  document.addEventListener('touchmove', onMove, { passive: true });
  document.addEventListener('touchend', onEnd);
}

function triggerSwipe(direction) {
  if (!currentCard) return;
  
  audio.pause();
  audio.currentTime = 0;
  isPlaying = false;
  
  const sample = samples[currentIndex];
  
  if (direction === 'left') {
    currentCard.classList.add('swiping-left');
    passedSamples.push(sample);
  } else if (direction === 'right') {
    currentCard.classList.add('swiping-right');
    fireSamples.push(sample);
    // Save favorite to localStorage for persistence
    if (sample.id) {
      const favorites = JSON.parse(localStorage.getItem('ignite_favorites') || '[]');
      if (!favorites.includes(sample.id)) {
        favorites.push(sample.id);
        localStorage.setItem('ignite_favorites', JSON.stringify(favorites));
      }
    }
  } else {
    currentCard.classList.add('swiping-down');
    skippedSamples.push(sample);
  }
  
  setTimeout(() => {
    currentIndex++;
    renderCurrentCard();
  }, 250);
}

function togglePlayback(e) {
  e.stopPropagation();
  if (audio.paused) {
    audio.play();
    isPlaying = true;
  } else {
    audio.pause();
    isPlaying = false;
  }
  updatePlayButton();
}

function toggleLoop() {
  isLooping = !isLooping;
  audio.loop = isLooping;
  document.querySelector('.loop-toggle button').classList.toggle('active', isLooping);
}

function seekAudio(e) {
  const rect = e.currentTarget.getBoundingClientRect();
  const percent = (e.clientX - rect.left) / rect.width;
  if (audio.duration) audio.currentTime = percent * audio.duration;
}

audio.addEventListener('timeupdate', () => {
  const progress = document.getElementById('waveform-progress');
  const currentTimeEl = document.getElementById('current-time');
  if (progress && audio.duration) {
    const percent = (audio.currentTime / audio.duration) * 100;
    progress.style.width = percent + '%';
    const bars = document.querySelectorAll('.waveform-bar');
    const activeCount = Math.floor((percent / 100) * bars.length);
    bars.forEach((bar, i) => bar.classList.toggle('active', i < activeCount));
  }
  if (currentTimeEl) currentTimeEl.textContent = formatTime(audio.currentTime);
});

audio.addEventListener('loadedmetadata', () => {
  const durationEl = document.getElementById('duration');
  if (durationEl) durationEl.textContent = formatTime(audio.duration);
});

function formatTime(s) {
  if (!s || isNaN(s)) return '0:00';
  return `${Math.floor(s / 60)}:${Math.floor(s % 60).toString().padStart(2, '0')}`;
}

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function showResults() {
  discoveryScreen.classList.remove('visible');
  resultsScreen.classList.add('visible');
  
  document.getElementById('final-fire').textContent = fireSamples.length;
  document.getElementById('final-passed').textContent = passedSamples.length;
  document.getElementById('final-skipped').textContent = skippedSamples.length;
  document.getElementById('fire-count').textContent = fireSamples.length;
  
  if (fireSamples.length === 0) {
    document.getElementById('fire-section').style.display = 'none';
    document.getElementById('download-btn').style.display = 'none';
  } else {
    document.getElementById('fire-list').innerHTML = fireSamples.map(s => `
      <div class="result-card" onclick="playResultSample('${s.url}')">
        <div class="result-card-art">
          ${generateAlbumArt(s.name, s.type)}
          <div class="result-card-play">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
          </div>
        </div>
        <div class="result-card-info">
          <div class="result-card-title">${escapeHtml(s.name)}</div>
        </div>
      </div>
    `).join('');
  }
}

function playResultSample(url) {
  audio.src = url;
  audio.loop = true;
  audio.play();
}

document.getElementById('download-btn').addEventListener('click', async () => {
  const btn = document.getElementById('download-btn');
  btn.disabled = true;
  btn.textContent = 'Preparing download...';
  
  // Download each file
  for (const sample of fireSamples) {
    try {
      const response = await fetch(sample.url);
      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = sample.filename || sample.name + '.wav';
      a.click();
      URL.revokeObjectURL(url);
      await new Promise(r => setTimeout(r, 500)); // Small delay between downloads
    } catch (err) {
      console.error('Download error:', err);
    }
  }
  
  btn.textContent = '‚úì Downloads started!';
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (currentIndex >= samples.length) return;
  switch(e.key) {
    case 'ArrowLeft': e.preventDefault(); triggerSwipe('left'); break;
    case 'ArrowRight': e.preventDefault(); triggerSwipe('right'); break;
    case 'ArrowDown': e.preventDefault(); triggerSwipe('down'); break;
    case ' ': e.preventDefault(); togglePlayback({ stopPropagation: () => {} }); break;
    case 'l': case 'L': toggleLoop(); break;
  }
});

// Button handlers
document.getElementById('btn-pass').addEventListener('click', () => triggerSwipe('left'));
document.getElementById('btn-skip').addEventListener('click', () => triggerSwipe('down'));
document.getElementById('btn-fire').addEventListener('click', () => triggerSwipe('right'));

// Init
async function init() {
  // Check for session parameter (shared link)
  const urlParams = new URLSearchParams(window.location.search);
  const sessionParam = urlParams.get('session');
  
  if (sessionParam === 'pool') {
    // Auto-start from pool
    await startFromPool();
  } else {
    // Normal load - show pool count
    loadPoolCount();
  }
}

init();
</script>

</body>
</html>
